{% load static %}
﻿
<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Étudiants - GénieSchool</title>
  <script src="{% static 'static/vendor/js/tailwind.js' %}"></script>
  <link href="{% static 'static/vendor/fonts/css2_8b874a3a' %}" rel="stylesheet"/>
  <link href="{% static 'static/vendor/fonts/css2_d26a7969' %}" rel="stylesheet"/>
  <link href="{% static 'static/vendor/fonts/css2_293c20c8' %}" rel="stylesheet"/>
  <style type="text/tailwindcss">
    /* Theme variables (light defaults) */
    :root {
      --app-green: #16a34a;
      --app-green-2: #059669;
      --bg-primary: #f7fafc; /* page background */
      --bg-card: #ffffff; /* cards / modals */
      --bg-sidebar: linear-gradient(180deg,#ffffff,#f8fafc);
      --sidebar-border: rgba(2,6,23,0.04);
      --text-primary: #0f172a;
      --text-secondary: #334155;
      --hover-bg: rgba(2,6,23,0.03);
      --active-link-bg: rgba(22,163,74,0.06);
      --active-link-text: #06202a;
      --shadow-color: rgba(2,6,23,0.06);
      --modal-overlay: rgba(2,6,23,0.45);
      --accent-1: #06b6d4;
      --accent-2: #0ea5a4;
      --transition-fast: .18s;
    }
    /* Dark theme overrides (darker / Discord-like) */
    [data-theme="dark"] {
      --bg-primary: #0b0d10; /* very dark background like Discord */
      --bg-card: #111217; /* darker card surface */
      --bg-sidebar: linear-gradient(180deg,#0d0f13,#07080a);
      --sidebar-border: rgba(255,255,255,0.02);
      --text-primary: #DCDDDE; /* near-white text similar to Discord */
      --text-secondary: #99A0AA; /* muted secondary */
      --hover-bg: rgba(255,255,255,0.02);
      --active-link-bg: rgba(88,101,242,0.06); /* subtle blurple */
      --active-link-text: #DCDDDE;
      --shadow-color: rgba(0,0,0,0.7);
      --modal-overlay: rgba(0,0,0,0.78);
      --accent-1: #5865f2; /* Discord-like blurple */
      --accent-2: #4752c4;
    }

    /* Base layout colors using variables */
    body { font-family: 'Poppins', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); }
    .main-content { background-color: var(--bg-primary); transition: background-color var(--transition-fast) ease, color var(--transition-fast) ease; }
    .card, .modal, .popup, .dropdown { background: var(--bg-card); color: var(--text-primary); border-radius: 0.75rem; box-shadow: 0 8px 20px var(--shadow-color); transition: background var(--transition-fast) ease, color var(--transition-fast) ease, box-shadow .22s ease; }
    .btn-primary { background-color: var(--accent-2); color: white; }
    .btn-secondary { background-color: rgba(255,255,255,0.04); color: var(--text-primary); }

    /* Sidebar/nav styles */
    .sidebar { background: var(--bg-sidebar); border-right: none; box-shadow: 8px 0 24px rgba(2,6,23,0.06); transition: width .25s ease, transform .25s, background .22s ease; position:relative; }
    .sidebar .logo-text h1 { letter-spacing: .2px; color: var(--text-primary); }
    a, a:link, a:visited { text-decoration: none !important; border-bottom: none !important; box-shadow: none !important; }
  .sidebar a { transition: transform calc(var(--transition-fast) * 1.1) cubic-bezier(.2,.9,.25,1), background .22s ease, color .18s ease; font-size:1.07rem; padding: .7rem 1rem; display:flex; align-items:center; gap:.75rem; border-radius:.75rem; color: var(--text-secondary); }
  /* larger icons for better visibility */
  .sidebar .material-icons { font-size:1.9rem; margin-right:.72rem; transition: transform .18s ease, color .18s ease; color: inherit; display:inline-block; line-height:1; }
  /* professional hover: subtle move, use app green for accents */
  .sidebar a:hover { transform: translateX(6px) scale(1.03); background: var(--active-link-bg); color: var(--text-primary); }
  .sidebar a:hover .material-icons { transform: translateX(3px) scale(1.10); color: var(--app-green); }

  /* make group-header inner links align like normal nav items */
  .group-header a { display:flex; align-items:center; justify-content:space-between; gap:.75rem; color: inherit; width:100%; padding: .55rem .9rem; }
  .group-header .material-icons { margin-right:.6rem; }
    .sidebar .group-header:hover { transform: translateX(4px); }
    .active-link { background: var(--active-link-bg); box-shadow: none; color: var(--active-link-text); border-left: none; font-weight: 600; }
    .nav-indicator { position: absolute; left: 6px; width:6px; height:44px; background: linear-gradient(180deg,var(--accent-1),var(--accent-2)); border-radius:6px; transition: top var(--transition-fast) cubic-bezier(.2,.9,.2,1), height .18s, opacity var(--transition-fast); opacity:0; z-index:40; }
    .nav-separator { width:4px; min-width:4px; display:flex; align-items:center; justify-content:center; background: transparent; }
    .nav-separator::before, .nav-separator::after { display: none !important; }

    /* submenu */
    .submenu { display: none; margin-left: 0; padding-left: 0; opacity:0; transform:translateY(-6px); }
    .submenu.open { display: block; opacity:1; transform:translateY(0); animation: submenuFadeIn .18s ease both; }
    @keyframes submenuFadeIn { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
    .sidebar .submenu li a { display:flex; align-items:center; padding:8px 14px; border-radius:8px; color: var(--text-secondary); font-size:0.95rem; }
    .sidebar .submenu li a:hover { background: var(--hover-bg); color: var(--text-primary); }
    .sidebar .submenu li a { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* user and toggle */
    .theme-toggle { display:inline-block; margin-left:8px; }
    .theme-toggle input { display:none; }
    .toggle-slider { width:44px; height:24px; background: rgba(0,0,0,0.06); border-radius:999px; display:inline-block; position:relative; vertical-align:middle; transition: background .18s; }
    .toggle-slider::after { content: ''; width:18px; height:18px; background: white; border-radius:50%; position:absolute; left:3px; top:3px; transition: transform .18s ease; }
    [data-theme="dark"] .toggle-slider { background: linear-gradient(90deg,var(--accent-2),var(--accent-1)); }
    [data-theme="dark"] .toggle-slider::after { transform: translateX(20px); }

    /* modal / popup overlay helper */
    .modal-overlay { position: fixed; inset: 0; background: var(--modal-overlay); display:flex; align-items:center; justify-content:center; z-index:60; }
    .modal { max-width: 720px; padding: 20px; }

    /* small utilities */
    .pill-badge { background: linear-gradient(90deg,var(--accent-2),var(--accent-1)); color: white; padding:2px 8px; border-radius:999px; font-size:0.75rem; }
    /* Dark-mode force: make cards, widgets, tables, filters and inputs clearly visible */
    [data-theme="dark"] .card,
    [data-theme="dark"] .panel,
    [data-theme="dark"] .widget,
    [data-theme="dark"] .info-card,
    [data-theme="dark"] .white-card,
    [data-theme="dark"] .revenue-card,
    [data-theme="dark"] .dropdown,
    [data-theme="dark"] .modal,
    [data-theme="dark"] .popup,
    [data-theme="dark"] .table,
    [data-theme="dark"] .table thead,
    [data-theme="dark"] .table tbody,
    [data-theme="dark"] .filters,
    [data-theme="dark"] .search-bar,
    [data-theme="dark"] .filter-chip {
      background: rgba(255,255,255,0.02) !important;
      color: var(--text-primary) !important;
      border: 1px solid rgba(255,255,255,0.04) !important;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5) !important;
    }
    /* Tables and rows */
    [data-theme="dark"] table, [data-theme="dark"] .table { background: transparent !important; color: var(--text-primary) !important; }
    [data-theme="dark"] .table thead th { color: var(--text-secondary) !important; background: transparent !important; border-bottom: 1px solid rgba(255,255,255,0.04); }
    [data-theme="dark"] .table tbody tr td { color: var(--text-primary) !important; border-bottom: 1px solid rgba(255,255,255,0.02); }
    /* Inputs / selects / search */
    [data-theme="dark"] input, [data-theme="dark"] textarea, [data-theme="dark"] select, [data-theme="dark"] .search-input {
      background: rgba(255,255,255,0.02) !important;
      color: var(--text-primary) !important;
      border: 1px solid rgba(255,255,255,0.04) !important;
      box-shadow: none !important;
    }
    /* Buttons in dark mode */
    [data-theme="dark"] .btn-secondary { background: transparent !important; color: var(--text-primary) !important; border: 1px solid rgba(255,255,255,0.04) !important; }
    [data-theme="dark"] .btn-primary { box-shadow: 0 6px 18px rgba(124,58,237,0.12); }
    /* Ensure titles, headings and small text are readable */
    [data-theme="dark"] h1, [data-theme="dark"] h2, [data-theme="dark"] h3, [data-theme="dark"] h4, [data-theme="dark"] h5, [data-theme="dark"] p, [data-theme="dark"] span, [data-theme="dark"] a {
      color: var(--text-primary) !important;
    }
    /* Special: make any explicit white backgrounds darker (fallback) */
    [data-theme="dark"] [style*="background: #fff"], [data-theme="dark"] [style*="background: white"] {
      background: rgba(255,255,255,0.02) !important;
      color: var(--text-primary) !important;
    }
    /* Force common Tailwind white/gray and light color utilities to dark-friendly backgrounds */
    [data-theme="dark"] .bg-white,
    [data-theme="dark"] .bg-gray-50,
    [data-theme="dark"] .bg-gray-100,
    [data-theme="dark"] .bg-gray-200,
    [data-theme="dark"] .bg-gray-100\/50,
    [data-theme="dark"] .bg-white\/50,
    [data-theme="dark"] .bg-blue-50,
    [data-theme="dark"] .bg-pink-50,
    [data-theme="dark"] .bg-green-50,
    [data-theme="dark"] .bg-yellow-50,
    [data-theme="dark"] .bg-purple-100 {
      background: rgba(255,255,255,0.02) !important;
      color: var(--text-primary) !important;
      border: 1px solid rgba(255,255,255,0.04) !important;
      box-shadow: 0 8px 24px rgba(0,0,0,0.45) !important;
    }
    /* Override colored text utilities that are dark on light themes */
    [data-theme="dark"] .text-blue-700,
    [data-theme="dark"] .text-pink-600,
    [data-theme="dark"] .text-green-700,
    [data-theme="dark"] .text-amber-600,
    [data-theme="dark"] .text-purple-600,
    [data-theme="dark"] .text-black,
    [data-theme="dark"] .text-gray-900,
    [data-theme="dark"] .text-gray-800 {
      color: var(--text-primary) !important;
    }
    /* Map small utility text colors used across templates to readable dark-mode values */
    [data-theme="dark"] .text-gray-500, [data-theme="dark"] .text-gray-600, [data-theme="dark"] .text-gray-400 {
      color: var(--text-secondary) !important;
    }
    [data-theme="dark"] .text-red-600, [data-theme="dark"] .text-red-500 {
      color: #f87171 !important; /* visible red */
    }
    [data-theme="dark"] .text-green-700, [data-theme="dark"] .text-green-600 {
      color: #34d399 !important; /* visible green */
    }
    [data-theme="dark"] .text-amber-600, [data-theme="dark"] .text-amber-500 {
      color: #f59e0b !important; /* visible amber */
    }
    /* Neutralize common inline light-color usages in templates (labels, small text) */
    [data-theme="dark"] [style*="color:#6b7280"],
    [data-theme="dark"] [style*="color: #6b7280"] {
      color: var(--text-secondary) !important;
    }
    /* Make inline balance labels (amber) visible in dark mode */
    [data-theme="dark"] [style*="color:#92400e"],
    [data-theme="dark"] [style*="color: #92400e"] {
      color: #fb923c !important;
      font-weight:700 !important;
    }
    /* Convert small inline light-yellow banners to visible amber gradient in dark mode */
    [data-theme="dark"] [style*="background:#fff7ed"],
    [data-theme="dark"] [style*="background: #fff7ed"] {
      background: linear-gradient(90deg,#92400e,#fb923c) !important;
      color: #ffffff !important;
      border: none !important;
      box-shadow: 0 6px 18px rgba(146,64,14,0.12) !important;
    }
    /* Make the inscription remaining amount visible (use amber by default) */
    [data-theme="dark"] .inscription-remaining, [data-theme="dark"] .remaining-amount {
      color: #fb923c !important;
      font-weight:700 !important;
    }
    /* Ensure amounts are readable */
    [data-theme="dark"] .amount { color: var(--text-primary) !important; }
    /* Specific dashboard small tiles (apprenants) */
    [data-theme="dark"] .card .bg-blue-50,
    [data-theme="dark"] .card .bg-pink-50,
    [data-theme="dark"] .card .bg-green-50,
    [data-theme="dark"] .card .bg-yellow-50 {
      background: rgba(255,255,255,0.02) !important;
      color: var(--text-primary) !important;
    }
    [data-theme="dark"] .card .material-icons { color: var(--text-secondary) !important; filter: brightness(1.2); }
    [data-theme="dark"] .card .text-blue-700,
    [data-theme="dark"] .card .text-pink-600,
    [data-theme="dark"] .card .text-green-700,
    [data-theme="dark"] .card .text-amber-600 {
      color: var(--text-primary) !important;
    }
    /* Level bars and counts */
    [data-theme="dark"] .lvl-bar { background: rgba(255,255,255,0.03) !important; }
    [data-theme="dark"] .lvl-fill { box-shadow: none !important; }
    [data-theme="dark"] .level-name { color: var(--text-primary) !important; }
    [data-theme="dark"] .level-count { color: var(--text-secondary) !important; }
    /* Revenus card adjustments */
    [data-theme="dark"] .rev-card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)) !important; }
    [data-theme="dark"] .rev-name { color: var(--text-primary) !important; }
    [data-theme="dark"] .rev-right, [data-theme="dark"] .rev-currency { color: var(--text-secondary) !important; }
    [data-theme="dark"] .rev-value { background: linear-gradient(90deg,var(--accent-1),var(--accent-2)) !important; }
    /* Recent avatars and list */
    [data-theme="dark"] .recent-avatar { background: rgba(255,255,255,0.03) !important; color: var(--text-primary) !important; }
    /* Replace explicit white inline background-color variants */
    [data-theme="dark"] [style*="background-color: #fff"],
    [data-theme="dark"] [style*="background-color:#fff"],
    [data-theme="dark"] [style*="background: #ffffff"],
    [data-theme="dark"] [style*="background:#ffffff"],
    [data-theme="dark"] [style*="background-color: white"] {
      background: rgba(255,255,255,0.02) !important;
      color: var(--text-primary) !important;
      border: 1px solid rgba(255,255,255,0.04) !important;
    }
    /* Ensure dark-mode text contrasts (override text-black / dark text utilities) */
    [data-theme="dark"] .text-black,
    [data-theme="dark"] .text-gray-900,
    [data-theme="dark"] .text-gray-800 {
      color: var(--text-primary) !important;
    }
    /* Specific small tiles inside cards (fallback generic selectors) */
    [data-theme="dark"] .card .small-tile,
    [data-theme="dark"] .card .stat-tile,
    [data-theme="dark"] .small-box,
    [data-theme="dark"] .tile {
      background: rgba(255,255,255,0.02) !important;
      color: var(--text-primary) !important;
      border: 1px solid rgba(255,255,255,0.04) !important;
      box-shadow: none !important;
    }

    /* Ensure generic badges and pills are readable in dark mode (keep semantic badges separate) */
    [data-theme="dark"] .badge,
    [data-theme="dark"] .pill,
    [data-theme="dark"] .statut-label,
    [data-theme="dark"] .level-count {
      background: rgba(255,255,255,0.03) !important;
      color: var(--text-primary) !important;
      border: 1px solid rgba(255,255,255,0.06) !important;
      box-shadow: none !important;
      padding: .25rem .6rem !important;
      border-radius: 999px !important;
      font-weight: 600 !important;
      font-size: 0.85rem !important;
    }

    /* Semantic badge colors in dark mode — keep strong contrast like in light theme */
    [data-theme="dark"] .badge-paid {
      background: linear-gradient(90deg,#065f46,#10b981) !important;
      color: #ffffff !important;
      border: none !important;
      padding: .35rem .7rem !important;
      box-shadow: 0 6px 14px rgba(6,95,70,0.12) !important;
    }
    [data-theme="dark"] .badge-partial {
      background: linear-gradient(90deg,#92400e,#fb923c) !important;
      color: #ffffff !important;
      border: none !important;
      padding: .35rem .7rem !important;
      box-shadow: 0 6px 14px rgba(146,64,14,0.10) !important;
    }
    [data-theme="dark"] .badge-due {
      background: linear-gradient(90deg,#7f1d1d,#ef4444) !important;
      color: #ffffff !important;
      border: none !important;
      padding: .35rem .7rem !important;
      box-shadow: 0 6px 14px rgba(127,29,29,0.12) !important;
    }

    /* Status classes used in students/enseignants/inscriptions */
    [data-theme="dark"] .status-actif,
    [data-theme="dark"] .status-inactif {
      padding: .35rem .7rem !important;
      border-radius: 999px !important;
      font-weight: 600 !important;
      font-size: 0.85rem !important;
      border: none !important;
    }
    [data-theme="dark"] .status-actif { background: linear-gradient(90deg,#065f46,#10b981) !important; color: #ffffff !important; }
    [data-theme="dark"] .status-inactif { background: linear-gradient(90deg,#7f1d1d,#ef4444) !important; color: #ffffff !important; }

    /* Balance / solde visual indicator (remaining fee) — match light-mode amber but increase contrast for dark bg */
    [data-theme="dark"] .balance-solde,
    [data-theme="dark"] .solde {
      background: linear-gradient(90deg,#92400e,#fb923c) !important;
      color: #ffffff !important;
      border: none !important;
      padding: .35rem .7rem !important;
      box-shadow: 0 6px 14px rgba(146,64,14,0.12) !important;
    }
    
      /* Force frais restant (remaining fees) to use app green so it matches light theme semantics but stays visible */
      [data-theme="dark"] .frais-restant,
      [data-theme="dark"] .remaining-amount,
      [data-theme="dark"] .remaining-green,
      [data-theme="dark"] .solde-positif,
      [data-theme="dark"] .balance-solde-positive {
        background: linear-gradient(90deg,var(--app-green),var(--app-green-2)) !important;
        color: #ffffff !important;
        border: none !important;
        padding: .35rem .6rem !important;
        font-weight:700 !important;
        box-shadow: 0 8px 20px rgba(6,95,70,0.12) !important;
      }
    
      /* Inscription status: ensure enrolled/inscrit badges are visible and prominent */
      [data-theme="dark"] .inscription-status,
      [data-theme="dark"] .inscription-badge,
      [data-theme="dark"] .status-inscrit,
      [data-theme="dark"] .status-enrolled,
      [data-theme="dark"] .statut-inscrit {
        padding: .32rem .65rem !important;
        border-radius: 999px !important;
        font-weight: 700 !important;
        font-size: 0.85rem !important;
        color: #ffffff !important;
        border: none !important;
        box-shadow: 0 8px 20px rgba(0,0,0,0.45) !important;
      }
      [data-theme="dark"] .inscription-status.inscrit, [data-theme="dark"] .status-inscrit.inscrit {
        background: linear-gradient(90deg,var(--app-green),var(--app-green-2)) !important;
      }
      [data-theme="dark"] .inscription-status.attente, [data-theme="dark"] .status-inscrit.attente, [data-theme="dark"] .inscription-badge.attente {
        background: linear-gradient(90deg,#92400e,#fb923c) !important; /* waiting / partial */
      }
      [data-theme="dark"] .inscription-status.annule, [data-theme="dark"] .status-inscrit.annule {
        background: linear-gradient(90deg,#7f1d1d,#ef4444) !important; /* cancelled */
      }
    
      /* Also neutralize some inline light-green backgrounds to use app green gradient */
      [data-theme="dark"] [style*="#dcfce7"],
      [data-theme="dark"] [style*="#bbf7d0"],
      [data-theme="dark"] [style*="#bbf7d0"] {
        background: linear-gradient(90deg,var(--app-green),var(--app-green-2)) !important;
        color: #ffffff !important;
        border: none !important;
      }

    /* Icon-only and action buttons (print, delete, solde, etc.) */
    [data-theme="dark"] .action-icon-btn,
    [data-theme="dark"] .icon-btn,
    [data-theme="dark"] .row-print-btn,
    [data-theme="dark"] .print-btn,
    [data-theme="dark"] .action-print,
    [data-theme="dark"] .print-option,
    [data-theme="dark"] .btn-white,
    [data-theme="dark"] .btn-secondary,
    [data-theme="dark"] .modal-action-btn.secondary,
    [data-theme="dark"] .modal-action-btn.primary,
    [data-theme="dark"] .modal-action-btn {
      background: rgba(255,255,255,0.02) !important;
      color: var(--text-primary) !important;
      border: 1px solid rgba(255,255,255,0.06) !important;
      box-shadow: none !important;
    }

    /* Danger / Supprimer buttons should keep a subtle red tint but remain readable */
    [data-theme="dark"] .btn-danger,
    [data-theme="dark"] .delete-btn,
    [data-theme="dark"] .action-delete {
      background: linear-gradient(90deg, rgba(239,68,68,0.12), rgba(239,68,68,0.06)) !important;
      color: #fff5f5 !important;
      border: 1px solid rgba(239,68,68,0.18) !important;
      box-shadow: none !important;
    }

    /* Ensure material icons inside action buttons are visible */
    [data-theme="dark"] .action-icon-btn .material-icons,
    [data-theme="dark"] .icon-btn .material-icons,
    [data-theme="dark"] .row-print-btn .material-icons,
    [data-theme="dark"] .delete-btn .material-icons,
    [data-theme="dark"] .action-print .material-icons {
      color: var(--text-primary) !important;
      filter: brightness(1.05) !important;
    }

    /* Map utility text-white to readable color in dark mode (templates may use this) */
    [data-theme="dark"] .text-white {
      color: var(--text-primary) !important;
    }
    /* Strong modal/popup contrast and readable controls in dark mode */
    [data-theme="dark"] .modal-overlay { background: rgba(1,2,6,0.86) !important; backdrop-filter: none !important; }
    [data-theme="dark"] .modal { max-width: 820px; padding: 28px !important; border-radius: 12px !important; background: linear-gradient(180deg, rgba(255,255,255,0.045), rgba(255,255,255,0.025)) !important; border: 1px solid rgba(255,255,255,0.08) !important; box-shadow: 0 40px 120px rgba(0,0,0,0.8) !important; z-index: 10001 !important; }
    [data-theme="dark"] .modal .modal-header { border-bottom: 1px solid rgba(255,255,255,0.04) !important; padding-bottom: 12px !important; margin-bottom: 14px !important; }
    [data-theme="dark"] .modal .modal-title { color: var(--text-primary) !important; font-weight:700 !important; font-size:1.15rem !important; }
    [data-theme="dark"] .modal .modal-body { color: var(--text-secondary) !important; max-height: 65vh; overflow:auto; padding-right: 8px !important; }
    [data-theme="dark"] .modal .modal-footer { border-top: 1px solid rgba(255,255,255,0.03) !important; padding-top: 12px !important; margin-top: 14px !important; display:flex; gap:8px; justify-content:flex-end; }

    /* Inputs / selects inside modals: make fields darker and text readable */
    [data-theme="dark"] .modal input, [data-theme="dark"] .modal textarea, [data-theme="dark"] .modal select, [data-theme="dark"] .modal .form-control {
      background: rgba(0,0,0,0.22) !important; /* subtle dark field */
      color: var(--text-primary) !important;
      border: 1px solid rgba(255,255,255,0.06) !important;
      box-shadow: none !important;
      padding: .5rem .7rem !important;
    }
    [data-theme="dark"] .modal input::placeholder, [data-theme="dark"] .modal textarea::placeholder { color: rgba(230,238,248,0.6) !important; }
    [data-theme="dark"] .modal label, [data-theme="dark"] .modal .label { color: var(--text-primary) !important; font-weight:600 !important; }

    /* Make modal close button / small icons visible */
    [data-theme="dark"] .modal .close-btn, [data-theme="dark"] .modal .btn-close, [data-theme="dark"] .modal .material-icons.close {
      background: rgba(255,255,255,0.03) !important; color: var(--text-primary) !important; border: 1px solid rgba(255,255,255,0.06) !important; box-shadow: none !important;
    }

    /* Scrollbar inside modal body */
    [data-theme="dark"] .modal .modal-body::-webkit-scrollbar { width: 12px; }
    [data-theme="dark"] .modal .modal-body::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); border-radius: 8px; }
    [data-theme="dark"] .modal .modal-body::-webkit-scrollbar-thumb { background: linear-gradient(180deg, rgba(124,58,237,0.22), rgba(6,182,212,0.12)); border-radius: 8px; border: 2px solid rgba(0,0,0,0.12); }

    /* Ensure small help/muted text in modals is visible (no collapse into background) */
    [data-theme="dark"] .modal small, [data-theme="dark"] .modal .muted, [data-theme="dark"] .modal .help-text { color: var(--text-secondary) !important; opacity: 1 !important; }

    /* If any inline translucent white is present in modals, strengthen it */
    [data-theme="dark"] .modal [style*="background: rgba(255,255,255,0.02)"],
    [data-theme="dark"] .modal [style*="background: rgba(255,255,255,0.03)"] {
      background: rgba(255,255,255,0.045) !important; color: var(--text-primary) !important;
    }
    /* ==================== Additional fixes for visibility in dark mode ==================== */
    /* Make modals/popups the visually dominant elements */
    [data-theme="dark"] .modal-overlay {
      background: rgba(0,0,0,0.90) !important; /* strongest dark backdrop to contrast popups */
      backdrop-filter: none !important; -webkit-backdrop-filter: none !important;
      z-index: 9998 !important;
    }
    /* Defensive: ensure any modal-backdrop used in templates is also non-blurring */
    [data-theme="dark"] .modal-backdrop, [data-theme="dark"] .modal-backdrop * {
      backdrop-filter: none !important; -webkit-backdrop-filter: none !important; filter: none !important;
    }
    [data-theme="dark"] .modal, [data-theme="dark"] .popup {
      /* Force opaque/darker modal surface to prevent background bleed-through */
      background: rgba(10,10,12,0.98) !important;
      color: var(--text-primary) !important;
      box-shadow: 0 30px 80px rgba(0,0,0,0.75) !important;
      border: 1px solid rgba(255,255,255,0.06) !important;
      z-index: 9999 !important;
      transform: translateZ(0); /* avoid blending with background */
    }
    /* Also ensure modal inner cards/panels are opaque */
    [data-theme="dark"] .modal .bg-white, [data-theme="dark"] .modal-card, [data-theme="dark"] .modal > div, [data-theme="dark"] .modal * {
      background: rgba(10,10,12,0.98) !important;
      color: var(--text-primary) !important;
    }
    /* Also cover cases where the inner popup doesn't use the .modal class but is placed inside .modal-backdrop (many templates use bg-white on the inner panel) */
    [data-theme="dark"] .modal-backdrop .bg-white,
    [data-theme="dark"] .modal-backdrop > div,
    [data-theme="dark"] .modal-backdrop div,
    [data-theme="dark"] .modal-backdrop form {
      background: rgba(10,10,12,0.98) !important;
      color: var(--text-primary) !important;
      border: 1px solid rgba(255,255,255,0.04) !important;
      box-shadow: 0 30px 80px rgba(0,0,0,0.75) !important;
    }
    [data-theme="dark"] .modal h1, [data-theme="dark"] .modal h2, [data-theme="dark"] .modal h3, [data-theme="dark"] .modal label, [data-theme="dark"] .modal p {
      color: var(--text-primary) !important;
    }
    [data-theme="dark"] .modal .btn-primary, [data-theme="dark"] .popup .btn-primary {
      background: linear-gradient(90deg,var(--accent-2),var(--accent-1)) !important;
      color: #fff !important;
      box-shadow: 0 8px 30px rgba(124,58,237,0.18) !important;
    }

    /* Ensure modal action text/icons are visible */
    [data-theme="dark"] .modal .material-icons, [data-theme="dark"] .popup .material-icons {
      color: var(--text-primary) !important; filter: brightness(1.1) !important;
    }

    /* Important: stronger status mappings for any variant names used across templates */
    [data-theme="dark"] .status-actif, [data-theme="dark"] .status-active, [data-theme="dark"] .is-active, [data-theme="dark"] .statut-actif, [data-theme="dark"] .badge-success {
      background: linear-gradient(90deg,#065f46,#10b981) !important; color: #ffffff !important; border: none !important; box-shadow: 0 8px 20px rgba(6,95,70,0.12) !important;
    }
    [data-theme="dark"] .status-inactif, [data-theme="dark"] .status-inactive, [data-theme="dark"] .badge-failed, [data-theme="dark"] .badge-danger {
      background: linear-gradient(90deg,#7f1d1d,#ef4444) !important; color: #ffffff !important; border: none !important; box-shadow: 0 8px 20px rgba(127,29,29,0.12) !important;
    }

    /* ======================================================================= */
    /* Ensure frais restant (remaining fees) use clear semantic colors in dark */
    /* Positive balances (overpaid / credit) -> green (value < 0 or credited) */
    [data-theme="dark"] .balance-credite, /* produced when value < 0 */
    [data-theme="dark"] .solde-positif,
    [data-theme="dark"] .remaining-amount.positive,
    [data-theme="dark"] .remaining-green {
      background: linear-gradient(90deg,#065f46,#10b981) !important;
      color: #ffffff !important;
      border: none !important;
      padding: .35rem .6rem !important;
      font-weight:700 !important;
      box-shadow: 0 8px 20px rgba(6,95,70,0.14) !important;
    }

    /* Negative balances (student owes) -> use amber same as light theme (value > 0) */
    [data-theme="dark"] .balance-solde, /* produced when value > 0 */
    [data-theme="dark"] .solde-negatif,
    [data-theme="dark"] .remaining-amount.negative {
      background: linear-gradient(90deg,#92400e,#fb923c) !important;
      color: #ffffff !important;
      border: none !important;
      padding: .35rem .6rem !important;
      font-weight:700 !important;
      box-shadow: 0 8px 20px rgba(146,64,14,0.14) !important;
    }

    /* Neutral / réglé */
    [data-theme="dark"] .balance-regle, [data-theme="dark"] .balance-regle span {
      background: rgba(255,255,255,0.03) !important;
      color: var(--text-secondary) !important;
      border: 1px solid rgba(255,255,255,0.04) !important;
      padding: .25rem .5rem !important;
      font-weight:700 !important;
    }

    /* Make inscription status badges as prominent as student status badges (parity) */
    [data-theme="dark"] .status-inscrit, [data-theme="dark"] .status-actif, [data-theme="dark"] .statut-inscrit, [data-theme="dark"] .inscription-status {
      background: linear-gradient(90deg,#065f46,#10b981) !important;
      color: #ffffff !important;
      border: none !important;
      box-shadow: 0 8px 20px rgba(6,95,70,0.12) !important;
      padding: .32rem .65rem !important;
      border-radius: 999px !important;
      font-weight:700 !important;
      font-size: 0.85rem !important;
    }
    [data-theme="dark"] .status-autre, [data-theme="dark"] .status-inactif, [data-theme="dark"] .status-autre, [data-theme="dark"] .status-annule {
      background: linear-gradient(90deg,#7f1d1d,#ef4444) !important;
      color: #ffffff !important;
      border: none !important;
      box-shadow: 0 8px 20px rgba(127,29,29,0.12) !important;
      padding: .32rem .65rem !important;
      border-radius: 999px !important;
      font-weight:700 !important;
      font-size: 0.85rem !important;
    }

    /* Remaining fee / solde: ensure credited amounts are green and owed amounts are red */
    [data-theme="dark"] .remaining-amount, [data-theme="dark"] .remaining-green, [data-theme="dark"] .solde-positif, [data-theme="dark"] .balance-credite, [data-theme="dark"] .solde {
      /* default: prefer green for credited amounts when class is balance-credite; owed items use balance-solde (red) */
      background: linear-gradient(90deg,#065f46,#10b981) !important;
      color: #ffffff !important;
      border: none !important;
      padding: .35rem .6rem !important;
      font-weight:700 !important;
      box-shadow: 0 8px 20px rgba(6,95,70,0.12) !important;
    }

    /* Neutralize common pale-light-green inline colors (tailwind/light theme greens) so they become strong in dark mode */
    [data-theme="dark"] [style*="#ecfdf5"],
    [data-theme="dark"] [style*="#dcfce7"],
    [data-theme="dark"] [style*="#bbf7d0"],
    [data-theme="dark"] [style*="#10b981"],
    [data-theme="dark"] [style*="#16a34a"],
    [data-theme="dark"] [style*="#059669"] {
      background: linear-gradient(90deg,#065f46,#10b981) !important;
      color: #ffffff !important;
      border: none !important;
      box-shadow: 0 6px 18px rgba(6,95,70,0.10) !important;
    }

    /* Ensure pop-up close / action buttons remain visible */
    [data-theme="dark"] .modal .btn-secondary, [data-theme="dark"] .modal .btn-white {
      background: rgba(255,255,255,0.03) !important; color: var(--text-primary) !important; border: 1px solid rgba(255,255,255,0.06) !important;
    }

    /* Reduce chance of modal text collapsing into background: increase contrast on small text */
    [data-theme="dark"] .modal small, [data-theme="dark"] .modal .muted, [data-theme="dark"] .popup small, [data-theme="dark"] .popup .muted {
      color: var(--text-secondary) !important; opacity: 1 !important;
    }
    /* ======================================================================================= */
  </style>
</head>
<body class="flex h-screen">
  <aside class="w-64 sidebar flex flex-col p-4">
    <div class="flex items-center mb-10">
      <div class="w-10 h-10 bg-green-600 rounded-lg flex items-center justify-center text-white text-lg font-bold mr-3">GS</div>
      <div class="logo-text">
        <h1 class="text-xl font-bold">GénieSchool</h1>
        <p class="text-sm">Excellence en Formation</p>
      </div>
    </div>
  <!-- Animated nav indicator (moves to hovered/active link) -->
  <div id="navIndicator" class="nav-indicator" aria-hidden="true"></div>
    <nav class="flex-grow">
      
      
  
  
      
      
  
      
  
      
  
      
      
      
      <ul>
        <li class="mb-4">
          <a href="/" class="flex items-center px-4 py-2 rounded-lg ">
            <span class="material-icons mr-3">dashboard</span> Tableau de bord
          </a>
        </li>
        <li class="mb-4">
          <div class="group-header px-4 py-2 rounded-lg flex items-center justify-between active-link">
            <div class="flex items-center">
              <span class="material-icons mr-3">people</span>
              <span>Étudiants</span>
            </div>
            <span class="material-icons text-gray-400">expand_more</span>
          </div>
          <ul class="mt-2 submenu open">
            <li class="mb-2">
              <a href="/etudiants/" class="active-link">
                <span class="material-icons mr-3 text-sm" style="vertical-align:middle;">people</span>
                <span>Liste des étudiants</span>
              </a>
            </li>
            <li>
              <a href="/inscriptions/" class="">
                <span class="material-icons mr-3 text-sm" style="vertical-align:middle;">how_to_reg</span>
                <span>Liste des inscriptions</span>
              </a>
            </li>
          </ul>
        </li>
        <li class="mb-4">
          <a href="/enseignants/" class="flex items-center px-4 py-2 rounded-lg ">
            <span class="material-icons mr-3">supervisor_account</span> Enseignant
          </a>
        </li>
        <li class="mb-4">
          <a href="/formations/" class="flex items-center px-4 py-2 rounded-lg ">
            <span class="material-icons mr-3">school</span> Formations
          </a>
        </li>
        <li class="mb-4">
          <a href="/planning/" class="flex items-center px-4 py-2 rounded-lg ">
            <span class="material-icons mr-3">event</span> Planning
          </a>
        </li>
        <li class="mb-4">
          <a href="/presence/" class="flex items-center px-4 py-2 rounded-lg ">
            <span class="material-icons mr-3">visibility</span> Présence
          </a>
        </li>
        <li class="mb-4">
          <a href="/examens/" class="flex items-center px-4 py-2 rounded-lg ">
            <span class="material-icons mr-3">assignment</span> Examens
          </a>
        </li>
        
        <li class="mb-4">
          <div class="group-header">
            <a href="/finances/" class="flex items-center px-4 py-2 rounded-lg justify-between ">
              <div class="flex items-center">
                <span class="material-icons mr-3">payments</span>
                <span>Finances</span>
              </div>
              <span class="material-icons text-gray-400">expand_more</span>
            </a>
          </div>
          <ul class="mt-2 submenu ">
            
            <li class="mb-2">
              <a href="/reglements/fournisseurs/" class="">
                <span class="material-icons mr-3 text-sm" style="vertical-align:middle;">storefront</span>
                <span>Fournisseurs</span>
              </a>
            </li>
            <li class="mb-2">
              
              <a href="/finances/charges/" class="">
                <span class="material-icons mr-3 text-sm" style="vertical-align:middle;">receipt_long</span>
                <span>Charges</span>
              </a>
            </li>
            <li>
              <a href="#">
                <span class="material-icons mr-3 text-sm" style="vertical-align:middle;">savings</span>
                <span>Trésor</span>
              </a>
            </li>
          </ul>
        </li>
        <li class="mb-4">
          <a href="/parametres/" class="flex items-center px-4 py-2 rounded-lg ">
            <span class="material-icons mr-3">settings</span> Paramètres
          </a>
        </li>
        <li>
          <a href="/rapports/" class="flex items-center px-4 py-2 rounded-lg ">
            <span class="material-icons mr-3">bar_chart</span> Rapports
          </a>
        </li>
      </ul>
    </nav>
    <div class="mt-auto">
      <div class="mt-4 flex items-center justify-between">
        <span class="material-icons dark-mode-icon" id="themeIcon">dark_mode</span>
        <label class="theme-toggle">
          <input type="checkbox" id="themeToggle"/>
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="flex items-center">
        <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center text-gray-600 font-bold mr-3">H</div>
        <div class="user-info">
          <p class="font-semibold">HAMZA</p>
          <p class="text-sm">Administrateur</p>
        </div>
      </div>
    </div>
  </aside>
  <!-- modern visual separator between sidebar and content -->
  <div class="nav-separator" aria-hidden="true"></div>
  <main class="flex-1 p-8 overflow-y-auto main-content" style="margin-left:0;">
    
  <style>
    /* Local styles for the students interface; keep small and page-scoped */
    .btn-primary { background-color: #16a34a; color: white; }
    .btn-primary:hover { background-color: #15803d; }
    .btn-secondary { background-color: #e5e7eb; color: #374151; }
    .btn-secondary:hover { background-color: #d1d5db; }
  .status-actif { background-color: var(--status-actif-bg, #dcfce7); color: var(--status-actif-text, #16a34a); }
  .status-inactif { background-color: var(--status-inactif-bg, #fee2e2); color: var(--status-inactif-text, #dc2626); }
  .modal-backdrop { background: rgba(2,6,23,0.45); }
  /* Animations removed: keep layout & colors only */
  /* Student row hover animation */
  #studentsTbody tr.student-row { transition: transform 160ms ease, box-shadow 160ms ease, background-color 160ms; cursor: pointer; }
  #studentsTbody tr.student-row:hover { transform: translateY(-6px); box-shadow: 0 10px 30px rgba(2,6,23,0.08); background-color: var(--row-hover-bg, #fbfdff); }
  /* Elegant action buttons */
  .icon-btn {
    background: var(--icon-btn-bg, #ffffff); border: 0; padding: 6px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; border-radius:8px;
    box-shadow: 0 4px 12px rgba(2,6,23,0.06);
    transition: transform .14s ease, box-shadow .14s ease, background-position .28s ease;
    min-width: 40px; height: 40px;
    background-size: 150% 100%;
    background-position: 0% 50%;
    position: relative; overflow: hidden;
  }
  .icon-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 28px rgba(2,6,23,0.07); background-position: 100% 50%; }
  /* Slightly smaller, muted icons for an elegant look */
  .icon-svg { width: 18px; height: 18px; display: inline-block; vertical-align: middle; transition: stroke .18s ease, fill .18s ease, opacity .14s ease; }

  /* Stronger hover for specific action buttons: print and delete */
  .row-print-btn.icon-btn, .print-btn.icon-btn { transition: transform .16s cubic-bezier(.2,.9,.25,1), box-shadow .16s ease, background .18s ease; }
  .row-print-btn.icon-btn:hover, .print-btn.icon-btn:hover { transform: translateY(-6px) scale(1.08); box-shadow: 0 18px 40px rgba(79,70,229,0.14); background: linear-gradient(90deg,#6366f1,#4f46e5); }
  .row-print-btn.icon-btn:hover .icon-svg path, .row-print-btn.icon-btn:hover .icon-svg rect, .print-btn.icon-btn:hover .icon-svg path, .print-btn.icon-btn:hover .icon-svg rect { stroke: #ffffff !important; fill: #ffffff !important; }

  .delete-btn.icon-btn { transition: transform .16s cubic-bezier(.2,.9,.25,1), box-shadow .16s ease, background .18s ease; }
  .delete-btn.icon-btn:hover { transform: translateY(-6px) scale(1.08); box-shadow: 0 18px 40px rgba(239,68,68,0.14); background: linear-gradient(90deg,#f97316,#ef4444); }
  .delete-btn.icon-btn:hover .icon-svg path, .delete-btn.icon-btn:hover .icon-svg rect { stroke: #fff5f5 !important; fill: #fff5f5 !important; }

  /* Muted/low-contrast backgrounds (subtle hint only) */
  .verify-btn.icon-btn { background-image: linear-gradient(90deg, rgba(34,197,94,0.06), rgba(6,182,212,0.04)); }
  .edit-btn.icon-btn { background-image: linear-gradient(90deg, rgba(245,158,11,0.05), rgba(245,158,11,0.02)); border: 1px solid rgba(0,0,0,0.04); }
  .delete-btn.icon-btn { background-image: linear-gradient(90deg, rgba(239,68,68,0.05), rgba(239,68,68,0.02)); border: 1px solid rgba(0,0,0,0.04); }

  /* Hover: subtle, desaturated contrast for clarity without bright colors */
  .verify-btn.icon-btn:hover .icon-svg path, .verify-btn.icon-btn:hover .icon-svg rect { stroke: #344054 !important; fill: #344054 !important; opacity: 0.95 !important; }
  .edit-btn.icon-btn:hover .icon-svg path, .edit-btn.icon-btn:hover .icon-svg rect { stroke: #4b4030 !important; fill: none !important; opacity: 0.95 !important; }
  .delete-btn.icon-btn:hover .icon-svg path, .delete-btn.icon-btn:hover .icon-svg rect { stroke: #4a2730 !important; fill: none !important; opacity: 0.95 !important; }

  /* Slightly thinner strokes for a refined look */
  .icon-svg path, .icon-svg rect { stroke-width: 1.2px; }

  /* Small elegant tooltip for icon buttons (uses data-tooltip attribute) */
  .icon-btn[data-tooltip] {
    position: relative; /* establish containing block for pseudo elements */
  }
  .icon-btn[data-tooltip]::after {
    content: attr(data-tooltip);
    position: absolute;
    left: 50%; transform: translateX(-50%) translateY(6px);
    bottom: 100%;
    background: #ffffff; /* white background as requested */
    color: #0f172a; font-size: 12px; padding: 6px 10px; border-radius: 8px;
    border: 1px solid rgba(15,23,42,0.06);
    white-space: nowrap; pointer-events: none; opacity: 0; z-index: 60;
    box-shadow: 0 6px 18px rgba(2,6,23,0.06);
    transition: opacity .18s ease, transform .18s cubic-bezier(.2,.9,.25,1), filter .18s ease;
    transform-origin: 50% 100%;
  /* removed blur to avoid dark-mode blurry popups; keep solid background */
  }
  /* remove caret: no ::before */
  .icon-btn[data-tooltip]:hover::after {
    opacity: 1; transform: translateX(-50%) translateY(0); filter: drop-shadow(0 6px 14px rgba(2,6,23,0.06));
  }
  /* Slight offset for keyboard focus as well */
  .icon-btn[data-tooltip]:focus::after { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* Force SVG stroke/fill colors so icons remain visible regardless of inline attributes */
  .edit-btn.icon-btn .icon-svg path,
  .edit-btn.icon-btn .icon-svg rect {
    stroke: #b45309 !important; /* darker orange */
    fill: #fff7ed !important;
  }
  .delete-btn.icon-btn .icon-svg path,
  .delete-btn.icon-btn .icon-svg rect {
    stroke: #dc2626 !important; /* stronger red */
    fill: #fff5f5 !important;
  }
  /* Ensure small strokes are visible */
  .icon-svg path, .icon-svg rect { stroke-width: 1.4px; }
  /* View icons selection animation */
  .view-icon { transition: transform .18s cubic-bezier(.2,.9,.25,1), box-shadow .18s ease, background .18s ease; position: relative; z-index: 1; }
  .view-icon[aria-pressed="true"] { transform: translateY(-3px) scale(1.03); box-shadow: 0 8px 20px rgba(16,185,129,0.12); }
  .view-icon .h-5 { transition: transform .18s ease, color .18s ease; }
  .view-icon[aria-pressed="true"] .h-5 { transform: scale(1.06); }
  /* Moving green selection indicator behind icons */
  .view-icons-wrap { position: relative; display: inline-flex; gap: 8px; padding: 4px; align-items: center; }
  .view-indicator { position: absolute; top: 4px; left: 0; height: 40px; width: 40px; border-radius: 10px; background: linear-gradient(90deg,#bbf7d0,#86efac); box-shadow: 0 8px 24px rgba(16,185,129,0.10); transition: transform 300ms cubic-bezier(.2,.9,.25,1), width 240ms ease, background 220ms ease; z-index: 0; }
  /* optional pulse class still available */
  .selected-pulse { filter: drop-shadow(0 6px 18px rgba(16,185,129,0.08)); }
  /* Styled file picker and upload button for verification modal */
  .file-picker { display:inline-flex; align-items:center; gap:8px; border:1px solid #d1d5db; padding:6px 10px; border-radius:6px; background:#fff; cursor:pointer; transition:box-shadow .18s ease, transform .08s ease; }
  .file-picker:hover { box-shadow:0 6px 18px rgba(2,6,23,0.06); transform:translateY(-1px); }
  .file-picker .file-input { display:none; }
  .file-label { font-size:13px; color:#374151; }
  .upload-btn { background:#10b981; color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; transition:transform .12s ease, box-shadow .12s ease; }
  .upload-btn:hover { transform:translateY(-2px); box-shadow:0 8px 24px rgba(16,185,129,0.12); }
  .upload-btn:active { transform:translateY(0); }
  /* Top cancel button in verify modal */
  .verify-top-actions { display:flex; justify-content:flex-end; gap:8px; align-items:center; }
  .verify-top-actions .btn-secondary { background:#f3f4f6; color:#374151; border-radius:6px; padding:6px 10px; }
  /* Step controls styling */
  .step-controls { display:flex; gap:8px; justify-content:flex-end; align-items:center; }
  .step-btn { padding:8px 12px; border-radius:6px; border:1px solid #d1d5db; background:#fff; color:#374151; cursor:pointer; font-weight:600; transition:transform .08s ease, box-shadow .12s ease, background .12s ease; }
  .step-btn:hover { transform:translateY(-2px); box-shadow:0 8px 20px rgba(2,6,23,0.06); }
  .step-btn.primary { background:#10b981; color:white; border-color:transparent; }
  .step-btn[disabled], .step-btn.disabled { opacity:.5; cursor:not-allowed; transform:none; box-shadow:none; }
  /* Verify progress small helpers */
  .verify-circle { width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; }
  .verify-connector { height:6px; border-radius:4px; background:#e6e8eb; }
  /* Balance display classes */
  .balance-regle { background:#ecfccb; color:#065f46; padding:6px 10px; border-radius:999px; font-weight:700; }
  .balance-solde { background:var(--balance-solde-bg, #fff7ed); color:var(--balance-solde-text, #92400e); padding:6px 10px; border-radius:999px; font-weight:700; }
  .balance-credite { background:#ecfeff; color:#065f46; padding:6px 10px; border-radius:999px; font-weight:700; }
  /* Add button larger and hover */
  #openAddBtn { padding: .65rem 1.1rem; font-size: 1rem; border-radius: 10px; box-shadow: 0 8px 22px rgba(16,185,129,0.08); transition: transform .12s ease, box-shadow .12s ease, background .12s ease; }
  #openAddBtn:hover { transform: translateY(-3px); background: linear-gradient(90deg,#059669,#10b981); box-shadow: 0 12px 34px rgba(16,185,129,0.14); }
  </style>

  <style>
    /* Tighter modal: remove blur, reduce empty space and shrink elements for compactness */
    .modal-backdrop { background: rgba(0,0,0,0.25); }
    /* Modal panel sizing and entrance - wider but denser to avoid internal scroll */
    #addModal > div.bg-white {
      max-width: 980px;
      width: calc(100% - 96px);
  max-height: 98vh;
  min-height: auto;
  overflow-y: visible;
      padding: 0.6rem !important;
      border-radius: 10px;
      box-shadow: 0 10px 28px rgba(2,6,23,0.08);
      transform-origin: center center;
      animation: appearUpLarge .28s cubic-bezier(.2,.9,.25,1) both;
    }
    /* center modal to avoid large empty area below */
    #addModal { align-items: center !important; padding-top: 0 !important; }

    /* header */
    #addModal h2 { font-size: 1.05rem; letter-spacing: -0.2px; margin-bottom: .25rem; }

    /* Inputs: slightly taller, a bit less wide for breathing room, and slightly larger text for readability */
    #addModal input[type="text"], #addModal input[type="email"], #addModal input[type="date"], #addModal select, #addModal input[type="file"] {
      height: 2.6rem; padding: .45rem .75rem !important; font-size: 1rem !important; border-radius: 8px;
      transition: box-shadow .12s ease, transform .10s ease, border-color .12s ease;
    }
    /* Reduce full-width inputs slightly so they don't touch the panel edges (visual from provided screenshot) */
    #addModal input[class*="w-full"],
    #addModal select[class*="w-full"],
    #addModal textarea[class*="w-full"] {
      max-width: calc(100% - 18px);
      box-sizing: border-box;
    }
    #addModal textarea { min-height: 6.5rem; padding: .5rem .75rem !important; font-size:1rem !important; border-radius:8px; }
    #addModal input:focus, #addModal textarea:focus, #addModal select:focus { outline: none; box-shadow: 0 6px 20px rgba(16,185,129,0.09); border-color: rgba(16,185,129,0.9); }

    /* Buttons */
    #addModal .btn-primary, #addModal button[type="submit"] { background:#16a34a; border:none; color:#fff; border-radius:8px; }
    #addModal .btn-secondary, #addModal button[type="button"] { background:#f3f4f6; color:#374151; border-radius:8px; }

  /* Photo placeholder: enlarge to match screenshot and keep circular crop */
  #addModal .photo-picker-large { width: 10.5rem !important; height: 10.5rem !important; border-radius: 12px; overflow: hidden; }
  #addModal .photo-picker-large img { width:100%; height:100%; object-fit:cover; }
  /* The form uses a label[for="photoInput"] as the visible avatar area — increase it here */
  #addModal label[for="photoInput"] { width: 14rem; height: 14rem; border-radius: 9999px; display:flex; align-items:center; justify-content:center; overflow:hidden; }
  #addModal label[for="photoInput"] .material-icons { font-size: 4.2rem; color: #4b5563; }
  #addModal label[for="photoInput"] p { margin: 0; }

    /* Responsive grid: stack on small, three equal columns on md+ so rows with md:grid-cols-3 get 3 columns */
    #addModal .grid.grid-cols-1.md\:grid-cols-3 { grid-template-columns: repeat(1, minmax(0,1fr)); }
    @media(min-width:768px){
      /* Use three equal columns for md:grid-cols-3 (Date / Lieu / NIN row) */
      #addModal .grid.grid-cols-1.md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    }

  /* Align form inner grid: two columns on md+, stacked on small. Use denser gaps */
  #addModal .form-grid { display: grid; grid-template-columns: repeat(1, minmax(0,1fr)); gap: .5rem; }
  @media(min-width:768px){ #addModal .form-grid { grid-template-columns: repeat(2, minmax(0,1fr)); gap:.6rem; } }

  /* Make the remarks / infos area larger and add breathing room above action buttons */
  /* Keep add/edit infos textarea consistent size */
  #addModal textarea[name="remarques"],
  #addModal textarea#infos_supplementaires,
  #editModal textarea#infos_supplementaires_edit,
  #editModal textarea[name="remarques"] { min-height: 8rem; }
  /* Add more space between the last infos field and the action buttons like the provided screenshot */
  #addModal .flex.justify-between.items-center { margin-top: 3.5rem; }

  /* Align the third form row (genre / date / lieu) with the bottom of the photo on medium+ screens */
  @media(min-width:768px){
    #addModal .align-with-photo { margin-top: 6.8rem; }
  }

    /* entrance keyframes */
    @keyframes appearUpLarge { from { opacity: 0; transform: translateY(6vh) scale(.99); } to { opacity:1; transform: translateY(0) scale(1); } }

    /* subtle fade-in for modal content blocks */
    .modal-section { animation: fadeInSmall .28s ease both; }
    @keyframes fadeInSmall { from { opacity: 0; transform: translateY(6px); } to { opacity:1; transform: translateY(0); } }
  </style>

  <main>
    <!-- Header exactly matching the screenshot: minimal, centered search, left icons, right add button, filter row below -->
    <header class="bg-white rounded-md px-6 py-4 mb-6 shadow-sm">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="view-icons-wrap">
            <div id="viewIndicator" class="view-indicator" aria-hidden="true"></div>
            <button id="viewGridIcon" onclick="toggleView('grid')" class="view-icon inline-flex h-10 w-10 items-center justify-center rounded-md bg-green-100 text-green-600" aria-label="grid" aria-pressed="false">
              <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="14" width="7" height="7" rx="1"></rect><rect x="3" y="14" width="7" height="7" rx="1"></rect></svg>
            </button>
            <button id="viewListIcon" onclick="toggleView('list')" class="view-icon inline-flex h-10 w-10 items-center justify-center rounded-md text-gray-600" aria-label="menu" aria-pressed="false">
              <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 6h16"></path><path d="M4 12h16"></path><path d="M4 18h16"></path></svg>
            </button>
          </div>
        </div>

        <div class="flex-1 px-8">
          <div class="relative max-w-2xl mx-auto">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>
            <input id="searchInput" type="search" placeholder="Search students..." class="w-full rounded-md border border-gray-200 py-3 pl-11 pr-4 text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" />
          </div>
        </div>

        <div>
          <button id="openAddBtn" class="inline-flex items-center gap-2 rounded-md bg-green-600 px-4 py-2 text-sm font-medium text-white hover:bg-green-700">+ Ajouter un Etudiant</button>
        </div>
      </div>

          <div class="mt-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <!-- Sort control used by JS -->
          <select id="sortFilter" class="rounded-md border border-gray-200 bg-white px-3 py-2 text-sm">
            <option value="">Trier</option>
            <option value="alpha">Alphabetical</option>
            <option value="recent">Plus récent</option>
            <option value="oldest">Plus ancien</option>
          </select>
          <select id="statusFilter" class="rounded-md border border-gray-200 bg-white px-3 py-2 text-sm">
            <option value="all">Status</option>
            <option value="inscrit">Inscrit</option>
            <option value="non_inscrit">Non inscrit</option>
            <option value="verifie">Verifié</option>
            <option value="non_verifie">Non verifié</option>
          </select>
          <!-- Formation filter (strict uses data-formation on rows/cards) -->
          <select id="formationFilter" class="rounded-md border border-gray-200 bg-white px-3 py-2 text-sm" style="min-width:220px;">
            <option value="">Toutes les formations</option>
            
            <option value="3">Informatique</option>
            
            <option value="4">Mathématiques Appliquées</option>
            
            <option value="5">Gestion &amp; Finance</option>
            
            <option value="6">Design Web</option>
            
            <option value="7">Marketing Digital</option>
            
            <option value="8">Resauxxw</option>
            
            <option value="9">CYBERSECURITY</option>
            
            <option value="10">dfdfdf</option>
            
            <option value="11">SOFTWARE TESTING</option>
            
            <option value="13">dxd</option>
            
          </select>
          <!-- Balance filter: show students with remaining >0, <0 or exactly 0 (Réglé) -->
          <select id="balanceFilter" class="rounded-md border border-gray-200 bg-white px-3 py-2 text-sm">
            <option value="">Tous les soldes</option>
            <option value="positive" >Solde positif (à payer)</option>
            <option value="negative" >Solde négatif (crédit)</option>
            <option value="regle" >Réglé (0)</option>
          </select>
          <!-- keep niveauFilter hidden for compatibility with existing code that might reference it -->
          <select id="niveauFilter" style="display:none;">
            <option value="">Tous les niveaux</option>
            
            <option value="Terminal" >Terminal</option>
            
            <option value="Universitaire" >Universitaire</option>
            
            <option value="Diplomé" >Diplomé</option>
            
          </select>
        </div>

        <div class="flex items-center gap-3">
          <button id="exportXlsxBtn" class="inline-flex items-center gap-2 rounded-md border border-gray-200 bg-white px-4 py-2 text-sm text-gray-700">
            <svg class="h-4 w-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v14"></path><path d="M5 12h14"></path></svg>
            Export Excel
          </button>
          <button id="exportPdfBtn" class="inline-flex items-center gap-2 rounded-md border border-gray-200 bg-white px-4 py-2 text-sm text-gray-700">
            <svg class="h-4 w-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line></svg>
            Export PDF
          </button>
          <!-- Hidden CSV / JSON buttons (JS references them) -->
          <button id="exportCsvBtn" style="display:none;"></button>
          <button id="exportJsonBtn" style="display:none;"></button>
        </div>
      </div>
    </header>

    <!-- Vue Tableau -->
    <div id="tableView" class="overflow-x-auto bg-white rounded-xl shadow">
      <table class="min-w-full text-sm text-left text-gray-700">
        <thead class="bg-gray-100 text-gray-600 uppercase text-xs font-semibold">
          <tr>
            <th class="px-6 py-3">ID</th>
            <th class="px-6 py-3">Photo</th>
            <th class="px-6 py-3">NOM / PRÉNOM</th>
            <th class="px-6 py-3">Tél</th>
            <th class="px-6 py-3">Adresse</th>
            <th class="px-6 py-3">Frais restant à payer</th>
            <th class="px-6 py-3">Statut</th>
            <th class="px-6 py-3">Vérification</th>
            <th class="px-6 py-3 text-right">Actions
              <!-- header print removed; printing is per-row -->
            </th>
          </tr>
        </thead>
        <tbody id="studentsTbody">
          
          <tr class="border-b student-row" data-id="91" data-name="LANA  DEL Rey" data-nom_arabe="" data-prenom_arabe="هفس" data-email="vadire6@gmail.com" data-phone="13847383443" data-address="Boukhiama" data-remaining="0.0" data-status="Actif" data-photo="/media/etudiants/Billie-Eilish.jpg" data-sexe="F" data-date_naissance="Sept. 10, 2025" data-lieu_naissance="Béjaïa" data-nationalite="Algérien" data-nin="000000001111111132" data-remarques="sqdssd" data-extrait="" data-carte="" data-verify="0" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="non_inscrit">
            <td class="px-6 py-4 font-mono text-sm">91</td>
            <td class="px-6 py-4"><img src="/media/etudiants/Billie-Eilish.jpg" class="w-10 h-10 rounded-full"/></td>
            <td class="px-6 py-4 font-semibold">LANA  DEL Rey
              <div class="text-xs text-gray-500">vadire6@gmail.com</div>
            </td>
            <td class="px-6 py-4">
              
                13847383443
              
            </td>
            <td class="px-6 py-4">Boukhiama</td>
            <td class="px-6 py-4"><span class="balance-regle">Réglé</span></td>
            <td class="px-6 py-4">
              
                  <a href="/inscriptions/?etudiant_id=91" class="status-inactif px-3 py-1 rounded-full text-xs font-semibold open-add-inscription" data-etudiant="91" data-etudiant-name="LANA  DEL Rey">Non inscrit</a>
              
            </td>
            <td class="px-6 py-4">
              
                <span class="status-inactif px-3 py-1 rounded-full text-xs font-semibold">Non vérifié</span>
              
            </td>
            <td class="px-6 py-4 text-right">
              <!-- Print button (per-row) -->
              <button class="row-print-btn icon-btn" title="Imprimer" aria-label="Imprimer" data-id="91" data-tooltip="Imprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9V3h12v6" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="9" width="18" height="10" rx="2" stroke="#4f46e5" stroke-width="1.2" fill="#f8fafc"/>
                  <path d="M8 13h8" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </button>
              <!-- Delete kept for admin actions -->
              <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
                  <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
                  <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                </svg>
              </button>
            </td>
          </tr>
          
          <tr class="border-b student-row" data-id="75" data-name="RODRIGO Rodrigo" data-nom_arabe="" data-prenom_arabe="" data-email="rayneera654@gmail.com" data-phone="13847383443" data-address="" data-remaining="0.0" data-status="Actif" data-photo="/media/etudiants/9ba9fd9f7dd022ba7afbd06a1ea614fa.jpg" data-sexe="F" data-date_naissance="Sept. 11, 2025" data-lieu_naissance="Béjaïa" data-nationalite="Algérien" data-nin="128238485868886655" data-remarques="" data-extrait="" data-carte="" data-verify="2" data-niveau="terminal" data-situation="fonctionnaire" data-dernier_diplome="" data-formation="" data-inscription="non_inscrit">
            <td class="px-6 py-4 font-mono text-sm">75</td>
            <td class="px-6 py-4"><img src="/media/etudiants/9ba9fd9f7dd022ba7afbd06a1ea614fa.jpg" class="w-10 h-10 rounded-full"/></td>
            <td class="px-6 py-4 font-semibold">RODRIGO Rodrigo
              <div class="text-xs text-gray-500">rayneera654@gmail.com</div>
            </td>
            <td class="px-6 py-4">
              
                13847383443
              
            </td>
            <td class="px-6 py-4">-</td>
            <td class="px-6 py-4"><span class="balance-regle">Réglé</span></td>
            <td class="px-6 py-4">
              
                  <a href="/inscriptions/?etudiant_id=75" class="status-inactif px-3 py-1 rounded-full text-xs font-semibold open-add-inscription" data-etudiant="75" data-etudiant-name="RODRIGO Rodrigo">Non inscrit</a>
              
            </td>
            <td class="px-6 py-4">
              
                <span class="status-inactif px-3 py-1 rounded-full text-xs font-semibold">Non vérifié</span>
              
            </td>
            <td class="px-6 py-4 text-right">
              <!-- Print button (per-row) -->
              <button class="row-print-btn icon-btn" title="Imprimer" aria-label="Imprimer" data-id="75" data-tooltip="Imprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9V3h12v6" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="9" width="18" height="10" rx="2" stroke="#4f46e5" stroke-width="1.2" fill="#f8fafc"/>
                  <path d="M8 13h8" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </button>
              <!-- Delete kept for admin actions -->
              <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
                  <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
                  <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                </svg>
              </button>
            </td>
          </tr>
          
          <tr class="border-b student-row" data-id="69" data-name="IRELIA Fd" data-nom_arabe="olivia" data-prenom_arabe="هفس" data-email="rayneera654@gmail.com" data-phone="0658943244" data-address="Boukhiama" data-remaining="30930.0" data-status="Actif" data-photo="/media/etudiants/OIP.webp" data-sexe="M" data-date_naissance="Sept. 16, 2003" data-lieu_naissance="Taourirt Ighil" data-nationalite="Allemand" data-nin="393902344424443446" data-remarques="" data-extrait="" data-carte="" data-verify="3" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="inscrit">
            <td class="px-6 py-4 font-mono text-sm">69</td>
            <td class="px-6 py-4"><img src="/media/etudiants/OIP.webp" class="w-10 h-10 rounded-full"/></td>
            <td class="px-6 py-4 font-semibold">IRELIA Fd
              <div class="text-xs text-gray-500">rayneera654@gmail.com</div>
            </td>
            <td class="px-6 py-4">
              
                0658943244
              
            </td>
            <td class="px-6 py-4">Boukhiama</td>
            <td class="px-6 py-4"><span class="balance-solde">30 930,00 DA</span></td>
            <td class="px-6 py-4">
              
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Inscrit</span>
              
            </td>
            <td class="px-6 py-4">
              
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Vérifié</span>
              
            </td>
            <td class="px-6 py-4 text-right">
              <!-- Print button (per-row) -->
              <button class="row-print-btn icon-btn" title="Imprimer" aria-label="Imprimer" data-id="69" data-tooltip="Imprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9V3h12v6" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="9" width="18" height="10" rx="2" stroke="#4f46e5" stroke-width="1.2" fill="#f8fafc"/>
                  <path d="M8 13h8" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </button>
              <!-- Delete kept for admin actions -->
              <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
                  <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
                  <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                </svg>
              </button>
            </td>
          </tr>
          
          <tr class="border-b student-row" data-id="63" data-name="HAMID Salima" data-nom_arabe="" data-prenom_arabe="" data-email="" data-phone="0555123456" data-address="" data-remaining="-23856.0" data-status="Actif" data-photo="/media/etudiants/OIP%20(1).webp" data-sexe="" data-date_naissance="Oct. 4, 2003" data-lieu_naissance="Amizour" data-nationalite="Albanais" data-nin="393902344424443444" data-remarques="" data-extrait="" data-carte="" data-verify="1" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="inscrit">
            <td class="px-6 py-4 font-mono text-sm">63</td>
            <td class="px-6 py-4"><img src="/media/etudiants/OIP%20(1).webp" class="w-10 h-10 rounded-full"/></td>
            <td class="px-6 py-4 font-semibold">HAMID Salima
              <div class="text-xs text-gray-500"></div>
            </td>
            <td class="px-6 py-4">
              
                0555123456
              
            </td>
            <td class="px-6 py-4">-</td>
            <td class="px-6 py-4"><span class="balance-credite">23 856,00 DA</span></td>
            <td class="px-6 py-4">
              
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Inscrit</span>
              
            </td>
            <td class="px-6 py-4">
              
                <span class="status-inactif px-3 py-1 rounded-full text-xs font-semibold">Non vérifié</span>
              
            </td>
            <td class="px-6 py-4 text-right">
              <!-- Print button (per-row) -->
              <button class="row-print-btn icon-btn" title="Imprimer" aria-label="Imprimer" data-id="63" data-tooltip="Imprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9V3h12v6" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="9" width="18" height="10" rx="2" stroke="#4f46e5" stroke-width="1.2" fill="#f8fafc"/>
                  <path d="M8 13h8" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </button>
              <!-- Delete kept for admin actions -->
              <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
                  <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
                  <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                </svg>
              </button>
            </td>
          </tr>
          
          <tr class="border-b student-row" data-id="39" data-name="BRIAREEZZ Hamida" data-nom_arabe="" data-prenom_arabe="" data-email="vadire6@gmail.com" data-phone="3555666777" data-address="Boukhiama" data-remaining="450.0" data-status="inscrit" data-photo="/media/etudiants/Anime-Profile-Picture-2_uYcslTr.jpg" data-sexe="M" data-date_naissance="Aug. 14, 2025" data-lieu_naissance="Amizour" data-nationalite="ALGERIENNE" data-nin="393902344424443214" data-remarques="" data-extrait="etudiants/39_extrait_Anime-Profile-Picture-2.jpg" data-carte="etudiants/39_carte_FR-Daugherty-Digital-Technology-Business-1200x627-1200x627.jpg" data-verify="3" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="inscrit">
            <td class="px-6 py-4 font-mono text-sm">39</td>
            <td class="px-6 py-4"><img src="/media/etudiants/Anime-Profile-Picture-2_uYcslTr.jpg" class="w-10 h-10 rounded-full"/></td>
            <td class="px-6 py-4 font-semibold">BRIAREEZZ Hamida
              <div class="text-xs text-gray-500">vadire6@gmail.com</div>
            </td>
            <td class="px-6 py-4">
              
                3555666777
              
            </td>
            <td class="px-6 py-4">Boukhiama</td>
            <td class="px-6 py-4"><span class="balance-solde">450,00 DA</span></td>
            <td class="px-6 py-4">
              
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Inscrit</span>
              
            </td>
            <td class="px-6 py-4">
              
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Vérifié</span>
              
            </td>
            <td class="px-6 py-4 text-right">
              <!-- Print button (per-row) -->
              <button class="row-print-btn icon-btn" title="Imprimer" aria-label="Imprimer" data-id="39" data-tooltip="Imprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9V3h12v6" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="9" width="18" height="10" rx="2" stroke="#4f46e5" stroke-width="1.2" fill="#f8fafc"/>
                  <path d="M8 13h8" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </button>
              <!-- Delete kept for admin actions -->
              <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
                  <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
                  <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                </svg>
              </button>
            </td>
          </tr>
          
          <tr class="border-b student-row" data-id="38" data-name="B HAMID" data-nom_arabe="" data-prenom_arabe="" data-email="vadire73@gmail.com" data-phone="0555123456" data-address="Boukhiama" data-remaining="30450.0" data-status="inscrit" data-photo="/media/etudiants/images%20(1)_0sWvkgD.jfif" data-sexe="" data-date_naissance="Aug. 9, 2025" data-lieu_naissance="BEJAIA" data-nationalite="ALGERIENNE" data-nin="" data-remarques="" data-extrait="" data-carte="" data-verify="1" data-niveau="" data-situation="fonctionnaire" data-dernier_diplome="" data-formation="" data-inscription="inscrit">
            <td class="px-6 py-4 font-mono text-sm">38</td>
            <td class="px-6 py-4"><img src="/media/etudiants/images%20(1)_0sWvkgD.jfif" class="w-10 h-10 rounded-full"/></td>
            <td class="px-6 py-4 font-semibold">B HAMID
              <div class="text-xs text-gray-500">vadire73@gmail.com</div>
            </td>
            <td class="px-6 py-4">
              
                0555123456
              
            </td>
            <td class="px-6 py-4">Boukhiama</td>
            <td class="px-6 py-4"><span class="balance-solde">30 450,00 DA</span></td>
            <td class="px-6 py-4">
              
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Inscrit</span>
              
            </td>
            <td class="px-6 py-4">
              
                <span class="status-inactif px-3 py-1 rounded-full text-xs font-semibold">Non vérifié</span>
              
            </td>
            <td class="px-6 py-4 text-right">
              <!-- Print button (per-row) -->
              <button class="row-print-btn icon-btn" title="Imprimer" aria-label="Imprimer" data-id="38" data-tooltip="Imprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9V3h12v6" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="9" width="18" height="10" rx="2" stroke="#4f46e5" stroke-width="1.2" fill="#f8fafc"/>
                  <path d="M8 13h8" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </button>
              <!-- Delete kept for admin actions -->
              <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
                  <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
                  <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                </svg>
              </button>
            </td>
          </tr>
          
          <tr class="border-b student-row" data-id="37" data-name="GAREN DARIUS" data-nom_arabe="" data-prenom_arabe="" data-email="vadire7@gmail.com" data-phone="0492344242" data-address="Boukhiama" data-remaining="300.0" data-status="inscrit" data-photo="/media/etudiants/images%20(1)_Gdha3sI.jfif" data-sexe="" data-date_naissance="Aug. 13, 2025" data-lieu_naissance="BEJAIA" data-nationalite="ALGERIENNE" data-nin="" data-remarques="FSDSDF" data-extrait="" data-carte="" data-verify="3" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="inscrit">
            <td class="px-6 py-4 font-mono text-sm">37</td>
            <td class="px-6 py-4"><img src="/media/etudiants/images%20(1)_Gdha3sI.jfif" class="w-10 h-10 rounded-full"/></td>
            <td class="px-6 py-4 font-semibold">GAREN DARIUS
              <div class="text-xs text-gray-500">vadire7@gmail.com</div>
            </td>
            <td class="px-6 py-4">
              
                0492344242
              
            </td>
            <td class="px-6 py-4">Boukhiama</td>
            <td class="px-6 py-4"><span class="balance-solde">300,00 DA</span></td>
            <td class="px-6 py-4">
              
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Inscrit</span>
              
            </td>
            <td class="px-6 py-4">
              
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Vérifié</span>
              
            </td>
            <td class="px-6 py-4 text-right">
              <!-- Print button (per-row) -->
              <button class="row-print-btn icon-btn" title="Imprimer" aria-label="Imprimer" data-id="37" data-tooltip="Imprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9V3h12v6" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="9" width="18" height="10" rx="2" stroke="#4f46e5" stroke-width="1.2" fill="#f8fafc"/>
                  <path d="M8 13h8" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </button>
              <!-- Delete kept for admin actions -->
              <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
                  <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
                  <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                </svg>
              </button>
            </td>
          </tr>
          
          <tr class="border-b student-row" data-id="33" data-name="bouchama HAMID" data-nom_arabe="" data-prenom_arabe="" data-email="None" data-phone="None" data-address="Boukhiama" data-remaining="480.0" data-status="inscrit" data-photo="/media/etudiants/cover-Cybersecurity-Budget-1.png" data-sexe="" data-date_naissance="Aug. 5, 2025" data-lieu_naissance="BEJAIA" data-nationalite="" data-nin="" data-remarques="ERRERE" data-extrait="" data-carte="" data-verify="3" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="inscrit">
            <td class="px-6 py-4 font-mono text-sm">33</td>
            <td class="px-6 py-4"><img src="/media/etudiants/cover-Cybersecurity-Budget-1.png" class="w-10 h-10 rounded-full"/></td>
            <td class="px-6 py-4 font-semibold">bouchama HAMID
              <div class="text-xs text-gray-500"></div>
            </td>
            <td class="px-6 py-4">
              
                -
              
            </td>
            <td class="px-6 py-4">Boukhiama</td>
            <td class="px-6 py-4"><span class="balance-solde">480,00 DA</span></td>
            <td class="px-6 py-4">
              
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Inscrit</span>
              
            </td>
            <td class="px-6 py-4">
              
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Vérifié</span>
              
            </td>
            <td class="px-6 py-4 text-right">
              <!-- Print button (per-row) -->
              <button class="row-print-btn icon-btn" title="Imprimer" aria-label="Imprimer" data-id="33" data-tooltip="Imprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9V3h12v6" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="9" width="18" height="10" rx="2" stroke="#4f46e5" stroke-width="1.2" fill="#f8fafc"/>
                  <path d="M8 13h8" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </button>
              <!-- Delete kept for admin actions -->
              <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
                  <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
                  <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                </svg>
              </button>
            </td>
          </tr>
          
          <tr class="border-b student-row" data-id="32" data-name="RIAD MH" data-nom_arabe="" data-prenom_arabe="" data-email="None" data-phone="None" data-address="PARIS" data-remaining="0.0" data-status="Actif" data-photo="/media/etudiants/Anime-Profile-Picture-2.jpg" data-sexe="M" data-date_naissance="Aug. 7, 2025" data-lieu_naissance="BEJAIA" data-nationalite="ALGERIENNE" data-nin="39390234" data-remarques="" data-extrait="" data-carte="" data-verify="0" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="non_inscrit">
            <td class="px-6 py-4 font-mono text-sm">32</td>
            <td class="px-6 py-4"><img src="/media/etudiants/Anime-Profile-Picture-2.jpg" class="w-10 h-10 rounded-full"/></td>
            <td class="px-6 py-4 font-semibold">RIAD MH
              <div class="text-xs text-gray-500"></div>
            </td>
            <td class="px-6 py-4">
              
                -
              
            </td>
            <td class="px-6 py-4">PARIS</td>
            <td class="px-6 py-4"><span class="balance-regle">Réglé</span></td>
            <td class="px-6 py-4">
              
                  <a href="/inscriptions/?etudiant_id=32" class="status-inactif px-3 py-1 rounded-full text-xs font-semibold open-add-inscription" data-etudiant="32" data-etudiant-name="RIAD MH">Non inscrit</a>
              
            </td>
            <td class="px-6 py-4">
              
                <span class="status-inactif px-3 py-1 rounded-full text-xs font-semibold">Non vérifié</span>
              
            </td>
            <td class="px-6 py-4 text-right">
              <!-- Print button (per-row) -->
              <button class="row-print-btn icon-btn" title="Imprimer" aria-label="Imprimer" data-id="32" data-tooltip="Imprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9V3h12v6" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="9" width="18" height="10" rx="2" stroke="#4f46e5" stroke-width="1.2" fill="#f8fafc"/>
                  <path d="M8 13h8" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </button>
              <!-- Delete kept for admin actions -->
              <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
                  <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
                  <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                </svg>
              </button>
            </td>
          </tr>
          
          <tr class="border-b student-row" data-id="31" data-name="IRELIA NOXUS" data-nom_arabe="" data-prenom_arabe="" data-email="None" data-phone="None" data-address="ZAUN" data-remaining="1950.0" data-status="inscrit" data-photo="/media/etudiants/5_H3_Ai_enhanced_2772e3ad7f.webp" data-sexe="F" data-date_naissance="Dec. 1, 2000" data-lieu_naissance="BEJAIA" data-nationalite="ALGERIENNE" data-nin="163723844" data-remarques="" data-extrait="" data-carte="" data-verify="3" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="inscrit">
            <td class="px-6 py-4 font-mono text-sm">31</td>
            <td class="px-6 py-4"><img src="/media/etudiants/5_H3_Ai_enhanced_2772e3ad7f.webp" class="w-10 h-10 rounded-full"/></td>
            <td class="px-6 py-4 font-semibold">IRELIA NOXUS
              <div class="text-xs text-gray-500"></div>
            </td>
            <td class="px-6 py-4">
              
                -
              
            </td>
            <td class="px-6 py-4">ZAUN</td>
            <td class="px-6 py-4"><span class="balance-solde">1 950,00 DA</span></td>
            <td class="px-6 py-4">
              
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Inscrit</span>
              
            </td>
            <td class="px-6 py-4">
              
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Vérifié</span>
              
            </td>
            <td class="px-6 py-4 text-right">
              <!-- Print button (per-row) -->
              <button class="row-print-btn icon-btn" title="Imprimer" aria-label="Imprimer" data-id="31" data-tooltip="Imprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9V3h12v6" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="9" width="18" height="10" rx="2" stroke="#4f46e5" stroke-width="1.2" fill="#f8fafc"/>
                  <path d="M8 13h8" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </button>
              <!-- Delete kept for admin actions -->
              <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
                  <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
                  <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                </svg>
              </button>
            </td>
          </tr>
          
          <tr class="border-b student-row" data-id="28" data-name="KATARINA NOXUS" data-nom_arabe="" data-prenom_arabe="" data-email="KATA@GMAIL.com" data-phone="0643722444" data-address="NOXUS,IONIA" data-remaining="0.0" data-status="Actif" data-photo="/media/etudiants/5fa500e772f3b355ebf94f09d32a6d62.jpg" data-sexe="homme" data-date_naissance="Oct. 4, 2003" data-lieu_naissance="BEJAIA" data-nationalite="ALGERIENNE" data-nin="167322424334" data-remarques="rien" data-extrait="" data-carte="" data-verify="2" data-niveau="TERMINAL" data-situation="ETUDIANT" data-dernier_diplome="LICENSE" data-formation="" data-inscription="non_inscrit">
            <td class="px-6 py-4 font-mono text-sm">28</td>
            <td class="px-6 py-4"><img src="/media/etudiants/5fa500e772f3b355ebf94f09d32a6d62.jpg" class="w-10 h-10 rounded-full"/></td>
            <td class="px-6 py-4 font-semibold">KATARINA NOXUS
              <div class="text-xs text-gray-500">KATA@GMAIL.com</div>
            </td>
            <td class="px-6 py-4">
              
                0643722444
              
            </td>
            <td class="px-6 py-4">NOXUS,IONIA</td>
            <td class="px-6 py-4"><span class="balance-regle">Réglé</span></td>
            <td class="px-6 py-4">
              
                  <a href="/inscriptions/?etudiant_id=28" class="status-inactif px-3 py-1 rounded-full text-xs font-semibold open-add-inscription" data-etudiant="28" data-etudiant-name="KATARINA NOXUS">Non inscrit</a>
              
            </td>
            <td class="px-6 py-4">
              
                <span class="status-inactif px-3 py-1 rounded-full text-xs font-semibold">Non vérifié</span>
              
            </td>
            <td class="px-6 py-4 text-right">
              <!-- Print button (per-row) -->
              <button class="row-print-btn icon-btn" title="Imprimer" aria-label="Imprimer" data-id="28" data-tooltip="Imprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9V3h12v6" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="9" width="18" height="10" rx="2" stroke="#4f46e5" stroke-width="1.2" fill="#f8fafc"/>
                  <path d="M8 13h8" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </button>
              <!-- Delete kept for admin actions -->
              <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
                  <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
                  <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                </svg>
              </button>
            </td>
          </tr>
          
          <tr class="border-b student-row" data-id="27" data-name="RRRRRRRRRRR Rrrrrrrr" data-nom_arabe="" data-prenom_arabe="" data-email="vadire37@gmail.com" data-phone="05551234564" data-address="" data-remaining="450.0" data-status="inscrit" data-photo="/media/etudiants/surprised-jazz-hands-happy-asian-girl-smiling-looking-amazed-camera-announcing-smth-standing-white-background_1258-89582_BQ7fv36.jpg" data-sexe="F" data-date_naissance="July 4, 1983" data-lieu_naissance="Amizour" data-nationalite="Allemand" data-nin="215557412575555553" data-remarques="" data-extrait="" data-carte="" data-verify="3" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="5" data-inscription="inscrit">
            <td class="px-6 py-4 font-mono text-sm">27</td>
            <td class="px-6 py-4"><img src="/media/etudiants/surprised-jazz-hands-happy-asian-girl-smiling-looking-amazed-camera-announcing-smth-standing-white-background_1258-89582_BQ7fv36.jpg" class="w-10 h-10 rounded-full"/></td>
            <td class="px-6 py-4 font-semibold">RRRRRRRRRRR Rrrrrrrr
              <div class="text-xs text-gray-500">vadire37@gmail.com</div>
            </td>
            <td class="px-6 py-4">
              
                05551234564
              
            </td>
            <td class="px-6 py-4">-</td>
            <td class="px-6 py-4"><span class="balance-solde">450,00 DA</span></td>
            <td class="px-6 py-4">
              
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Inscrit</span>
              
            </td>
            <td class="px-6 py-4">
              
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Vérifié</span>
              
            </td>
            <td class="px-6 py-4 text-right">
              <!-- Print button (per-row) -->
              <button class="row-print-btn icon-btn" title="Imprimer" aria-label="Imprimer" data-id="27" data-tooltip="Imprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9V3h12v6" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="9" width="18" height="10" rx="2" stroke="#4f46e5" stroke-width="1.2" fill="#f8fafc"/>
                  <path d="M8 13h8" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </button>
              <!-- Delete kept for admin actions -->
              <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
                  <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
                  <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                </svg>
              </button>
            </td>
          </tr>
          
          <tr class="border-b student-row" data-id="26" data-name="ggggggggg azzzzzzzzzzzzz" data-nom_arabe="" data-prenom_arabe="" data-email="dqjf@gmail.com" data-phone="068666666666" data-address="" data-remaining="450.0" data-status="inscrit" data-photo="/media/etudiants/eaa52db1594c46408ffa6f47b99d4076_l5tDjzX.webp" data-sexe="" data-date_naissance="" data-lieu_naissance="" data-nationalite="" data-nin="" data-remarques="" data-extrait="" data-carte="" data-verify="3" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="4" data-inscription="inscrit">
            <td class="px-6 py-4 font-mono text-sm">26</td>
            <td class="px-6 py-4"><img src="/media/etudiants/eaa52db1594c46408ffa6f47b99d4076_l5tDjzX.webp" class="w-10 h-10 rounded-full"/></td>
            <td class="px-6 py-4 font-semibold">ggggggggg azzzzzzzzzzzzz
              <div class="text-xs text-gray-500">dqjf@gmail.com</div>
            </td>
            <td class="px-6 py-4">
              
                068666666666
              
            </td>
            <td class="px-6 py-4">-</td>
            <td class="px-6 py-4"><span class="balance-solde">450,00 DA</span></td>
            <td class="px-6 py-4">
              
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Inscrit</span>
              
            </td>
            <td class="px-6 py-4">
              
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Vérifié</span>
              
            </td>
            <td class="px-6 py-4 text-right">
              <!-- Print button (per-row) -->
              <button class="row-print-btn icon-btn" title="Imprimer" aria-label="Imprimer" data-id="26" data-tooltip="Imprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9V3h12v6" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="9" width="18" height="10" rx="2" stroke="#4f46e5" stroke-width="1.2" fill="#f8fafc"/>
                  <path d="M8 13h8" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </button>
              <!-- Delete kept for admin actions -->
              <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
                  <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
                  <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                </svg>
              </button>
            </td>
          </tr>
          
          <tr class="border-b student-row" data-id="25" data-name="BERBOUCHA LYNA" data-nom_arabe="" data-prenom_arabe="" data-email="lyna@gmail.com" data-phone="0213214" data-address="" data-remaining="26633.0" data-status="inscrit" data-photo="/media/etudiants/images_Gmmc5sO.jfif" data-sexe="" data-date_naissance="" data-lieu_naissance="" data-nationalite="" data-nin="" data-remarques="" data-extrait="" data-carte="" data-verify="3" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="6" data-inscription="inscrit">
            <td class="px-6 py-4 font-mono text-sm">25</td>
            <td class="px-6 py-4"><img src="/media/etudiants/images_Gmmc5sO.jfif" class="w-10 h-10 rounded-full"/></td>
            <td class="px-6 py-4 font-semibold">BERBOUCHA LYNA
              <div class="text-xs text-gray-500">lyna@gmail.com</div>
            </td>
            <td class="px-6 py-4">
              
                0213214
              
            </td>
            <td class="px-6 py-4">-</td>
            <td class="px-6 py-4"><span class="balance-solde">26 633,00 DA</span></td>
            <td class="px-6 py-4">
              
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Inscrit</span>
              
            </td>
            <td class="px-6 py-4">
              
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Vérifié</span>
              
            </td>
            <td class="px-6 py-4 text-right">
              <!-- Print button (per-row) -->
              <button class="row-print-btn icon-btn" title="Imprimer" aria-label="Imprimer" data-id="25" data-tooltip="Imprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9V3h12v6" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="9" width="18" height="10" rx="2" stroke="#4f46e5" stroke-width="1.2" fill="#f8fafc"/>
                  <path d="M8 13h8" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </button>
              <!-- Delete kept for admin actions -->
              <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
                  <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
                  <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                </svg>
              </button>
            </td>
          </tr>
          
          <tr class="border-b student-row" data-id="24" data-name="ZZZZZZZZZZ Zzzzzzzzzzz" data-nom_arabe="" data-prenom_arabe="" data-email="garymartin1968@cholemail.com" data-phone="0883822232" data-address="" data-remaining="0.0" data-status="Actif" data-photo="/media/etudiants/eaa52db1594c46408ffa6f47b99d4076_rjzk2l7.webp" data-sexe="" data-date_naissance="" data-lieu_naissance="Chellata" data-nationalite="Allemand" data-nin="393902344424443455" data-remarques="" data-extrait="" data-carte="" data-verify="0" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="5" data-inscription="non_inscrit">
            <td class="px-6 py-4 font-mono text-sm">24</td>
            <td class="px-6 py-4"><img src="/media/etudiants/eaa52db1594c46408ffa6f47b99d4076_rjzk2l7.webp" class="w-10 h-10 rounded-full"/></td>
            <td class="px-6 py-4 font-semibold">ZZZZZZZZZZ Zzzzzzzzzzz
              <div class="text-xs text-gray-500">garymartin1968@cholemail.com</div>
            </td>
            <td class="px-6 py-4">
              
                0883822232
              
            </td>
            <td class="px-6 py-4">-</td>
            <td class="px-6 py-4"><span class="balance-regle">Réglé</span></td>
            <td class="px-6 py-4">
              
                  <a href="/inscriptions/?etudiant_id=24" class="status-inactif px-3 py-1 rounded-full text-xs font-semibold open-add-inscription" data-etudiant="24" data-etudiant-name="ZZZZZZZZZZ Zzzzzzzzzzz">Non inscrit</a>
              
            </td>
            <td class="px-6 py-4">
              
                <span class="status-inactif px-3 py-1 rounded-full text-xs font-semibold">Non vérifié</span>
              
            </td>
            <td class="px-6 py-4 text-right">
              <!-- Print button (per-row) -->
              <button class="row-print-btn icon-btn" title="Imprimer" aria-label="Imprimer" data-id="24" data-tooltip="Imprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9V3h12v6" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="9" width="18" height="10" rx="2" stroke="#4f46e5" stroke-width="1.2" fill="#f8fafc"/>
                  <path d="M8 13h8" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </button>
              <!-- Delete kept for admin actions -->
              <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
                  <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
                  <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                </svg>
              </button>
            </td>
          </tr>
          
          <tr class="border-b student-row" data-id="22" data-name="Belkacem Rachid" data-nom_arabe="" data-prenom_arabe="" data-email="rachid.belkacem@example.com" data-phone="+213555444555" data-address="Rue I, Béjaïa" data-remaining="450.0" data-status="inscrit" data-photo="/media/etudiants/pedro-pascal-as-joel-miller-in-the-last-of-us-episode-9.webp" data-sexe="" data-date_naissance="" data-lieu_naissance="" data-nationalite="" data-nin="" data-remarques="" data-extrait="" data-carte="" data-verify="3" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="inscrit">
            <td class="px-6 py-4 font-mono text-sm">22</td>
            <td class="px-6 py-4"><img src="/media/etudiants/pedro-pascal-as-joel-miller-in-the-last-of-us-episode-9.webp" class="w-10 h-10 rounded-full"/></td>
            <td class="px-6 py-4 font-semibold">Belkacem Rachid
              <div class="text-xs text-gray-500">rachid.belkacem@example.com</div>
            </td>
            <td class="px-6 py-4">
              
                +213555444555
              
            </td>
            <td class="px-6 py-4">Rue I, Béjaïa</td>
            <td class="px-6 py-4"><span class="balance-solde">450,00 DA</span></td>
            <td class="px-6 py-4">
              
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Inscrit</span>
              
            </td>
            <td class="px-6 py-4">
              
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Vérifié</span>
              
            </td>
            <td class="px-6 py-4 text-right">
              <!-- Print button (per-row) -->
              <button class="row-print-btn icon-btn" title="Imprimer" aria-label="Imprimer" data-id="22" data-tooltip="Imprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9V3h12v6" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="9" width="18" height="10" rx="2" stroke="#4f46e5" stroke-width="1.2" fill="#f8fafc"/>
                  <path d="M8 13h8" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </button>
              <!-- Delete kept for admin actions -->
              <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
                  <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
                  <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                </svg>
              </button>
            </td>
          </tr>
          
          <tr class="border-b student-row" data-id="20" data-name="Amrani Sofiane" data-nom_arabe="" data-prenom_arabe="" data-email="sofiane.amrani@example.com" data-phone="+213555999000" data-address="Rue G, Sétif" data-remaining="0.0" data-status="non inscrit" data-photo="/media/etudiants/eaa52db1594c46408ffa6f47b99d4076.webp" data-sexe="" data-date_naissance="" data-lieu_naissance="" data-nationalite="" data-nin="" data-remarques="" data-extrait="" data-carte="" data-verify="0" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="non_inscrit">
            <td class="px-6 py-4 font-mono text-sm">20</td>
            <td class="px-6 py-4"><img src="/media/etudiants/eaa52db1594c46408ffa6f47b99d4076.webp" class="w-10 h-10 rounded-full"/></td>
            <td class="px-6 py-4 font-semibold">Amrani Sofiane
              <div class="text-xs text-gray-500">sofiane.amrani@example.com</div>
            </td>
            <td class="px-6 py-4">
              
                +213555999000
              
            </td>
            <td class="px-6 py-4">Rue G, Sétif</td>
            <td class="px-6 py-4"><span class="balance-regle">Réglé</span></td>
            <td class="px-6 py-4">
              
                  <a href="/inscriptions/?etudiant_id=20" class="status-inactif px-3 py-1 rounded-full text-xs font-semibold open-add-inscription" data-etudiant="20" data-etudiant-name="Amrani Sofiane">Non inscrit</a>
              
            </td>
            <td class="px-6 py-4">
              
                <span class="status-inactif px-3 py-1 rounded-full text-xs font-semibold">Non vérifié</span>
              
            </td>
            <td class="px-6 py-4 text-right">
              <!-- Print button (per-row) -->
              <button class="row-print-btn icon-btn" title="Imprimer" aria-label="Imprimer" data-id="20" data-tooltip="Imprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9V3h12v6" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="9" width="18" height="10" rx="2" stroke="#4f46e5" stroke-width="1.2" fill="#f8fafc"/>
                  <path d="M8 13h8" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </button>
              <!-- Delete kept for admin actions -->
              <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
                  <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
                  <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                </svg>
              </button>
            </td>
          </tr>
          
          <tr class="border-b student-row" data-id="18" data-name="Djebali Omar" data-nom_arabe="" data-prenom_arabe="" data-email="omar.djebali@example.com" data-phone="+213555555666" data-address="Rue E, Blida" data-remaining="-22833.0" data-status="inscrit" data-photo="/media/etudiants/images.jfif" data-sexe="" data-date_naissance="" data-lieu_naissance="" data-nationalite="" data-nin="" data-remarques="" data-extrait="" data-carte="" data-verify="0" data-niveau="Terminal" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="inscrit">
            <td class="px-6 py-4 font-mono text-sm">18</td>
            <td class="px-6 py-4"><img src="/media/etudiants/images.jfif" class="w-10 h-10 rounded-full"/></td>
            <td class="px-6 py-4 font-semibold">Djebali Omar
              <div class="text-xs text-gray-500">omar.djebali@example.com</div>
            </td>
            <td class="px-6 py-4">
              
                +213555555666
              
            </td>
            <td class="px-6 py-4">Rue E, Blida</td>
            <td class="px-6 py-4"><span class="balance-credite">22 833,00 DA</span></td>
            <td class="px-6 py-4">
              
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Inscrit</span>
              
            </td>
            <td class="px-6 py-4">
              
                <span class="status-inactif px-3 py-1 rounded-full text-xs font-semibold">Non vérifié</span>
              
            </td>
            <td class="px-6 py-4 text-right">
              <!-- Print button (per-row) -->
              <button class="row-print-btn icon-btn" title="Imprimer" aria-label="Imprimer" data-id="18" data-tooltip="Imprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9V3h12v6" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="9" width="18" height="10" rx="2" stroke="#4f46e5" stroke-width="1.2" fill="#f8fafc"/>
                  <path d="M8 13h8" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </button>
              <!-- Delete kept for admin actions -->
              <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
                  <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
                  <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                </svg>
              </button>
            </td>
          </tr>
          
          <tr class="border-b student-row" data-id="17" data-name="Cherif Leila" data-nom_arabe="" data-prenom_arabe="" data-email="leila.cherif@example.com" data-phone="+213555333444" data-address="Rue D, Annaba" data-remaining="0.0" data-status="non inscrit" data-photo="/media/etudiants/surprised-jazz-hands-happy-asian-girl-smiling-looking-amazed-camera-announcing-smth-standing-white-background_1258-89582_IR1yMyX.jpg" data-sexe="" data-date_naissance="" data-lieu_naissance="" data-nationalite="" data-nin="" data-remarques="" data-extrait="" data-carte="" data-verify="0" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="non_inscrit">
            <td class="px-6 py-4 font-mono text-sm">17</td>
            <td class="px-6 py-4"><img src="/media/etudiants/surprised-jazz-hands-happy-asian-girl-smiling-looking-amazed-camera-announcing-smth-standing-white-background_1258-89582_IR1yMyX.jpg" class="w-10 h-10 rounded-full"/></td>
            <td class="px-6 py-4 font-semibold">Cherif Leila
              <div class="text-xs text-gray-500">leila.cherif@example.com</div>
            </td>
            <td class="px-6 py-4">
              
                +213555333444
              
            </td>
            <td class="px-6 py-4">Rue D, Annaba</td>
            <td class="px-6 py-4"><span class="balance-regle">Réglé</span></td>
            <td class="px-6 py-4">
              
                  <a href="/inscriptions/?etudiant_id=17" class="status-inactif px-3 py-1 rounded-full text-xs font-semibold open-add-inscription" data-etudiant="17" data-etudiant-name="Cherif Leila">Non inscrit</a>
              
            </td>
            <td class="px-6 py-4">
              
                <span class="status-inactif px-3 py-1 rounded-full text-xs font-semibold">Non vérifié</span>
              
            </td>
            <td class="px-6 py-4 text-right">
              <!-- Print button (per-row) -->
              <button class="row-print-btn icon-btn" title="Imprimer" aria-label="Imprimer" data-id="17" data-tooltip="Imprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9V3h12v6" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="9" width="18" height="10" rx="2" stroke="#4f46e5" stroke-width="1.2" fill="#f8fafc"/>
                  <path d="M8 13h8" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </button>
              <!-- Delete kept for admin actions -->
              <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
                  <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
                  <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                </svg>
              </button>
            </td>
          </tr>
          
          <tr class="border-b student-row" data-id="3" data-name="bouchama HAMID" data-nom_arabe="" data-prenom_arabe="" data-email="rayneera654@gmail.com" data-phone="0555123456" data-address="" data-remaining="1550.0" data-status="inscrit" data-photo="/media/etudiants/images_GZTcPxT.jfif" data-sexe="" data-date_naissance="" data-lieu_naissance="" data-nationalite="" data-nin="" data-remarques="" data-extrait="" data-carte="" data-verify="0" data-niveau="universitaire" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="inscrit">
            <td class="px-6 py-4 font-mono text-sm">3</td>
            <td class="px-6 py-4"><img src="/media/etudiants/images_GZTcPxT.jfif" class="w-10 h-10 rounded-full"/></td>
            <td class="px-6 py-4 font-semibold">bouchama HAMID
              <div class="text-xs text-gray-500">rayneera654@gmail.com</div>
            </td>
            <td class="px-6 py-4">
              
                0555123456
              
            </td>
            <td class="px-6 py-4">-</td>
            <td class="px-6 py-4"><span class="balance-solde">1 550,00 DA</span></td>
            <td class="px-6 py-4">
              
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Inscrit</span>
              
            </td>
            <td class="px-6 py-4">
              
                <span class="status-inactif px-3 py-1 rounded-full text-xs font-semibold">Non vérifié</span>
              
            </td>
            <td class="px-6 py-4 text-right">
              <!-- Print button (per-row) -->
              <button class="row-print-btn icon-btn" title="Imprimer" aria-label="Imprimer" data-id="3" data-tooltip="Imprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M6 9V3h12v6" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
                  <rect x="3" y="9" width="18" height="10" rx="2" stroke="#4f46e5" stroke-width="1.2" fill="#f8fafc"/>
                  <path d="M8 13h8" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round"/>
                </svg>
              </button>
              <!-- Delete kept for admin actions -->
              <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
                  <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
                  <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                </svg>
              </button>
            </td>
          </tr>
          
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    
    <nav class="mt-4 flex items-center justify-between">
      <div>
        <span class="text-sm text-gray-600">Affichage 1–20 sur 22</span>
      </div>
      <div class="space-x-2">
        
          <span class="px-3 py-1 bg-gray-100 border rounded text-gray-400">Précédent</span>
        

        
          
            <span class="px-3 py-1 bg-green-100 border rounded font-semibold">1</span>
            
        
          
            <a href="?page=2&per_page=20" class="px-3 py-1 bg-white border rounded">2</a>
          
        

        
          <a href="?page=2&per_page=20" class="px-3 py-1 bg-white border rounded">Suivants</a>
        
      </div>
    </nav>
    
    <script>
      (function(){
        var balanceSel = document.getElementById('balanceFilter');
        if(balanceSel){
          balanceSel.addEventListener('change', function(){
            var params = new URLSearchParams(window.location.search);
            var val = this.value || '';
            if(val) params.set('balance', val); else params.delete('balance');
            // preserve per_page if present
            if(!params.get('per_page')) params.set('per_page', '20');
            // navigate
            window.location.search = params.toString();
          });
        }
      })();
    </script>

    <!-- Vue Cartes -->
    <div id="cardView" class="hidden">
      <main class="flex-1 p-4 md:p-8">
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5">
          
          <div class="group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row" role="button" tabindex="0" data-id="91" data-name="LANA  DEL Rey" data-nom_arabe="" data-prenom_arabe="هفس" data-email="vadire6@gmail.com" data-phone="13847383443" data-address="Boukhiama" data-remaining="0.0" data-status="Actif" data-photo="/media/etudiants/Billie-Eilish.jpg" data-sexe="F" data-date_naissance="Sept. 10, 2025" data-lieu_naissance="Béjaïa" data-nationalite="Algérien" data-nin="000000001111111132" data-remarques="sqdssd" data-extrait="" data-carte="" data-verify="0" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="non_inscrit">
            <div class="flex h-40 items-center justify-center pt-4">
              <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="/media/etudiants/Billie-Eilish.jpg"/>
            </div>
            <div class="p-4 text-center">
              <h3 class="text-base font-semibold text-gray-800">LANA  DEL Rey</h3>
              <p class="text-sm text-gray-500">
                13847383443
              </p>
              
                <span class="mt-2 inline-block status-inactif px-3 py-1 text-xs font-semibold">Non inscrit</span>
              
            </div>
          </div>
          
          <div class="group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row" role="button" tabindex="0" data-id="75" data-name="RODRIGO Rodrigo" data-nom_arabe="" data-prenom_arabe="" data-email="rayneera654@gmail.com" data-phone="13847383443" data-address="" data-remaining="0.0" data-status="Actif" data-photo="/media/etudiants/9ba9fd9f7dd022ba7afbd06a1ea614fa.jpg" data-sexe="F" data-date_naissance="Sept. 11, 2025" data-lieu_naissance="Béjaïa" data-nationalite="Algérien" data-nin="128238485868886655" data-remarques="" data-extrait="" data-carte="" data-verify="2" data-niveau="terminal" data-situation="fonctionnaire" data-dernier_diplome="" data-formation="" data-inscription="non_inscrit">
            <div class="flex h-40 items-center justify-center pt-4">
              <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="/media/etudiants/9ba9fd9f7dd022ba7afbd06a1ea614fa.jpg"/>
            </div>
            <div class="p-4 text-center">
              <h3 class="text-base font-semibold text-gray-800">RODRIGO Rodrigo</h3>
              <p class="text-sm text-gray-500">
                13847383443
              </p>
              
                <span class="mt-2 inline-block status-inactif px-3 py-1 text-xs font-semibold">Non inscrit</span>
              
            </div>
          </div>
          
          <div class="group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row" role="button" tabindex="0" data-id="69" data-name="IRELIA Fd" data-nom_arabe="olivia" data-prenom_arabe="هفس" data-email="rayneera654@gmail.com" data-phone="0658943244" data-address="Boukhiama" data-remaining="30930.0" data-status="Actif" data-photo="/media/etudiants/OIP.webp" data-sexe="M" data-date_naissance="Sept. 16, 2003" data-lieu_naissance="Taourirt Ighil" data-nationalite="Allemand" data-nin="393902344424443446" data-remarques="" data-extrait="" data-carte="" data-verify="3" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="inscrit">
            <div class="flex h-40 items-center justify-center pt-4">
              <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="/media/etudiants/OIP.webp"/>
            </div>
            <div class="p-4 text-center">
              <h3 class="text-base font-semibold text-gray-800">IRELIA Fd</h3>
              <p class="text-sm text-gray-500">
                0658943244
              </p>
              
                <span class="mt-2 inline-block status-actif px-3 py-1 text-xs font-semibold">Inscrit</span>
              
            </div>
          </div>
          
          <div class="group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row" role="button" tabindex="0" data-id="63" data-name="HAMID Salima" data-nom_arabe="" data-prenom_arabe="" data-email="" data-phone="0555123456" data-address="" data-remaining="-23856.0" data-status="Actif" data-photo="/media/etudiants/OIP%20(1).webp" data-sexe="" data-date_naissance="Oct. 4, 2003" data-lieu_naissance="Amizour" data-nationalite="Albanais" data-nin="393902344424443444" data-remarques="" data-extrait="" data-carte="" data-verify="1" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="inscrit">
            <div class="flex h-40 items-center justify-center pt-4">
              <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="/media/etudiants/OIP%20(1).webp"/>
            </div>
            <div class="p-4 text-center">
              <h3 class="text-base font-semibold text-gray-800">HAMID Salima</h3>
              <p class="text-sm text-gray-500">
                0555123456
              </p>
              
                <span class="mt-2 inline-block status-actif px-3 py-1 text-xs font-semibold">Inscrit</span>
              
            </div>
          </div>
          
          <div class="group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row" role="button" tabindex="0" data-id="39" data-name="BRIAREEZZ Hamida" data-nom_arabe="" data-prenom_arabe="" data-email="vadire6@gmail.com" data-phone="3555666777" data-address="Boukhiama" data-remaining="450.0" data-status="inscrit" data-photo="/media/etudiants/Anime-Profile-Picture-2_uYcslTr.jpg" data-sexe="M" data-date_naissance="Aug. 14, 2025" data-lieu_naissance="Amizour" data-nationalite="ALGERIENNE" data-nin="393902344424443214" data-remarques="" data-extrait="" data-carte="" data-verify="3" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="inscrit">
            <div class="flex h-40 items-center justify-center pt-4">
              <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="/media/etudiants/Anime-Profile-Picture-2_uYcslTr.jpg"/>
            </div>
            <div class="p-4 text-center">
              <h3 class="text-base font-semibold text-gray-800">BRIAREEZZ Hamida</h3>
              <p class="text-sm text-gray-500">
                3555666777
              </p>
              
                <span class="mt-2 inline-block status-actif px-3 py-1 text-xs font-semibold">Inscrit</span>
              
            </div>
          </div>
          
          <div class="group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row" role="button" tabindex="0" data-id="38" data-name="B HAMID" data-nom_arabe="" data-prenom_arabe="" data-email="vadire73@gmail.com" data-phone="0555123456" data-address="Boukhiama" data-remaining="30450.0" data-status="inscrit" data-photo="/media/etudiants/images%20(1)_0sWvkgD.jfif" data-sexe="" data-date_naissance="Aug. 9, 2025" data-lieu_naissance="BEJAIA" data-nationalite="ALGERIENNE" data-nin="" data-remarques="" data-extrait="" data-carte="" data-verify="1" data-niveau="" data-situation="fonctionnaire" data-dernier_diplome="" data-formation="" data-inscription="inscrit">
            <div class="flex h-40 items-center justify-center pt-4">
              <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="/media/etudiants/images%20(1)_0sWvkgD.jfif"/>
            </div>
            <div class="p-4 text-center">
              <h3 class="text-base font-semibold text-gray-800">B HAMID</h3>
              <p class="text-sm text-gray-500">
                0555123456
              </p>
              
                <span class="mt-2 inline-block status-actif px-3 py-1 text-xs font-semibold">Inscrit</span>
              
            </div>
          </div>
          
          <div class="group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row" role="button" tabindex="0" data-id="37" data-name="GAREN DARIUS" data-nom_arabe="" data-prenom_arabe="" data-email="vadire7@gmail.com" data-phone="0492344242" data-address="Boukhiama" data-remaining="300.0" data-status="inscrit" data-photo="/media/etudiants/images%20(1)_Gdha3sI.jfif" data-sexe="" data-date_naissance="Aug. 13, 2025" data-lieu_naissance="BEJAIA" data-nationalite="ALGERIENNE" data-nin="" data-remarques="FSDSDF" data-extrait="" data-carte="" data-verify="3" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="inscrit">
            <div class="flex h-40 items-center justify-center pt-4">
              <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="/media/etudiants/images%20(1)_Gdha3sI.jfif"/>
            </div>
            <div class="p-4 text-center">
              <h3 class="text-base font-semibold text-gray-800">GAREN DARIUS</h3>
              <p class="text-sm text-gray-500">
                0492344242
              </p>
              
                <span class="mt-2 inline-block status-actif px-3 py-1 text-xs font-semibold">Inscrit</span>
              
            </div>
          </div>
          
          <div class="group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row" role="button" tabindex="0" data-id="33" data-name="bouchama HAMID" data-nom_arabe="" data-prenom_arabe="" data-email="" data-phone="" data-address="Boukhiama" data-remaining="480.0" data-status="inscrit" data-photo="/media/etudiants/cover-Cybersecurity-Budget-1.png" data-sexe="" data-date_naissance="Aug. 5, 2025" data-lieu_naissance="BEJAIA" data-nationalite="" data-nin="" data-remarques="ERRERE" data-extrait="" data-carte="" data-verify="3" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="inscrit">
            <div class="flex h-40 items-center justify-center pt-4">
              <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="/media/etudiants/cover-Cybersecurity-Budget-1.png"/>
            </div>
            <div class="p-4 text-center">
              <h3 class="text-base font-semibold text-gray-800">bouchama HAMID</h3>
              <p class="text-sm text-gray-500">
                -
              </p>
              
                <span class="mt-2 inline-block status-actif px-3 py-1 text-xs font-semibold">Inscrit</span>
              
            </div>
          </div>
          
          <div class="group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row" role="button" tabindex="0" data-id="32" data-name="RIAD MH" data-nom_arabe="" data-prenom_arabe="" data-email="" data-phone="" data-address="PARIS" data-remaining="0.0" data-status="Actif" data-photo="/media/etudiants/Anime-Profile-Picture-2.jpg" data-sexe="M" data-date_naissance="Aug. 7, 2025" data-lieu_naissance="BEJAIA" data-nationalite="ALGERIENNE" data-nin="39390234" data-remarques="" data-extrait="" data-carte="" data-verify="0" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="non_inscrit">
            <div class="flex h-40 items-center justify-center pt-4">
              <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="/media/etudiants/Anime-Profile-Picture-2.jpg"/>
            </div>
            <div class="p-4 text-center">
              <h3 class="text-base font-semibold text-gray-800">RIAD MH</h3>
              <p class="text-sm text-gray-500">
                -
              </p>
              
                <span class="mt-2 inline-block status-inactif px-3 py-1 text-xs font-semibold">Non inscrit</span>
              
            </div>
          </div>
          
          <div class="group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row" role="button" tabindex="0" data-id="31" data-name="IRELIA NOXUS" data-nom_arabe="" data-prenom_arabe="" data-email="" data-phone="" data-address="ZAUN" data-remaining="1950.0" data-status="inscrit" data-photo="/media/etudiants/5_H3_Ai_enhanced_2772e3ad7f.webp" data-sexe="F" data-date_naissance="Dec. 1, 2000" data-lieu_naissance="BEJAIA" data-nationalite="ALGERIENNE" data-nin="163723844" data-remarques="" data-extrait="" data-carte="" data-verify="3" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="inscrit">
            <div class="flex h-40 items-center justify-center pt-4">
              <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="/media/etudiants/5_H3_Ai_enhanced_2772e3ad7f.webp"/>
            </div>
            <div class="p-4 text-center">
              <h3 class="text-base font-semibold text-gray-800">IRELIA NOXUS</h3>
              <p class="text-sm text-gray-500">
                -
              </p>
              
                <span class="mt-2 inline-block status-actif px-3 py-1 text-xs font-semibold">Inscrit</span>
              
            </div>
          </div>
          
          <div class="group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row" role="button" tabindex="0" data-id="28" data-name="KATARINA NOXUS" data-nom_arabe="" data-prenom_arabe="" data-email="KATA@GMAIL.com" data-phone="0643722444" data-address="NOXUS,IONIA" data-remaining="0.0" data-status="Actif" data-photo="/media/etudiants/5fa500e772f3b355ebf94f09d32a6d62.jpg" data-sexe="homme" data-date_naissance="Oct. 4, 2003" data-lieu_naissance="BEJAIA" data-nationalite="ALGERIENNE" data-nin="167322424334" data-remarques="rien" data-extrait="" data-carte="" data-verify="2" data-niveau="TERMINAL" data-situation="ETUDIANT" data-dernier_diplome="LICENSE" data-formation="" data-inscription="non_inscrit">
            <div class="flex h-40 items-center justify-center pt-4">
              <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="/media/etudiants/5fa500e772f3b355ebf94f09d32a6d62.jpg"/>
            </div>
            <div class="p-4 text-center">
              <h3 class="text-base font-semibold text-gray-800">KATARINA NOXUS</h3>
              <p class="text-sm text-gray-500">
                0643722444
              </p>
              
                <span class="mt-2 inline-block status-inactif px-3 py-1 text-xs font-semibold">Non inscrit</span>
              
            </div>
          </div>
          
          <div class="group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row" role="button" tabindex="0" data-id="27" data-name="RRRRRRRRRRR Rrrrrrrr" data-nom_arabe="" data-prenom_arabe="" data-email="vadire37@gmail.com" data-phone="05551234564" data-address="" data-remaining="450.0" data-status="inscrit" data-photo="/media/etudiants/surprised-jazz-hands-happy-asian-girl-smiling-looking-amazed-camera-announcing-smth-standing-white-background_1258-89582_BQ7fv36.jpg" data-sexe="F" data-date_naissance="July 4, 1983" data-lieu_naissance="Amizour" data-nationalite="Allemand" data-nin="215557412575555553" data-remarques="" data-extrait="" data-carte="" data-verify="3" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="5" data-inscription="inscrit">
            <div class="flex h-40 items-center justify-center pt-4">
              <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="/media/etudiants/surprised-jazz-hands-happy-asian-girl-smiling-looking-amazed-camera-announcing-smth-standing-white-background_1258-89582_BQ7fv36.jpg"/>
            </div>
            <div class="p-4 text-center">
              <h3 class="text-base font-semibold text-gray-800">RRRRRRRRRRR Rrrrrrrr</h3>
              <p class="text-sm text-gray-500">
                05551234564
              </p>
              
                <span class="mt-2 inline-block status-actif px-3 py-1 text-xs font-semibold">Inscrit</span>
              
            </div>
          </div>
          
          <div class="group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row" role="button" tabindex="0" data-id="26" data-name="ggggggggg azzzzzzzzzzzzz" data-nom_arabe="" data-prenom_arabe="" data-email="dqjf@gmail.com" data-phone="068666666666" data-address="" data-remaining="450.0" data-status="inscrit" data-photo="/media/etudiants/eaa52db1594c46408ffa6f47b99d4076_l5tDjzX.webp" data-sexe="" data-date_naissance="" data-lieu_naissance="" data-nationalite="" data-nin="" data-remarques="" data-extrait="" data-carte="" data-verify="3" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="4" data-inscription="inscrit">
            <div class="flex h-40 items-center justify-center pt-4">
              <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="/media/etudiants/eaa52db1594c46408ffa6f47b99d4076_l5tDjzX.webp"/>
            </div>
            <div class="p-4 text-center">
              <h3 class="text-base font-semibold text-gray-800">ggggggggg azzzzzzzzzzzzz</h3>
              <p class="text-sm text-gray-500">
                068666666666
              </p>
              
                <span class="mt-2 inline-block status-actif px-3 py-1 text-xs font-semibold">Inscrit</span>
              
            </div>
          </div>
          
          <div class="group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row" role="button" tabindex="0" data-id="25" data-name="BERBOUCHA LYNA" data-nom_arabe="" data-prenom_arabe="" data-email="lyna@gmail.com" data-phone="0213214" data-address="" data-remaining="26633.0" data-status="inscrit" data-photo="/media/etudiants/images_Gmmc5sO.jfif" data-sexe="" data-date_naissance="" data-lieu_naissance="" data-nationalite="" data-nin="" data-remarques="" data-extrait="" data-carte="" data-verify="3" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="6" data-inscription="inscrit">
            <div class="flex h-40 items-center justify-center pt-4">
              <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="/media/etudiants/images_Gmmc5sO.jfif"/>
            </div>
            <div class="p-4 text-center">
              <h3 class="text-base font-semibold text-gray-800">BERBOUCHA LYNA</h3>
              <p class="text-sm text-gray-500">
                0213214
              </p>
              
                <span class="mt-2 inline-block status-actif px-3 py-1 text-xs font-semibold">Inscrit</span>
              
            </div>
          </div>
          
          <div class="group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row" role="button" tabindex="0" data-id="24" data-name="ZZZZZZZZZZ Zzzzzzzzzzz" data-nom_arabe="" data-prenom_arabe="" data-email="garymartin1968@cholemail.com" data-phone="0883822232" data-address="" data-remaining="0.0" data-status="Actif" data-photo="/media/etudiants/eaa52db1594c46408ffa6f47b99d4076_rjzk2l7.webp" data-sexe="" data-date_naissance="" data-lieu_naissance="Chellata" data-nationalite="Allemand" data-nin="393902344424443455" data-remarques="" data-extrait="" data-carte="" data-verify="0" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="5" data-inscription="non_inscrit">
            <div class="flex h-40 items-center justify-center pt-4">
              <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="/media/etudiants/eaa52db1594c46408ffa6f47b99d4076_rjzk2l7.webp"/>
            </div>
            <div class="p-4 text-center">
              <h3 class="text-base font-semibold text-gray-800">ZZZZZZZZZZ Zzzzzzzzzzz</h3>
              <p class="text-sm text-gray-500">
                0883822232
              </p>
              
                <span class="mt-2 inline-block status-inactif px-3 py-1 text-xs font-semibold">Non inscrit</span>
              
            </div>
          </div>
          
          <div class="group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row" role="button" tabindex="0" data-id="22" data-name="Belkacem Rachid" data-nom_arabe="" data-prenom_arabe="" data-email="rachid.belkacem@example.com" data-phone="+213555444555" data-address="Rue I, Béjaïa" data-remaining="450.0" data-status="inscrit" data-photo="/media/etudiants/pedro-pascal-as-joel-miller-in-the-last-of-us-episode-9.webp" data-sexe="" data-date_naissance="" data-lieu_naissance="" data-nationalite="" data-nin="" data-remarques="" data-extrait="" data-carte="" data-verify="3" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="inscrit">
            <div class="flex h-40 items-center justify-center pt-4">
              <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="/media/etudiants/pedro-pascal-as-joel-miller-in-the-last-of-us-episode-9.webp"/>
            </div>
            <div class="p-4 text-center">
              <h3 class="text-base font-semibold text-gray-800">Belkacem Rachid</h3>
              <p class="text-sm text-gray-500">
                +213555444555
              </p>
              
                <span class="mt-2 inline-block status-actif px-3 py-1 text-xs font-semibold">Inscrit</span>
              
            </div>
          </div>
          
          <div class="group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row" role="button" tabindex="0" data-id="20" data-name="Amrani Sofiane" data-nom_arabe="" data-prenom_arabe="" data-email="sofiane.amrani@example.com" data-phone="+213555999000" data-address="Rue G, Sétif" data-remaining="0.0" data-status="non inscrit" data-photo="/media/etudiants/eaa52db1594c46408ffa6f47b99d4076.webp" data-sexe="" data-date_naissance="" data-lieu_naissance="" data-nationalite="" data-nin="" data-remarques="" data-extrait="" data-carte="" data-verify="0" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="non_inscrit">
            <div class="flex h-40 items-center justify-center pt-4">
              <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="/media/etudiants/eaa52db1594c46408ffa6f47b99d4076.webp"/>
            </div>
            <div class="p-4 text-center">
              <h3 class="text-base font-semibold text-gray-800">Amrani Sofiane</h3>
              <p class="text-sm text-gray-500">
                +213555999000
              </p>
              
                <span class="mt-2 inline-block status-inactif px-3 py-1 text-xs font-semibold">Non inscrit</span>
              
            </div>
          </div>
          
          <div class="group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row" role="button" tabindex="0" data-id="18" data-name="Djebali Omar" data-nom_arabe="" data-prenom_arabe="" data-email="omar.djebali@example.com" data-phone="+213555555666" data-address="Rue E, Blida" data-remaining="-22833.0" data-status="inscrit" data-photo="/media/etudiants/images.jfif" data-sexe="" data-date_naissance="" data-lieu_naissance="" data-nationalite="" data-nin="" data-remarques="" data-extrait="" data-carte="" data-verify="0" data-niveau="Terminal" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="inscrit">
            <div class="flex h-40 items-center justify-center pt-4">
              <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="/media/etudiants/images.jfif"/>
            </div>
            <div class="p-4 text-center">
              <h3 class="text-base font-semibold text-gray-800">Djebali Omar</h3>
              <p class="text-sm text-gray-500">
                +213555555666
              </p>
              
                <span class="mt-2 inline-block status-actif px-3 py-1 text-xs font-semibold">Inscrit</span>
              
            </div>
          </div>
          
          <div class="group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row" role="button" tabindex="0" data-id="17" data-name="Cherif Leila" data-nom_arabe="" data-prenom_arabe="" data-email="leila.cherif@example.com" data-phone="+213555333444" data-address="Rue D, Annaba" data-remaining="0.0" data-status="non inscrit" data-photo="/media/etudiants/surprised-jazz-hands-happy-asian-girl-smiling-looking-amazed-camera-announcing-smth-standing-white-background_1258-89582_IR1yMyX.jpg" data-sexe="" data-date_naissance="" data-lieu_naissance="" data-nationalite="" data-nin="" data-remarques="" data-extrait="" data-carte="" data-verify="0" data-niveau="" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="non_inscrit">
            <div class="flex h-40 items-center justify-center pt-4">
              <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="/media/etudiants/surprised-jazz-hands-happy-asian-girl-smiling-looking-amazed-camera-announcing-smth-standing-white-background_1258-89582_IR1yMyX.jpg"/>
            </div>
            <div class="p-4 text-center">
              <h3 class="text-base font-semibold text-gray-800">Cherif Leila</h3>
              <p class="text-sm text-gray-500">
                +213555333444
              </p>
              
                <span class="mt-2 inline-block status-inactif px-3 py-1 text-xs font-semibold">Non inscrit</span>
              
            </div>
          </div>
          
          <div class="group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row" role="button" tabindex="0" data-id="3" data-name="bouchama HAMID" data-nom_arabe="" data-prenom_arabe="" data-email="rayneera654@gmail.com" data-phone="0555123456" data-address="" data-remaining="1550.0" data-status="inscrit" data-photo="/media/etudiants/images_GZTcPxT.jfif" data-sexe="" data-date_naissance="" data-lieu_naissance="" data-nationalite="" data-nin="" data-remarques="" data-extrait="" data-carte="" data-verify="0" data-niveau="universitaire" data-situation="" data-dernier_diplome="" data-formation="" data-inscription="inscrit">
            <div class="flex h-40 items-center justify-center pt-4">
              <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="/media/etudiants/images_GZTcPxT.jfif"/>
            </div>
            <div class="p-4 text-center">
              <h3 class="text-base font-semibold text-gray-800">bouchama HAMID</h3>
              <p class="text-sm text-gray-500">
                0555123456
              </p>
              
                <span class="mt-2 inline-block status-actif px-3 py-1 text-xs font-semibold">Inscrit</span>
              
            </div>
          </div>
          
        </div>
      </main>
    </div>
    <!-- Add Modal (clean, single copy matching ajout.txt layout) -->
    <div id="addModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full" style="max-width:980px; width:calc(100% - 48px); max-height:95vh; overflow:hidden; display:flex; flex-direction:column; font-family: 'Roboto', Roboto, system-ui, -apple-system, 'Segoe UI', sans-serif;">
        <h1 class="text-2xl font-bold text-center mb-4">Etudiant</h1>
        <form id="addForm" enctype="multipart/form-data" style="display:flex;flex-direction:column;flex:1 1 auto;overflow:auto;padding-bottom:12px;">
          <input type="hidden" name="csrfmiddlewaretoken" value="8wriUNEKGvJVmYT0R4tRQujMeyxxKBhjZ8MfReoAPhWhh0aBkBbkmFbnXCb3lAo5">
          <!-- CSS grid: left photo column spans 4 rows, right side is a two-column grid for names; third row placed in row 4 so it aligns with photo bottom -->
          <div style="display:grid;grid-template-columns:14rem 1fr;grid-template-rows:auto auto auto auto;gap:1rem;align-items:start;">
            <div style="grid-row:1 / span 4; display:flex;flex-direction:column;align-items:center;justify-content:flex-start;">
              <label for="photoInput" style="width:14rem;height:14rem;border-radius:9999px;border:2px dashed #d1d5db;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f8fafb;margin-bottom:0.75rem;cursor:pointer;overflow:hidden;">
                <span class="material-icons" style="font-size:4.2rem;color:#4b5563;">school</span>
                <p class="text-sm text-gray-500 mt-2" style="margin:0">Photo</p>
                <p class="text-xs text-gray-400" style="margin:0">PNG, JPG</p>
              </label>
              <input id="photoInput" type="file" name="photo" accept="image/*" class="hidden" />
            </div>
            <div style="grid-column:2;grid-row:1 / span 2;display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;">
              <div>
                <label class="block text-sm font-medium text-gray-700" for="nom">Nom</label>
                <input name="nom" id="nom" tabindex="1" required style="font-size:19px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Entrez votre nom" type="text" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 text-right" for="nom_ar">اللقب</label>
                <input name="nom_arabe" id="nom_ar" tabindex="3" dir="rtl" class="mt-1 block w-full ml-auto px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" type="text" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700" for="prenom">Prénom</label>
                <input name="prenom" id="prenom" tabindex="2" required style="font-size:15px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Entrez votre prénom" type="text" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 text-right" for="prenom_ar">الاسم</label>
                <input name="prenom_arabe" id="prenom_ar" tabindex="4" dir="rtl" class="mt-1 block w-full ml-auto px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" type="text" />
              </div>
            </div>
            <div style="grid-column:2;grid-row:4;">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2 items-center">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="sexe">Genre</label>
                  <div class="relative mt-1">
                    <select name="sexe" id="sexe" required style="font-size:15px" class="block w-full appearance-none px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                      <option value="">-- Sexe --</option>
                      <option value="M">Masculin</option>
                      <option value="F">Féminin</option>
                    </select>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="lieu_naissance">Lieu de Naissance</label>
                  <input name="lieu_naissance" id="lieu_naissance" list="lieu_list" required style="font-size:15px" class="block w-full mt-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Entrez lieu de naissance" type="text" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="date_naissance">Date de Naissance</label>
                  <div style="position:relative">
                    <input name="date_naissance" id="date_naissance" style="padding-right:2.6rem" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="JJ/MM/AAAA" type="date" />
                    
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div class="md:col-span-1">
              <label class="block text-sm font-medium text-gray-700" for="nin">NIN</label>
              <input name="nin" id="nin" required style="font-size:15px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Ex: 123456789" type="text" />
              <div id="ninErrorAdd" class="text-sm text-red-600 mt-1 hidden" role="alert" aria-live="polite">
                <span class="material-icons" style="font-size:16px;vertical-align:middle;margin-right:6px;">error_outline</span>
                <span id="ninErrorAddMsg"></span>
              </div>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700" for="nationalite">Nationalité</label>
              <input name="nationalite" id="nationalite" list="nationalite_list" value="Algérien" required style="font-size:15px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Entrez nationalité" type="text" />
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div>
              <label class="block text-sm font-medium text-gray-700" for="telephone">Téléphone</label>
              <input name="telephone" id="telephone" required style="font-size:15px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="+33 6 12 34 56 78" type="tel" />
              <div id="telErrorAdd" class="text-sm text-red-600 mt-1 hidden" role="alert" aria-live="polite">
                <span class="material-icons" style="font-size:16px;vertical-align:middle;margin-right:6px;">error_outline</span>
                <span id="telErrorAddMsg"></span>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700" for="email">Email</label>
              <input name="email" id="email" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="nom.prenom@email.com" type="email" />
            </div>
            <div x-data="{ social: '', profile: '' }">
              <label class="block text-sm font-medium text-gray-700" for="social_network">Réseaux sociaux</label>
              <div class="relative mt-1 w-full">
                <select name="social_network" id="social_network" x-model="social" class="block w-full appearance-none px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                  <option value="">Sélectionnez</option>
                  <option value="instagram">Instagram</option>
                  <option value="facebook">Facebook</option>
                  <option value="whatsapp">WhatsApp</option>
                  <option value="telegram">Telegram</option>
                </select>
                <!-- removed duplicate visual arrow; select already shows native arrow in most browsers -->
              </div>
              <div class="mt-2 w-full" x-show="social">
                <input name="social_profile" id="social_profile" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Nom du profil" type="text" x-model="profile" />
              </div>
            </div>
          </div>

          <!-- Ligne ajoutée : niveau d'étude, situation et dernier diplôme -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
            <div>
              <label class="block text-sm font-medium text-gray-700" for="niveau_etude">Niveau d'étude</label>
              <select name="niveau_etude" id="niveau_etude" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                <option value="">Sélectionnez</option>
                <option value="terminal">Terminal</option>
                <option value="universitaire">Universitaire</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700" for="situation">Situation</label>
              <select name="situation" id="situation" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                <option value="">Sélectionnez</option>
                <option value="fonctionnaire">Fonctionnaire</option>
                <option value="etudiant">Etudiant</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700" for="dernier_diplome">Dernier diplôme</label>
              <select name="dernier_diplome" id="dernier_diplome" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                <option value="">Sélectionnez</option>
                <option value="bac">Bac</option>
                <option value="licence">Licence</option>
                <option value="master">Master</option>
                <option value="doctorat">Doctorat</option>
              </select>
            </div>
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700" for="adresse">Adresse</label>
            <input name="adresse" id="adresse" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="123 Rue de l'Exemple, 75001 Paris" type="text" />
          </div>
          <div class="mt-4 mb-8">
            <label class="block text-sm font-medium text-gray-700" for="infos_supplementaires">Infos supplémentaires</label>
            <textarea name="remarques" id="infos_supplementaires" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Allergies, conditions médicales, etc." rows="2"></textarea>
          </div>
          <div style="position:sticky;bottom:0;background:linear-gradient(rgba(255,255,255,0.9), rgba(255,255,255,1));padding-top:10px;margin-top:6px;border-top:1px solid #eef2f7;" class="flex justify-between items-center">
            <button type="button" onclick="closeAddModal()" class="modal-action-btn secondary">Annuler</button>
            <button type="submit" class="modal-action-btn primary">Valider</button>
          </div>
        </form>
        <!-- keep datalist below (single copy) -->
    <style>
      /* Modal action buttons: slightly bigger, rounded, elegant hover */
      .modal-action-btn{
        padding: .7rem 1.4rem !important;
        font-size:15px !important;
        border-radius:8px !important;
        transition: transform .14s ease, box-shadow .14s ease, background .14s ease;
        cursor: pointer;
        min-width:160px;
      }
      .modal-action-btn.primary{ background: #10b981; color:#fff; border: 1px solid rgba(0,0,0,0.04); }
      .modal-action-btn.primary:hover{ background: linear-gradient(90deg,#059669,#10b981); transform: translateY(-3px); box-shadow: 0 10px 30px rgba(6,95,70,0.12); }
      .modal-action-btn.secondary{ background: #fff; color:#374151; border: 1px solid #d1d5db; }
      /* Cancel button: progressive red hover */
      .modal-action-btn.secondary:hover{ background: linear-gradient(90deg,#f87171,#ef4444); color:#fff; transform: translateY(-2px); box-shadow: 0 8px 22px rgba(239,68,68,0.12); border-color: rgba(0,0,0,0.06); }
      /* ensure sticky footer buttons look nice on small screens */
      @media (max-width: 640px){
        .modal-action-btn{ min-width:140px; width:140px; }
      }
    </style>
    <datalist id="nationalite_list">
      <option value="Afghan"></option>
      <option value="Albanais"></option>
      <option value="Algérien"></option>
      <option value="Allemand"></option>
      <option value="Américain"></option>
      <option value="Andorran"></option>
      <option value="Angolais"></option>
      <option value="Antiguais-et-Barbudien"></option>
      <option value="Saoudien"></option>
      <option value="Argentin"></option>
      <option value="Arménien"></option>
      <option value="Australien"></option>
      <option value="Autrichien"></option>
      <option value="Azerbaïdjanais"></option>
      <option value="Bahaméen"></option>
      <option value="Bahreïni"></option>
      <option value="Bangladais"></option>
      <option value="Barbadien"></option>
      <option value="Belge"></option>
      <option value="Bélizien"></option>
      <option value="Béninois"></option>
      <option value="Bhoutanais"></option>
      <option value="Biélorusse"></option>
      <option value="Birman"></option>
      <option value="Bolivien"></option>
      <option value="Bosnien-Herzégovinien"></option>
      <option value="Botswanais"></option>
      <option value="Brésilien"></option>
      <option value="Britannique"></option>
      <option value="Brunéien"></option>
      <option value="Bulgare"></option>
      <option value="Burkinabè"></option>
      <option value="Burundais"></option>
      <option value="Cambodgien"></option>
      <option value="Camerounais"></option>
      <option value="Canadien"></option>
      <option value="Cap-Verdien"></option>
      <option value="Centrafricain"></option>
      <option value="Chilien"></option>
      <option value="Chinois"></option>
      <option value="Chypriote"></option>
      <option value="Colombien"></option>
      <option value="Comorien"></option>
      <option value="Congolais"></option>
      <option value="Costaricien"></option>
      <option value="Croate"></option>
      <option value="Cubain"></option>
      <option value="Danois"></option>
      <option value="Djiboutien"></option>
      <option value="Dominicain"></option>
      <option value="Dominiquais"></option>
      <option value="Égyptien"></option>
      <option value="Émirien"></option>
      <option value="Équatorien"></option>
      <option value="Érythréen"></option>
      <option value="Espagnol"></option>
      <option value="Estonien"></option>
      <option value="Eswatini"></option>
      <option value="Éthiopien"></option>
      <option value="Fidjien"></option>
      <option value="Finlandais"></option>
      <option value="Français"></option>
      <option>Gabonais</option>
      <option>Gambien</option>
      <option>Géorgien</option>
      <option>Ghanéen</option>
      <option>Grec</option>
      <option>Grenadien</option>
      <option>Guatémaltèque</option>
      <option>Guinéen</option>
      <option>Bissau-Guinéen</option>
      <option>Équato-Guinéen</option>
      <option>Guyanien</option>
      <option>Haïtien</option>
      <option>Hondurien</option>
      <option>Hongrois</option>
      <option>Indien</option>
      <option>Indonésien</option>
      <option>Irakien</option>
      <option>Iranien</option>
      <option>Irlandais</option>
      <option>Islandais</option>
      <option>Israélien</option>
      <option>Italien</option>
      <option>Ivoirien</option>
      <option>Jamaïcain</option>
      <option>Japonais</option>
      <option>Jordanien</option>
      <option>Kazakh</option>
      <option>Kényan</option>
      <option>Kirghiz</option>
      <option>Kiribatien</option>
      <option>Koweïtien</option>
      <option>Laotien</option>
      <option>Letton</option>
      <option>Libanais</option>
      <option>Libérien</option>
      <option>Libyen</option>
      <option>Liechtensteinois</option>
      <option>Lituanien</option>
      <option>Luxembourgeois</option>
      <option>Macédonien</option>
      <option>Malaisien</option>
      <option>Malawite</option>
      <option>Maldivien</option>
      <option>Malien</option>
      <option>Maltais</option>
      <option>Marocain</option>
      <option>Marshallais</option>
      <option>Mauricien</option>
      <option>Mauritanien</option>
  
      <option>Mongol</option>
      <option>Monténégrin</option>
      <option>Mozambicain</option>
      <option>Namibien</option>
      <option>Nauruan</option>
      <option>Néerlandais</option>
      <option>Néo-Zélandais</option>
      <option>Népalais</option>
      <option>Nigérian</option>
      <option>Nigérien</option>
      <option>Nord-Coréen</option>
      <option>Norvégien</option>
 
      <option>Palestinien</option>
     

    </datalist>
        <datalist id="lieu_list">
          <option value="Béjaïa"></option>
          <option value="Amizour"></option>
          <option value="Ferraoun"></option>
          <option value="Taourirt Ighil"></option>
          <option value="Chellata"></option>
          <option value="Tamokra"></option>
          <option value="Timezrit"></option>
          <option value="Souk El Ténine"></option>
          <option value="M'cisna"></option>
          <option value="Tinabdher"></option>
          <option value="Tichy"></option>
          <option value="Semaoun"></option>
          <option value="Kendira"></option>
          <option value="Tifra"></option>
          <option value="Ighram"></option>
          <option value="Amalou"></option>
          <option value="Ighil Ali"></option>
          <option value="Fenaïa Ilmaten"></option>
          <option value="Toudja"></option>
          <option value="Darguina"></option>
          <option value="Sidi-Ayad"></option>
          <option value="Aokas"></option>
          <option value="Beni Djellil"></option>
          <option value="Adekar"></option>
          <option value="Akbou"></option>
          <option value="Seddouk"></option>
          <option value="Tazmalt"></option>
          <option value="Aït-R'zine"></option>
          <option value="Chemini"></option>
          <option value="Souk-Oufella"></option>
          <option value="Taskriout"></option>
          <option value="Tibane"></option>
          <option value="Tala Hamza"></option>
          <option value="Barbacha"></option>
          <option value="Beni Ksila"></option>
          <option value="Ouzellaguen"></option>
          <option value="Bouhamza"></option>
          <option value="Beni Mellikeche"></option>
          <option value="Sidi-Aïch"></option>
          <option value="El Kseur"></option>
          <option value="Melbou"></option>
          <option value="Akfadou"></option>
          <option value="Leflaye"></option>
          <option value="Kherrata"></option>
          <option value="Draâ El-Kaïd"></option>
          <option value="Tamridjet"></option>
          <option value="Aït-Smail"></option>
          <option value="Boukhelifa"></option>
          <option value="Tizi N'Berber"></option>
          <option value="Beni Maouche"></option>
          <option value="Oued Ghir"></option>
          <option value="Boudjellil"></option>
        </datalist>
      </div>
    </div>


    
  <!-- Edit Modal (copy of Add Modal layout, fields will be prefilled by JS) -->
  <div id="editModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full" style="max-width:980px; width:calc(100% - 48px); max-height:95vh; overflow:hidden; display:flex; flex-direction:column; font-family: 'Roboto', Roboto, system-ui, -apple-system, 'Segoe UI', sans-serif;">
      <h1 class="text-2xl font-bold text-center mb-4">Modifier l'étudiant</h1>
      <form id="editForm" enctype="multipart/form-data" style="display:flex;flex-direction:column;flex:1 1 auto;overflow:auto;padding-bottom:12px;">
        <input type="hidden" name="csrfmiddlewaretoken" value="8wriUNEKGvJVmYT0R4tRQujMeyxxKBhjZ8MfReoAPhWhh0aBkBbkmFbnXCb3lAo5">
        <input type="hidden" name="id" />
        <div style="display:grid;grid-template-columns:14rem 1fr;grid-template-rows:auto auto auto auto;gap:1rem;align-items:start;">
          <div style="grid-row:1 / span 4; display:flex;flex-direction:column;align-items:center;justify-content:flex-start;">
            <label for="photoInputEdit" style="width:14rem;height:14rem;border-radius:9999px;border:2px dashed #d1d5db;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f8fafb;margin-bottom:0.75rem;cursor:pointer;overflow:hidden;">
              <span class="material-icons" style="font-size:4.2rem;color:#4b5563;">school</span>
              <p class="text-sm text-gray-500 mt-2" style="margin:0">Photo</p>
              <p class="text-xs text-gray-400" style="margin:0">PNG, JPG</p>
            </label>
            <input id="photoInputEdit" type="file" name="photo" accept="image/*" class="hidden" />
          </div>
          <div style="grid-column:2;grid-row:1 / span 2;display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;">
            <div>
              <label class="block text-sm font-medium text-gray-700" for="nom">Nom</label>
              <input name="nom" id="nom_edit" tabindex="1" required style="font-size:19px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Entrez votre nom" type="text" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 text-right" for="nom_ar">اللقب</label>
              <input name="nom_arabe" id="nom_ar_edit" tabindex="3" dir="rtl" class="mt-1 block w-full ml-auto px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" type="text" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700" for="prenom">Prénom</label>
              <input name="prenom" id="prenom_edit" tabindex="2" required style="font-size:15px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Entrez votre prénom" type="text" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 text-right" for="prenom_ar">الاسم</label>
              <input name="prenom_arabe" id="prenom_ar_edit" tabindex="4" dir="rtl" class="mt-1 block w-full ml-auto px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" type="text" />
            </div>
          </div>
          <div style="grid-column:2;grid-row:4;">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2 items-center">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="sexe">Genre</label>
                  <div class="relative mt-1">
                    <select name="sexe" id="sexe_edit" required style="font-size:15px" class="block w-full appearance-none px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                      <option value="">-- Sexe --</option>
                      <option value="M">Masculin</option>
                      <option value="F">Féminin</option>
                    </select>
                  </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="lieu_naissance">Lieu de Naissance</label>
                <input name="lieu_naissance" id="lieu_naissance_edit2" list="lieu_list" required style="font-size:15px" class="block w-full mt-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Entrez lieu de naissance" type="text" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="date_naissance">Date de Naissance</label>
                <div style="position:relative">
                  <input name="date_naissance" id="date_naissance_edit" style="padding-right:2.6rem" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="JJ/MM/AAAA" type="date" />
                  
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <div class="md:col-span-1">
            <label class="block text-sm font-medium text-gray-700" for="nin">NIN</label>
            <input name="nin" id="nin_edit" required style="font-size:15px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Ex: 123456789" type="text" />
            <div id="ninErrorEdit" class="text-sm text-red-600 mt-1 hidden" role="alert" aria-live="polite">
              <span class="material-icons" style="font-size:16px;vertical-align:middle;margin-right:6px;">error_outline</span>
              <span id="ninErrorEditMsg"></span>
            </div>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700" for="nationalite">Nationalité</label>
            <input name="nationalite" id="nationalite_edit2" list="nationalite_list" style="font-size:15px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Entrez nationalité" type="text" />
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <div>
            <label class="block text-sm font-medium text-gray-700" for="telephone">Téléphone</label>
            <input name="telephone" id="telephone_edit" required style="font-size:15px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="+33 6 12 34 56 78" type="tel" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700" for="email">Email</label>
            <input name="email" id="email_edit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="nom.prenom@email.com" type="email" />
          </div>
          <div x-data="{ social: '', profile: '' }">
            <label class="block text-sm font-medium text-gray-700" for="social_network">Réseaux sociaux</label>
            <div class="relative mt-1 w-full">
              <select name="social_network" id="social_network_edit" x-model="social" class="block w-full appearance-none px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                <option value="">Sélectionnez</option>
                <option value="instagram">Instagram</option>
                <option value="facebook">Facebook</option>
                <option value="whatsapp">WhatsApp</option>
                <option value="telegram">Telegram</option>
              </select>
            </div>
            <div class="mt-2 w-full" x-show="social">
              <input name="social_profile" id="social_profile_edit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Nom du profil" type="text" x-model="profile" />
            </div>
          </div>
        </div>
        <!-- Ligne ajoutée pour edit: niveau d'etude, situation, dernier diplome -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <div>
            <label class="block text-sm font-medium text-gray-700" for="niveau_etude_edit">Niveau d'étude</label>
            <select name="niveau_etude" id="niveau_etude_edit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
              <option value="">Sélectionnez</option>
              <option value="terminal">Terminal</option>
              <option value="universitaire">Universitaire</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700" for="situation_edit">Situation</label>
            <select name="situation" id="situation_edit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
              <option value="">Sélectionnez</option>
              <option value="fonctionnaire">Fonctionnaire</option>
              <option value="etudiant">Etudiant</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700" for="dernier_diplome_edit">Dernier diplôme</label>
            <select name="dernier_diplome" id="dernier_diplome_edit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
              <option value="">Sélectionnez</option>
              <option value="bac">Bac</option>
              <option value="licence">Licence</option>
              <option value="master">Master</option>
              <option value="doctorat">Doctorat</option>
            </select>
          </div>
        </div>

        <div class="mt-4">
          <label class="block text-sm font-medium text-gray-700" for="adresse">Adresse</label>
          <input name="adresse" id="adresse_edit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="123 Rue de l'Exemple, 75001 Paris" type="text" />
        </div>
        <div class="mt-4 mb-8">
          <label class="block text-sm font-medium text-gray-700" for="infos_supplementaires">Infos supplémentaires</label>
          <textarea name="remarques" id="infos_supplementaires_edit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Allergies, conditions médicales, etc." rows="2"></textarea>
        </div>
        <div style="position:sticky;bottom:0;background:linear-gradient(rgba(255,255,255,0.9), rgba(255,255,255,1));padding-top:10px;margin-top:6px;border-top:1px solid #eef2f7;" class="flex justify-between items-center">
          <button type="button" onclick="closeEditModal()" class="modal-action-btn secondary">Annuler</button>
          <button type="submit" class="modal-action-btn primary">Modifier</button>
        </div>
      </form>
    </div>
  </div>



  
  
  <script>
    // Stagger modal-section animations inside addModal for a pleasant entrance
    (function(){
      const addModal = document.getElementById('addModal');
      if (!addModal) return;
      const sections = addModal.querySelectorAll('.modal-section');
      sections.forEach((el, idx) => {
        const d = 0.04 * idx;
        el.style.animationDelay = d + 's';
      });
    })();
    // Format number to DA: 1234.56 -> "1 234,56 DA"
    function formatDA(v){
      const n = Number(v) || 0;
      return n.toFixed(2) + ' DA';
    }
    function toggleView(mode) {
      const table = document.getElementById('tableView');
      const cards = document.getElementById('cardView');
      const gridIcon = document.getElementById('viewGridIcon');
      const listIcon = document.getElementById('viewListIcon');

      if (!table || !cards) return;

      const tableHidden = window.getComputedStyle(table).display === 'none';

      if (mode === 'grid') {
        if (table) { table.style.display = 'none'; table.classList.add('hidden'); }
        if (cards) { cards.classList.remove('hidden'); cards.style.display = ''; }
      } else if (mode === 'list') {
        if (table) { table.style.display = ''; table.classList.remove('hidden'); }
        if (cards) { cards.style.display = 'none'; cards.classList.add('hidden'); }
      } else {
        if (tableHidden) { if (table) { table.style.display = ''; table.classList.remove('hidden'); } if (cards) { cards.style.display = 'none'; cards.classList.add('hidden'); } }
        else { if (table) { table.style.display = 'none'; table.classList.add('hidden'); } if (cards) { cards.classList.remove('hidden'); cards.style.display = ''; } }
      }

      // Update icon aria-pressed and animate selection
      const showingCards = window.getComputedStyle(cards).display !== 'none';
      if (gridIcon) gridIcon.setAttribute('aria-pressed', showingCards ? 'true' : 'false');
      if (listIcon) listIcon.setAttribute('aria-pressed', showingCards ? 'false' : 'true');

      // move the green indicator to the selected icon with smooth transform
      try{
        const indicator = document.getElementById('viewIndicator');
        if (indicator){
          const target = showingCards ? gridIcon : listIcon;
          moveIndicatorTo(target);
        }
      }catch(e){/* ignore */}
    }

    function moveIndicatorTo(el){
      if (!el) return;
      const wrap = document.querySelector('.view-icons-wrap');
      const indicator = document.getElementById('viewIndicator');
      if (!wrap || !indicator) return;
      // compute relative position inside wrap
      const wrapRect = wrap.getBoundingClientRect();
      const elRect = el.getBoundingClientRect();
      const offsetX = elRect.left - wrapRect.left;
      const offsetY = elRect.top - wrapRect.top;
      // center the indicator under the icon (use icon width)
      const translateX = offsetX;
      const translateY = 0; // keep top for consistent vertical position
      indicator.style.transform = `translate3d(${translateX}px, ${translateY}px, 0)`;
      // match indicator width to icon width for better visual
      indicator.style.width = (elRect.width) + 'px';
    }

    // initialize indicator position on load
    window.addEventListener('load', function(){
      const cardEl = document.getElementById('cardView');
      const cardsVisible = cardEl ? (window.getComputedStyle(cardEl).display !== 'none') : false;
      const gridIcon = document.getElementById('viewGridIcon');
      const listIcon = document.getElementById('viewListIcon');
      const target = cardsVisible ? gridIcon : listIcon;
      setTimeout(()=>{ moveIndicatorTo(target); }, 80);
    });

  // Modal controls (animations removed)
  const addModalEl = document.getElementById('addModal');
  const DEFAULT_AVATAR = "/static/images/happy.gif";
  const editModal = document.getElementById('editModal');
  document.getElementById('openAddBtn').addEventListener('click', () => { 
    // set default nationalite if empty
    try{ const nat = document.getElementById('nationalite'); if(nat && !nat.value) nat.value = 'Algérien'; }catch(e){}
    // clear date field formatting guidance
    try{ const d = document.getElementById('date_naissance'); if(d && !d.value) d.placeholder = 'JJ/MM/AAAA'; }catch(e){}
    addModalEl.classList.remove('hidden'); 
  });
  function closeAddModal(){
    try{
      const form = document.getElementById('addForm');
      if(form){
        const globalErr = document.getElementById('addFormGlobalError'); if(globalErr) globalErr.remove();
        const telWrap = document.getElementById('telErrorAdd'); if(telWrap) telWrap.classList.add('hidden');
        const ninWrap = document.getElementById('ninErrorAdd'); if(ninWrap) ninWrap.classList.add('hidden');
        const telMsg = document.getElementById('telErrorAddMsg'); if(telMsg) telMsg.textContent = '';
        const ninMsg = document.getElementById('ninErrorAddMsg'); if(ninMsg) ninMsg.textContent = '';
        try{ form.reset(); }catch(e){}
      }
      addModalEl.classList.add('hidden');
      const openAdd = document.getElementById('openAddBtn'); if(openAdd) openAdd.focus();
    }catch(e){ }
  }
  function closeEditModal(){
    try{
      // Reset and clear inline errors so modal appears clean next time
      const form = document.getElementById('editForm');
      if(form){
        // remove any global error banner
        const globalErr = document.getElementById('editFormGlobalError'); if(globalErr) globalErr.remove();
        // hide field-specific error wrappers if present
        const telWrap = document.getElementById('telErrorEdit'); if(telWrap) telWrap.classList.add('hidden');
        const ninWrap = document.getElementById('ninErrorEdit'); if(ninWrap) ninWrap.classList.add('hidden');
        const telMsg = document.getElementById('telErrorEditMsg'); if(telMsg) telMsg.textContent = '';
        const ninMsg = document.getElementById('ninErrorEditMsg'); if(ninMsg) ninMsg.textContent = '';
        // reset the form fields (preserve file input display handled elsewhere)
        try{ form.reset(); }catch(e){}
      }
      // actually hide the modal
      editModal.classList.add('hidden');
      // briefly remove any focus trap by returning focus to the table or add button
      const openAdd = document.getElementById('openAddBtn');
      if(openAdd) openAdd.focus(); else {
        const firstRow = document.querySelector('#studentsTbody tr.student-row'); if(firstRow) firstRow.focus && firstRow.focus();
      }
    }catch(e){ /* swallow errors to avoid breaking callers */ }
  }

  // Date normalization: accept many formats and return ISO (YYYY-MM-DD) for input[type=date]
  function normalizeDateToISO(raw){
    if(!raw) return '';
    const s = String(raw).trim();
    // ISO yyyy-mm-dd
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    // dd/mm/yyyy or dd-mm-yyyy
    if(/^\d{2}[\/\-]\d{2}[\/\-]\d{4}$/.test(s)){
      const parts = s.split(/[-\/]/);
      return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
    }
    // digits only, try to parse ddmmyyyy or yyyymmdd
    const digits = s.replace(/[^0-9]/g,'');
    if(digits.length === 8){
      // detect ddmmyyyy (first two <=31)
      const d1 = digits.substr(0,2); const m1 = digits.substr(2,2); const y1 = digits.substr(4,4);
      if(Number(d1) >= 1 && Number(d1) <= 31 && Number(m1) >= 1 && Number(m1) <= 12) return `${y1}-${m1}-${d1}`;
      // fallback to yyyymmdd
      const y2 = digits.substr(0,4); const m2 = digits.substr(4,2); const d2 = digits.substr(6,2);
      return `${y2}-${m2}-${d2}`;
    }
    // as last resort, try Date parsing and format
    const parsed = new Date(s);
    if (!isNaN(parsed.getTime())){
      const y = parsed.getFullYear(); const m = String(parsed.getMonth()+1).padStart(2,'0'); const d = String(parsed.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    return '';
  }

  // attach blur handlers to date inputs to normalize user input into ISO (YYYY-MM-DD)
  try{
    const dAdd = document.getElementById('date_naissance');
    if (dAdd){ dAdd.addEventListener('blur', function(){ const iso = normalizeDateToISO(this.value); if (iso) this.value = iso; }); }
    const dEdit = document.getElementById('date_naissance_edit');
    if (dEdit){ dEdit.addEventListener('blur', function(){ const iso = normalizeDateToISO(this.value); if (iso) this.value = iso; }); }
  }catch(e){ console.error('date normalize attach failed', e); }

    // Inline Add Inscription Modal (opens on students page when clicking 'Non inscrit')
    (function(){
      const inlineInsModal = document.createElement('div');
      inlineInsModal.id = 'addInsInlineModal';
      inlineInsModal.className = 'hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop';
      inlineInsModal.innerHTML = `
        <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-lg p-6">
          <h2 class="text-xl font-semibold mb-4">Nouvelle inscription</h2>
          <form id="addInsInlineForm">
            <input type="hidden" name="csrfmiddlewaretoken" value="8wriUNEKGvJVmYT0R4tRQujMeyxxKBhjZ8MfReoAPhWhh0aBkBbkmFbnXCb3lAo5">
            <div class="grid grid-cols-1 gap-3">
              <input type="hidden" name="etudiant" id="inlineEtudiantId" />
              <div><strong>Étudiant:</strong> <span id="inlineEtudiantName"></span></div>
              <label>Formation</label>
              <select name="formation" class="border px-3 py-2 rounded">
                <option value="">-- Choisir formation --</option>
                
                <option value="3">Informatique</option>
                
                <option value="4">Mathématiques Appliquées</option>
                
                <option value="5">Gestion &amp; Finance</option>
                
                <option value="6">Design Web</option>
                
                <option value="7">Marketing Digital</option>
                
                <option value="8">Resauxxw</option>
                
                <option value="9">CYBERSECURITY</option>
                
                <option value="10">dfdfdf</option>
                
                <option value="11">SOFTWARE TESTING</option>
                
                <option value="13">dxd</option>
                
              </select>
              <label>Session</label>
              <select name="session" id="inlineSessionSelect" class="border px-3 py-2 rounded">
                <option value="session normale">Session normale</option>
                <option value="session estivale">Session estivale</option>
              </select>
              <label>Groupe</label>
              <select name="groupe" id="inlineGroupeSelect" class="border px-3 py-2 rounded" required>
                <option value="">-- Choisir formation d'abord --</option>
              </select>
              <label>Formateur (optionnel)</label>
              <select name="formateur" id="inlineFormateurSelect" class="border px-3 py-2 rounded">
                
                  <option value="">-- Choisir formateur --</option>
                  
                    <option value="26">HAMID bouchama</option>
                  
                    <option value="28">marvel captain </option>
                  
                    <option value="29">Eiliesh Billie</option>
                  
                    <option value="30">rodrigo olivia</option>
                  
                
              </select>
            </div>
            <div class="mt-4 flex justify-end">
              <button type="button" id="cancelAddInsInline" class="btn-secondary py-2 px-4 rounded mr-2">Annuler</button>
              <button type="submit" class="btn-primary py-2 px-4 rounded">Enregistrer</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(inlineInsModal);

      // Populate inline groupe options when a formation is selected.
      (function(){
        const inlineForm = document.getElementById('addInsInlineForm');
        if (!inlineForm) return;
        const inlineFormation = inlineForm.querySelector('select[name="formation"]');
        const inlineGroupe = document.getElementById('inlineGroupeSelect');
        // ensure there's a session and formateur element (already in template)
        const inlineSession = document.getElementById('inlineSessionSelect');
        const inlineFormateur = document.getElementById('inlineFormateurSelect');

        // Try to use server-provided formation_groups_json (same format as in inscriptions.html)
        let formationGroupsInline = {};
        try { formationGroupsInline = JSON.parse('{\u00223\u0022: [{\u0022code\u0022: \u0022GI1\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 1, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GI2\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GI3\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}], \u00224\u0022: [{\u0022code\u0022: \u0022GM1\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 3, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GM2\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 1, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GM3\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 1, \u0022capacity\u0022: 16}], \u00225\u0022: [{\u0022code\u0022: \u0022GG1\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 2, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GG2\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 1, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GG3\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}], \u00226\u0022: [{\u0022code\u0022: \u0022GD1\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 1, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GD2\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GD3\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 1, \u0022capacity\u0022: 16}], \u00227\u0022: [{\u0022code\u0022: \u0022GM1\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 1, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GM2\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GM3\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 1, \u0022capacity\u0022: 16}], \u00228\u0022: [{\u0022code\u0022: \u0022GR1\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 1, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GR2\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 1, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GR3\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 1, \u0022capacity\u0022: 16}], \u00229\u0022: [{\u0022code\u0022: \u0022GC1\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GC2\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GC3\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}], \u002210\u0022: [{\u0022code\u0022: \u0022GD1\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GD2\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GD3\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}], \u002211\u0022: [{\u0022code\u0022: \u0022GS1\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GS2\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GS3\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}], \u002213\u0022: [{\u0022code\u0022: \u0022GD1\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GD2\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GD3\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}]}'); } catch(e) { formationGroupsInline = {}; }

        function buildInlineGroupsFromFormation(formationId){
          inlineGroupe.innerHTML = '';
          const placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = '-- Choisir groupe --';
          inlineGroupe.appendChild(placeholder);
          if(!formationId) return;
          const opts = formationGroupsInline[String(formationId)] || [];
          if (opts && opts.length){
            opts.forEach(o => {
              const opt = document.createElement('option');
              opt.value = o.code;
              // show code and capacity/occupancy like inscriptions page
              opt.textContent = (o.count !== undefined) ? `${o.code} (${o.count}/${o.capacity || 16})` : o.code;
              if (o.disabled) opt.disabled = true;
              inlineGroupe.appendChild(opt);
            });
            return;
          }
          // fallback: generate simple groups based on formation name initial
          const sel = inlineFormation.options[inlineFormation.selectedIndex];
          const name = sel ? sel.text : '';
          const first = (name.trim().charAt(0) || '').toUpperCase();
          ['1','2','3'].forEach(n => {
            const o = document.createElement('option');
            o.value = `G${first}${n}`;
            o.textContent = `G${first}${n}`;
            inlineGroupe.appendChild(o);
          });
        }

        if(inlineFormation && inlineGroupe){
          inlineFormation.addEventListener('change', function(){
            buildInlineGroupsFromFormation(this.value);
          });
        }
        // If the page opened with a formation pre-selected (or if opening modal triggers change), ensure groups populate
        try{ if(inlineFormation) inlineFormation.dispatchEvent(new Event('change')); }catch(e){}
      
        // Also attach logic for the main addIns modal (if present on this page) using the same formation_groups_json
        try{
          let formationGroupsMain = {};
          try { formationGroupsMain = JSON.parse('{\u00223\u0022: [{\u0022code\u0022: \u0022GI1\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 1, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GI2\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GI3\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}], \u00224\u0022: [{\u0022code\u0022: \u0022GM1\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 3, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GM2\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 1, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GM3\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 1, \u0022capacity\u0022: 16}], \u00225\u0022: [{\u0022code\u0022: \u0022GG1\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 2, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GG2\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 1, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GG3\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}], \u00226\u0022: [{\u0022code\u0022: \u0022GD1\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 1, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GD2\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GD3\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 1, \u0022capacity\u0022: 16}], \u00227\u0022: [{\u0022code\u0022: \u0022GM1\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 1, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GM2\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GM3\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 1, \u0022capacity\u0022: 16}], \u00228\u0022: [{\u0022code\u0022: \u0022GR1\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 1, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GR2\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 1, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GR3\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 1, \u0022capacity\u0022: 16}], \u00229\u0022: [{\u0022code\u0022: \u0022GC1\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GC2\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GC3\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}], \u002210\u0022: [{\u0022code\u0022: \u0022GD1\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GD2\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GD3\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}], \u002211\u0022: [{\u0022code\u0022: \u0022GS1\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GS2\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GS3\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}], \u002213\u0022: [{\u0022code\u0022: \u0022GD1\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GD2\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}, {\u0022code\u0022: \u0022GD3\u0022, \u0022disabled\u0022: false, \u0022count\u0022: 0, \u0022capacity\u0022: 16}]}'); } catch(e) { formationGroupsMain = {}; }
          const mainForm = document.getElementById('addInsForm');
          const mainFormation = mainForm ? mainForm.querySelector('select[name="formation"]') : null;
          const mainGroupe = document.getElementById('addInsGroupeSelect');
          if (mainFormation && mainGroupe){
            mainFormation.addEventListener('change', function(){
              mainGroupe.innerHTML = '';
              const placeholder = document.createElement('option'); placeholder.value=''; placeholder.textContent='-- Choisir groupe --'; mainGroupe.appendChild(placeholder);
              const opts = formationGroupsMain[String(this.value)] || [];
              if (opts && opts.length){
                opts.forEach(o=>{
                  const opt = document.createElement('option'); opt.value = o.code; opt.textContent = (o.count !== undefined) ? `${o.code} (${o.count}/${o.capacity || 16})` : o.code; if(o.disabled) opt.disabled = true; mainGroupe.appendChild(opt);
                });
              } else {
                // fallback to simple generated groups using selected formation name
                const sel = this.options[this.selectedIndex]; const name = sel ? sel.text : ''; const first = (name.trim().charAt(0) || '').toUpperCase(); ['1','2','3'].forEach(n=>{ const o = document.createElement('option'); o.value = `G${first}${n}`; o.textContent = `G${first}${n}`; mainGroupe.appendChild(o); });
              }
            });
            // trigger initial population if a value already selected
            try{ mainFormation.dispatchEvent(new Event('change')); }catch(e){}
          }
        }catch(e){ /* fail quietly */ }
      })();

      // open modal when clicking Non inscrit links
      document.addEventListener('click', function(e){
        const a = e.target.closest('.open-add-inscription');
        if (!a) return;
        e.preventDefault();
        const etuId = a.dataset.etudiant;
        const name = a.dataset.etudiantName || '';
        document.getElementById('inlineEtudiantId').value = etuId;
        document.getElementById('inlineEtudiantName').textContent = name;
        // When opening inline modal, populate its groupe select for the current formation value (if any)
        const inlineForm = document.getElementById('addInsInlineForm');
        const inlineFormation = inlineForm.querySelector('select[name="formation"]');
        const inlineGroupe = document.getElementById('inlineGroupeSelect');
        if (inlineFormation && inlineGroupe){
          // build options using the same formationGroups object if available
          const evt = new Event('change');
          // trigger change handler to populate options
          inlineFormation.dispatchEvent(evt);
        }
        inlineInsModal.classList.remove('hidden');
      });

      document.getElementById('cancelAddInsInline').addEventListener('click', function(){ inlineInsModal.classList.add('hidden'); });

  document.getElementById('addInsInlineForm').addEventListener('submit', function(e){
    e.preventDefault();
    const form = e.target;
    // ensure groupe value is read from whichever control exists
    const groupeEl = form.querySelector('[name="groupe"]');
    const groupeVal = groupeEl ? (groupeEl.value || '') : '';
    const formationVal = form.querySelector('select[name="formation"]') ? form.querySelector('select[name="formation"]').value : '';
    if (!formationVal){
      let g = document.getElementById('addInsInlineFormGlobalError'); if(!g){ g = document.createElement('div'); g.id='addInsInlineFormGlobalError'; g.className='text-sm text-red-600 mt-2'; form.insertBefore(g, form.firstChild); }
      g.textContent = 'Veuillez choisir une formation.'; return;
    }
    if (!groupeVal){
      let g = document.getElementById('addInsInlineFormGlobalError'); if(!g){ g = document.createElement('div'); g.id='addInsInlineFormGlobalError'; g.className='text-sm text-red-600 mt-2'; form.insertBefore(g, form.firstChild); }
      g.textContent = 'Veuillez choisir un groupe.'; return;
    }
    // groupe is optional here (label says optionnel) so we only warn if explicitly required by server; do not block
    const data = new FormData(form);
    // include credentials and CSRF header for same-origin
  fetch('/inscriptions/add/', { method: 'POST', headers: { 'X-CSRFToken': csrftoken }, body: data, credentials: 'same-origin' }).then(r=>r.json()).then(json=>{
          if (json.success){
            // Optionally update the student row status to "Inscrit"
            const tr = document.querySelector('tr[data-id="'+data.get('etudiant')+'"]');
            if (tr){
              const status = tr.querySelector('td:nth-child(7)');
              if (status) status.innerHTML = '<span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Inscrit</span>';
            }
            inlineInsModal.classList.add('hidden');
          } else {
              let g = document.getElementById('addInsInlineFormGlobalError'); if(!g){ g = document.createElement('div'); g.id='addInsInlineFormGlobalError'; g.className='text-sm text-red-600 mt-2'; form.insertBefore(g, form.firstChild); }
              g.textContent = 'Erreur: '+(json.error||'');
            }
          }).catch(err=>{ console.error(err);
            try{
              const raw = (err && err.message) ? String(err.message) : 'vérifier la connexion';
              let parsed = null; try{ parsed = JSON.parse(raw); }catch(e){ parsed = null; }
              const msg = (parsed && (parsed.error||parsed.message)) ? (parsed.error||parsed.message) : raw;
              let g = document.getElementById('addInsInlineFormGlobalError'); if(!g){ g = document.createElement('div'); g.id='addInsInlineFormGlobalError'; g.className='text-sm text-red-600 mt-2'; form.insertBefore(g, form.firstChild); }
              g.textContent = 'Erreur réseau: ' + msg;
            }catch(e){}
          });
      });
    })();

    // CSRF helper
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

  // Handle add submit -> POST to server (animations removed)
  const addFormEl = document.getElementById('addForm');

    document.getElementById('addForm').addEventListener('submit', function(e){
  e.preventDefault();
  // client-side validation: email format, NIN length (18 digits), telephone length (10 or 11 digits)
  const emailEl = this.querySelector('input[name="email"]');
  const ninEl = this.querySelector('input[name="nin"]');
  const telEl = this.querySelector('input[name="telephone"]');
  // clear previous inline messages
  const ninMsg = document.getElementById('ninErrorAddMsg'); if(ninMsg) ninMsg.textContent=''; const ninErr = document.getElementById('ninErrorAdd'); if(ninErr) ninErr.classList.add('hidden');
  const telMsg = document.getElementById('telErrorAddMsg'); if(telMsg) telMsg.textContent=''; const telErr = document.getElementById('telErrorAdd'); if(telErr) telErr.classList.add('hidden');
  if (emailEl && emailEl.value && !emailEl.checkValidity()) { let g = document.getElementById('addFormGlobalError'); if(!g){ g = document.createElement('div'); g.id='addFormGlobalError'; g.className='text-sm text-red-600 mt-2'; document.getElementById('addForm').insertBefore(g, document.getElementById('addForm').firstChild); } g.textContent = 'Email invalide'; return; }
  if (ninEl && ninEl.value && (!/^\d{18}$/.test(ninEl.value.trim()))) { if(ninMsg){ ninMsg.textContent='Le NIN doit contenir exactement 18 chiffres'; ninErr.classList.remove('hidden'); ninEl.focus(); } return; }
  if (telEl && telEl.value){ const digits = telEl.value.replace(/\D/g,''); if(!/^\d{10,11}$/.test(digits)){ if(telMsg){ telMsg.textContent='Le téléphone doit contenir 10 ou 11 chiffres'; telErr.classList.remove('hidden'); telEl.focus(); } return; } }
      const form = e.target;
      const data = new FormData(form);
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      // POST to server (no animations)
      fetch('/etudiants/add/', {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken },
        body: data,
        credentials: 'same-origin'
      }).then(r => {
        if (!r.ok) return r.text().then(text => { throw new Error(text || r.statusText); });
        return r.json();
      }).then(json => {
        if (json.success) {
          appendStudentRow(json.student);
          // show success toast and include email send status if available
          try{
            const toast = document.createElement('div');
            toast.className = 'text-sm py-2 px-3 rounded shadow-md';
            toast.style.position = 'fixed';
            toast.style.right = '18px';
            toast.style.top = '18px';
            toast.style.background = '#10b981';
            toast.style.color = '#fff';
            toast.style.zIndex = 120;
            let msg = json.message || 'Ajouté avec succès';
            if (typeof json.email_scheduled !== 'undefined' && json.email_scheduled){
              msg += ' — Email planifié';
              toast.style.background = '#10b981';
            }
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(()=>{ try{ toast.remove(); }catch(e){} }, 3200);
          }catch(e){}
          closeAddModal();
        } else {
          // show NIN specific error inline when backend reports it
          const ninErrEl = document.getElementById('ninErrorAdd');
          if (ninErrEl) {
            const serverMsg = String(json.error || json.message || '');
            const lowerSrv = serverMsg.toLowerCase();
            if (lowerSrv.indexOf('nin') !== -1 || lowerSrv.indexOf('déjà utilisé') !== -1) {
              // place NIN error inline and remove any global banner
              const ninErrMsg = document.getElementById('ninErrorAddMsg'); if(ninErrMsg){ ninErrMsg.textContent = serverMsg; } ninErrEl.classList.remove('hidden'); const gRem = document.getElementById('addFormGlobalError'); if(gRem) gRem.remove();
            } else if (lowerSrv.indexOf('tel') !== -1 || lowerSrv.indexOf('télé') !== -1) {
              // telephone-related server error: show in telephone container; remove global banner
              const telErrMsg2 = document.getElementById('telErrorAddMsg'); if(telErrMsg2){ telErrMsg2.textContent = serverMsg; } const telWrap = document.getElementById('telErrorAdd'); if(telWrap) telWrap.classList.remove('hidden'); const gRem2 = document.getElementById('addFormGlobalError'); if(gRem2) gRem2.remove();
            } else {
              // form-level inline error fallback: clear field-specific errors
              const ninErrMsgClear = document.getElementById('ninErrorAddMsg'); if(ninErrMsgClear) ninErrMsgClear.textContent=''; ninErrEl.classList.add('hidden'); let g = document.getElementById('addFormGlobalError');
              if(!g){ g = document.createElement('div'); g.id='addFormGlobalError'; g.className='text-sm text-red-600 mt-2'; const ref = document.getElementById('addForm').firstChild; document.getElementById('addForm').insertBefore(g, ref); }
              g.textContent = 'Erreur: ' + (serverMsg || 'Impossible d\'ajouter');
            }
          } else {
            let g = document.getElementById('addFormGlobalError');
            const serverMsg2 = String(json.error || json.message || '');
            if(!g){ g = document.createElement('div'); g.id='addFormGlobalError'; g.className='text-sm text-red-600 mt-2'; const ref = document.getElementById('addForm').firstChild; document.getElementById('addForm').insertBefore(g, ref); }
            g.textContent = 'Erreur: ' + (serverMsg2 || 'Impossible d\'ajouter');
          }
        }
      }).catch(err => { console.error(err);
        try{
          const raw = (err && err.message) ? String(err.message) : 'réseau';
          let parsed = null; try{ parsed = JSON.parse(raw); }catch(e){ parsed = null; }
          const msg = parsed && (parsed.error||parsed.message) ? (parsed.error||parsed.message) : raw;
          // if message refers to nin or telephone, display inline under the field
          const lower = (String(msg||'')).toLowerCase();
          if(lower.indexOf('nin') !== -1 || lower.indexOf('numéro d\'ident') !== -1 || lower.indexOf('déjà utilisé') !== -1){
            const ninErrEl = document.getElementById('ninErrorAdd');
            const ninMsgEl = document.getElementById('ninErrorAddMsg');
            if(ninErrEl && ninMsgEl){ ninMsgEl.textContent = msg; ninErrEl.classList.remove('hidden'); }
          } else if(lower.indexOf('tel') !== -1 || lower.indexOf('télé') !== -1){
            const telErrEl = document.getElementById('telErrorAdd');
            const telMsgEl = document.getElementById('telErrorAddMsg');
            if(telErrEl && telMsgEl){ telMsgEl.textContent = msg; telErrEl.classList.remove('hidden'); }
          } else {
            let g = document.getElementById('addFormGlobalError');
            if(!g){ g = document.createElement('div'); g.id='addFormGlobalError'; g.className='text-sm text-red-600 mt-2'; const ref = document.getElementById('addForm').firstChild; document.getElementById('addForm').insertBefore(g, ref); }
            g.textContent = 'Erreur serveur: ' + msg;
          }
        }catch(e){}
        // show a toast with the error and close the modal so user is returned to the list
        try{
          const toast = document.createElement('div');
          toast.className = 'text-sm py-2 px-3 rounded shadow-md';
          toast.style.position = 'fixed'; toast.style.right = '18px'; toast.style.top = '18px'; toast.style.background = '#ef4444'; toast.style.color = '#fff'; toast.style.zIndex = 120;
          toast.textContent = 'Erreur serveur: ' + (String((err && err.message) ? err.message : 'réseau'));
          document.body.appendChild(toast);
          setTimeout(()=>{ try{ toast.remove(); }catch(e){} }, 4200);
        }catch(e){}
        try{ closeAddModal(); }catch(e){}
      })
      .finally(() => { submitBtn.disabled = false; });
    });

    // Clear inline NIN error messages when user types
    (function(){
      const ninAddInput = document.getElementById('nin');
      if (ninAddInput){ ninAddInput.addEventListener('input', function(){ const wrapper = document.getElementById('ninErrorAdd'); const msg = document.getElementById('ninErrorAddMsg'); if(msg) msg.textContent=''; if(wrapper) wrapper.classList.add('hidden'); }); }
      const ninEditInput = document.getElementById('nin_edit');
      if (ninEditInput){ ninEditInput.addEventListener('input', function(){ const wrapper = document.getElementById('ninErrorEdit'); const msg = document.getElementById('ninErrorEditMsg'); if(msg) msg.textContent=''; if(wrapper) wrapper.classList.add('hidden'); }); }
      const telAddInput = document.getElementById('telephone');
      if (telAddInput){ telAddInput.addEventListener('input', function(){ const wrapper = document.getElementById('telErrorAdd'); const msg = document.getElementById('telErrorAddMsg'); if(msg) msg.textContent=''; if(wrapper) wrapper.classList.add('hidden'); }); }
  const telEditInput = document.getElementById('telephone_edit');
  if (telEditInput){ telEditInput.addEventListener('input', function(){ const wrapper = document.getElementById('telErrorEdit'); const msg = document.getElementById('telErrorEditMsg'); if(msg) msg.textContent=''; if(wrapper) wrapper.classList.add('hidden'); }); }
    })();

    // close icons simply close modals
    document.querySelectorAll('button[aria-label="Fermer"]').forEach(btn => {
      btn.addEventListener('click', function(e){
        e.preventDefault();
        closeAddModal();
      });
    });

    // Edit logic: open modal and prefill from row/card dataset
    function openEditModalWithData(data){
      const form = document.getElementById('editForm');
  console.debug('[debug] openEditModalWithData called', data);
  const idInput = form.querySelector('input[name="id"]');
  if (idInput) idInput.value = data.id || '';
    if (form.querySelector('input[name="nom"]')) form.querySelector('input[name="nom"]').value = data.nom || data.name || '';
  if (form.querySelector('input[name="nom_arabe"]')) form.querySelector('input[name="nom_arabe"]').value = data.nom_arabe || '';
    if (form.querySelector('input[name="prenom"]')) form.querySelector('input[name="prenom"]').value = data.prenom || '';
  if (form.querySelector('input[name="prenom_arabe"]')) form.querySelector('input[name="prenom_arabe"]').value = data.prenom_arabe || '';
    if (form.querySelector('input[name="email"]')) form.querySelector('input[name="email"]').value = data.email || '';
    if (form.querySelector('input[name="telephone"]')) form.querySelector('input[name="telephone"]').value = data.telephone || data.phone || '';
  // new fields
  // sex/genre: try multiple selectors (some templates use name="genre", others name="sexe") and match by value or by option text
  function setSelectValueByValueOrText(sel, val){
    if (!sel) return;
    if (val === null || val === undefined || val === '') { sel.value = ''; return; }
    const v = String(val).trim();
    // exact value match
    const opts = Array.from(sel.options || []);
    let found = opts.find(o => o.value === v);
    if (!found) found = opts.find(o => (o.value || '').toLowerCase() === v.toLowerCase());
    if (!found) found = opts.find(o => ((o.textContent||'').toLowerCase().indexOf(v.toLowerCase()) !== -1));
    if (found) { sel.value = found.value; return; }
    // fallback: try first char (M/F)
    const short = v.charAt(0).toLowerCase();
    found = opts.find(o => (o.value||'').toLowerCase() === short);
    if (found) { sel.value = found.value; return; }
    sel.value = '';
  }
  const sexSel = form.querySelector('select[name="sexe"]') || form.querySelector('select[name="genre"]') || form.querySelector('#genre_edit') || form.querySelector('#genre');
  if (sexSel) setSelectValueByValueOrText(sexSel, data.sexe || data.genre || '');
  if (form.querySelector('input[name="date_naissance"]')){
    try{ const iso = (typeof normalizeDateToISO === 'function') ? normalizeDateToISO(data.date_naissance || '') : (data.date_naissance || ''); form.querySelector('input[name="date_naissance"]').value = iso || (data.date_naissance || ''); }catch(e){ form.querySelector('input[name="date_naissance"]').value = data.date_naissance || ''; }
  }
  // show existing photo (if any) inside the edit modal's label so user sees current avatar before changing it
  try{
    const editLabel = document.querySelector('label[for="photoInputEdit"]');
    if (editLabel){
      if (data.photo){
        const url = data.photo;
        editLabel.style.backgroundImage = `url(${url})`;
        editLabel.style.backgroundSize = 'cover';
        editLabel.style.backgroundPosition = 'center';
        // remove inner icon/text so the photo is visible (consistent with file-change preview)
        editLabel.querySelectorAll('*').forEach(n => n.remove());
        editLabel.setAttribute('aria-label','Photo existante');
      } else {
        // restore a neutral background if no photo
        editLabel.style.backgroundImage = '';
      }
    }
  }catch(e){ /* ignore preview errors */ }
  // write into edit inputs (new ids) if present, fall back to existing selectors
  const lieuEdit = form.querySelector('#lieu_naissance_edit') || form.querySelector('#lieu_naissance_edit2') || form.querySelector('input[name="lieu_naissance"], select[name="lieu_naissance"]');
  if (lieuEdit) lieuEdit.value = data.lieu_naissance || '';
  const natEdit = form.querySelector('#nationalite_edit') || form.querySelector('#nationalite_edit2') || form.querySelector('input[name="nationalite"], select[name="nationalite"]');
  if (natEdit) natEdit.value = data.nationalite || '';
  // ensure arabic name inputs present in edit modal also reflect dataset
  try{ const nomAr = form.querySelector('input[name="nom_arabe"]') || form.querySelector('#nom_ar_edit'); if(nomAr) nomAr.value = data.nom_arabe || ''; const prenAr = form.querySelector('input[name="prenom_arabe"]') || form.querySelector('#prenom_ar_edit'); if(prenAr) prenAr.value = data.prenom_arabe || ''; }catch(e){}
  if (form.querySelector('input[name="nin"]')) form.querySelector('input[name="nin"]').value = data.nin || '';
  // adresse: support both input and textarea variants and common ids
  const addrEl = form.querySelector('input[name="adresse"], textarea[name="adresse"], #adresse_edit, #adresse_edit2');
  if (addrEl) addrEl.value = data.adresse || '';
  // bio / remarques: support multiple name variants used across templates
  (function(){
    const bioEl = form.querySelector('textarea[name="infos_supplementaires"], textarea[name="remarques"], textarea[name="bio"], #infos_supplementaires_edit, #bio_edit, textarea[name="remarques_edit"]');
    const rawBio = (data.remarques || data.infos_supplementaires || data.bio || '');
    console.debug('[debug] bio selectors ->', { found: !!bioEl, rawBio: rawBio });
    if (!bioEl) return;
    try{
      const dec = document.createElement('textarea');
      dec.innerHTML = rawBio || '';
      const finalVal = dec.value || rawBio || '';
      bioEl.value = finalVal;
      console.debug('[debug] bio assigned', finalVal);
    }catch(e){ bioEl.value = rawBio || ''; console.debug('[debug] bio assign error', e); }
  })();
  // new selects: niveau_etude, situation, dernier_diplome (edit)
  const nivEdit = form.querySelector('#niveau_etude_edit') || form.querySelector('select[name="niveau_etude"]');
  if (nivEdit) nivEdit.value = data.niveau_etude || '';
  const sitEdit = form.querySelector('#situation_edit') || form.querySelector('select[name="situation"]');
  if (sitEdit) sitEdit.value = data.situation || '';
  const dipEdit = form.querySelector('#dernier_diplome_edit') || form.querySelector('select[name="dernier_diplome"]');
  if (dipEdit) dipEdit.value = data.dernier_diplome || '';
  // set disabled display select and hidden value
  const disp = form.querySelector('select[name="formation_display"]');
  const hidden = form.querySelector('input[name="formation"]');
  if (disp) { disp.value = data.formation || ''; }
  if (hidden) { hidden.value = data.formation || ''; }
      editModal.classList.remove('hidden');
    }

  // ...existing code...

    // Attach handlers to edit buttons (table and cards)
    // NOTE: edit/verify buttons were removed in favor of status badge interactions.
    // Keep a stub to avoid errors where this function is called; delete handling is attached elsewhere.
    function attachEditHandlers(){
      // no-op: editing is now accessed via other UI paths (status badge / dedicated forms)
      return;
    }

    function openEditModalWithRow(row){
      const fullName = row.dataset.name || '';
      const parts = fullName.split(' ');
      const prenom = parts.length > 1 ? parts.pop() : '';
      const nom = parts.join(' ') || fullName;
      const data = {
        id: row.dataset.id,
        name: fullName,
        nom: nom,
        prenom: prenom,
        email: row.dataset.email,
        telephone: row.dataset.phone,
        formation: row.dataset.formation || row.dataset.display_formation || '',
        status: row.dataset.status,
        // forward common dataset fields so the edit modal can prefill them
        date_naissance: row.dataset.date_naissance || '',
        lieu_naissance: row.dataset.lieu_naissance || '',
        nationalite: row.dataset.nationalite || '',
        sexe: row.dataset.sexe || '',
        nin: row.dataset.nin || '',
        adresse: row.dataset.address || row.dataset.adresse || '',
        remarques: row.dataset.remarques || '',
        niveau_etude: row.dataset.niveau || '',
        situation: row.dataset.situation || '',
        dernier_diplome: row.dataset.dernier_diplome || '',
        photo: row.dataset.photo || ''
        , nom_arabe: row.dataset.nom_arabe || ''
        , prenom_arabe: row.dataset.prenom_arabe || ''
      };
      openEditModalWithData(data);
    }

    // date icon focus handlers: clicking the calendar svg focuses the nearest date input
    function attachDateIconHandlers(root){
      const container = root || document;
      // ensure only one visible date-icon exists per parent container (dedupe accidental duplicates)
      container.querySelectorAll('div, label, .relative').forEach(parent => {
        try{
          const icons = Array.from(parent.querySelectorAll && parent.querySelectorAll('.date-icon') || []);
          if (icons.length > 1){
            // keep the first, remove the rest
            for (let i = 1; i < icons.length; i++) try{ icons[i].remove(); }catch(e){}
          }
        }catch(e){}
      });

      container.querySelectorAll('.date-icon').forEach(icon => {
        // avoid double-binding
        if (icon.__dateHandlerAttached) return; icon.__dateHandlerAttached = true;
        icon.addEventListener('click', function(e){
          // prefer explicit target by id if provided
          const targetId = this.getAttribute('data-target');
          let input = null;
          if (targetId) input = document.getElementById(targetId) || document.querySelector(`#${CSS.escape(targetId)}`);
          if (!input){ // fallback: look near the icon
            const parent = this.closest('div') || this.parentElement;
            input = parent && parent.querySelector('input[name="date_naissance"]') ? parent.querySelector('input[name="date_naissance"]') : (parent && parent.querySelector('input[id^="date_naissance"]') ? parent.querySelector('input[id^="date_naissance"]') : null);
          }
          if (input) {
            openNativeDatePicker(input);
          }
        });
        icon.addEventListener('keydown', function(e){ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); this.click(); } });
      });
    }

    // Use a temporary input[type=date] to show the native date picker, then copy value back formatted
    function openNativeDatePicker(targetTextInput){
      try{
        const temp = document.createElement('input');
        temp.type = 'date';
        temp.style.position = 'absolute'; temp.style.left = '-9999px'; temp.style.width = '1px';
        // try to seed value from current text input if parseable (DD/MM/YYYY or ISO)
        const cur = (targetTextInput.value || '').trim();
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(cur)){
          const parts = cur.split('/'); // dd/mm/yyyy
          temp.value = `${parts[2]}-${parts[1]}-${parts[0]}`;
        } else if (/^\d{4}-\d{2}-\d{2}$/.test(cur)){
          temp.value = cur;
        }
        document.body.appendChild(temp);
        // open picker: focus then dispatch click (some browsers open on focus)
        temp.focus();
        temp.addEventListener('change', function onChange(){
          const v = this.value; // yyyy-mm-dd
          if (v && /^\d{4}-\d{2}-\d{2}$/.test(v)){
            try{ targetTextInput.value = v; targetTextInput.dispatchEvent(new Event('input', { bubbles: true })); targetTextInput.dispatchEvent(new Event('change', { bubbles: true })); }catch(e){}
          }
          setTimeout(()=>{ temp.remove(); }, 50);
        });
        // also remove if focusout without change
        temp.addEventListener('blur', function(){ setTimeout(()=>{ if (document.body.contains(temp)) temp.remove(); }, 200); });
        // some browsers open datepicker on click
        temp.click();
      }catch(e){ console.error('openNativeDatePicker failed', e); }
    }

    // attach initially and after DOM mutations that insert modals or rows
    attachDateIconHandlers(document);

// Photo input preview for add modal
document.getElementById('photoInput').addEventListener('change', function(e){
  const file = this.files && this.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    const label = document.querySelector('label[for="photoInput"]');
    if(label){
      label.style.backgroundImage = `url(${ev.target.result})`;
      label.style.backgroundSize = 'cover';
      label.style.backgroundPosition = 'center';
  // remove inner icon/text so the uploaded photo is fully visible; keep the label as clickable placeholder
  label.querySelectorAll('*').forEach(n => n.remove());
  // keep accessibility: set an aria-label indicating a photo is present
  label.setAttribute('aria-label', 'Photo uploadée');
    }
  };
  reader.readAsDataURL(file);
});
// Photo input preview for edit modal (if present)
const photoEditInput = document.getElementById('photoInputEdit');
if (photoEditInput){
  photoEditInput.addEventListener('change', function(e){
    const file = this.files && this.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = function(ev){
      const label = document.querySelector('label[for="photoInputEdit"]');
      if(label){
        label.style.backgroundImage = `url(${ev.target.result})`;
        label.style.backgroundSize = 'cover';
        label.style.backgroundPosition = 'center';
        label.querySelectorAll('*').forEach(n => n.remove());
        label.setAttribute('aria-label', 'Photo uploadée');
      }
      // if an img preview element exists inside edit modal, update it too
      const imgPreview = document.getElementById('v_photo');
      if (imgPreview) imgPreview.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });
}
// Note: JS alignment/enforcement removed — layout is handled via CSS grid for predictable alignment.

    // Insert delete confirmation modal
    const deleteConfirmModal = document.createElement('div');
    deleteConfirmModal.id = 'deleteConfirmModal';
    deleteConfirmModal.className = 'hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop';
    deleteConfirmModal.innerHTML = `
      <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-md p-6">
        <h3 class="text-lg font-semibold mb-2">Confirmer la suppression</h3>
        <p class="text-sm text-gray-600 mb-4">Êtes-vous sûr de vouloir supprimer cet étudiant ? Cette action est irréversible.</p>
        <div class="flex justify-end space-x-3">
          <button id="cancelDeleteBtn" class="btn-secondary py-2 px-4 rounded">Annuler</button>
          <button id="confirmDeleteBtn" class="btn-danger py-2 px-4 rounded">Supprimer</button>
        </div>
      </div>
    `;
    document.body.appendChild(deleteConfirmModal);
    let _pendingDeleteRow = null;

    // When delete icon clicked, show modal instead of native confirm
    document.addEventListener('click', function(e){
      if (e.target.closest('.delete-btn')){
        e.stopPropagation();
        const row = e.target.closest('tr') || e.target.closest('div[ data-name ]');
        if (!row) return;
        _pendingDeleteRow = row;
        deleteConfirmModal.classList.remove('hidden');
      }
    });

    document.getElementById('cancelDeleteBtn').addEventListener('click', function(){
      _pendingDeleteRow = null;
      deleteConfirmModal.classList.add('hidden');
    });

    document.getElementById('confirmDeleteBtn').addEventListener('click', function(){
      if (!_pendingDeleteRow) { deleteConfirmModal.classList.add('hidden'); return; }
      const row = _pendingDeleteRow;
      const id = row.dataset.id;
      const fd = new FormData(); fd.append('id', id);
      fetch('/etudiants/delete/', {
        method: 'POST', headers: { 'X-CSRFToken': csrftoken }, body: fd, credentials: 'same-origin'
      }).then(r => {
        if (!r.ok) return r.text().then(text => { throw new Error(text || r.statusText); });
        return r.json();
      }).then(json => {
        if (json.success) {
          row.remove();
        } else {
          // inline error inside modal
          let g = document.getElementById('deleteRowError');
          if(!g){ g = document.createElement('div'); g.id='deleteRowError'; g.className='text-sm text-red-600 mt-2'; const ref = deleteConfirmModal.querySelector('div'); if(ref) ref.appendChild(g); }
          g.textContent = 'Erreur: ' + (json.error || 'Impossible de supprimer');
        }
      }).catch(err => { console.error(err);
        try{
          const raw = (err && err.message) ? String(err.message) : 'réseau'; let parsed=null; try{ parsed = JSON.parse(raw); }catch(e){ parsed = null; }
          const msg = parsed && (parsed.error||parsed.message) ? (parsed.error||parsed.message) : raw;
          let g = document.getElementById('deleteRowError'); if(!g){ g = document.createElement('div'); g.id='deleteRowError'; g.className='text-sm text-red-600 mt-2'; const ref = deleteConfirmModal.querySelector('div'); if(ref) ref.appendChild(g); }
          g.textContent = 'Erreur serveur: ' + msg;
        }catch(e){}
      })
      .finally(() => { _pendingDeleteRow = null; deleteConfirmModal.classList.add('hidden'); });
    });

    // Edit submit -> POST to server
    document.getElementById('editForm').addEventListener('submit', function(e){
  e.preventDefault();
    // client-side validation for edit form: email, NIN, telephone (use inline messages)
  const emailEl = this.querySelector('input[name="email"]');
  const ninEl = this.querySelector('input[name="nin"]');
  const telEl = this.querySelector('input[name="telephone"]');
  // clear previous inline messages
  const ninEditMsg = document.getElementById('ninErrorEditMsg'); if(ninEditMsg){ ninEditMsg.textContent=''; const wrap = document.getElementById('ninErrorEdit'); if(wrap) wrap.classList.add('hidden'); }
  // add tel error container for edit if missing
  let telEditErr = document.getElementById('telErrorEdit'); if(!telEditErr){ const wrap = document.getElementById('telephone_edit'); if(wrap){ const div = document.createElement('div'); div.id='telErrorEdit'; div.className='text-sm text-red-600 mt-1 hidden'; div.innerHTML = '<span class="material-icons" style="font-size:16px;vertical-align:middle;margin-right:6px;">error_outline</span><span id="telErrorEditMsg"></span>'; wrap.parentNode.insertBefore(div, wrap.nextSibling); telEditErr = div; } }
  if (emailEl && emailEl.value && !emailEl.checkValidity()) { let g = document.getElementById('editFormGlobalError'); if(!g){ g = document.createElement('div'); g.id='editFormGlobalError'; g.className='text-sm text-red-600 mt-2'; document.getElementById('editForm').insertBefore(g, document.getElementById('editForm').firstChild);} g.textContent = 'Email invalide'; return; }
  if (ninEl && ninEl.value && (!/^\d{18}$/.test(ninEl.value.trim()))) { const ne = document.getElementById('ninErrorEdit'); const nem = document.getElementById('ninErrorEditMsg'); if(ne && nem){ nem.textContent='Le NIN doit contenir exactement 18 chiffres'; ne.classList.remove('hidden'); ninEl.focus(); } return; }
  if (telEl && telEl.value){ const digits = telEl.value.replace(/\D/g,''); if(!/^\d{10,11}$/.test(digits)){ const te = document.getElementById('telErrorEditMsg'); const telWrap = document.getElementById('telErrorEdit'); if(te && telWrap){ te.textContent = 'Le téléphone doit contenir 10 ou 11 chiffres'; telWrap.classList.remove('hidden'); telEl.focus(); } return; } }
      const form = e.target;
      const data = new FormData(form);
  // include id
  const idInput = form.querySelector('input[name="id"]');
  const id = idInput ? idInput.value : '';
  if (id) data.append('id', id);
      fetch('/etudiants/edit/', {
        method: 'POST', headers: { 'X-CSRFToken': csrftoken }, body: data, credentials: 'same-origin'
      }).then(r => {
        if (!r.ok) return r.text().then(text => { throw new Error(text || r.statusText); });
        return r.json();
      }).then(json => {
        if (json.success) {
          const s = json.student;
          updateStudentRow(s);
          // show a small success toast
          try{
            const toast = document.createElement('div');
            toast.className = 'text-sm py-2 px-3 rounded shadow-md';
            toast.style.position = 'fixed';
            toast.style.right = '18px';
            toast.style.top = '18px';
            toast.style.color = '#fff';
            toast.style.zIndex = 120;
            let msg = json.message || 'Modifié avec succès';
            if (typeof json.email_scheduled !== 'undefined' && json.email_scheduled){
              msg += ' — Email planifié';
              toast.style.background = '#10b981';
            } else {
              toast.style.background = '#10b981';
            }
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(()=>{ try{ toast.remove(); }catch(e){} }, 3200);
          }catch(e){}
          // always close the modal after handling success
          closeEditModal();
        } else {
          const ninErrEl = document.getElementById('ninErrorEdit');
          const serverMsg = String(json.error || json.message || ''); const lowerSrv = serverMsg.toLowerCase();
          if (ninErrEl) {
            if (lowerSrv.indexOf('nin') !== -1 || lowerSrv.indexOf('déjà utilisé') !== -1) {
              // NIN-specific error: inline and clear any global banner
              const ninErrMsg3 = document.getElementById('ninErrorEditMsg'); if(ninErrMsg3) ninErrMsg3.textContent = serverMsg; ninErrEl.classList.remove('hidden'); const gRem = document.getElementById('editFormGlobalError'); if(gRem) gRem.remove();
            } else {
              // clear field-specific and show global error
              const ninErrMsgClear2 = document.getElementById('ninErrorEditMsg'); if(ninErrMsgClear2) ninErrMsgClear2.textContent=''; ninErrEl.classList.add('hidden'); const telRem = document.getElementById('telErrorEdit'); if(telRem) { const tmsg = document.getElementById('telErrorEditMsg'); if(tmsg) tmsg.textContent=''; telRem.classList.add('hidden'); }
              let g = document.getElementById('editFormGlobalError');
              if(!g){ g = document.createElement('div'); g.id='editFormGlobalError'; g.className='text-sm text-red-600 mt-2'; document.getElementById('editForm').insertBefore(g, document.getElementById('editForm').firstChild); }
              g.textContent = 'Erreur: ' + (serverMsg || 'Impossible de modifier');
            }
          } else {
            let g = document.getElementById('editFormGlobalError');
            if(!g){ g = document.createElement('div'); g.id='editFormGlobalError'; g.className='text-sm text-red-600 mt-2'; document.getElementById('editForm').insertBefore(g, document.getElementById('editForm').firstChild); }
            g.textContent = 'Erreur: ' + (serverMsg || 'Impossible de modifier');
          }
        }
      }).catch(err => { console.error(err);
        try{
          const raw = (err && err.message) ? String(err.message) : 'réseau'; let parsed=null; try{ parsed = JSON.parse(raw); }catch(e){ parsed = null; }
          const msg = parsed && (parsed.error||parsed.message) ? (parsed.error||parsed.message) : raw;
          const lower = (String(msg||'')).toLowerCase();
          if(lower.indexOf('nin') !== -1 || lower.indexOf('déjà utilisé') !== -1 || lower.indexOf('numéro d\'ident') !== -1){
            const ninErr = document.getElementById('ninErrorEdit'); const ninMsg = document.getElementById('ninErrorEditMsg'); if(ninErr && ninMsg){ ninMsg.textContent = msg; ninErr.classList.remove('hidden'); }
          } else if(lower.indexOf('tel') !== -1 || lower.indexOf('télé') !== -1){
            const telWrap = document.getElementById('telErrorEdit'); const telMsg = document.getElementById('telErrorEditMsg'); if(telWrap && telMsg){ telMsg.textContent = msg; telWrap.classList.remove('hidden'); }
          } else {
            let g = document.getElementById('editFormGlobalError');
            if(!g){ g = document.createElement('div'); g.id='editFormGlobalError'; g.className='text-sm text-red-600 mt-2'; document.getElementById('editForm').insertBefore(g, document.getElementById('editForm').firstChild); }
            g.textContent = 'Erreur serveur: ' + msg;
          }
        }catch(e){}
      });
    });

    // Helpers to add/update DOM rows/cards
    function appendStudentRow(s){
      const tbody = document.getElementById('studentsTbody');
      const tr = document.createElement('tr');
  tr.className = 'border-b student-row';
      tr.dataset.id = s.id;
      tr.dataset.name = (s.nom||'') + ' ' + (s.prenom||'');
  tr.dataset.nom_arabe = s.nom_arabe || '';
  tr.dataset.prenom_arabe = s.prenom_arabe || '';
      tr.dataset.email = s.email || '';
      tr.dataset.phone = s.telephone || '';
  tr.dataset.sexe = s.sexe || '';
  tr.dataset.date_naissance = s.date_naissance || '';
  tr.dataset.lieu_naissance = s.lieu_naissance || '';
  tr.dataset.nationalite = s.nationalite || '';
  tr.dataset.nin = s.nin || '';
  tr.dataset.remarques = s.remarques || '';
  tr.dataset.extrait = s.extrait_naissance_photo || s.extrait || '';
  tr.dataset.carte = s.carte_identite_photo || s.carte || '';
  tr.dataset.verify = s.verification_step || 0;
      tr.dataset.formation = s.formation || '';
      tr.dataset.status = s.statut || 'Actif';
      tr.dataset.photo = s.photo || '';
      const remaining = formatDA(s.remaining || 0);
      tr.innerHTML = `
        <td class="px-6 py-4 font-mono text-sm">${s.id}</td>
        <td class="px-6 py-4"><img src="${s.photo || DEFAULT_AVATAR}" class="w-10 h-10 rounded-full"/></td>
        <td class="px-6 py-4 font-semibold">${s.nom || ''} ${s.prenom || ''}
          <div class="text-xs text-gray-500">${s.email || ''}</div>
        </td>
        <td class="px-6 py-4">${s.telephone || s.mobile || s.phone || '-'}</td>
        <td class="px-6 py-4">${s.adresse || '-'}</td>
    <td class="px-6 py-4 text-red-600 font-semibold">${remaining}</td>
  <td class="px-6 py-4"><span class="${s.inscription_status=='inscrit' ? 'status-actif' : 'status-inactif'} px-3 py-1 rounded-full text-xs font-semibold" role="button" tabindex="0">${s.inscription_status=='inscrit' ? 'Inscrit' : 'Non inscrit'}</span></td>
  <td class="px-6 py-4">${ Number(s.verification_step || 0) === 3 ? '<span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Vérifié</span>' : '<span class="status-inactif px-3 py-1 rounded-full text-xs font-semibold">Non vérifié</span>' }</td>
    <td class="px-6 py-4 text-right">
         
          <!-- Edit/Verify removed in favor of status-badge interactions; keep delete only -->
          <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
            <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
              <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
              <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
            </svg>
          </button>
        </td>
      `;
    tbody.prepend(tr);
  // make any date icons interactive on newly added row
  attachDateIconHandlers(tr);
    }

    function updateStudentRow(s){
      const selector = `tr[data-id="${s.id}"]`;
      const tr = document.querySelector(selector);
  if (!tr) return;
      tr.dataset.name = (s.nom||'') + ' ' + (s.prenom||'');
  tr.dataset.nom_arabe = s.nom_arabe || '';
  tr.dataset.prenom_arabe = s.prenom_arabe || '';
      tr.dataset.email = s.email || '';
      tr.dataset.phone = s.telephone || '';
  tr.dataset.sexe = s.sexe || '';
  tr.dataset.date_naissance = s.date_naissance || '';
  tr.dataset.lieu_naissance = s.lieu_naissance || '';
  tr.dataset.nationalite = s.nationalite || '';
  tr.dataset.nin = s.nin || '';
  tr.dataset.remarques = s.remarques || '';
  tr.dataset.extrait = s.extrait_naissance_photo || s.extrait || '';
  tr.dataset.carte = s.carte_identite_photo || s.carte || '';
  tr.dataset.verify = s.verification_step || 0;
      tr.dataset.formation = s.formation || '';
      tr.dataset.status = s.statut || 'Actif';
  const remainingU = formatDA(s.remaining || 0);
      tr.classList.add('student-row');
      tr.classList.add('student-row');
      tr.innerHTML = `
        <td class="px-6 py-4 font-mono text-sm">${s.id}</td>
  <td class="px-6 py-4"><img src="${s.photo || DEFAULT_AVATAR}" class="w-10 h-10 rounded-full"/></td>
        <td class="px-6 py-4 font-semibold">${s.nom || ''} ${s.prenom || ''}
          <div class="text-xs text-gray-500">${s.email || ''}</div>
        </td>
        <td class="px-6 py-4">${s.telephone || s.mobile || s.phone || '-'}</td>
        <td class="px-6 py-4">${s.adresse || '-'}</td>
        <td class="px-6 py-4 text-red-600 font-semibold">${remainingU}</td>
        <td class="px-6 py-4"><span class="${s.inscription_status=='inscrit' ? 'status-actif' : 'status-inactif'} px-3 py-1 rounded-full text-xs font-semibold" role="button" tabindex="0">${s.inscription_status=='inscrit' ? 'Inscrit' : 'Non inscrit'}</span></td>
        <td class="px-6 py-4">${ Number(s.verification_step || 0) === 3 ? '<span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Vérifié</span>' : '<span class="status-inactif px-3 py-1 rounded-full text-xs font-semibold">Non vérifié</span>' }</td>
              <td class="px-6 py-4 text-right">
          <button class="row-print-btn icon-btn" title="Imprimer" aria-label="Imprimer" data-id="${s.id}" data-tooltip="Imprimer">
            <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M6 9V3h12v6" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
              <rect x="3" y="9" width="18" height="10" rx="2" stroke="#4f46e5" stroke-width="1.2" fill="#f8fafc"/>
              <path d="M8 13h8" stroke="#4f46e5" stroke-width="1.4" stroke-linecap="round"/>
            </svg>
          </button>
          <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
            <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12z" fill="#ef4444"/><path d="M19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="#ef4444"/></svg>
          </button>
        </td>
      `;
  // attachEditHandlers is not required here because we removed edit/verify buttons; badge clicks are handled by delegated listener
  // rebind date icon handlers for the updated row
  attachDateIconHandlers(tr);
    }

    // Filters: search (by name, phone, address) and status
    document.getElementById('searchInput').addEventListener('input', function(){
      const q = (this.value || '').trim().toLowerCase();
      // handle both table rows and card elements which use class .student-row
      document.querySelectorAll('.student-row').forEach(el => {
        const name = (el.dataset.name || '').toLowerCase();
        const phone = (el.dataset.phone || '').toLowerCase();
        const addr = (el.dataset.address || '').toLowerCase();
        const match = !q || name.includes(q) || phone.includes(q) || addr.includes(q);
        // preserve display for either tr or div
        el.style.display = match ? '' : 'none';
      });
    });

    // --- Verification fiche modal ---
    // create modal element
    const verifyModal = document.createElement('div');
    verifyModal.id = 'verifyModal';
    verifyModal.className = 'hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop';
    verifyModal.innerHTML = `
      <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-4xl p-6" style="max-height:88vh;overflow:auto;">
        <div style="position:sticky;top:0;z-index:60;background:#fff;padding:10px 12px;border-bottom:1px solid #eef2f7;margin-bottom:12px;">
          <div id="verifyProgress" style="display:flex;gap:12px;margin:0;padding:0 6px;align-items:center;width:100%;justify-content:space-between;"> <!-- steps inserted here --> </div>
        </div>
        <div class="flex justify-between items-center mb-2" style="margin-top:8px;">
          <h3 class="text-lg font-semibold">Fiche vérification</h3>
          <div class="verify-top-actions">
            <button id="verifyCancelTop" class="btn-secondary">Annuler</button>
            <button id="closeVerify" class="icon-btn">✕</button>
          </div>
        </div>
        <div id="verifyContent" style="padding-top:8px;">
          <div style="display:flex;gap:20px;align-items:flex-start;">
            <div style="flex:1; display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px;">
              <div style="">
                <div style="font-size:12px;color:#6b7280;font-weight:700;">Nom</div>
                <div id="v_nom" style="font-size:14px;color:#111827;font-weight:600;"></div>
              </div>
              <div>
                <div style="font-size:12px;color:#6b7280;font-weight:700;">Prénom</div>
                <div id="v_prenom" style="font-size:14px;color:#111827;font-weight:600;"></div>
              </div>
              <div>
                <div style="font-size:12px;color:#6b7280;font-weight:700;">Sexe</div>
                <div id="v_sexe" style="font-size:14px;color:#111827;"></div>
              </div>
              <div>
                <div style="font-size:12px;color:#6b7280;font-weight:700;">Date de naissance</div>
                <div id="v_dob" style="font-size:14px;color:#111827;"></div>
              </div>
              <div>
                <div style="font-size:12px;color:#6b7280;font-weight:700;">Lieu</div>
                <div id="v_lieu" style="font-size:14px;color:#111827;"></div>
              </div>
              <div>
                <div style="font-size:12px;color:#6b7280;font-weight:700;">Nationalité</div>
                <div id="v_nat" style="font-size:14px;color:#111827;"></div>
              </div>
              <div>
                <div style="font-size:12px;color:#6b7280;font-weight:700;">NIN</div>
                <div id="v_nin" style="font-size:14px;color:#111827;"></div>
              </div>
              <div>
                <div style="font-size:12px;color:#6b7280;font-weight:700;">Email</div>
                <div id="v_email" style="font-size:14px;color:#111827;"></div>
              </div>
              <div style="grid-column: 1 / -1;">
                <div style="font-size:12px;color:#6b7280;font-weight:700;">Adresse</div>
                <div id="v_addr" style="font-size:14px;color:#111827;"></div>
              </div>
            </div>
            <div style="width:220px;text-align:center;flex-shrink:0;">
              <img id="v_photo" src="images/happy.gif" style="width:220px;height:220px;border-radius:12px;object-fit:cover;"/>
            </div>
          </div>
          <hr style="margin:12px 0"/>
          <div>
            <h4 class="font-semibold">Documents</h4>
            <div style="display:flex;gap:12px;margin-top:8px;align-items:flex-start;">
              <div style="flex:1">
                <div><strong>Extrait de naissance</strong></div>
                <div id="v_extrait_preview" style="margin-top:6px;"></div>
                <div style="margin-top:6px;display:flex;gap:8px;align-items:center;">
                  <label class="file-picker">
                    <span class="file-label">Choisir un fichier</span>
                    <input class="file-input" id="picker_extrait" type="file" accept="image/*" />
                  </label>
                  <button id="upload_extrait_btn" class="upload-btn">Upload</button>
                  <div id="extrait_filename" style="font-size:13px;color:#6b7280;">Aucun fichier choisi</div>
                </div>
              </div>
              <div style="flex:1">
                <div><strong>Carte d'identité</strong></div>
                <div id="v_carte_preview" style="margin-top:6px;"></div>
                <div style="margin-top:6px;display:flex;gap:8px;align-items:center;">
                  <label class="file-picker">
                    <span class="file-label">Choisir un fichier</span>
                    <input class="file-input" id="picker_carte" type="file" accept="image/*" />
                  </label>
                  <button id="upload_carte_btn" class="upload-btn">Upload</button>
                  <div id="carte_filename" style="font-size:13px;color:#6b7280;">Aucun fichier choisi</div>
                </div>
              </div>
            </div>
          </div>
          <div style="margin-top:12px;text-align:right;">
            <div class="step-controls">
              <button id="stepBack" class="step-btn" title="Précédent">Précédent</button>
              <button id="stepNext" class="step-btn primary" title="Suivant">Suivant</button>
              <button id="verifySave" class="step-btn primary" style="margin-left:4px;">Enregistrer</button>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(verifyModal);

  let currentVerifyId = null;
  let currentVerifyStep = 0; // keeps the current numeric step for Next/Prev actions
  let _editDelegate = null;

  // Custom styled datalist dropdown to ensure consistent appearance inside modals
  (function(){
    const STYLE_ID = 'custom-datalist-styles';
    if (!document.getElementById(STYLE_ID)){
      const s = document.createElement('style'); s.id = STYLE_ID; s.textContent = `
      .custom-datalist { position: absolute; z-index: 99999; background: #fff; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 10px 30px rgba(2,6,23,0.08); border-radius:8px; overflow:auto; max-height:320px; font-size:14px; color:#111827; }
      .custom-datalist .item { padding:10px 14px; cursor:pointer; border-bottom:1px solid rgba(0,0,0,0.04); }
      .custom-datalist .item:hover, .custom-datalist .item.active{ background: #f8fafc; }
      `; document.head.appendChild(s);
    }

    function buildDropdown(input){
      const listId = input.getAttribute('list');
      if (!listId) return null;
      const dl = document.getElementById(listId);
      if (!dl) return null;
      // collect options and remove duplicates (case-insensitive, trimmed)
      const raw = Array.from(dl.querySelectorAll('option')).map(o=> (o.value||o.textContent||'').toString());
      const seen = new Set();
      const opts = [];
      raw.forEach(v => {
        const key = (v||'').trim().toLowerCase();
        if (!key) return;
        if (!seen.has(key)) { seen.add(key); opts.push({ value: v }); }
      });
      const box = document.createElement('div'); box.className = 'custom-datalist'; box.style.display='none'; document.body.appendChild(box);
      function render(filter){
        box.innerHTML = '';
        const f = (filter||'').toLowerCase();
        const matches = opts.filter(o=> o.value.toLowerCase().includes(f));
        matches.forEach(o=>{ const it = document.createElement('div'); it.className='item'; it.textContent = o.value; it.dataset.value = o.value; box.appendChild(it); });
        if (!matches.length){ const it = document.createElement('div'); it.className='item'; it.textContent='(Aucune suggestion)'; it.style.opacity=0.6; box.appendChild(it); }
      }
      function position(){
        const r = input.getBoundingClientRect(); const docEl = document.documentElement; const scrollTop = window.scrollY || docEl.scrollTop; const scrollLeft = window.scrollX || docEl.scrollLeft;
        box.style.minWidth = Math.max(r.width, 220) + 'px';
        box.style.left = (r.left + scrollLeft) + 'px';
        // prefer showing below input; if not enough space, show above
        const belowSpace = window.innerHeight - r.bottom; const aboveSpace = r.top;
        if (belowSpace > 200 || belowSpace >= aboveSpace){ box.style.top = (r.bottom + scrollTop + 6) + 'px'; }
        else { box.style.top = (r.top + scrollTop - box.offsetHeight - 6) + 'px'; }
      }
      let activeIdx = -1;
      // store original list value so we can restore it when hiding custom dropdown
      try { input.__origList = input.getAttribute && input.getAttribute('list'); } catch(e){ input.__origList = null; }
      const showCustom = ()=>{ try{ if (input.hasAttribute && input.hasAttribute('list')){ input.removeAttribute('list'); input.__listRemoved = true; } }catch(_){}; render(input.value); position(); box.style.display='block'; activeIdx = -1; };
      const hideCustom = ()=>{ box.style.display='none'; try{ if (input.__listRemoved && input.__origList){ input.setAttribute('list', input.__origList); input.__listRemoved = false; } }catch(_){} };

      input.addEventListener('input', e=>{ showCustom(); });
      input.addEventListener('focus', e=>{ showCustom(); });
      input.addEventListener('blur', e=>{ setTimeout(hideCustom, 180); });
      box.addEventListener('mousedown', e=>{ // use mousedown so blur hasn't hidden it yet
        const it = e.target.closest('.item'); if(!it) return; const v = it.dataset.value; if (v) input.value = v; hideCustom(); input.focus(); e.preventDefault(); });
      input.addEventListener('keydown', e=>{
        const items = Array.from(box.querySelectorAll('.item')).filter(i=> i.dataset.value);
        if (!items.length) return;
        if (e.key === 'ArrowDown'){ e.preventDefault(); activeIdx = Math.min(activeIdx+1, items.length-1); items.forEach((it,i)=> it.classList.toggle('active', i===activeIdx)); items[activeIdx].scrollIntoView({block:'nearest'}); }
        else if (e.key === 'ArrowUp'){ e.preventDefault(); activeIdx = Math.max(activeIdx-1, 0); items.forEach((it,i)=> it.classList.toggle('active', i===activeIdx)); items[activeIdx].scrollIntoView({block:'nearest'}); }
        else if (e.key === 'Enter'){ if (activeIdx>=0 && items[activeIdx]){ e.preventDefault(); input.value = items[activeIdx].dataset.value; hideCustom(); } }
      });
      // reposition on resize/scroll
      window.addEventListener('resize', position); window.addEventListener('scroll', position, true);
      return box;
    }

    // Bind to inputs inside modals and also top-level inputs to keep Add behaviour
    const selector = 'input[list]';
    document.querySelectorAll(selector).forEach(inp=>{ try{ buildDropdown(inp); }catch(e){ /* ignore */ } });
  })();

    function renderProgress(step){
      const labels = ['Info personnelles','Documents','Email','Vérifié'];
      const c = document.getElementById('verifyProgress');
      c.innerHTML = '';
      // update the tracked step so other controls can rely on it
      currentVerifyStep = Number(step) || 0;
      // make container a horizontal flex so we can insert connectors between steps
      c.style.display = 'flex';
      c.style.alignItems = 'center';
      c.style.gap = '8px';

      const connectors = [];
  labels.forEach((lbl, i)=>{
        const el = document.createElement('div');
        el.style.display = 'flex';
        el.style.flexDirection = 'column';
        el.style.alignItems = 'center';
        el.style.minWidth = '60px';
        // circle + label
  const active = i <= step;
  el.innerHTML = `<div class='verify-circle' style='width:30px;height:30px;border-radius:15px;border:2px solid ${active?"#10b981":"#e6e8eb"};display:flex;align-items:center;justify-content:center;background:${active?"#10b981":"transparent"};color:${active?"#fff":"#374151"};font-weight:700;transition:transform 250ms ease, background 250ms ease,border-color 250ms ease'>${i+1}</div><div style='font-size:12px;margin-top:8px;color:#374151;'>${lbl}</div>`;
        el.addEventListener('click', ()=>{ setVerifyStep(currentVerifyId, i); });
        c.appendChild(el);

        // create connector between this and next, except after last
        if (i < labels.length - 1){
          const conn = document.createElement('div');
          conn.className = 'verify-connector';
          conn.style.flex = '1 1 auto';
          conn.style.height = '6px';
          conn.style.borderRadius = '4px';
          conn.style.background = '#e6e8eb';
          conn.style.transform = 'scaleX(0)';
          conn.style.transformOrigin = 'left center';
          conn.style.transition = 'transform 420ms ease, background 420ms ease';
          // small wrapper so the layout spacing remains consistent
          const wrapper = document.createElement('div');
          wrapper.style.display = 'flex';
          wrapper.style.alignItems = 'center';
          wrapper.appendChild(conn);
          c.appendChild(wrapper);
          connectors.push({el: conn, index: i});
        }
      });

      // trigger animations: grow connectors up to current step
      // start collapsed then expand the active ones so the transition plays
      setTimeout(()=>{
        connectors.forEach(item => {
      if (item.index < currentVerifyStep){
        item.el.style.transform = 'scaleX(1)';
        item.el.style.background = '#10b981';
          } else {
            item.el.style.transform = 'scaleX(0)';
        item.el.style.background = '#e6e8eb';
          }
        });
        // subtle pulse on the active circle
        try{
          const activeCircle = c.querySelectorAll('.verify-circle')[currentVerifyStep];
          if (activeCircle){
            activeCircle.style.transform = 'scale(1.06)';
            setTimeout(()=>{ activeCircle.style.transform = 'scale(1)'; }, 220);
          }
        }catch(e){/* ignore */}
      }, 30);
  // update Prev/Next disabled state
  try{ updateStepButtons(); }catch(e){/* ignore if not defined yet */}
    }

  function openVerifyModal(id){
      currentVerifyId = id;
      console.debug('[verify] openVerifyModal start id=', id);
      verifyModal.classList.remove('hidden'); document.body.style.overflow = 'hidden';
      fetch(`/etudiants/${id}/json/`).then(r=>{
        if (!r.ok) return r.text().then(t=>{ throw new Error(t||r.statusText); });
        return r.json();
      }).then(json=>{
        console.debug('[verify] etudiant_detail_json', json);
        if (!json.success) return alert('Erreur chargement');
        const e = json.etudiant;
  document.getElementById('v_nom').textContent = e.nom || '';
        document.getElementById('v_prenom').textContent = e.prenom || '';
        document.getElementById('v_sexe').textContent = e.sexe || '';
        // show a human-friendly date (DD/MM/YYYY) when possible
        function formatDateForDisplay(raw){
          if(!raw) return '';
          try{
            const iso = (typeof normalizeDateToISO === 'function') ? normalizeDateToISO(raw) : raw;
            if(/^\d{4}-\d{2}-\d{2}$/.test(iso)){ const p = iso.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; }
            return raw;
          }catch(e){ return raw || ''; }
        }
        document.getElementById('v_dob').textContent = formatDateForDisplay(e.date_naissance || '');
        document.getElementById('v_lieu').textContent = e.lieu_naissance || '';
        document.getElementById('v_nat').textContent = e.nationalite || '';
        document.getElementById('v_nin').textContent = e.nin || '';
  document.getElementById('v_addr').textContent = e.adresse || '';
  document.getElementById('v_email').textContent = e.email || '';
  // photo
  const photoUrl = e.photo_url || (e.photo ? ('/' + e.photo) : DEFAULT_AVATAR);
  document.getElementById('v_photo').src = photoUrl;
  // extrait
  const extraitUrl = e.extrait_naissance_photo_url || (e.extrait_naissance_photo ? ('/' + e.extrait_naissance_photo) : '');
  if (extraitUrl){ document.getElementById('v_extrait_preview').innerHTML = `<img src="${extraitUrl}" style="max-width:180px;max-height:140px;"/>`; if(document.getElementById('extrait_filename')) document.getElementById('extrait_filename').textContent = extractBasename(extraitUrl); } else { document.getElementById('v_extrait_preview').innerHTML = '<div class="muted">Aucun</div>'; if(document.getElementById('extrait_filename')) document.getElementById('extrait_filename').textContent = 'Aucun fichier choisi'; }
  // carte
  const carteUrl = e.carte_identite_photo_url || (e.carte_identite_photo ? ('/' + e.carte_identite_photo) : '');
  if (carteUrl){ document.getElementById('v_carte_preview').innerHTML = `<img src="${carteUrl}" style="max-width:180px;max-height:140px;"/>`; if(document.getElementById('carte_filename')) document.getElementById('carte_filename').textContent = extractBasename(carteUrl); } else { document.getElementById('v_carte_preview').innerHTML = '<div class="muted">Aucun</div>'; if(document.getElementById('carte_filename')) document.getElementById('carte_filename').textContent = 'Aucun fichier choisi'; }
  // initialize the tracked step then render
  currentVerifyStep = Number(e.verification_step) || 0;
  renderProgress(currentVerifyStep);
      }).catch(err=>{ console.error(err); alert('Erreur chargement'); });
    }

    document.addEventListener('click', function(e){
      const v = e.target.closest('.verify-btn');
      if (v){ const id = v.dataset.id; openVerifyModal(id); }
    });

    // Clicking the status badge should open the verification modal (table rows and cards)
    document.addEventListener('click', function(e){
      const badge = e.target.closest('.status-actif, .status-inactif');
      if (!badge) return;
      // prevent clicks on links inside badges (if any)
      if (e.target.closest('a')) return;
      const row = badge.closest('[data-id]');
      if (!row) return;
      const id = row.dataset.id;
      try{ openVerifyModal(id); }catch(err){ console.warn('openVerifyModal failed', err); }
    });

    // Keyboard accessibility: Enter/Space on the status badge opens verify modal
    document.addEventListener('keydown', function(e){
      if (e.key !== 'Enter' && e.key !== ' ') return;
      const active = document.activeElement;
      if (!active) return;
      if (!active.classList.contains('status-actif') && !active.classList.contains('status-inactif')) return;
      e.preventDefault();
      const row = active.closest('[data-id]'); if (!row) return; const id = row.dataset.id; try{ openVerifyModal(id); }catch(err){ console.warn('openVerifyModal failed', err); }
    });

  document.getElementById('closeVerify').addEventListener('click', ()=>{ console.debug('[verify] close clicked'); verifyModal.classList.add('hidden'); });
  document.getElementById('verifyCancelTop').addEventListener('click', ()=>{ console.debug('[verify] cancel top clicked'); verifyModal.classList.add('hidden'); });

  // restore body scrolling when modal closes
  function closeVerifyModal(){ verifyModal.classList.add('hidden'); try{ document.body.style.overflow = ''; }catch(e){} }
  document.getElementById('closeVerify').addEventListener('click', closeVerifyModal);
  document.getElementById('verifyCancelTop').addEventListener('click', closeVerifyModal);

  function extractBasename(path){ if(!path) return ''; try{ const parts = String(path).split(/[\\/]/); return parts[parts.length-1].substr(0,60); }catch(e){ return path; } }

    // file picker display handlers
    const pickerEx = document.getElementById('picker_extrait');
    const pickerCa = document.getElementById('picker_carte');
    const extraitFilename = document.getElementById('extrait_filename');
    const carteFilename = document.getElementById('carte_filename');
    if (pickerEx){ pickerEx.addEventListener('change', function(){ const f = this.files[0]; extraitFilename.textContent = f ? f.name : 'Aucun fichier choisi'; console.debug('[verify] picker_extrait change', f && f.name); }); }
    if (pickerCa){ pickerCa.addEventListener('change', function(){ const f = this.files[0]; carteFilename.textContent = f ? f.name : 'Aucun fichier choisi'; console.debug('[verify] picker_carte change', f && f.name); }); }

    // delegated handlers (robust if elements are recreated)
    document.addEventListener('click', function delegatedUploads(e){
      const btn = e.target.closest('#upload_extrait_btn');
  if (btn){ e.preventDefault(); console.debug('[verify] upload_extrait_btn clicked'); const f = (document.getElementById('picker_extrait')||{}).files && document.getElementById('picker_extrait').files[0]; if(!f){ const preview = document.getElementById('v_extrait_preview'); let m = document.getElementById('v_extrait_error'); if(!m){ m = document.createElement('div'); m.id='v_extrait_error'; m.className='text-sm text-red-600 mt-1'; preview.parentNode.insertBefore(m, preview.nextSibling); } m.textContent = 'Choisir un fichier'; return; } try{ const r = new FileReader(); r.onload = ev => { document.getElementById('v_extrait_preview').innerHTML = `<img src="${ev.target.result}" style="max-width:180px;max-height:140px;"/>`; }; r.readAsDataURL(f); }catch(e){} const fd = new FormData(); fd.append('file', f); fd.append('type', 'extrait'); fetch(`/etudiants/${currentVerifyId}/upload-doc/`, { method:'POST', body: fd, credentials:'same-origin', headers: { 'X-CSRFToken': csrftoken } }).then(r=>{ if (!r.ok) return r.text().then(t=>{ throw new Error(t||r.statusText); }); return r.json(); }).then(json=>{ console.debug('[verify] upload_extrait response', json); if (json.success){ const url = json.url || ('/' + (json.path||'')).replace(/\\/g,'/'); document.getElementById('v_extrait_preview').innerHTML = `<img src="${url}" style="max-width:180px;max-height:140px;"/>`; if (document.getElementById('extrait_filename')) document.getElementById('extrait_filename').textContent = 'Aucun fichier choisi'; if (document.getElementById('picker_extrait')) document.getElementById('picker_extrait').value = ''; const errEl = document.getElementById('v_extrait_error'); if(errEl) errEl.remove(); } else { const preview = document.getElementById('v_extrait_preview'); let m = document.getElementById('v_extrait_error'); if(!m){ m = document.createElement('div'); m.id='v_extrait_error'; m.className='text-sm text-red-600 mt-1'; preview.parentNode.insertBefore(m, preview.nextSibling); } m.textContent = 'Erreur upload: '+(json.error||''); } }).catch(err=>{ console.error(err); const preview = document.getElementById('v_extrait_preview'); let m = document.getElementById('v_extrait_error'); if(!m){ m = document.createElement('div'); m.id='v_extrait_error'; m.className='text-sm text-red-600 mt-1'; preview.parentNode.insertBefore(m, preview.nextSibling); } m.textContent = 'Erreur upload'; }); return; }
      const btn2 = e.target.closest('#upload_carte_btn');
  if (btn2){ e.preventDefault(); console.debug('[verify] upload_carte_btn clicked'); const f = (document.getElementById('picker_carte')||{}).files && document.getElementById('picker_carte').files[0]; if(!f){ const preview = document.getElementById('v_carte_preview'); let m = document.getElementById('v_carte_error'); if(!m){ m = document.createElement('div'); m.id='v_carte_error'; m.className='text-sm text-red-600 mt-1'; preview.parentNode.insertBefore(m, preview.nextSibling); } m.textContent = 'Choisir un fichier'; return; } try{ const r = new FileReader(); r.onload = ev => { document.getElementById('v_carte_preview').innerHTML = `<img src="${ev.target.result}" style="max-width:180px;max-height:140px;"/>`; }; r.readAsDataURL(f); }catch(e){} const fd = new FormData(); fd.append('file', f); fd.append('type', 'carte'); fetch(`/etudiants/${currentVerifyId}/upload-doc/`, { method:'POST', body: fd, credentials:'same-origin', headers: { 'X-CSRFToken': csrftoken } }).then(r=>{ if (!r.ok) return r.text().then(t=>{ throw new Error(t||r.statusText); }); return r.json(); }).then(json=>{ console.debug('[verify] upload_carte response', json); if (json.success){ const url = json.url || ('/' + (json.path||'')).replace(/\\/g,'/'); document.getElementById('v_carte_preview').innerHTML = `<img src="${url}" style="max-width:180px;max-height:140px;"/>`; if (document.getElementById('carte_filename')) document.getElementById('carte_filename').textContent = 'Aucun fichier choisi'; if (document.getElementById('picker_carte')) document.getElementById('picker_carte').value = ''; const errEl = document.getElementById('v_carte_error'); if(errEl) errEl.remove(); } else { const preview = document.getElementById('v_carte_preview'); let m = document.getElementById('v_carte_error'); if(!m){ m = document.createElement('div'); m.id='v_carte_error'; m.className='text-sm text-red-600 mt-1'; preview.parentNode.insertBefore(m, preview.nextSibling); } m.textContent = 'Erreur upload: '+(json.error||''); } }).catch(err=>{ console.error(err); const preview = document.getElementById('v_carte_preview'); let m = document.getElementById('v_carte_error'); if(!m){ m = document.createElement('div'); m.id='v_carte_error'; m.className='text-sm text-red-600 mt-1'; preview.parentNode.insertBefore(m, preview.nextSibling); } m.textContent = 'Erreur upload'; }); return; }
    });

    // Legacy form-based upload handlers — guard in case forms exist (we now use styled pickers)
    const legacyUploadEx = document.getElementById('upload_extrait');
    if (legacyUploadEx){
      legacyUploadEx.addEventListener('submit', function(e){
        e.preventDefault();
        const f = e.target.querySelector('input[type=file]').files[0];
  if (!f){ const preview = document.getElementById('v_extrait_preview'); let m = document.getElementById('v_extrait_error'); if(!m){ m = document.createElement('div'); m.id='v_extrait_error'; m.className='text-sm text-red-600 mt-1'; preview.parentNode.insertBefore(m, preview.nextSibling); } m.textContent = 'Choisir un fichier'; return; }
        try{ const reader = new FileReader(); reader.onload = ev => { document.getElementById('v_extrait_preview').innerHTML = `<img src="${ev.target.result}" style="max-width:180px;max-height:140px;"/>`; }; reader.readAsDataURL(f); }catch(err){ console.debug('preview failed', err); }
        const fd = new FormData(); fd.append('file', f); fd.append('type', 'extrait');
        fetch(`/etudiants/${currentVerifyId}/upload-doc/`, { method:'POST', body: fd, credentials:'same-origin', headers: { 'X-CSRFToken': csrftoken } }).then(r => { if (!r.ok) return r.text().then(t => { throw new Error(t || r.statusText); }); return r.json(); }).then(json=>{ console.log('upload_extrait response', json); if (json.success){ if (json.url) { document.getElementById('v_extrait_preview').innerHTML = `<img src="${json.url}" style="max-width:180px;max-height:140px;"/>`; } else if (json.path) { const p = ('/' + String(json.path)).replace(/\\/g, '/'); document.getElementById('v_extrait_preview').innerHTML = `<img src="${p}" style="max-width:180px;max-height:140px;"/>`; } } else { alert('Erreur upload: '+(json.error||'')); } }).catch(err=>{ console.error(err); alert('Erreur upload'); });
      });
    }

    const legacyUploadCarte = document.getElementById('upload_carte');
    if (legacyUploadCarte){
      legacyUploadCarte.addEventListener('submit', function(e){
        e.preventDefault();
        const f = e.target.querySelector('input[type=file]').files[0];
  if (!f){ const preview = document.getElementById('v_carte_preview'); let m = document.getElementById('v_carte_error'); if(!m){ m = document.createElement('div'); m.id='v_carte_error'; m.className='text-sm text-red-600 mt-1'; preview.parentNode.insertBefore(m, preview.nextSibling); } m.textContent = 'Choisir un fichier'; return; }
        try{ const reader = new FileReader(); reader.onload = ev => { document.getElementById('v_carte_preview').innerHTML = `<img src="${ev.target.result}" style="max-width:180px;max-height:140px;"/>`; }; reader.readAsDataURL(f); }catch(err){ console.debug('preview failed', err); }
        const fd = new FormData(); fd.append('file', f); fd.append('type', 'carte');
        fetch(`/etudiants/${currentVerifyId}/upload-doc/`, { method:'POST', body: fd, credentials:'same-origin', headers: { 'X-CSRFToken': csrftoken } }).then(r => { if (!r.ok) return r.text().then(t => { throw new Error(t || r.statusText); }); return r.json(); }).then(json=>{ console.log('upload_carte response', json); if (json.success){ if (json.url) { document.getElementById('v_carte_preview').innerHTML = `<img src="${json.url}" style="max-width:180px;max-height:140px;"/>`; } else if (json.path) { const p = ('/' + String(json.path)).replace(/\\/g, '/'); document.getElementById('v_carte_preview').innerHTML = `<img src="${p}" style="max-width:180px;max-height:140px;"/>`; } } else { alert('Erreur upload: '+(json.error||'')); } }).catch(err=>{ console.error(err); alert('Erreur upload'); });
      });
    }

    // Save button in verify modal: simply close the modal (state already persisted by uploads/step changes)
    document.getElementById('verifySave').addEventListener('click', function(){ verifyModal.classList.add('hidden'); });

    // step controls
    function setVerifyStep(id, step){
      const targetId = id || currentVerifyId;
      if (!targetId) return alert('Aucun étudiant sélectionné');
      const fd = new FormData(); fd.append('step', step);
      fetch(`/etudiants/${targetId}/update-step/`, { method:'POST', body: fd, credentials:'same-origin', headers: { 'X-CSRFToken': csrftoken } }).then(r=>{
        if (!r.ok) return r.text().then(t=>{ throw new Error(t||r.statusText); });
        return r.json();
      }).then(json=>{
        if (json.success){
          renderProgress(json.step);
        } else { alert('Erreur étape'); }
      }).catch(err=>{ console.error('setVerifyStep', err); alert('Erreur mise à jour'); });
    }

    function updateStepButtons(){
      const back = document.getElementById('stepBack');
      const next = document.getElementById('stepNext');
      if (!back || !next) return;
      back.disabled = (currentVerifyStep <= 0);
      next.disabled = (currentVerifyStep >= 3);
      if (back.disabled) back.classList.add('disabled'); else back.classList.remove('disabled');
      if (next.disabled) next.classList.add('disabled'); else next.classList.remove('disabled');
    }

    document.getElementById('stepNext').addEventListener('click', function(){ if (currentVerifyId !== null){ const next = Math.min(3, Number(currentVerifyStep) + 1); setVerifyStep(currentVerifyId, next); } });
    document.getElementById('stepBack').addEventListener('click', function(){ if (currentVerifyId !== null){ const prev = Math.max(0, Number(currentVerifyStep) - 1); setVerifyStep(currentVerifyId, prev); } });
    // Single-click on a student (card or table row) should open the edit modal.
    // We avoid interactive controls (links, buttons, inputs) and status badges which have their
    // own click handlers (they open the verification modal).
    document.addEventListener('click', function(e){
      // Ignore clicks on interactive controls so we don't intercept normal actions
      if (e.target.closest('a, button, input, textarea, select, .icon-btn')) return;
      // If click is on a status badge or inscription link, let the existing handler run (verify/inscription)
      if (e.target.closest('.status-actif, .status-inactif, .open-add-inscription')) return;
      const card = e.target.closest('.student-row');
      if (!card) return;
      try{ openEditModalWithRow(card); }catch(err){ console.warn('openEditModalWithRow failed', err); }
    });

    // Print preview modal (re-using rapports pattern)
    const studentPrintPreview = document.createElement('div');
    studentPrintPreview.id = 'studentPrintPreview';
    studentPrintPreview.className = 'hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40';
    studentPrintPreview.innerHTML = `
      <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-4xl p-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold">Prévisualiser - Cartes étudiants</h3>
          <div>
            <button id="studentPrintClose" class="btn-secondary px-3 py-1 rounded mr-2">Fermer</button>
            <button id="studentPrintExecute" class="btn-primary px-3 py-1 rounded">Imprimer</button>
          </div>
        </div>
        <div id="studentPrintContent" style="max-height:70vh;overflow:auto;padding:6px;border:1px solid #eef2f7;"></div>
      </div>
    `;
    document.body.appendChild(studentPrintPreview);

    document.getElementById('studentPrintClose').addEventListener('click', ()=>{ studentPrintPreview.classList.add('hidden'); });

    // Helper: fetch QR image as a base64 data URL (falls back to remote png if fetch fails)
    async function fetchQrDataUrl(text){
      try{
        const data = encodeURIComponent(String(text || ''));
        const api = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${data}`;
        const resp = await fetch(api);
        if (!resp.ok) throw new Error('QR fetch failed');
        const blob = await resp.blob();
        return await new Promise((res, rej) => {
          const reader = new FileReader();
          reader.onload = () => res(reader.result);
          reader.onerror = rej;
          reader.readAsDataURL(blob);
        });
      }catch(err){
        // If the external fetch fails, return null so caller can fallback to external URL
        console.warn('fetchQrDataUrl failed', err);
        return null;
      }
    }

    // Ensure media paths are absolute so they resolve inside a new print window
    function tryPrefixMedia(path){
      if(!path) return path || '';
      const p = String(path || '');
      try{
        if(p.startsWith('http') || p.startsWith('data:') || p.startsWith('/')) return p;
        const origin = window.location.origin || (location.protocol + '//' + location.host || '');
        return origin.replace(/\/+$/,'') + '/' + p.replace(/^\/+/, '');
      }catch(e){ return p; }
    }

    // Build card HTML for printing. Accepts an optional qrDataUrl (data:image/*;base64...) to inline the QR image.
    function buildPrintableCard(e, qrDataUrl){
      // Ensure fields exist and prefix media paths so they resolve in the print window
      const photo = tryPrefixMedia(e.photo_url || e.photo || DEFAULT_AVATAR);
  // Build a robust full name: prefer structured fields then fallbacks
  const nom = (e.nom || '').toString().trim();
  const prenom = (e.prenom || '').toString().trim();
  const fullNameFallback = (e.name || e.full_name || '').toString().trim();
  const name = ((nom || '') + ' ' + (prenom || '')).trim() || fullNameFallback || (e.display_name || '');
      const dateIns = e.date_inscription ? (new Date(e.date_inscription)).toLocaleDateString() : (e.date_inscription || '');
  // Prefer verification status (verification_step / verify) to indicate 'Vérifié' / 'Non vérifié'
  const verificationFlag = Number(e.verification_step || e.verify || e.verification || 0);
  const statutDisplay = (verificationFlag === 3) ? 'Vérifié' : 'Non vérifié';
      // prefer an inlined data URL (safer for print windows); otherwise fall back to external api URL
      const targetUrl = window.location.origin + '/etudiants/' + e.id + '/';
      const qrImg = qrDataUrl || `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(targetUrl)}`;

      // Build formations display: prefer structured inscriptions, then display_formation fallback
      let formations = [];
      if (Array.isArray(e.inscriptions) && e.inscriptions.length){
        // Show only the formation name (remove any date/year prefixes)
        formations = e.inscriptions.map(it => (it.formation || it.formation_name || it.nom || '').toString().trim()).filter(Boolean);
      } else if (e.formations && Array.isArray(e.formations) && e.formations.length){
        // ensure elements are strings and strip surrounding whitespace and any leading dates
        formations = e.formations.map(f => (''+f).replace(/^\s*\d{4}-?\d{0,2}-?\d{0,2}\s*-?\s*/, '').trim()).filter(Boolean);
      } else if (e.display_formation){
        formations = [e.display_formation];
      }

      // Build a safe HTML list for formations with a constrained max-height for many items
      let formationsHtml = '';
      if (formations.length){
        formationsHtml = `<div class="formations-list" style="margin-top:8px;max-height:96px;overflow:auto;padding:6px;border-top:1px solid #eef2f7;margin-left:0;">`;
        formationsHtml += `<div style="font-weight:700;font-size:12px;color:#0f172a;margin-bottom:6px">Formations</div>`;
        formationsHtml += '<ul style="margin:0;padding-left:16px;font-size:12px;color:#1f2937;line-height:1.25">';
        formations.forEach(it => { formationsHtml += `<li style="margin-bottom:4px">${it}</li>`; });
        formationsHtml += '</ul></div>';
      }

      // Card wrapper optimized for print: compact, flexible and consistent layout
      return `
        <div class="print-card" style="width:340px;min-height:180px;border:1px solid #e6eef6;padding:12px;border-radius:8px;margin:8px;display:inline-block;vertical-align:top;font-family:Arial,Helvetica,sans-serif;background:#fff;box-shadow:0 2px 6px rgba(2,6,23,0.04)">
          <div style="display:flex;gap:12px;align-items:flex-start">
            <div style="flex:0 0 86px">
              <img src="${photo}" style="width:86px;height:86px;object-fit:cover;border-radius:8px;border:1px solid #eef2f7;display:block"/>
            </div>
            <div style="flex:1;min-width:0">
              <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
                <div style="min-width:0">
                  <div style="font-weight:800;font-size:15px;color:#0f172a;white-space:normal;word-break:break-word;">${name}</div>
                  <div style="font-size:12px;color:#374151;margin-top:6px">ID: ${e.id || ''}</div>
                  <div style="font-size:12px;color:#6b7280;margin-top:6px">Date d'inscription: ${dateIns}</div>
                  <div style="font-size:12px;color:#6b7280;margin-top:6px">Statut: ${statutDisplay}</div>
                </div>
                <div style="flex:0 0 100px;text-align:center">
                  <img src="${qrImg}" alt="QR" style="width:90px;height:90px;object-fit:contain;border:1px solid #f1f5f9;padding:6px;background:#fff;border-radius:6px"/>
                </div>
              </div>
              ${formationsHtml}
            </div>
          </div>
        </div>
      `;
    }

  // When print button clicked, gather visible students and show preview
  const studentsPrintBtnEl = document.getElementById('studentsPrintBtn');
  if (studentsPrintBtnEl) studentsPrintBtnEl.addEventListener('click', async function(e){
      e.preventDefault();
      // gather currently displayed students in card or table view
      const cards = Array.from(document.querySelectorAll('[data-id]'));
      if (!cards.length){ alert('Aucun étudiant trouvé à imprimer.'); return; }
      studentPrintPreview.classList.remove('hidden');
      const container = document.getElementById('studentPrintContent');
      container.innerHTML = '<div style="padding:8px;color:#6b7280">Chargement...</div>';
      // Build promises to fetch details for inscrit students to include inscriptions
      const promises = cards.map(function(el){
        return (async function(element){
          const id = element.dataset.id;
          try{
            const r = await fetch(`/etudiants/${id}/json/`);
            if (r.ok){
              const j = await r.json();
              if (j && j.success){
                const eData = j.etudiant || j.student || {};
                const payload = {
                  id: eData.id || id,
                  nom: eData.nom || '',
                  prenom: eData.prenom || '',
                  telephone: eData.telephone || eData.phone || eData.mobile || element.dataset.phone || '',
                  photo: eData.photo_url || eData.photo || element.dataset.photo || DEFAULT_AVATAR,
                  photo_url: eData.photo_url || eData.photo || element.dataset.photo || DEFAULT_AVATAR,
                  email: eData.email || '',
                  inscription_status: j.inscription_status || eData.inscription_status || eData.status || eData.inscription || element.dataset.inscription,
                  inscriptions: j.inscriptions || eData.inscriptions || eData.formations || [],
                  // helpful display fallbacks from DOM when server doesn't return formatted formation/statut
                  display_formation: element.dataset.formationText || element.dataset.displayFormation || element.dataset.formation || eData.formation_text || eData.formation_name || '',
                  statut: eData.statut || eData.status || element.dataset.status || '',
                  date_inscription: eData.date_inscription || eData.dateInscription || '',
                  date_naissance: eData.date_naissance || eData.dateNaissance || ''
                };
                return { payload: payload, el: element };
              }
            }
          }catch(err){ /* ignore - fallback to dataset */ }
          // fallback to dataset
          const fallbackPayload = {
            id: element.dataset.id,
            nom: element.dataset.name ? element.dataset.name.split(' ').slice(0,-1).join(' ') : '',
            prenom: element.dataset.name ? element.dataset.name.split(' ').slice(-1).join(' ') : '',
            telephone: element.dataset.phone || element.dataset.telephone || '',
            photo: element.dataset.photo || DEFAULT_AVATAR,
            photo_url: element.dataset.photo || DEFAULT_AVATAR,
            email: element.dataset.email || '',
            inscription_status: element.dataset.inscription || element.dataset.status,
            inscriptions: [],
            display_formation: element.dataset.formationText || element.dataset.displayFormation || element.dataset.formation || '',
            statut: element.dataset.status || '',
            date_inscription: element.dataset.dateInscription || element.dataset.date_inscription || '',
            date_naissance: element.dataset.dateNaissance || element.dataset.date_naissance || ''
          };
          return { payload: fallbackPayload, el: element };
        })(el);
      });

      const results = await Promise.all(promises);
      let html = '';
      // For each result, try to fetch a data URL for QR and pass it to builder
      for (const resObj of results){
        const payload = resObj.payload;
        // Build a short info string so scanning the printed QR displays student details directly
        const formationsText = (Array.isArray(payload.inscriptions) && payload.inscriptions.length) ? payload.inscriptions.map(it => (it.formation || it.formation_name || it.nom || '')).filter(Boolean).join(', ') : (payload.display_formation || '');
  // Build a friendly full name: prefer structured prenom+nom, then combined name
  const fullName = ((payload.prenom || '') + ' ' + (payload.nom || '')).trim() || payload.name || payload.nom || '';
  const telVal = payload.telephone || payload.phone || payload.tel || payload.mobile || '';
  const infoText = `Nom: ${fullName}\nID: ${payload.id || ''}\nFormation: ${formationsText}\nDate inscription: ${payload.date_inscription || ''}\nTel: ${telVal}\nEmail: ${payload.email || ''}`;
        // If telephone or email missing, try a last-resort fetch to the server for this student
        if((!telVal || !payload.email) && payload.id){
          try{
            const rr = await fetch(`/etudiants/${payload.id}/json/`);
            if(rr.ok){ const jj = await rr.json(); if(jj && jj.success){ const d = jj.etudiant || jj.student || {}; payload.telephone = payload.telephone || d.telephone || d.phone || d.mobile || '' ; payload.email = payload.email || d.email || ''; payload.nom = payload.nom || d.nom || ''; payload.prenom = payload.prenom || d.prenom || ''; }
            }
          }catch(e){ /* ignore */ }
        }
        const qrData = await fetchQrDataUrl(infoText);
        html += buildPrintableCard(payload, qrData);
      }
      container.innerHTML = html;
    });

    // Execute print from preview window
    const studentPrintExecuteEl = document.getElementById('studentPrintExecute');
    if (studentPrintExecuteEl) studentPrintExecuteEl.addEventListener('click', function(){
      const content = document.getElementById('studentPrintContent'); if(!content) return;
      const w = window.open('','studentcards_print');
      w.document.write('<html><head><title>Cartes étudiants</title>');
      w.document.write('<style>');
  w.document.write('body{font-family:Arial,Helvetica,sans-serif;padding:18px;background:#fff;color:#0f172a} img{max-width:100%}');
  w.document.write('.print-card{box-sizing:border-box;margin:6px} .print-card .formations-list{border-top:1px solid #eef2f7;padding-top:8px} .print-card ul{margin:0;padding-left:16px} .print-card li{margin-bottom:4px}');
  w.document.write('@media print { body { margin:0; } .print-card { page-break-inside:avoid; -webkit-print-color-adjust:exact } }');
      w.document.write('</style>');
      w.document.write('</head><body>');
      w.document.write(content.innerHTML);
      w.document.write('</body></html>');
      w.document.close(); w.focus(); setTimeout(()=>{ w.print(); w.close(); }, 300);
    });

    // Delegated single-row print button handler
    document.addEventListener('click', async function(e){
      const btn = e.target.closest('.row-print-btn');
      if (!btn) return;
      e.preventDefault(); e.stopPropagation();
      const id = btn.dataset.id || btn.getAttribute('data-id');
      if (!id){ alert('ID étudiant introuvable'); return; }
      // fetch details
      let payload = null;
      try{
        const r = await fetch(`/etudiants/${id}/json/`);
        if (r.ok){ const j = await r.json(); if (j && j.success){ const eData = j.etudiant || j.student || {}; payload = { id: eData.id || id, nom: eData.nom || '', prenom: eData.prenom || '', photo: eData.photo_url || eData.photo || DEFAULT_AVATAR, photo_url: eData.photo_url || eData.photo || DEFAULT_AVATAR, email: eData.email || '', inscription_status: j.inscription_status || eData.inscription_status || eData.status || eData.inscription || '', inscriptions: j.inscriptions || eData.inscriptions || eData.formations || [], display_formation: eData.formation_text || eData.formation_name || '', statut: eData.statut || eData.status || '', date_inscription: eData.date_inscription || eData.dateInscription || '', date_naissance: eData.date_naissance || eData.dateNaissance || '' };
            // supplement server response with dataset values from DOM row/card when available
            try{
              const domEl = document.querySelector(`[data-id="${CSS.escape(id)}"]`);
              if (domEl){
                // fill display_formation from dataset if server didn't provide it
                if (!payload.display_formation){ payload.display_formation = domEl.dataset.formationText || domEl.dataset.displayFormation || domEl.dataset.formation || '' }
                // fill statut from dataset if missing
                if (!payload.statut){ payload.statut = domEl.dataset.status || domEl.dataset.statut || '' }
                // if no structured inscriptions, create one from dataset.formation if present
                if ((!payload.inscriptions || payload.inscriptions.length === 0) && (domEl.dataset.formation || domEl.dataset.formationText)){
                  payload.inscriptions = [{ formation: domEl.dataset.formationText || domEl.dataset.formation || '' }];
                }
              }
            }catch(e){ /* ignore DOM supplement errors */ }
        }}
      }catch(err){ /* ignore, fallback below */ }
      if (!payload){ // fallback to dataset
        const el = document.querySelector(`[data-id="${CSS.escape(id)}"]`);
          payload = { id: id, nom: (el && el.dataset && el.dataset.name) ? (el.dataset.name.split(' ').slice(0,-1).join(' ')) : '', prenom: (el && el.dataset && el.dataset.name) ? (el.dataset.name.split(' ').slice(-1).join(' ')) : '', telephone: (el && el.dataset) ? (el.dataset.phone || el.dataset.telephone || '') : '', photo: el && el.dataset && el.dataset.photo ? el.dataset.photo : DEFAULT_AVATAR, photo_url: el && el.dataset && el.dataset.photo ? el.dataset.photo : DEFAULT_AVATAR, email: el && el.dataset && el.dataset.email ? el.dataset.email : '', inscription_status: el && el.dataset && (el.dataset.inscription || el.dataset.status) ? (el.dataset.inscription || el.dataset.status) : '', inscriptions: [], display_formation: (el && el.dataset) ? (el.dataset.formationText || el.dataset.displayFormation || el.dataset.formation || '') : '', statut: (el && el.dataset) ? (el.dataset.status || '') : '', date_inscription: el && el.dataset && (el.dataset.dateInscription || el.dataset.date_inscription) ? (el.dataset.dateInscription || el.dataset.date_inscription) : '', date_naissance: el && el.dataset && (el.dataset.dateNaissance || el.dataset.date_naissance) ? (el.dataset.dateNaissance || el.dataset.date_naissance) : '' };
      }
  
  // prefer a compact student info string as QR payload so scanners display details directly
  const formationsSingle = (Array.isArray(payload.inscriptions) && payload.inscriptions.length) ? payload.inscriptions.map(it => (it.formation || it.formation_name || it.nom || '')).filter(Boolean).join(', ') : (payload.display_formation || '');
  const fullNameSingle = ((payload.prenom || '') + ' ' + (payload.nom || '')).trim() || payload.name || payload.nom || '';
  const telSingle = payload.telephone || payload.phone || payload.tel || payload.mobile || '';
  const infoSingle = `Nom: ${fullNameSingle}\nID: ${payload.id || ''}\nFormation: ${formationsSingle}\nDate inscription: ${payload.date_inscription || ''}\nTel: ${telSingle}\nEmail: ${payload.email || ''}`;
  // If tel/email empty, try to fetch authoritative data from server before generating QR
  if((!telSingle || !payload.email) && payload.id){
    try{
      const rr = await fetch(`/etudiants/${payload.id}/json/`);
      if(rr.ok){ const jj = await rr.json(); if(jj && jj.success){ const d = jj.etudiant || jj.student || {}; payload.telephone = payload.telephone || d.telephone || d.phone || d.mobile || ''; payload.email = payload.email || d.email || ''; payload.nom = payload.nom || d.nom || ''; payload.prenom = payload.prenom || d.prenom || ''; }
      }
    }catch(e){ /* ignore */ }
  }
  // rebuild friendly name and telephone after possible server update
  const fullNameSingleFinal = ((payload.prenom || '') + ' ' + (payload.nom || '')).trim() || payload.name || payload.nom || '';
  const telSingleFinal = payload.telephone || payload.phone || payload.tel || payload.mobile || '';
  const infoSingleFinal = `Nom: ${fullNameSingleFinal}\nID: ${payload.id || ''}\nFormation: ${formationsSingle}\nDate inscription: ${payload.date_inscription || ''}\nTel: ${telSingleFinal}\nEmail: ${payload.email || ''}`;
  const qrDataSingle = await fetchQrDataUrl(infoSingleFinal);
  const html = buildPrintableCard(payload, qrDataSingle);
  const w = window.open('','studentcard_print');
  w.document.write('<html><head><title>Carte étudiant</title>');
  w.document.write('<style>');
  w.document.write('body{font-family:Arial,Helvetica,sans-serif;padding:18px;background:#fff;color:#0f172a} img{max-width:100%}');
  w.document.write('.print-card{box-sizing:border-box;margin:6px} .print-card .formations-list{border-top:1px solid #eef2f7;padding-top:8px} .print-card ul{margin:0;padding-left:16px} .print-card li{margin-bottom:4px}');
  // Force each card to print as its own block; for multiple cards this will allow multiple per page
  w.document.write('@media print { body { margin:0; } .print-card { page-break-inside:avoid; -webkit-print-color-adjust:exact } }');
  w.document.write('</style>');
  w.document.write('</head><body>');
  w.document.write(html);
  w.document.write('</body></html>');
      w.document.close(); w.focus(); setTimeout(()=>{ w.print(); w.close(); }, 300);
    });
  // statusFilter change is handled by the centralized applyFilters() in the filtering module

    // Init
    attachEditHandlers();
    // Niveau filter change -> reload with query param
    // Auto-open add student modal when ?open_add_student=1
    (function(){
      try{
        const params = new URLSearchParams(window.location.search);
        if (params.get('open_add_student') === '1'){
          const btn = document.getElementById('openAddBtn');
          if (btn) btn.click();
        }
      }catch(e){ console.error(e); }
    })();
    document.getElementById('niveauFilter').addEventListener('change', function(){
      const val = this.value;
      const params = new URLSearchParams(window.location.search);
      if(val) params.set('niveau', val); else params.delete('niveau');
      params.delete('page'); // reset to first page
      window.location.search = params.toString();
    });

    // --- Populate searchable selects (keep visual select but add a small search input) ---
    (function(){
      // helper: read values from a datalist into an array
      function valuesFromDatalist(id){
        const dl = document.getElementById(id);
        if(!dl) return [];
        return Array.from(dl.querySelectorAll('option')).map(o=>o.value).filter(Boolean);
      }

      // populate all selects that have matching datalist sources
      const natValues = valuesFromDatalist('nationalite_list');
      const lieuValues = valuesFromDatalist('lieu_list');

      function populateSelect(sel, items){
        if(!sel) return;
        // keep first placeholder option if present
        const first = sel.querySelector('option') && sel.querySelector('option').value === '' ? sel.querySelector('option') : null;
        sel.innerHTML = '';
        if(first) sel.appendChild(first);
        items.forEach(v=>{ const o = document.createElement('option'); o.value = v; o.textContent = v; sel.appendChild(o); });
      }

      // populate all matching selects (nationalite / lieu_naissance)
      document.querySelectorAll('select[name="nationalite"]').forEach(s => populateSelect(s, natValues));
      document.querySelectorAll('select[name="lieu_naissance"]').forEach(s => populateSelect(s, lieuValues));

      // attach filter behavior: each .select-search targets the following select element
      document.querySelectorAll('.select-search').forEach(inp => {
        const sel = inp.nextElementSibling && inp.nextElementSibling.tagName === 'SELECT' ? inp.nextElementSibling : null;
        const targetName = sel ? sel.getAttribute('name') : inp.dataset.target;
        // on input, rebuild options from the master array to avoid hiding issues
        inp.addEventListener('input', function(){
          const q = (this.value || '').toLowerCase();
          const master = (targetName === 'nationalite') ? natValues : (targetName === 'lieu_naissance' ? lieuValues : []);
          if(!sel) return;
          // preserve placeholder (empty) option if present
          const placeholder = sel.querySelector('option') && sel.querySelector('option').value === '' ? sel.querySelector('option').outerHTML : '<option value="">--</option>';
          // rebuild
          const html = [placeholder].concat(master.filter(v => !q || v.toLowerCase().indexOf(q) !== -1).map(v => `<option value="${v}">${v}</option>`)).join('');
          sel.innerHTML = html;
        });
      });
    })();
        // Arabic-only input enforcement for Arabic name fields
        (function(){
          function normalizeArabicInput(str){
            // allow Arabic letters, spaces, hyphen, shadda, long vowels and common punctuation
            // Ranges: \u0600-\u06FF, \u0750-\u077F, \u08A0-\u08FF
            const allowed = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\s\-\u064B-\u0652\u0621-\u063A\u0641-\u064A\u0670]/g;
            const matches = str.match(allowed);
            return matches ? matches.join('') : '';
          }
          ['nom_arabe','prenom_arabe'].forEach(function(name){
            const el = document.querySelector('input[name="'+name+'"]');
            if(!el) return;
            // on input: filter characters
            el.addEventListener('input', function(e){
              const val = this.value || '';
              const clean = normalizeArabicInput(val);
              if (clean !== val) { this.value = clean; }
            });
            // on paste: sanitize paste content
            el.addEventListener('paste', function(e){
              e.preventDefault();
              const text = (e.clipboardData || window.clipboardData).getData('text') || '';
              this.value = normalizeArabicInput(text);
            });
          });
        })();
        // Client-side filtering and export
        (function(){
          const sortFilter = document.getElementById('sortFilter');
          const formationFilter = document.getElementById('formationFilter');
          const statusFilter = document.getElementById('statusFilter');
          const niveauFilterVisible = document.getElementById('niveauFilterVisible');
          const exportCsvBtn = document.getElementById('exportCsvBtn');
          const exportJsonBtn = document.getElementById('exportJsonBtn');
          const searchInput = document.getElementById('searchInput');

          function getAllRows(){
            // table rows and card elements
            const rows = Array.from(document.querySelectorAll('#studentsTbody tr.student-row'));
            const cards = Array.from(document.querySelectorAll('#cardView .student-row'));
            return rows.concat(cards);
          }

          function matchesFormation(el){
            if(!formationFilter) return true;
            const selected = formationFilter && formationFilter.selectedOptions ? Array.from(formationFilter.selectedOptions).map(o=>o.value).filter(Boolean) : [];
            if(selected.length === 0) return true;
            // strict matching: student data-formation should contain the formation id (string)
            const f = (el.dataset.formation || '').toString();
            // if student has formation_text (non-numeric), allow matching by text
            const fText = (el.dataset.formationText || el.dataset.displayFormation || '').toString();
            for (let v of selected){
              if (!v) continue;
              // numeric compare first
              if (f && String(f) === String(v)) return true;
              if (fText && String(fText) === String(v)) return true;
            }
            return false;
          }

          function matchesStatus(el){
            const val = (statusFilter && statusFilter.value) || 'all';
            if(val === 'all') return true;
            // prefer explicit data-inscription when present (normalized: 'inscrit' or 'non_inscrit')
            const inscriptionRaw = (el.dataset.inscription || el.dataset.status || '').toString();
            const inscription = inscriptionRaw.trim().toLowerCase();
            const verified = el.dataset.verify && String(el.dataset.verify) === '3';
            if(val === 'inscrit') return inscription === 'inscrit' || inscription === 'actif';
            if(val === 'non_inscrit') return inscription === 'non_inscrit' || !(inscription === 'inscrit' || inscription === 'actif');
            if(val === 'verifie') return !!verified;
            if(val === 'non_verifie') return !verified;
            return true;
          }

          function matchesNiveau(el){
            const val = (niveauFilterVisible && (''+niveauFilterVisible.value).toLowerCase()) || '';
            if(!val) return true;
            return (''+(el.dataset.niveau || '')).toLowerCase() === val;
          }

          function matchesSearch(el){
            const q = (searchInput && searchInput.value || '').toLowerCase().trim();
            if(!q) return true;
            const name = (el.dataset.name || '').toLowerCase();
            const phone = (el.dataset.phone || '').toLowerCase();
            const addr = (el.dataset.address || '').toLowerCase();
            return name.indexOf(q) !== -1 || phone.indexOf(q) !== -1 || addr.indexOf(q) !== -1;
          }

          function applyFilters(){
            const all = getAllRows();
            all.forEach(el => {
              const ok = matchesFormation(el) && matchesStatus(el) && matchesNiveau(el) && matchesSearch(el);
              if(ok) el.style.display = '';
              else el.style.display = 'none';
            });
            // sorting table rows
            const table = document.getElementById('studentsTbody');
            if(table && sortFilter && typeof sortFilter.value !== 'undefined'){
              const key = sortFilter.value;
              const trs = Array.from(table.querySelectorAll('tr.student-row'));
              trs.sort((a,b)=>{
                if(key === 'alpha'){
                  const an = (a.dataset.name||'').toLowerCase();
                  const bn = (b.dataset.name||'').toLowerCase();
                  return an.localeCompare(bn);
                }
                if(key === 'oldest'){
                  return Number(a.dataset.id||0) - Number(b.dataset.id||0);
                }
                if(key === 'recent'){
                  return Number(b.dataset.id||0) - Number(a.dataset.id||0);
                }
                return 0;
              });
              trs.forEach(r=> table.appendChild(r));
            }
          }

          function collectVisibleData(){
            const items = [];
            getAllRows().forEach(el => {
              if(el.style.display === 'none') return;
              const obj = {
                id: el.dataset.id || '',
                nom: el.dataset.name || '',
                email: el.dataset.email || '',
                telephone: el.dataset.phone || '',
                adresse: el.dataset.address || '',
                formation: el.dataset.formation || el.dataset.formationName || '',
                statut: el.dataset.status || '',
                verification: el.dataset.verify || '',
                niveau: el.dataset.niveau || '',
                situation: el.dataset.situation || '',
                dernier_diplome: el.dataset.dernierDiplome || el.dataset.dernier_diplome || ''
              };
              items.push(obj);
            });
            return items;
          }

          function downloadCSV(items, filename){
            if(!items || items.length === 0) { alert('Aucun élément à exporter'); return; }
            const keys = Object.keys(items[0]);
            const lines = [keys.join(',')].concat(items.map(it => keys.map(k=> '"'+String(it[k]||'').replace(/"/g,'""')+'"').join(',')));
            const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename || 'students.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
          }

          if(sortFilter) sortFilter.addEventListener('change', applyFilters);
          if(formationFilter) formationFilter.addEventListener('change', applyFilters);
          if(statusFilter) statusFilter.addEventListener('change', applyFilters);
          if(niveauFilterVisible) niveauFilterVisible.addEventListener('change', applyFilters);
          if(searchInput) searchInput.addEventListener('input', function(){ setTimeout(applyFilters, 10); });

          if(exportCsvBtn) exportCsvBtn.addEventListener('click', function(){ const items = collectVisibleData(); downloadCSV(items, 'etudiants_export.csv'); });
          if(exportJsonBtn) exportJsonBtn.addEventListener('click', function(){ const items = collectVisibleData(); const blob = new Blob([JSON.stringify(items, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'etudiants_export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); });

          // server-side exports: XLSX / PDF buttons
          const exportXlsxBtn = document.getElementById('exportXlsxBtn');
          const exportPdfBtn = document.getElementById('exportPdfBtn');
          function buildExportUrl(base){
            const params = new URLSearchParams();
            // add selected formation filters
            if (formationFilter){
              Array.from(formationFilter.selectedOptions).forEach(o => { if (o.value) params.append('formation', o.value); });
            }
            // add status filter
            if (statusFilter && statusFilter.value && statusFilter.value !== 'all') params.set('status', statusFilter.value);
            // add search
            if (searchInput && searchInput.value) params.set('q', searchInput.value);
            return base + (params.toString() ? ('?' + params.toString()) : '');
          }
          if (exportXlsxBtn){ exportXlsxBtn.addEventListener('click', function(){ window.location = buildExportUrl('/etudiants/export/xlsx/'); }); }
          if (exportPdfBtn){ exportPdfBtn.addEventListener('click', function(){ window.location = buildExportUrl('/etudiants/export/pdf/'); }); }

          // initial filter pass
          setTimeout(applyFilters, 30);
        })();

        // Make status badges clickable: open verification modal when clicked (delegated)
        document.addEventListener('click', function(e){
          const badge = e.target.closest('.status-actif, .status-inactif');
          if(!badge) return;
          // find row element that contains this badge
          const row = badge.closest('[data-id]') || badge.closest('.student-row');
          if(!row) return;
          const id = row.dataset.id;
          if(!id) return;
          // If the badge is the inscription link (Non inscrit anchor), let its default behaviour (open inscription) run
          if(badge.tagName === 'A' && badge.classList.contains('open-add-inscription')) return;
          // otherwise open verify modal for this student
          try{ openVerifyModal(id); }catch(err){ console.warn('openVerifyModal failed', err); }
        });
        // Show full datalist options on focus/click for specific inputs (nationalite, lieu_naissance)
        (function(){
          // buildDropdown is already defined above; bind it to every input[list] once
          try{
            document.querySelectorAll('input[list]').forEach(inp => {
              try{ buildDropdown(inp); }catch(e){}
            });
          }catch(e){ /* ignore */ }
        })();
        // --- Enforce name casing: NOM => UPPERCASE, Prénom => Capitalize first letters ---
        (function(){
          function capitalizePrenom(s){
            if(!s) return '';
            return s.toLowerCase().split(/(\s|\-)/).map(part => {
              return part.replace(/^[\s\-]*([a-zàâäáéèêëìíîïòóôöùúûüçœ])/i, function(m, c){ return c ? c.toUpperCase() : m; });
            }).join('');
          }

          function attachUppercase(el){ if(!el) return; el.addEventListener('blur', function(){ this.value = (this.value||'').toUpperCase(); }); }
          function attachCapitalize(el){ if(!el) return; el.addEventListener('blur', function(){ this.value = capitalizePrenom(this.value||''); }); }

          try{
            // Add form
            const nomAdd = document.getElementById('nom');
            const prenomAdd = document.getElementById('prenom');
            attachUppercase(nomAdd);
            attachCapitalize(prenomAdd);
          }catch(e){ /* ignore */ }

          try{
            // Edit form
            const editForm = document.getElementById('editForm');
            if(editForm){
              const nomEdit = editForm.querySelector('input[name="nom"]');
              const prenomEdit = editForm.querySelector('input[name="prenom"]');
              attachUppercase(nomEdit);
              attachCapitalize(prenomEdit);

              // Normalize values after edit modal is populated
              if(typeof openEditModalWithData === 'function'){
                const _orig = openEditModalWithData;
                window.openEditModalWithData = function(data){
                  _orig(data);
                  setTimeout(function(){ if(nomEdit) nomEdit.value = (nomEdit.value||'').toUpperCase(); if(prenomEdit) prenomEdit.value = capitalizePrenom(prenomEdit.value||''); }, 8);
                };
              }
            }
          }catch(e){ /* ignore */ }
        })();
  </script>


  </main>



  <script>
    // Toggle sidebar submenu groups: click header to open/close


    
    document.addEventListener('DOMContentLoaded', function(){
        // Theme initialization and toggle
        try {
          var htmlEl = document.documentElement;
          var saved = null;
          try { saved = localStorage.getItem('theme'); } catch(e) { saved = null; }
          if (!saved) {
            saved = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light';
          }
          htmlEl.setAttribute('data-theme', saved);
          var toggle = document.getElementById('themeToggle');
          var icon = document.getElementById('themeIcon');
          var toggleSlider = document.querySelector('.toggle-slider');
          if (toggle) {
            toggle.checked = (saved === 'dark');
            // set accessible attribute
            if(toggleSlider) toggleSlider.setAttribute('aria-checked', toggle.checked ? 'true' : 'false');
            toggle.addEventListener('change', function () {
              var theme = toggle.checked ? 'dark' : 'light';
              htmlEl.setAttribute('data-theme', theme);
              try { localStorage.setItem('theme', theme); } catch(e) {}
              if (icon) icon.textContent = theme === 'dark' ? 'dark_mode' : 'light_mode';
              if(toggleSlider) toggleSlider.setAttribute('aria-checked', toggle.checked ? 'true' : 'false');
            });
          }
          if (icon) icon.textContent = (saved === 'dark') ? 'dark_mode' : 'light_mode';
        } catch(e) {}
        document.querySelectorAll('.group-header').forEach(function(h){
          h.setAttribute('role','button');
          h.setAttribute('tabindex','0');
          h.addEventListener('click', function(e){
            // if the click originated from a link inside the header, let it navigate
            if (e.target.closest('a')) return;
            var ul = h.nextElementSibling;
            if(!ul) return;
            ul.classList.toggle('open');
            h.classList.toggle('open');
            // accessibility
            var expanded = ul.classList.contains('open');
            h.setAttribute('aria-expanded', expanded ? 'true' : 'false');
            ul.setAttribute('aria-hidden', expanded ? 'false' : 'true');
          });
          h.addEventListener('keydown', function(e){ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); h.click(); } });
        });
        // Nav indicator interactivity: move indicator to hovered/active link
        (function(){
          var indicator = document.getElementById('navIndicator');
          var aside = document.querySelector('.sidebar');
          if(!indicator || !aside) return;
          var items = Array.from(aside.querySelectorAll('a, .group-header'));
          function place(el){
            if(!el) return;
            var rect = el.getBoundingClientRect();
            var asideRect = aside.getBoundingClientRect();
            var top = rect.top - asideRect.top + (window.scrollY || 0);
            indicator.style.top = (top + 6) + 'px';
            indicator.style.height = Math.max(36, rect.height - 8) + 'px';
            indicator.style.opacity = 1;
          }
          // show indicator on hover
          items.forEach(function(it){
            it.addEventListener('mouseenter', function(){ place(it); });
          });
          // hide when leaving aside
          aside.addEventListener('mouseleave', function(){ indicator.style.opacity = 0; });
          // keep indicator on the active link if present
          var active = aside.querySelector('.active-link');
          if(active) place(active);
        })();
      });
  </script>
</body>
</html>
