{% extends 'base.html' %}
{% load static %}
{% block title %}Paramètres - GénieSchool{% endblock %}
{% block content %}
<div class="card p-6">
  <div class="flex items-center gap-4">
    <span class="material-icons" style="font-size:2rem;">settings</span>
    <h2 class="text-2xl font-bold">Paramètres</h2>
  </div>
  <div class="mt-3 flex justify-end">
    <a href="{% url 'logout' %}" class="btn-secondary px-3 py-1 rounded text-red-600 hover:bg-red-50">Déconnexion</a>
  </div>
  <p class="text-sm text-gray-600 mt-3">Cette page contiendra les réglages de l'application (SMTP, thèmes, intégrations...).</p>
  <!-- Toast container for non-blocking notifications -->
  <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
 
  
  <style>
    /* Big, colorful users table styling */
  .users-table { border-collapse: separate; border-spacing: 0; width: 100%; background: linear-gradient(180deg,#ffffff,#fbfffb); border-radius:12px; overflow: hidden; box-shadow: 0 10px 40px rgba(6,95,70,0.06); }
  .users-table thead th { background: linear-gradient(90deg,#ecfdf5,#dcfce7); color: #065f46; font-weight:900; font-size:16px; padding:18px 14px; text-align:left; }
  .users-table thead th:last-child { text-align:right; }
  .users-table tbody td { padding:18px 14px; vertical-align:middle; font-size:15px; color:#064e3b; }
    .users-table tbody tr { transition: transform .16s cubic-bezier(.2,.9,.25,1), box-shadow .16s ease, background .12s ease; background:transparent; }
    .users-table tbody tr:hover { transform: translateY(-6px); box-shadow: 0 18px 48px rgba(6,95,70,0.08); background: linear-gradient(180deg, rgba(16,185,129,0.03), rgba(255,255,255,0.4)); }
    .users-table tbody tr:nth-child(odd) { background: rgba(6,95,70,0.01); }
    .users-table tbody tr.pending { opacity: 0.9; filter: blur(0.0); }
  .pill { display:inline-block; padding:10px 14px; border-radius:999px; background: #ecfdf5; color:#065f46; font-weight:800; font-size:14px; }
    .icon-btn { background: transparent; border: none; padding:8px; cursor:pointer; border-radius:10px; transition: background .12s ease, transform .12s ease; }
    .icon-btn:hover { background: rgba(6,95,70,0.08); transform: translateY(-2px); }
    .icon-btn svg { display:block; }
  .btn-primary { background: linear-gradient(90deg,var(--accent-2),#059669); color:#fff; border:none; padding:8px 12px; font-weight:700; }
  .btn-primary:hover { transform: translateY(-2px); }
    .btn-secondary { background: #f3f4f6; border: none; padding:8px 12px; }
    .table-password { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', monospace; color:#065f46; background: rgba(16,185,129,0.03); padding:8px 10px; border-radius:6px; display:inline-block; }

  /* Slightly larger email and password values for readability */
  .users-table tbody td.email-cell { font-size:17px; font-weight:600; color:#044e3a; }
  .users-table tbody td .table-password, .users-table tbody td.table-password { font-size:16px; font-weight:700; padding:10px 12px; }
    .fade-in { animation: fadeIn .28s cubic-bezier(.2,.9,.25,1) both; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }

    /* Toast styles */
    #toastContainer { right: 20px; bottom: 20px; }
    #toastContainer .toast { min-width:220px; padding:10px 14px; border-radius:10px; color:#fff; box-shadow: 0 8px 28px rgba(2,6,23,0.12); font-weight:600; }
    #toastContainer .toast.info { background: linear-gradient(90deg,#065f46,#10b981); }
    #toastContainer .toast.success { background: linear-gradient(90deg,#10b981,#059669); }
    #toastContainer .toast.error { background: linear-gradient(90deg,#ef4444,#dc2626); }
  </style>

  <style>
    /* Animated Add button */
  #openAddUser { display:inline-flex; align-items:center; gap:10px; padding:12px 18px; font-size:16px; border-radius:12px; box-shadow: 0 10px 36px rgba(6,95,70,0.14); transition: transform .16s cubic-bezier(.2,.9,.25,1), box-shadow .16s ease; }
    #openAddUser:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 18px 44px rgba(6,95,70,0.14); }
    #openAddUser svg { transition: transform .18s ease; }
    #openAddUser:hover svg { transform: rotate(20deg) scale(1.06); }

    /* Modal backdrop blur + pop-in */
    .modal-backdrop { backdrop-filter: blur(6px) saturate(120%); background: rgba(6,6,6,0.28); }
    #userModal .bg-white { border-radius:14px; box-shadow: 0 28px 80px rgba(2,6,23,0.14); transform-origin: center; animation: modalPop .28s cubic-bezier(.2,.9,.25,1) both; }
    @keyframes modalPop { from { opacity:0; transform: translateY(12px) scale(.98); } to { opacity:1; transform: translateY(0) scale(1); } }
    /* Close button style inside modal */
    #userModal .close-x { position:absolute; right:14px; top:12px; border-radius:8px; width:34px; height:34px; display:inline-flex; align-items:center; justify-content:center; background:transparent; border:none; cursor:pointer; transition: background .12s ease, transform .12s ease; }
    #userModal .close-x:hover { background: rgba(6,95,70,0.06); transform: translateY(-2px); }
  </style>

  <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="card p-4">
      <h3 class="font-semibold">Apparence</h3>
      <p class="text-sm text-gray-500">Choisissez le thème de l'interface.</p>
      <div class="mt-3">
        <label class="block text-sm font-medium">Mode</label>
        <div class="mt-2">
          <label class="inline-flex items-center mr-4"><input type="radio" name="theme_mode" value="system" class="theme-option"> <span class="ml-2">Système</span></label>
          <label class="inline-flex items-center mr-4"><input type="radio" name="theme_mode" value="light" class="theme-option"> <span class="ml-2">Clair</span></label>
          <label class="inline-flex items-center mr-4"><input type="radio" name="theme_mode" value="dark" class="theme-option"> <span class="ml-2">Sombre</span></label>
        </div>
        <div class="mt-4 text-sm text-gray-600">Le choix sera sauvegardé pour votre compte (ou en cookie si non connecté).</div>
      </div>
    </div>

      {% if not is_secretaire %}
      <div class="card p-6">
        <h3 class="font-semibold mt-6">Utilisateurs</h3>
        <p class="text-sm text-gray-500">G\u00e9rer les comptes utilisateurs et leurs r\u00f4les.</p>
        <div class="mt-4">
          <button id="openAddUser" class="btn-primary px-4 py-2 rounded-lg text-base" title="Ajouter un utilisateur">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle; margin-right:8px"><path d="M12 5v14M5 12h14"/></svg>
            Ajouter
          </button>
        </div>
        <div class="mt-4 overflow-auto">
          <table id="usersTable" class="users-table text-base text-left text-gray-700 w-full">
            <thead><tr><th class="px-4 py-3">ID</th><th class="px-4 py-3">Nom</th><th class="px-4 py-3">Email</th><th class="px-4 py-3">Mot de passe</th><th class="px-4 py-3">R\u00f4le</th><th class="px-4 py-3 text-right">Actions</th></tr></thead>
            <tbody id="usersTbody">
              {% for u in utilisateurs %}
              <tr class="fade-in" data-id="{{ u.id }}" data-nom="{{ u.nom|default:'' }}" data-email="{{ u.email }}" data-role="{{ u.role }}" data-password="{{ u.mot_de_passe|default:'' }}">
                <td class="px-4 py-3">{{ u.id }}</td>
                <td class="px-4 py-3 font-semibold">{{ u.nom|default:'' }}</td>
                <td class="px-4 py-3 email-cell">{{ u.email }}</td>
                <td class="px-4 py-3 table-password">{{ u.mot_de_passe|default:'' }}</td>
                <td class="px-4 py-3"><span class="pill">{{ u.role }}</span></td>
                <td class="px-4 py-3 text-right">
                  <button class="edit-user-btn icon-btn" data-id="{{ u.id }}" title="Modifier">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#065f46" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 113 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>
                  </button>
                  <button class="delete-user-btn delete-btn icon-btn" data-id="{{ u.id }}" title="Supprimer">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg>
                  </button>
                </td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="px-4 py-3 text-gray-500">Aucun utilisateur</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% else %}
      <!-- Secretaire: hide user management table. Keep an information note and allow profile editing below -->
      <div class="card p-6">
        <h3 class="font-semibold mt-6">Utilisateurs</h3>
        <p class="text-sm text-gray-500">La gestion des utilisateurs n'est pas disponible pour votre r\u00f4le. Vous pouvez modifier uniquement votre profil (nom / email / mot de passe).</p>
      </div>
      {% endif %}

    <div class="card p-4">
      <h3 class="font-semibold">Informations école</h3>
      <p class="text-sm text-gray-500">Modifier le nom de l'école et son logo.</p>
      <div class="mt-3">
        <label class="block text-sm font-medium">Nom de l'école</label>
        <input id="schoolNameInput" class="mt-1 block w-full border-b-2 border-gray-200 px-2 py-1 text-lg font-semibold" placeholder="Nom de l'école" value="{{ school_name|default:'' }}" />
        <div class="text-sm text-gray-500 mt-1">Le nom sera affiché dans la navbar (souligné).</div>
      </div>
      
      <div class="mt-6">
        <h3 class="font-semibold">Mon profil</h3>
        <p class="text-sm text-gray-500">Modifier votre prénom et nom affichés dans la navbar.</p>
        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium">Prénom</label>
            <input id="profilePrenom" class="mt-1 block w-full border px-3 py-2 rounded" value="{{ current_user.prenom|default:'' }}" />
          </div>
          <div>
            <label class="block text-sm font-medium">Nom</label>
            <input id="profileNom" class="mt-1 block w-full border px-3 py-2 rounded" value="{{ current_user.nom|default:'' }}" />
          </div>
        </div>
        <div class="mt-3 flex justify-end">
          <button id="saveProfileBtn" class="btn-primary px-3 py-1 rounded">Enregistrer mon profil</button>
        </div>
      </div>
      <div class="mt-6">
        <h3 class="font-semibold">Base de données active</h3>
        <p class="text-sm text-gray-500">Choisissez la base de données à utiliser pour l'application.</p>
        <div class="mt-3">
          <label class="block text-sm font-medium">Base de données</label>
          <select id="dbSelector" class="mt-1 block w-full border rounded-md px-3 py-2">
            <option value="default" {% if active_db == 'default' %}selected{% endif %}>default (bd_gss_2025)</option>
            <option value="schooloctobre" {% if active_db == 'schooloctobre' %}selected{% endif %}>school</option>
          </select>
          <div class="text-sm text-gray-500 mt-2">Cette sélection est conservée en cookie et peut être utilisée côté serveur pour choisir la connexion.</div>
          <div class="mt-3 flex justify-end">
            <button id="saveDbBtn" class="btn-primary px-3 py-1 rounded">Sauvegarder</button>
          </div>
        </div>
      </div>
      <div class="mt-3 flex items-center gap-4">
        <div>
          <label class="block text-sm font-medium">Logo</label>
          <input id="schoolLogoInput" type="file" accept="image/*" class="mt-1" />
        </div>
        <div id="schoolLogoPreview" style="width:64px;height:64px;border-radius:8px;overflow:hidden;box-shadow:0 8px 20px rgba(2,6,23,0.08);background:#fff;">
          {% if school_logo %}
            <img src="{{ school_logo }}" style="width:100%;height:100%;object-fit:cover;" alt="logo" />
          {% else %}
            <div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-weight:700;">GS</div>
          {% endif %}
        </div>
      </div>
      <div class="mt-3 flex justify-end gap-2">
        <button id="saveSchoolBtn" class="btn-primary px-3 py-1 rounded">Sauvegarder</button>
      </div>

      <!-- Users table moved to the left column above. Duplicate removed. -->
    </div>
  </div>

  <!-- Add/Edit User Modal -->
  <div id="userModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md" style="position:relative;">
      <button type="button" class="close-x" aria-label="Fermer" id="closeUserModalX">&times;</button>
      <h3 id="userModalTitle" class="text-lg font-semibold">Ajouter un utilisateur</h3>
      <form id="userForm" class="mt-3">
        {% csrf_token %}
  <input type="hidden" name="id" />
  <div class="mb-3"><label class="block text-sm">Nom</label><input name="nom" type="text" class="mt-1 block w-full border px-3 py-2 rounded"/></div>
  <div class="mb-3"><label class="block text-sm">Email</label><input name="email" type="email" class="mt-1 block w-full border px-3 py-2 rounded" required /></div>
        <div class="mb-3"><label class="block text-sm">Mot de passe</label><input name="password" type="password" class="mt-1 block w-full border px-3 py-2 rounded"/></div>
        <div class="mb-3"><label class="block text-sm">Rôle</label>
          <select name="role" class="mt-1 block w-full border px-3 py-2 rounded">
            <option value="Admin">Admin</option>
            <option value="Enseignant">Enseignant</option>
            <option value="Secretaire">Secrétaire</option>
            <option value="Comptable">Comptable</option>
          </select>
        </div>
        <div class="flex justify-end gap-2">
          <button type="button" id="closeUserModal" class="btn-secondary px-3 py-1 rounded">Annuler</button>
          <button type="submit" class="btn-primary px-3 py-1 rounded">Enregistrer</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Copy of getCookie helper used throughout templates
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Defensive: if template variable wasn't available for some reason, hide users table client-side when user role indicates secretary
    try{
      var _isSec = {% if is_secretaire %}true{% else %}false{% endif %};
      if(_isSec){
        var usersCard = document.querySelector('#usersTable');
        if(usersCard){ usersCard.closest('.card') && usersCard.closest('.card').remove(); }
      }
    }catch(e){ /* ignore when template tags unavailable */ }

    // Theme sync: mirror the same 'theme' localStorage key used by base.html
    (function(){
      function applyTheme(mode){
        var html = document.documentElement;
        if(mode === 'system'){
          var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          html.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
          try { localStorage.removeItem('theme'); } catch(e) {}
        } else {
          html.setAttribute('data-theme', mode);
          try { localStorage.setItem('theme', mode); } catch(e) {}
        }
        // sync navbar toggle
        var navToggle = document.getElementById('themeToggle');
        var navIcon = document.getElementById('themeIcon');
        if(navToggle) navToggle.checked = (mode === 'dark');
        if(navIcon) navIcon.textContent = (document.documentElement.getAttribute('data-theme') === 'dark') ? 'dark_mode' : 'light_mode';
      }

      var saved = null; try { saved = localStorage.getItem('theme'); } catch(e){ saved = null; }
      var initial = saved || 'system';
      var opts = document.querySelectorAll('.theme-option');
      opts.forEach(function(r){ r.checked = (initial === r.value); r.addEventListener('change', function(){ if(r.checked) applyTheme(r.value); }); });
      applyTheme(saved || 'system');
    })();

    {% if not is_secretaire %}
    // Users management UI: optimistic updates + non-blocking toasts
    (function(){
      var tbody = document.getElementById('usersTbody');
      var modal = document.getElementById('userModal');
      var form = document.getElementById('userForm');
      var openBtn = document.getElementById('openAddUser');
      var closeBtn = document.getElementById('closeUserModal');
      var toasts = document.getElementById('toastContainer');

      function showModal(){ modal.classList.remove('hidden'); }
      function hideModal(){ modal.classList.add('hidden'); form.reset(); form.querySelector('[name=id]').value=''; }

      function showToast(msg, type){
        var el = document.createElement('div');
        el.className = 'toast ' + (type || 'info');
        el.textContent = msg;
        toasts.appendChild(el);
        setTimeout(function(){ try{ el.remove(); }catch(e){} }, 3500);
      }

  if(openBtn) openBtn.addEventListener('click', function(){ form.reset(); form.querySelector('[name=id]').value=''; document.getElementById('userModalTitle').textContent='Ajouter un utilisateur'; showModal(); });
  if(closeBtn) closeBtn.addEventListener('click', hideModal);
  var closeX = document.getElementById('closeUserModalX'); if(closeX) closeX.addEventListener('click', hideModal);

      // Helper to create table row (includes password column)
      function makeRow(u){
        var tr = document.createElement('tr');
        tr.setAttribute('data-id', u.id);
        tr.setAttribute('data-nom', u.nom || '');
        tr.setAttribute('data-email', u.email || '');
        tr.setAttribute('data-role', u.role || '');
        tr.setAttribute('data-password', u.password || '');
        tr.className = 'fade-in';
        tr.innerHTML = '<td class="px-3 py-2">'+u.id+'<\/td>'+
                       '<td class="px-3 py-2 font-semibold">'+(u.nom||'')+'<\/td>'+
                       '<td class="px-3 py-2">'+(u.email||'')+'<\/td>'+
                       '<td class="px-3 py-2 table-password">'+(u.password||'')+'<\/td>'+
                       '<td class="px-3 py-2"><span class="pill">'+(u.role||'')+'<\/span><\/td>'+
                       '<td class="px-3 py-2 text-right">'+
                         '<button class="edit-user-btn icon-btn" data-id="'+u.id+'" title="Modifier">'+
                           '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#065f46" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 113 3L7 19l-4 1 1-4 12.5-12.5z"/></svg>'+
                         '</button> '+'<button class="delete-user-btn delete-btn icon-btn" data-id="'+u.id+'" title="Supprimer">'+
                           '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6"/></svg>'+
                         '</button>'+
                       '<\/td>';
        return tr;
      }

      // Click handler: edit or delete
      tbody.addEventListener('click', function(e){
        var edit = e.target.closest('.edit-user-btn');
        var del = e.target.closest('.delete-user-btn');
        if(edit){
          var tr = edit.closest('tr');
          var nomVal = tr.dataset.nom || '';
          var emailVal = tr.dataset.email || '';
          var roleVal = tr.dataset.role || '';
          var pwdVal = tr.dataset.password || '';
          form.querySelector('[name=id]').value = tr.dataset.id;
          form.querySelector('[name=nom]').value = nomVal;
          form.querySelector('[name=email]').value = emailVal;
          // prefill password and allow editing
          var pwd = form.querySelector('[name=password]'); if(pwd){ pwd.value = pwdVal || ''; pwd.placeholder = pwdVal ? '' : 'Laisser vide pour conserver'; }
          // set role
          try { form.querySelector('[name=role]').value = roleVal || ''; } catch(e){}
          document.getElementById('userModalTitle').textContent='Modifier utilisateur';
          showModal();
        }
        if(del){
          // optimistic remove
            var tr = del.closest('tr');
          if(!tr) return;
          var backup = tr.cloneNode(true);
          var id = tr.dataset.id;
          tr.remove();
          showToast('Suppression en cours...', 'info');
          fetch('{% url "users_delete" %}', { method:'POST', headers:{ 'X-CSRFToken': csrftoken, 'Content-Type':'application/x-www-form-urlencoded' }, body: 'id='+encodeURIComponent(id), credentials:'same-origin' })
            .then(r=>r.json()).then(function(j){ if(j && j.success){ showToast('Supprimé', 'success'); } else { tbody.appendChild(backup); showToast('Erreur suppression: '+(j && j.error ? j.error : 'inconnue'),'error'); } })
            .catch(function(){ tbody.appendChild(backup); showToast('Erreur réseau', 'error'); });
        }
      });

      // School info: save name + logo via AJAX
      (function(){
        var nameInput = document.getElementById('schoolNameInput');
        var logoInput = document.getElementById('schoolLogoInput');
        var preview = document.getElementById('schoolLogoPreview');
        var saveBtn = document.getElementById('saveSchoolBtn');

        if(logoInput){
          logoInput.addEventListener('change', function(e){
            var f = logoInput.files && logoInput.files[0];
            if(!f) return;
            var url = URL.createObjectURL(f);
            preview.innerHTML = '';
            var img = document.createElement('img'); img.src = url; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
            preview.appendChild(img);
          });
        }

        if(saveBtn){
          saveBtn.addEventListener('click', function(){
            var fd = new FormData();
            fd.append('school_name', nameInput.value || '');
            if(logoInput && logoInput.files && logoInput.files[0]) fd.append('school_logo', logoInput.files[0]);
            fetch('{% url "parametres_update_school" %}', { method: 'POST', body: fd, headers: {'X-CSRFToken': csrftoken} }).then(r=>r.json()).then(resp=>{
              if(resp && resp.success){ showToast('Informations école mises à jour', 'success');
                // update navbar name/logo if present
                try{ var navName = document.querySelector('.brand-name'); if(navName) { navName.textContent = resp.name || navName.textContent; navName.style.textDecoration = 'underline'; } var navLogo = document.querySelector('.brand-logo img'); if(navLogo && resp.logo) navLogo.src = resp.logo; }catch(e){}
              } else { showToast('Erreur: '+(resp.error||'unknown'), 'error'); }
            }).catch(e=> showToast('Erreur: '+e.message, 'error'));
          });
        }
      })();

      // Submit (create/update) with optimistic UI
      form.addEventListener('submit', function(e){
        e.preventDefault();
        var id = form.querySelector('[name=id]').value || '';
        var email = form.querySelector('[name=email]').value || '';
        var role = form.querySelector('[name=role]').value || '';

        var isNew = !id;
        var tempId = 'tmp-' + Date.now();
        var existing = isNew ? null : document.querySelector('tr[data-id="'+id+'"]');

        // ensure email present in FormData (some browsers/forms can omit empty fields)
        var data = new FormData(form);
        var emailField = (form.querySelector('[name=email]') || {}).value || '';
        if(!emailField || !emailField.trim()){
          showToast('Email requis', 'error');
          return;
        }
        // include password explicitly (could be empty string)
        var pwdField = (form.querySelector('[name=password]') || {}).value;
        if(pwdField === undefined) pwdField = '';
        data.set('password', pwdField);
        // now perform optimistic UI update after basic validation
        if(existing){
          var nomField = (form.querySelector('[name=nom]') || {}).value || '';
          existing.dataset.nom = nomField.trim(); existing.dataset.email = emailField.trim(); existing.dataset.role = role; existing.dataset.password = pwdField;
          existing.querySelector('td:nth-child(2)').textContent = nomField.trim();
          existing.querySelector('td:nth-child(3)').textContent = emailField.trim();
          existing.querySelector('td:nth-child(4)').textContent = pwdField || '';
          existing.querySelector('td:nth-child(5)').textContent = role || '';
        } else {
          var tr = makeRow({id: tempId, nom: (form.querySelector('[name=nom]')||{}).value || '', email: emailField.trim(), password: pwdField, role: role});
          tr.setAttribute('data-pending','true');
          tbody.appendChild(tr);
        }
        hideModal();
        showToast('Enregistrement...', 'info');
        data.set('email', emailField.trim());
        // ensure role field present
        var roleField = (form.querySelector('[name=role]') || {}).value || '';
        if(!roleField) data.set('role','');
        fetch('{% url "users_upsert" %}', { method:'POST', headers: {'X-CSRFToken': csrftoken}, body: data, credentials:'same-origin' })
          .then(r=>r.json()).then(function(j){
      if(j && j.success){
          var u = j.user;
          var row = document.querySelector('tr[data-id="'+(isNew ? tempId : u.id)+'"]') || document.querySelector('tr[data-id="'+u.id+'"]');
          // if server returned different id for new resource, update it
          if(isNew && row){ row.setAttribute('data-id', u.id); row.removeAttribute('data-pending'); row.dataset.nom = u.nom || ''; row.dataset.email = u.email; row.dataset.role = u.role; row.dataset.password = u.password || ''; row.querySelector('td:first-child').textContent = u.id; row.querySelector('td:nth-child(2)').textContent = u.nom || ''; row.querySelector('td:nth-child(3)').textContent = u.email; row.querySelector('td:nth-child(4)').textContent = u.password || ''; row.querySelector('td:nth-child(5)').textContent = u.role; }
          if(!isNew && row){ row.dataset.nom = u.nom || ''; row.dataset.email = u.email; row.dataset.role = u.role; row.dataset.password = u.password || ''; row.querySelector('td:nth-child(2)').textContent = u.nom || ''; row.querySelector('td:nth-child(3)').textContent = u.email; row.querySelector('td:nth-child(4)').textContent = u.password || ''; row.querySelector('td:nth-child(5)').textContent = u.role; }
                  showToast('Enregistré', 'success');
                } else {
              // revert optimistic update
              if(isNew){ var r = document.querySelector('tr[data-id="'+tempId+'"]'); if(r) r.remove(); }
              else if(existing){ /* existing row modified optimistically; restore values from server might be ideal - for now do nothing */ }
              showToast('Erreur enregistrement: ' + (j && j.error ? j.error : 'inconnue'), 'error');
            }
          }).catch(function(){
            // revert optimistic
            if(isNew){ var r = document.querySelector('tr[data-id="'+tempId+'"]'); if(r) r.remove(); }
            showToast('Erreur réseau', 'error');
          });
      });
    })();
    {% endif %}
    </script>
  <script>
    // DB selector: save selection to cookie and optionally notify server
    (function(){
      function setCookie(name,value,days){ var d=new Date(); d.setTime(d.getTime()+(days*24*60*60*1000)); document.cookie = name+'='+encodeURIComponent(value)+';path=/;expires='+d.toUTCString(); }
      function getCookie(name){ var match = document.cookie.match(new RegExp('(^| )'+name+'=([^;]+)')); return match ? decodeURIComponent(match[2]) : null; }

      var sel = document.getElementById('dbSelector');
      var saveBtn = document.getElementById('saveDbBtn');
      if(sel){
        // initialize from cookie if present
        var c = getCookie('active_db'); if(c) sel.value = c;
      }
      if(saveBtn){
        saveBtn.addEventListener('click', function(e){ e.preventDefault(); var v = sel.value; setCookie('active_db', v, 365); showToast('Base sélectionnée: '+v, 'success');
          // try to inform server (endpoint may not exist yet)
          fetch('{% url "parametres_set_database" %}', { method:'POST', headers:{ 'X-CSRFToken': csrftoken, 'Content-Type':'application/x-www-form-urlencoded' }, body: 'db='+encodeURIComponent(v), credentials:'same-origin' })
            .then(r=>r.json()).then(function(j){ if(j && j.success) showToast('Paramètre enregistré côté serveur', 'success'); else if(j && j.error) showToast('Erreur serveur: '+j.error,'error'); })
            .catch(function(){ /* ignore network errors; cookie persists */ });
        });
      }
    })();
  </script>
</div>
{% endblock %}