{% extends 'base.html' %}
{% load static %}
{% load static currency_filters %}
{% block title %}Étudiants - GénieSchool{% endblock %}
{% block content %}
  <style>
    /* Local styles for the students interface; keep small and page-scoped */
  .btn-primary { background-color: var(--accent-2); color: white; }
  .btn-primary:hover { background-color: #15803d; }
    .btn-secondary { background-color: #e5e7eb; color: #374151; }
    .btn-secondary:hover { background-color: #d1d5db; }
  .status-actif { background-color: var(--status-actif-bg, #dcfce7); color: var(--status-actif-text, #16a34a); }
  .status-inactif { background-color: var(--status-inactif-bg, #fee2e2); color: var(--status-inactif-text, #dc2626); }
  .modal-backdrop { background: rgba(2,6,23,0.45); }
  /* Animations removed: keep layout & colors only */
  /* Student row hover animation */
  #studentsTbody tr.student-row { transition: transform 160ms ease, box-shadow 160ms ease, background-color 160ms; cursor: pointer; }
  #studentsTbody tr.student-row:hover { transform: translateY(-6px); box-shadow: 0 10px 30px rgba(2,6,23,0.08); background-color: var(--row-hover-bg, #fbfdff); }

  /* Dark-mode: improve contrast for student list hover (white hover is not visible in dark theme) */
  [data-theme="dark"] #studentsTbody tr.student-row { background: transparent; color: #e6eef8; }
  [data-theme="dark"] #studentsTbody tr.student-row td { border-color: rgba(255,255,255,0.03); }
  [data-theme="dark"] #studentsTbody tr.student-row:hover {
    transform: translateY(-6px);
    box-shadow: 0 12px 30px rgba(2,6,23,0.5);
    /* subtle glowing gradient that works on dark backgrounds */
    background: linear-gradient(180deg, rgba(99,102,241,0.06), rgba(6,182,212,0.03));
  }
  [data-theme="dark"] #studentsTbody tr.student-row:hover td { color: #e6eef8; }
  /* Elegant action buttons */
  .icon-btn {
    background: var(--icon-btn-bg, #ffffff); border: 0; padding: 6px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; border-radius:8px;
    box-shadow: 0 4px 12px rgba(2,6,23,0.06);
    transition: transform .14s ease, box-shadow .14s ease, background-position .28s ease;
    min-width: 40px; height: 40px;
    background-size: 150% 100%;
    background-position: 0% 50%;
    position: relative; overflow: hidden;
  }
  .icon-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 28px rgba(2,6,23,0.07); background-position: 100% 50%; }
  /* Slightly smaller, muted icons for an elegant look */
  .icon-svg { width: 18px; height: 18px; display: inline-block; vertical-align: middle; transition: stroke .18s ease, fill .18s ease, opacity .14s ease; }

  /* Stronger hover for specific action buttons: print and delete */
  .row-print-btn.icon-btn, .print-btn.icon-btn { transition: transform .16s cubic-bezier(.2,.9,.25,1), box-shadow .16s ease, background .18s ease; }
  .row-print-btn.icon-btn:hover, .print-btn.icon-btn:hover { transform: translateY(-6px) scale(1.08); box-shadow: 0 18px 40px rgba(79,70,229,0.14); background: linear-gradient(90deg,#6366f1,#4f46e5); }
  .row-print-btn.icon-btn:hover .icon-svg path, .row-print-btn.icon-btn:hover .icon-svg rect, .print-btn.icon-btn:hover .icon-svg path, .print-btn.icon-btn:hover .icon-svg rect { stroke: #ffffff !important; fill: #ffffff !important; }

  .delete-btn.icon-btn { transition: transform .16s cubic-bezier(.2,.9,.25,1), box-shadow .16s ease, background .18s ease; }
  .delete-btn.icon-btn:hover { transform: translateY(-6px) scale(1.08); box-shadow: 0 18px 40px rgba(239,68,68,0.14); background: linear-gradient(90deg,#f97316,#ef4444); }
  .delete-btn.icon-btn:hover .icon-svg path, .delete-btn.icon-btn:hover .icon-svg rect { stroke: #fff5f5 !important; fill: #fff5f5 !important; }

  /* Muted/low-contrast backgrounds (subtle hint only) */
  .verify-btn.icon-btn { background-image: linear-gradient(90deg, rgba(34,197,94,0.06), rgba(6,182,212,0.04)); }
  .edit-btn.icon-btn { background-image: linear-gradient(90deg, rgba(245,158,11,0.05), rgba(245,158,11,0.02)); border: 1px solid rgba(0,0,0,0.04); }
  .delete-btn.icon-btn { background-image: linear-gradient(90deg, rgba(239,68,68,0.05), rgba(239,68,68,0.02)); border: 1px solid rgba(0,0,0,0.04); }

  /* Hover: subtle, desaturated contrast for clarity without bright colors */
  .verify-btn.icon-btn:hover .icon-svg path, .verify-btn.icon-btn:hover .icon-svg rect { stroke: #344054 !important; fill: #344054 !important; opacity: 0.95 !important; }
  .edit-btn.icon-btn:hover .icon-svg path, .edit-btn.icon-btn:hover .icon-svg rect { stroke: #4b4030 !important; fill: none !important; opacity: 0.95 !important; }
  .delete-btn.icon-btn:hover .icon-svg path, .delete-btn.icon-btn:hover .icon-svg rect { stroke: #4a2730 !important; fill: none !important; opacity: 0.95 !important; }

  /* Slightly thinner strokes for a refined look */
  .icon-svg path, .icon-svg rect { stroke-width: 1.2px; }

  /* Small elegant tooltip for icon buttons (uses data-tooltip attribute) */
  .icon-btn[data-tooltip] {
    position: relative; /* establish containing block for pseudo elements */
  }
  .icon-btn[data-tooltip]::after {
    content: attr(data-tooltip);
    position: absolute;
    left: 50%; transform: translateX(-50%) translateY(6px);
    bottom: 100%;
    background: #ffffff; /* white background as requested */
    color: #0f172a; font-size: 12px; padding: 6px 10px; border-radius: 8px;
    border: 1px solid rgba(15,23,42,0.06);
    white-space: nowrap; pointer-events: none; opacity: 0; z-index: 60;
    box-shadow: 0 6px 18px rgba(2,6,23,0.06);
    transition: opacity .18s ease, transform .18s cubic-bezier(.2,.9,.25,1), filter .18s ease;
    transform-origin: 50% 100%;
  /* removed blur to avoid dark-mode blurry popups; keep solid background */
  }
  /* remove caret: no ::before */
  .icon-btn[data-tooltip]:hover::after {
    opacity: 1; transform: translateX(-50%) translateY(0); filter: drop-shadow(0 6px 14px rgba(2,6,23,0.06));
  }
  /* Slight offset for keyboard focus as well */
  .icon-btn[data-tooltip]:focus::after { opacity: 1; transform: translateX(-50%) translateY(0); }

  /* Force SVG stroke/fill colors so icons remain visible regardless of inline attributes */
  .edit-btn.icon-btn .icon-svg path,
  .edit-btn.icon-btn .icon-svg rect {
    stroke: #b45309 !important; /* darker orange */
    fill: #fff7ed !important;
  }
  .delete-btn.icon-btn .icon-svg path,
  .delete-btn.icon-btn .icon-svg rect {
    stroke: #dc2626 !important; /* stronger red */
    fill: #fff5f5 !important;
  }
  /* Ensure small strokes are visible */
  .icon-svg path, .icon-svg rect { stroke-width: 1.4px; }
  /* View icons selection animation */
  .view-icon { transition: transform .18s cubic-bezier(.2,.9,.25,1), box-shadow .18s ease, background .18s ease; position: relative; z-index: 1; }
  .view-icon[aria-pressed="true"] { transform: translateY(-3px) scale(1.03); box-shadow: 0 8px 20px rgba(16,185,129,0.12); }
  .view-icon .h-5 { transition: transform .18s ease, color .18s ease; }
  .view-icon[aria-pressed="true"] .h-5 { transform: scale(1.06); }
  /* Moving green selection indicator behind icons */
  .view-icons-wrap { position: relative; display: inline-flex; gap: 8px; padding: 4px; align-items: center; }
  .view-indicator { position: absolute; top: 4px; left: 0; height: 40px; width: 40px; border-radius: 10px; background: linear-gradient(90deg,#bbf7d0,#86efac); box-shadow: 0 8px 24px rgba(16,185,129,0.10); transition: transform 300ms cubic-bezier(.2,.9,.25,1), width 240ms ease, background 220ms ease; z-index: 0; }
  /* optional pulse class still available */
  .selected-pulse { filter: drop-shadow(0 6px 18px rgba(16,185,129,0.08)); }
  /* Styled file picker and upload button for verification modal */
  .file-picker { display:inline-flex; align-items:center; gap:8px; border:1px solid #d1d5db; padding:6px 10px; border-radius:6px; background:#fff; cursor:pointer; transition:box-shadow .18s ease, transform .08s ease; }
  .file-picker:hover { box-shadow:0 6px 18px rgba(2,6,23,0.06); transform:translateY(-1px); }
  .file-picker .file-input { display:none; }
  .file-label { font-size:13px; color:#374151; }
  .upload-btn { background:#10b981; color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; transition:transform .12s ease, box-shadow .12s ease; }
  .upload-btn:hover { transform:translateY(-2px); box-shadow:0 8px 24px rgba(16,185,129,0.12); }
  .upload-btn:active { transform:translateY(0); }
  /* Top cancel button in verify modal */
  .verify-top-actions { display:flex; justify-content:flex-end; gap:8px; align-items:center; }
  .verify-top-actions .btn-secondary { background:#f3f4f6; color:#374151; border-radius:6px; padding:6px 10px; }
  /* Step controls styling */
  .step-controls { display:flex; gap:8px; justify-content:flex-end; align-items:center; }
  .step-btn { padding:8px 12px; border-radius:6px; border:1px solid #d1d5db; background:#fff; color:#374151; cursor:pointer; font-weight:600; transition:transform .08s ease, box-shadow .12s ease, background .12s ease; }
  .step-btn:hover { transform:translateY(-2px); box-shadow:0 8px 20px rgba(2,6,23,0.06); }
  .step-btn.primary { background:#10b981; color:white; border-color:transparent; }
  .step-btn[disabled], .step-btn.disabled { opacity:.5; cursor:not-allowed; transform:none; box-shadow:none; }
  /* Verify progress small helpers */
  .verify-circle { width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; }
  .verify-connector { height:6px; border-radius:4px; background:#e6e8eb; }
  /* Balance display classes */
  .balance-regle { background:#ecfccb; color:#065f46; padding:6px 10px; border-radius:999px; font-weight:700; }
  .balance-solde { background:var(--balance-solde-bg, #fff7ed); color:var(--balance-solde-text, #92400e); padding:6px 10px; border-radius:999px; font-weight:700; }
  .balance-credite { background:#ecfeff; color:#065f46; padding:6px 10px; border-radius:999px; font-weight:700; }
  /* Add button larger and hover */
  #openAddBtn { padding: .65rem 1.1rem; font-size: 1rem; border-radius: 10px; box-shadow: 0 8px 22px rgba(16,185,129,0.08); transition: transform .12s ease, box-shadow .12s ease, background .12s ease; }
  #openAddBtn:hover { transform: translateY(-3px); background: linear-gradient(90deg,#059669,#10b981); box-shadow: 0 12px 34px rgba(16,185,129,0.14); }
  /* Styled total restant badge */
  .total-reste {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border-radius: 999px;
    background: linear-gradient(90deg, rgba(255,243,244,1), rgba(255,250,240,1));
    border: 1px solid rgba(220,38,38,0.08);
    box-shadow: 0 6px 18px rgba(185,28,28,0.06);
    color: #b91c1c;
    font-weight: 800;
    transform-origin: center;
    transition: transform .14s ease, box-shadow .14s ease;
  }
  .total-reste:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 12px 30px rgba(185,28,28,0.12); }
  .total-reste .label { font-size: 0.95rem; color: #374151; font-weight:700; }
  .total-reste .amount { font-size: 1.25rem; font-weight: 900; color: #b91c1c; letter-spacing: 0.4px; }
  .total-reste .currency { font-size: 0.95rem; color:#374151; margin-left:4px; }
  @media (max-width: 768px) {
    .total-reste { padding: 6px 10px; }
    .total-reste .amount { font-size: 1.05rem; }
    .total-reste .label { display: none; }
  }
  
  /* Mobile Responsive Styles */
  @media (max-width: 640px) {
    /* Header adjustments */
    header.flex {
      flex-direction: column !important;
      align-items: flex-start !important;
      gap: 1rem !important;
      margin-bottom: 1.5rem !important;
    }
    
    h1 {
      font-size: 1.75rem !important;
    }
    
    /* Filters and search */
    .flex.items-center.gap-4,
    .flex.items-center.justify-between {
      flex-direction: column !important;
      align-items: stretch !important;
      gap: 0.75rem !important;
      width: 100% !important;
    }
    
    /* Buttons */
    #openAddBtn,
    .btn-primary,
    .btn-secondary {
      width: 100% !important;
      padding: 14px 20px !important;
      font-size: 15px !important;
      border-radius: 12px !important;
    }
    
    /* Search input */
    input[type="text"],
    input[type="search"],
    select {
      width: 100% !important;
      padding: 14px 16px !important;
      font-size: 16px !important; /* Prevent zoom on iOS */
      border-radius: 12px !important;
    }
    
    /* Table - convert to cards on mobile */
    #tableView {
      display: none !important;
    }
    
    #cardView {
      display: block !important;
    }
    
    /* Card grid */
    .grid.grid-cols-1.gap-6 {
      grid-template-columns: 1fr !important;
      gap: 1rem !important;
    }
    
    /* Student cards */
    .student-row {
      border-radius: 16px !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08) !important;
      background: linear-gradient(135deg, rgba(236,72,153,0.03), rgba(219,39,119,0.03)) !important;
      border-left: 4px solid #ec4899 !important;
      animation: studentCardSlide 0.4s ease-out backwards;
      overflow: hidden;
    }
    
    @keyframes studentCardSlide {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    /* Stagger card animations */
    .student-row:nth-child(1) { animation-delay: 0.1s; }
    .student-row:nth-child(2) { animation-delay: 0.2s; }
    .student-row:nth-child(3) { animation-delay: 0.3s; }
    .student-row:nth-child(4) { animation-delay: 0.4s; }
    .student-row:nth-child(5) { animation-delay: 0.5s; }
    
    .student-row:hover {
      transform: translateY(-4px) !important;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12) !important;
    }
    
    .student-row:active {
      transform: scale(0.98) !important;
    }
    
    /* Avatar size */
    .student-row img {
      width: 80px !important;
      height: 80px !important;
    }
    
    /* Status badges */
    .status-actif,
    .status-inactif {
      padding: 8px 12px !important;
      font-size: 0.85rem !important;
      border-radius: 12px !important;
    }
    
    /* Action buttons */
    .action-btn-group {
      flex-wrap: wrap !important;
      gap: 0.5rem !important;
    }
    
    .icon-btn {
      width: 44px !important;
      height: 44px !important;
    }
    
    /* Modal adjustments */
    #addModal > div.bg-white {
      width: 100% !important;
      max-width: 100% !important;
      margin: 0 !important;
      border-radius: 20px 20px 0 0 !important;
      max-height: 90vh !important;
      overflow-y: auto !important;
    }
    
    #addModal {
      align-items: flex-end !important;
      padding: 0 !important;
    }
    
    /* Pagination */
    nav.flex.items-center.justify-between {
      flex-direction: column !important;
      gap: 1rem !important;
    }
    
    .space-x-2 {
      display: flex !important;
      flex-wrap: wrap !important;
      gap: 0.5rem !important;
    }
  }
  </style>

  <style>
    /* Tighter modal: remove blur, reduce empty space and shrink elements for compactness */
    .modal-backdrop { background: rgba(0,0,0,0.25); }
    /* Modal panel sizing and entrance - wider but denser to avoid internal scroll */
    #addModal > div.bg-white {
      max-width: 980px;
      width: calc(100% - 96px);
  max-height: 98vh;
  min-height: auto;
  overflow-y: visible;
      padding: 0.6rem !important;
      border-radius: 10px;
      box-shadow: 0 10px 28px rgba(2,6,23,0.08);
      transform-origin: center center;
      animation: appearUpLarge .28s cubic-bezier(.2,.9,.25,1) both;
    }
    /* center modal to avoid large empty area below */
    #addModal { align-items: center !important; padding-top: 0 !important; }

    /* header */
    #addModal h2 { font-size: 1.05rem; letter-spacing: -0.2px; margin-bottom: .25rem; }

    /* Inputs: slightly taller, a bit less wide for breathing room, and slightly larger text for readability */
    #addModal input[type="text"], #addModal input[type="email"], #addModal input[type="date"], #addModal select, #addModal input[type="file"] {
      height: 2.6rem; padding: .45rem .75rem !important; font-size: 1rem !important; border-radius: 8px;
      transition: box-shadow .12s ease, transform .10s ease, border-color .12s ease;
    }
    /* Reduce full-width inputs slightly so they don't touch the panel edges (visual from provided screenshot) */
    #addModal input[class*="w-full"],
    #addModal select[class*="w-full"],
    #addModal textarea[class*="w-full"] {
      max-width: calc(100% - 18px);
      box-sizing: border-box;
    }
    #addModal textarea { min-height: 6.5rem; padding: .5rem .75rem !important; font-size:1rem !important; border-radius:8px; }
    #addModal input:focus, #addModal textarea:focus, #addModal select:focus { outline: none; box-shadow: 0 6px 20px rgba(16,185,129,0.09); border-color: rgba(16,185,129,0.9); }

    /* Buttons */
    #addModal .btn-primary, #addModal button[type="submit"] { background:#16a34a; border:none; color:#fff; border-radius:8px; }
    #addModal .btn-secondary, #addModal button[type="button"] { background:#f3f4f6; color:#374151; border-radius:8px; }

  /* Photo placeholder: enlarge to match screenshot and keep circular crop */
  #addModal .photo-picker-large { width: 10.5rem !important; height: 10.5rem !important; border-radius: 12px; overflow: hidden; }
  #addModal .photo-picker-large img { width:100%; height:100%; object-fit:cover; }
  /* The form uses a label[for="photoInput"] as the visible avatar area — increase it here */
  #addModal label[for="photoInput"] { width: 14rem; height: 14rem; border-radius: 9999px; display:flex; align-items:center; justify-content:center; overflow:hidden; }
  #addModal label[for="photoInput"] .material-icons { font-size: 4.2rem; color: #4b5563; }
  #addModal label[for="photoInput"] p { margin: 0; }

    /* Responsive grid: stack on small, three equal columns on md+ so rows with md:grid-cols-3 get 3 columns */
    #addModal .grid.grid-cols-1.md\:grid-cols-3 { grid-template-columns: repeat(1, minmax(0,1fr)); }
    @media(min-width:768px){
      /* Use three equal columns for md:grid-cols-3 (Date / Lieu / NIN row) */
      #addModal .grid.grid-cols-1.md\:grid-cols-3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    }

  /* Align form inner grid: two columns on md+, stacked on small. Use denser gaps */
  #addModal .form-grid { display: grid; grid-template-columns: repeat(1, minmax(0,1fr)); gap: .5rem; }
  @media(min-width:768px){ #addModal .form-grid { grid-template-columns: repeat(2, minmax(0,1fr)); gap:.6rem; } }

  /* Make the remarks / infos area larger and add breathing room above action buttons */
  /* Keep add/edit infos textarea consistent size */
  #addModal textarea[name="remarques"],
  #addModal textarea#infos_supplementaires,
  #editModal textarea#infos_supplementaires_edit,
  #editModal textarea[name="remarques"] { min-height: 8rem; }
  /* Add more space between the last infos field and the action buttons like the provided screenshot */
  #addModal .flex.justify-between.items-center { margin-top: 3.5rem; }

  /* Align the third form row (genre / date / lieu) with the bottom of the photo on medium+ screens */
  @media(min-width:768px){
    #addModal .align-with-photo { margin-top: 6.8rem; }
  }

    /* entrance keyframes */
    @keyframes appearUpLarge { from { opacity: 0; transform: translateY(6vh) scale(.99); } to { opacity:1; transform: translateY(0) scale(1); } }

    /* subtle fade-in for modal content blocks */
    .modal-section { animation: fadeInSmall .28s ease both; }
    @keyframes fadeInSmall { from { opacity: 0; transform: translateY(6px); } to { opacity:1; transform: translateY(0); } }
  </style>

  <main>
    <!-- Header exactly matching the screenshot: minimal, centered search, left icons, right add button, filter row below -->
    <header class="bg-white rounded-md px-6 py-4 mb-6 shadow-sm">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="view-icons-wrap">
            <div id="viewIndicator" class="view-indicator" aria-hidden="true"></div>
            <button id="viewGridIcon" onclick="toggleView('grid')" class="view-icon inline-flex h-10 w-10 items-center justify-center rounded-md bg-green-100 text-green-600" aria-label="grid" aria-pressed="false">
              <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="3" width="7" height="7" rx="1"></rect><rect x="14" y="14" width="7" height="7" rx="1"></rect><rect x="3" y="14" width="7" height="7" rx="1"></rect></svg>
            </button>
            <button id="viewListIcon" onclick="toggleView('list')" class="view-icon inline-flex h-10 w-10 items-center justify-center rounded-md text-gray-600" aria-label="menu" aria-pressed="false">
              <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 6h16"></path><path d="M4 12h16"></path><path d="M4 18h16"></path></svg>
            </button>
          </div>
        </div>

        <div class="flex-1 px-8">
          <div class="relative max-w-2xl mx-auto">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>
            <input id="searchInput" type="search" placeholder="Search students..." class="w-full rounded-md border border-gray-200 py-3 pl-11 pr-4 text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" />
          </div>
        </div>

        <div>
          <button id="openAddBtn" class="inline-flex items-center gap-2 rounded-md bg-green-600 px-4 py-2 text-sm font-medium text-white hover:bg-green-700">+ Ajouter un Etudiant</button>
        </div>
      </div>

          <div class="mt-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <!-- Sort control used by JS -->
          <select id="sortFilter" class="rounded-md border border-gray-200 bg-white px-3 py-2 text-sm">
            <option value="">Trier</option>
            <option value="alpha">Alphabetical</option>
            <option value="recent">Plus récent</option>
            <option value="oldest">Plus ancien</option>
          </select>
          <select id="statusFilter" class="rounded-md border border-gray-200 bg-white px-3 py-2 text-sm">
            <option value="all">Status</option>
            <option value="inscrit">Inscrit</option>
            <option value="non_inscrit">Non inscrit</option>
            <option value="verifie">Verifié</option>
            <option value="non_verifie">Non verifié</option>
          </select>
          <!-- Formation filter (strict uses data-formation on rows/cards) -->
          <select id="formationFilter" class="rounded-md border border-gray-200 bg-white px-3 py-2 text-sm" style="min-width:220px;">
            <option value="">Toutes les formations</option>
            {% for f in formations %}
            <option value="{{ f.nom }}">{{ f.nom }}</option>
            {% endfor %}
          </select>
          <!-- Ecole filter removed (not needed on students page) -->
          <!-- Visible frais restant filter for users: negative / positive balances -->
          <select id="fraisFilterVisible" class="rounded-md border border-gray-200 bg-white px-3 py-2 text-sm">
            <option value="">Tous</option>
            <option value="negatif">Solde négatif (à payer)</option>
            <option value="positif">Solde positif (crédit)</option>
            <option value="regle">Réglé (0)</option>
          </select>
          <!-- keep a hidden fraisFilter for compatibility if any server-side code reads it -->
          <select id="fraisFilter" style="display:none;">
            <option value="">Tous</option>
            <option value="negatif">negatif</option>
            <option value="positif">positif</option>
          </select>
        </div>

        <div class="flex items-center gap-3">
          <!-- Total restant à payer pour les étudiants filtrés (mis à jour côté client lors des filtres) -->
          <div id="totalResteContainer" class="mr-4 text-right">
            {% if total_reste_a_payer %}
              <div class="total-reste" role="status" aria-live="polite">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 8v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 8V6a5 5 0 0 1 10 0v2" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <div class="label">Total restant à payer :</div>
                <div class="amount"><span id="totalResteValue">{{ total_reste_a_payer|floatformat:0 }}</span></div>
                <div class="currency">DA</div>
              </div>
            {% else %}
              <div class="total-reste" role="status" aria-live="polite">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 8v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 8V6a5 5 0 0 1 10 0v2" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <div class="label">Total restant à payer :</div>
                <div class="amount"><span id="totalResteValue">0</span></div>
                <div class="currency">DA</div>
              </div>
            {% endif %}
          </div>
          <button id="exportXlsxBtn" class="inline-flex items-center gap-2 rounded-md border border-gray-200 bg-white px-4 py-2 text-sm text-gray-700">
            <svg class="h-4 w-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 5v14"></path><path d="M5 12h14"></path></svg>
            Export Excel
          </button>
          <button id="exportPdfBtn" class="inline-flex items-center gap-2 rounded-md border border-gray-200 bg-white px-4 py-2 text-sm text-gray-700">
            <svg class="h-4 w-4 text-gray-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line></svg>
            Export PDF
          </button>
          <!-- Hidden CSV / JSON buttons (JS references them) -->
          <button id="exportCsvBtn" style="display:none;"></button>
          <button id="exportJsonBtn" style="display:none;"></button>
        </div>
      </div>
    </header>

    <!-- Vue Tableau (desktop) -->
    <div id="tableView" class="overflow-x-auto bg-white rounded-xl shadow hidden sm:block">
      <table class="min-w-full text-sm text-left text-gray-700">
        <thead class="bg-gray-100 text-gray-600 uppercase text-xs font-semibold">
          <tr>
            <th class="px-6 py-3">ID</th>
            <th class="px-6 py-3">Photo</th>
            <th class="px-6 py-3">NOM / PRÉNOM</th>
            <th class="px-6 py-3">Tél</th>
            <th class="px-6 py-3">Adresse</th>
            <th class="px-6 py-3">Frais restant à payer</th>
            <th class="px-6 py-3">Statut</th>
            <th class="px-6 py-3">Vérification</th>
            <th class="px-6 py-3 text-right">Actions
              <!-- header print removed; printing is per-row -->
            </th>
          </tr>
        </thead>
        <tbody id="studentsTbody">
          {% for s in students %}
          <tr class="border-b student-row" data-id="{{ s.id }}" data-nom="{{ s.nom }}" data-prenom="{{ s.prenom }}" data-name="{{ s.nom }} {{ s.prenom }}" data-nom_arabe="{{ s.nom_arabe|default:'' }}" data-prenom_arabe="{{ s.prenom_arabe|default:'' }}" data-email="{{ s.email }}" data-phone="{{ s.telephone }}" data-address="{{ s.adresse|default:'' }}" data-ecole="{{ s.ecole|default:'' }}" data-remaining="{{ s.remaining_fees }}" data-regle="{{ s.regle|default:False }}" data-status="{{ s.statut|default:'Actif' }}" data-photo="{{ s.photo_url|default:'' }}" data-sexe="{{ s.sexe|default:'' }}" data-date_naissance="{{ s.date_naissance|default:'' }}" data-lieu_naissance="{{ s.lieu_naissance|default:'' }}" data-nationalite="{{ s.nationalite|default:'' }}" data-nin="{{ s.nin|default:'' }}" data-remarques="{{ s.remarques|default:''|escape }}" data-extrait="{{ s.extrait_naissance_photo|default:'' }}" data-carte="{{ s.carte_identite_photo|default:'' }}" data-verify="{{ s.verification_step|default:0 }}" data-niveau="{{ s.niveau_etude|default:'' }}" data-situation="{% if s.situation %}{{ s.situation }}{% else %}{{ s.situation_professionnelle|default:'' }}{% endif %}" data-dernier_diplome="{{ s.dernier_diplome|default:'' }}" data-formation="{% if s.formation %}{{ s.formation.id }}{% else %}{{ s.formation_text|default:'' }}{% endif %}" data-formation-id="{{ s.formation_id_for_filter|default:'' }}" data-formation-text="{{ s.display_formation|default:'' }}" data-display-formation="{{ s.display_formation|default:'' }}" data-inscription="{% if s.inscription_status == 'inscrit' or s.statut == 'Actif' %}inscrit{% else %}non_inscrit{% endif %}">
            <td class="px-6 py-4 font-mono text-sm">{{ s.id }}</td>
            <td class="px-6 py-4"><img src="{% if s.photo_url %}{{ s.photo_url }}{% else %}{% static 'images/delete_18986470.gif' %}{% endif %}" class="w-10 h-10 rounded-full"/></td>
            <td class="px-6 py-4 font-semibold">{{ s.nom }} {{ s.prenom }}
              <div class="text-xs text-gray-500">{{ s.email|default:'' }}</div>
            </td>
            <td class="px-6 py-4">
              {% if s.telephone %}
                {{ s.telephone }}
              {% elif s.mobile %}
                {{ s.mobile }}
              {% elif s.phone %}
                {{ s.phone }}
              {% else %}
                -
              {% endif %}
            </td>
            <td class="px-6 py-4">{{ s.adresse|default:'-' }}</td>
            <td class="px-6 py-4">
              {% if s.exclude_from_totals %}
                {% if s.marked_regle or s.regle %}
                  <span class="balance-regle">Réglé</span>
                {% else %}
                  <span class="balance-solde">Non réglé</span>
                {% endif %}
              {% else %}
                {% if s.marked_regle or s.regle %}
                  <span class="balance-regle">Réglé</span>
                {% else %}
                  <span class="{{ s.remaining_fees|balance_class }}">{{ s.remaining_fees|balance_for_student }}</span>
                {% endif %}
              {% endif %}
            </td>
            <td class="px-6 py-4">
              {% if s.inscription_status == 'inscrit' %}
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Inscrit</span>
              {% else %}
                  <a href="{% url 'inscriptions' %}?etudiant_id={{ s.id }}" class="status-inactif px-3 py-1 rounded-full text-xs font-semibold open-add-inscription" data-etudiant="{{ s.id }}" data-etudiant-name="{{ s.nom }} {{ s.prenom }}">Non inscrit</a>
              {% endif %}
            </td>
            <td class="px-6 py-4">
              {% if s.verification_step|default:0 == 3 %}
                <span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Vérifié</span>
              {% else %}
                <span class="status-inactif px-3 py-1 rounded-full text-xs font-semibold">Non vérifié</span>
              {% endif %}
            </td>
            <td class="px-6 py-4 text-right">
            <!-- print button removed -->
              <!-- Delete kept for admin actions -->
              <button class="view-card-btn icon-btn" title="Voir la carte" aria-label="Voir la carte" data-tooltip="Voir la carte" data-student-id="{{ s.id }}">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="6" width="18" height="12" rx="2" stroke="#10b981" stroke-width="1.4" fill="#ecfdf5"/><circle cx="8.5" cy="12" r="1.8" fill="#065f46"/><rect x="11" y="10" width="7" height="4" rx="1" fill="#ffffff" stroke="#065f46" stroke-width="0.8"/></svg>
              </button>
              <span style="display:inline-block;width:8px"></span>
              <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
                  <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
                  <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
                </svg>
              </button>
              {% if s.marked_regle or s.regle %}
                <span class="balance-regle px-3 py-1 rounded-full text-xs font-semibold" style="margin-left:8px;">Réglé</span>
              {% else %}
                <button class="verify-btn icon-btn mark-paid-btn" title="Marquer réglé" aria-label="Marquer réglé" data-student-id="{{ s.id }}" style="margin-left:8px;">
                  <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17l-5-5" stroke="#065f46" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Aucun étudiant trouvé.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Mobile list: cards stacked (visible only on small screens) -->
    <div id="mobileList" class="sm:hidden space-y-3">
      {% for s in students %}
      <div class="bg-white rounded-lg p-3 shadow flex items-center justify-between" data-ecole="{{ s.ecole|default:'' }}">
        <div class="flex items-center gap-3">
          <img src="{% if s.photo_url %}{{ s.photo_url }}{% else %}{% static 'images/delete_18986470.gif' %}{% endif %}" class="w-12 h-12 rounded-full object-cover" />
          <div>
            <div class="font-semibold">{{ s.nom }} {{ s.prenom }}</div>
            <div class="text-xs text-gray-500">{{ s.email|default:'-' }}</div>
            <div class="text-xs text-gray-500">{{ s.telephone|default:'-' }}</div>
          </div>
        </div>
        <div class="text-right flex flex-col items-end gap-2">
          <div class="text-sm">
            {% if s.exclude_from_totals %}
              {% if s.marked_regle or s.regle %}
                <span class="balance-regle">Réglé</span>
              {% else %}
                <span class="balance-solde">Non réglé</span>
              {% endif %}
            {% else %}
              {% if s.marked_regle or s.regle %}
                <span class="balance-regle">Réglé</span>
              {% else %}
                {% if s.remaining_fees %}
                  <span class="{{ s.remaining_fees|balance_class }}">{{ s.remaining_fees|balance_for_student }}</span>
                {% else %}-{% endif %}
              {% endif %}
            {% endif %}
          </div>
          <div class="flex items-center gap-2">
            <a href="{% url 'inscriptions' %}?etudiant_id={{ s.id }}" class="px-2 py-1 rounded bg-green-50 text-green-700 text-xs">Inscrire</a>
            <button class="icon-btn view-card-btn" data-student-id="{{ s.id }}" title="Voir la carte" aria-label="Voir la carte">
              <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="6" width="18" height="12" rx="2" stroke="#10b981" stroke-width="1.4" fill="#ecfdf5"/><circle cx="8.5" cy="12" r="1.8" fill="#065f46"/><rect x="11" y="10" width="7" height="4" rx="1" fill="#ffffff" stroke="#065f46" stroke-width="0.8"/></svg>
            </button>
            <button class="icon-btn delete-btn" data-id="{{ s.id }}" aria-label="Supprimer">
              <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5"/><path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round"/></svg>
            </button>
            {% if s.marked_regle or s.regle %}
              <span class="balance-regle px-3 py-1 rounded-full text-xs font-semibold">Réglé</span>
            {% else %}
              <button class="icon-btn mark-paid-btn" data-student-id="{{ s.id }}" title="Marquer réglé" aria-label="Marquer réglé">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17l-5-5" stroke="#065f46" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
            {% endif %}
          </div>
        </div>
      </div>
      {% empty %}
      <div class="text-center text-gray-500">Aucun étudiant trouvé.</div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <nav class="mt-4 flex items-center justify-between">
      <div>
        <span class="text-sm text-gray-600">Affichage {{ page_obj.start_index }}–{{ page_obj.end_index }} sur {{ paginator.count }}</span>
      </div>
      <div class="space-x-2">
        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}&per_page={{ per_page }}{% if current_niveau %}&niveau={{ current_niveau }}{% endif %}" class="px-3 py-1 bg-white border rounded">Précédent</a>
        {% else %}
          <span class="px-3 py-1 bg-gray-100 border rounded text-gray-400">Précédent</span>
        {% endif %}

        {% for num in paginator.page_range %}
          {% if num == page_obj.number %}
            <span class="px-3 py-1 bg-green-100 border rounded font-semibold">{{ num }}</span>
            {% elif num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
            <a href="?page={{ num }}&per_page={{ per_page }}{% if current_niveau %}&niveau={{ current_niveau }}{% endif %}" class="px-3 py-1 bg-white border rounded">{{ num }}</a>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}&per_page={{ per_page }}{% if current_niveau %}&niveau={{ current_niveau }}{% endif %}" class="px-3 py-1 bg-white border rounded">Suivants</a>
        {% else %}
          <span class="px-3 py-1 bg-gray-100 border rounded text-gray-400">Suivants</span>
        {% endif %}
      </div>
    </nav>
    {% endif %}

    <!-- Vue Cartes -->
    <div id="cardView" class="hidden">
      <main class="flex-1 p-4 md:p-8">
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5">
          {% for s in students %}
          <div class="group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row" role="button" tabindex="0" data-id="{{ s.id }}" data-name="{{ s.nom }} {{ s.prenom }}" data-nom_arabe="{{ s.nom_arabe|default:'' }}" data-prenom_arabe="{{ s.prenom_arabe|default:'' }}" data-email="{{ s.email|default:'' }}" data-phone="{{ s.telephone|default:'' }}" data-address="{{ s.adresse|default:'' }}" data-ecole="{{ s.ecole|default:'' }}" data-remaining="{{ s.remaining_fees|default:0 }}" data-status="{{ s.statut|default:'Actif' }}" data-photo="{% if s.photo_url %}{{ s.photo_url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" data-sexe="{{ s.sexe|default:'' }}" data-date_naissance="{{ s.date_naissance|default:'' }}" data-lieu_naissance="{{ s.lieu_naissance|default:'' }}" data-nationalite="{{ s.nationalite|default:'' }}" data-nin="{{ s.nin|default:'' }}" data-remarques="{{ s.remarques|default:''|escape }}" data-extrait="{{ s.extrait_naissance_photo.url|default:'' }}" data-carte="{{ s.carte_identite_photo.url|default:'' }}" data-verify="{{ s.verification_step|default:0 }}" data-niveau="{{ s.niveau_etude|default:'' }}" data-situation="{% if s.situation %}{{ s.situation }}{% else %}{{ s.situation_professionnelle|default:'' }}{% endif %}" data-dernier_diplome="{{ s.dernier_diplome|default:'' }}" data-formation="{% if s.formation %}{{ s.formation.id }}{% else %}{{ s.formation_text|default:'' }}{% endif %}" data-formation-text="{{ s.display_formation|default:'' }}" data-display-formation="{{ s.display_formation|default:'' }}" data-inscription="{% if s.inscription_status == 'inscrit' or s.statut == 'Actif' %}inscrit{% else %}non_inscrit{% endif %}">
            <div class="flex h-40 items-center justify-center pt-4">
              <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="{% if s.photo_url %}{{ s.photo_url }}{% elif s.photo %}{{ s.photo.url }}{% else %}{% static 'images/delete_18986470.gif'%}{% endif %}"/>
            </div>
            <div class="p-4 text-center">
              <h3 class="text-base font-semibold text-gray-800">{{ s.nom }} {{ s.prenom }}</h3>
              <p class="text-sm text-gray-500">
                {% if s.telephone %}{{ s.telephone }}{% elif s.mobile %}{{ s.mobile }}{% elif s.phone %}{{ s.phone }}{% else %}-{% endif %}
              </p>
              {% if s.inscription_status == 'inscrit' or s.statut == 'Actif' %}
                <span class="mt-2 inline-block status-actif px-3 py-1 text-xs font-semibold">Inscrit</span>
              {% else %}
                <a href="{% url 'inscriptions' %}?etudiant_id={{ s.id }}" class="mt-2 inline-block status-inactif px-3 py-1 text-xs font-semibold open-add-inscription" data-etudiant="{{ s.id }}" data-etudiant-name="{{ s.nom }} {{ s.prenom }}">Non inscrit</a>
              {% endif %}
              <!-- actions (print button removed) -->
            </div>
          </div>
          {% empty %}
            <div class="col-span-full text-center text-gray-500">Aucune carte d'étudiant disponible.</div>
          {% endfor %}
        </div>
      </main>

      <!-- Student Card Modal (moved outside cardView so it can open from any view: table or grid) -->
      <!-- Student Card Modal -->
      <div id="studentCardModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
        <div class="bg-white rounded-2xl p-6 shadow-xl w-full max-w-sm">
          <div class="flex items-start justify-between">
            <h3 class="text-lg font-semibold">Carte Étudiant</h3>
            <button id="closeStudentCard" class="p-2 rounded-full hover:bg-gray-100">✕</button>
          </div>
          <div class="mt-4 flex flex-col items-center gap-3">
            <div id="cardPhotoWrap" class="w-28 h-28 rounded-full overflow-hidden bg-gray-100">
              <img id="cardPhoto" src="" alt="photo" class="w-full h-full object-cover" />
            </div>
            <div class="text-center">
              <div id="cardName" class="text-xl font-bold"></div>
              <div id="cardDob" class="text-sm text-gray-600"></div>
              <div id="cardCode" class="text-sm text-gray-700 font-mono mt-2"></div>
            </div>
            <div id="cardQr" class="mt-3"></div>
            <div class="w-full flex justify-end mt-4">
              <button id="printCardBtn" class="px-4 py-2 rounded bg-green-600 text-white">Imprimer</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Include a small QR generator library (qrious) from CDN and modal JS -->
      <script src="{% static 'static/vendor/js/qrious.min.js' %}"></script>
      <script>
        (function(){
          // Modal elements
          const modal = document.getElementById('studentCardModal');
          const closeBtn = document.getElementById('closeStudentCard');
          const printBtn = document.getElementById('printCardBtn');
          const cardPhoto = document.getElementById('cardPhoto');
          const cardName = document.getElementById('cardName');
          const cardDob = document.getElementById('cardDob');
          const cardCode = document.getElementById('cardCode');
          const cardQr = document.getElementById('cardQr');

          function openCardFromRow(tr){
            // If tr is a student-row element (from either table or grid), read datasets
            const nom = tr.dataset.nom || tr.dataset.name || '';
            const prenom = tr.dataset.prenom || '';
            const fullname = (nom + ' ' + prenom).trim() || tr.dataset.name || '';
            const dob = tr.dataset.date_naissance || '';
            const nin = tr.dataset.nin || '';
            const id = tr.dataset.id || '';
            const photo = tr.dataset.photo || '';

            // set fields
            cardPhoto.src = photo || '{% static "images/delete_18986470.gif" %}';
            cardName.textContent = fullname;
            cardDob.textContent = dob ? ('Né(e) le: ' + dob) : '';
            const codeToShow = nin || id;
            cardCode.textContent = codeToShow ? ('Code: ' + codeToShow) : '';

            // generate QR containing only the student code (nin preferred, else id)
            cardQr.innerHTML = '';
            if(codeToShow){
              try{
                const qr = new QRious({ value: String(codeToShow), size: 160 });
                const img = document.createElement('img'); img.src = qr.toDataURL(); img.alt = 'QR code'; img.width = 160; img.height = 160;
                cardQr.appendChild(img);
              }catch(e){ /* ignore if QR lib fails */ }
            }

            // ensure modal is appended to document.body so it's not hidden by any ancestor
            if(modal.parentNode !== document.body) document.body.appendChild(modal);
            modal.classList.remove('hidden'); modal.classList.add('flex');
          }

          // wire open buttons (table + mobile)
          document.querySelectorAll('.view-card-btn').forEach(b=>{
            b.addEventListener('click', function(ev){ ev.stopPropagation(); ev.preventDefault(); const id = this.dataset.studentId; const tr = document.querySelector(`tr.student-row[data-id="${id}"]`) || document.querySelector(`.student-row[data-id="${id}"]`); if(tr) openCardFromRow(tr); });
          });

          // NOTE: Opening the student card used to occur by clicking the entire row,
          // but that conflicted with the edit-modal behavior (clicking a row should
          // open the edit modal). To avoid the card appearing on top of the edit
          // popup, we only open the student card via the dedicated "Voir la carte"
          // buttons (class `.view-card-btn`). The row click is handled elsewhere
          // to open the edit modal.

          closeBtn.addEventListener('click', ()=>{ modal.classList.add('hidden'); modal.classList.remove('flex'); });
          printBtn.addEventListener('click', ()=>{
            // print just the modal content: open new window with card HTML
            const w = window.open('', '_blank');
            if(!w) return alert('Impossible d\'ouvrir la fenêtre d\'impression');
            const content = document.querySelector('#studentCardModal .bg-white');
            const html = `<!doctype html><html><head><meta charset="utf-8"><title>Carte Étudiant</title></head><body style="font-family:Arial,Helvetica,sans-serif;padding:20px;">` + (content ? content.outerHTML : '') + `</body></html>`;
            w.document.write(html); w.document.close(); w.focus(); setTimeout(()=>{ w.print(); }, 300);
          });
        })();
      </script>
    </div>
    <!-- Add Modal (clean, single copy matching ajout.txt layout) -->
    <div id="addModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full" style="max-width:980px; width:calc(100% - 48px); max-height:95vh; overflow:hidden; display:flex; flex-direction:column; font-family: 'Roboto', Roboto, system-ui, -apple-system, 'Segoe UI', sans-serif;">
        <h1 class="text-2xl font-bold text-center mb-4">Etudiant</h1>
        <form id="addForm" enctype="multipart/form-data" style="display:flex;flex-direction:column;flex:1 1 auto;overflow:auto;padding-bottom:12px;">
          {% csrf_token %}
          <!-- CSS grid: left photo column spans 4 rows on desktop; on small screens the photo stacks on top -->
          <div class="add-modal-grid" style="display:grid;grid-template-columns:14rem 1fr;grid-template-rows:auto auto auto auto;gap:1rem;align-items:start;">
            <div class="photo-col" style="grid-row:1 / span 4; display:flex;flex-direction:column;align-items:center;justify-content:flex-start;">
              <label for="photoInput" class="photo-label" style="width:14rem;height:14rem;border-radius:9999px;border:2px dashed #d1d5db;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f8fafb;margin-bottom:0.75rem;cursor:pointer;overflow:hidden;">
                <!-- Default avatar SVG when no photo uploaded -->
                <svg aria-hidden="true" focusable="false" width="72" height="72" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color:#4b5563">
                  <circle cx="12" cy="8" r="3.6" fill="#E6EEF3" stroke="#CBD5E1"></circle>
                  <path d="M4 20c0-3.3 3.6-6 8-6s8 2.7 8 6" fill="#F8FAFB" stroke="#CBD5E1"></path>
                </svg>
                <p class="text-sm text-gray-500 mt-2" style="margin:0">Photo</p>
                <p class="text-xs text-gray-400" style="margin:0">PNG, JPG</p>
              </label>
              <input id="photoInput" type="file" name="photo" accept="image/*" class="hidden" />
            </div>
            <div class="form-col" style="grid-column:2;grid-row:1 / span 2;display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;">
              <div>
                <label class="block text-sm font-medium text-gray-700" for="nom">Nom</label>
                <input name="nom" id="nom" tabindex="1" required style="font-size:19px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Entrez votre nom" type="text" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 text-right" for="nom_ar">اللقب</label>
                <input name="nom_arabe" id="nom_ar" tabindex="3" dir="rtl" class="mt-1 block w-full ml-auto px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" type="text" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700" for="prenom">Prénom</label>
                <input name="prenom" id="prenom" tabindex="2" required style="font-size:15px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Entrez votre prénom" type="text" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 text-right" for="prenom_ar">الاسم</label>
                <input name="prenom_arabe" id="prenom_ar" tabindex="4" dir="rtl" class="mt-1 block w-full ml-auto px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" type="text" />
              </div>
            </div>
            <div style="grid-column:2;grid-row:4;">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2 items-center">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="sexe">Genre</label>
                  <div class="relative mt-1">
                    <select name="sexe" id="sexe" style="font-size:15px" class="block w-full appearance-none px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                      <option value="">-- Sexe --</option>
                      <option value="M">Masculin</option>
                      <option value="F">Féminin</option>
                    </select>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="lieu_naissance">Lieu de Naissance</label>
                  <input name="lieu_naissance" id="lieu_naissance" list="lieu_list" style="font-size:15px" class="block w-full mt-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Entrez lieu de naissance" type="text" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="date_naissance">Date de Naissance</label>
                  <div style="position:relative">
                    <input name="date_naissance" id="date_naissance" style="padding-right:2.6rem" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="JJ/MM/AAAA" type="date" />
                    
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
              <div class="md:col-span-1">
              <label class="block text-sm font-medium text-gray-700" for="nin">NIN</label>
              <input name="nin" id="nin" style="font-size:15px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Ex: 123456789" type="text" />
              <div id="ninErrorAdd" class="text-sm text-red-600 mt-1 hidden" role="alert" aria-live="polite">
                <span class="material-icons" style="font-size:16px;vertical-align:middle;margin-right:6px;">error_outline</span>
                <span id="ninErrorAddMsg"></span>
              </div>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700" for="nationalite">Nationalité</label>
              <input name="nationalite" id="nationalite" list="nationalite_list" value="Algérien" style="font-size:15px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Entrez nationalité" type="text" />
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div>
              <label class="block text-sm font-medium text-gray-700" for="telephone">Téléphone</label>
              <input name="telephone" id="telephone" style="font-size:15px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="+33 6 12 34 56 78" type="tel" />
              <div id="telErrorAdd" class="text-sm text-red-600 mt-1 hidden" role="alert" aria-live="polite">
                <span class="material-icons" style="font-size:16px;vertical-align:middle;margin-right:6px;">error_outline</span>
                <span id="telErrorAddMsg"></span>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700" for="email">Email</label>
              <input name="email" id="email" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="nom.prenom@email.com" type="email" />
            </div>
            <div x-data="{ social: '', profile: '' }">
              <label class="block text-sm font-medium text-gray-700" for="social_network">Réseaux sociaux</label>
              <div class="relative mt-1 w-full">
                <select name="social_network" id="social_network" x-model="social" class="block w-full appearance-none px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                  <option value="">Sélectionnez</option>
                  <option value="instagram">Instagram</option>
                  <option value="facebook">Facebook</option>
                  <option value="whatsapp">WhatsApp</option>
                  <option value="telegram">Telegram</option>
                </select>
                <!-- removed duplicate visual arrow; select already shows native arrow in most browsers -->
              </div>
              <div class="mt-2 w-full" x-show="social">
                <input name="social_profile" id="social_profile" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Nom du profil" type="text" x-model="profile" />
              </div>
            </div>
          </div>

          <!-- Ligne ajoutée : niveau d'étude, situation et dernier diplôme -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
            <div>
              <label class="block text-sm font-medium text-gray-700" for="niveau_etude">Niveau d'étude</label>
              <select name="niveau_etude" id="niveau_etude" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                <default>Universitaire</default>
                <option value="">Sélectionnez</option>

                <option value="primaire">Primaire</option>
                <option value="CEM">CEM</option>
                <option value="terminal">Lycée</option>
                <option value="terminal">Terminal</option>
                <option value="Universitaire">Universitaire</option>
                <script>
document.getElementsByName("niveau_etude").value = "Universitaire";
</script>
                
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700" for="situation">Situation</label>
              <select name="situation" id="situation" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                <option value="">Sélectionnez</option>
                <option value="fonctionnaire">Fonctionnaire</option>
                <option value="etudiant">Etudiant</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700" for="dernier_diplome">Dernier diplôme</label>
              <select name="dernier_diplome" id="dernier_diplome" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                <option value="">Sélectionnez</option>
                <option value="bac">Bac</option>
                <option value="licence">Licence</option>
                <option value="master">Master</option>
                <option value="doctorat">Doctorat</option>
              </select>
            </div>
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700" for="adresse">Adresse</label>
            <input name="adresse" id="adresse" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="123 Rue de l'Exemple, 75001 Paris" type="text" />
          </div>
          <div class="mt-4 mb-8">
            <label class="block text-sm font-medium text-gray-700" for="infos_supplementaires">Infos supplémentaires</label>
            <textarea name="remarques" id="infos_supplementaires" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Allergies, conditions médicales, etc." rows="2"></textarea>
          </div>
          <div style="position:sticky;bottom:0;background:linear-gradient(rgba(255,255,255,0.9), rgba(255,255,255,1));padding-top:10px;margin-top:6px;border-top:1px solid #eef2f7;" class="flex justify-between items-center">
            <button type="button" onclick="closeAddModal()" class="modal-action-btn secondary">Annuler</button>
            <button type="submit" class="modal-action-btn primary">Valider</button>
          </div>
        </form>
        <!-- keep datalist below (single copy) -->
    <style>
      /* Modal action buttons: slightly bigger, rounded, elegant hover */
      .modal-action-btn{
        padding: .7rem 1.4rem !important;
        font-size:15px !important;
        border-radius:8px !important;
        transition: transform .14s ease, box-shadow .14s ease, background .14s ease;
        cursor: pointer;
        min-width:160px;
      }
      .modal-action-btn.primary{ background: #10b981; color:#fff; border: 1px solid rgba(0,0,0,0.04); }
      .modal-action-btn.primary:hover{ background: linear-gradient(90deg,#059669,#10b981); transform: translateY(-3px); box-shadow: 0 10px 30px rgba(6,95,70,0.12); }
      .modal-action-btn.secondary{ background: #fff; color:#374151; border: 1px solid #d1d5db; }
      /* Cancel button: progressive red hover */
      .modal-action-btn.secondary:hover{ background: linear-gradient(90deg,#f87171,#ef4444); color:#fff; transform: translateY(-2px); box-shadow: 0 8px 22px rgba(239,68,68,0.12); border-color: rgba(0,0,0,0.06); }
      /* ensure sticky footer buttons look nice on small screens */
      @media (max-width: 640px){
        .modal-action-btn{ min-width:140px; width:140px; }
      }
    </style>
    <style>
      /* Responsive adjustments for Add Modal: stack photo above form on small screens */
      @media (max-width: 640px) {
        .add-modal-grid {
          display: block !important;
          grid-template-columns: 1fr !important;
          grid-template-rows: auto auto auto !important;
          gap: 0.75rem;
        }
        .add-modal-grid .photo-col {
          grid-row: 1 !important;
          display: flex !important;
          justify-content: center !important;
          align-items: center !important;
          padding-top: 0.25rem;
          margin-bottom: 0.5rem !important;
        }
        .add-modal-grid .photo-label {
          width: 6.5rem !important;
          height: 6.5rem !important;
          border-radius: 12px !important;
        }
        /* make the form column full-width and stack each field */
        .add-modal-grid .form-col {
          grid-column: 1 !important;
          grid-row: 2 !important;
          display: block !important;
          margin: 0 !important;
        }
        .add-modal-grid .form-col > div { width: 100% !important; display:block !important; }
        .add-modal-grid .form-col .block.w-full { width: 100% !important; }
        .add-modal-grid input[type="text"], .add-modal-grid input[type="email"], .add-modal-grid input[type="tel"], .add-modal-grid input[type="date"], .add-modal-grid select, .add-modal-grid textarea {
          width: 100% !important; box-sizing: border-box !important;
        }
        /* remove ml-auto which was pushing RTL fields off-center on small screens */
        .add-modal-grid input[dir="rtl"], .add-modal-grid input[dir="rtl"] + * { margin-left: 0 !important; margin-right: 0 !important; }
        /* reduce modal internal padding on small screens */
        #addModal .bg-white { max-width: calc(100% - 24px); }
        #addModal form { padding: 12px !important; }
      }
    </style>
    <datalist id="nationalite_list">
      <option value="Afghan"></option>
      <option value="Albanais"></option>
      <option value="Algérien"></option>
      <option value="Allemand"></option>
      <option value="Américain"></option>
      <option value="Andorran"></option>
      <option value="Angolais"></option>
      <option value="Antiguais-et-Barbudien"></option>
      <option value="Saoudien"></option>
      <option value="Argentin"></option>
      <option value="Arménien"></option>
      <option value="Australien"></option>
      <option value="Autrichien"></option>
      <option value="Azerbaïdjanais"></option>
      <option value="Bahaméen"></option>
      <option value="Bahreïni"></option>
      <option value="Bangladais"></option>
      <option value="Barbadien"></option>
      <option value="Belge"></option>
      <option value="Bélizien"></option>
      <option value="Béninois"></option>
      <option value="Bhoutanais"></option>
      <option value="Biélorusse"></option>
      <option value="Birman"></option>
      <option value="Bolivien"></option>
      <option value="Bosnien-Herzégovinien"></option>
      <option value="Botswanais"></option>
      <option value="Brésilien"></option>
      <option value="Britannique"></option>
      <option value="Brunéien"></option>
      <option value="Bulgare"></option>
      <option value="Burkinabè"></option>
      <option value="Burundais"></option>
      <option value="Cambodgien"></option>
      <option value="Camerounais"></option>
      <option value="Canadien"></option>
      <option value="Cap-Verdien"></option>
      <option value="Centrafricain"></option>
      <option value="Chilien"></option>
      <option value="Chinois"></option>
      <option value="Chypriote"></option>
      <option value="Colombien"></option>
      <option value="Comorien"></option>
      <option value="Congolais"></option>
      <option value="Costaricien"></option>
      <option value="Croate"></option>
      <option value="Cubain"></option>
      <option value="Danois"></option>
      <option value="Djiboutien"></option>
      <option value="Dominicain"></option>
      <option value="Dominiquais"></option>
      <option value="Égyptien"></option>
      <option value="Émirien"></option>
      <option value="Équatorien"></option>
      <option value="Érythréen"></option>
      <option value="Espagnol"></option>
      <option value="Estonien"></option>
      <option value="Eswatini"></option>
      <option value="Éthiopien"></option>
      <option value="Fidjien"></option>
      <option value="Finlandais"></option>
      <option value="Français"></option>
      <option>Gabonais</option>
      <option>Gambien</option>
      <option>Géorgien</option>
      <option>Ghanéen</option>
      <option>Grec</option>
      <option>Grenadien</option>
      <option>Guatémaltèque</option>
      <option>Guinéen</option>
      <option>Bissau-Guinéen</option>
      <option>Équato-Guinéen</option>
      <option>Guyanien</option>
      <option>Haïtien</option>
      <option>Hondurien</option>
      <option>Hongrois</option>
      <option>Indien</option>
      <option>Indonésien</option>
      <option>Irakien</option>
      <option>Iranien</option>
      <option>Irlandais</option>
      <option>Islandais</option>
      <option>Israélien</option>
      <option>Italien</option>
      <option>Ivoirien</option>
      <option>Jamaïcain</option>
      <option>Japonais</option>
      <option>Jordanien</option>
      <option>Kazakh</option>
      <option>Kényan</option>
      <option>Kirghiz</option>
      <option>Kiribatien</option>
      <option>Koweïtien</option>
      <option>Laotien</option>
      <option>Letton</option>
      <option>Libanais</option>
      <option>Libérien</option>
      <option>Libyen</option>
      <option>Liechtensteinois</option>
      <option>Lituanien</option>
      <option>Luxembourgeois</option>
      <option>Macédonien</option>
      <option>Malaisien</option>
      <option>Malawite</option>
      <option>Maldivien</option>
      <option>Malien</option>
      <option>Maltais</option>
      <option>Marocain</option>
      <option>Marshallais</option>
      <option>Mauricien</option>
      <option>Mauritanien</option>
  
      <option>Mongol</option>
      <option>Monténégrin</option>
      <option>Mozambicain</option>
      <option>Namibien</option>
      <option>Nauruan</option>
      <option>Néerlandais</option>
      <option>Néo-Zélandais</option>
      <option>Népalais</option>
      <option>Nigérian</option>
      <option>Nigérien</option>
      <option>Nord-Coréen</option>
      <option>Norvégien</option>
 
      <option>Palestinien</option>
     

    </datalist>
        <datalist id="lieu_list">
          <option value="Béjaïa"></option>
          <option value="Amizour"></option>
          <option value="Ferraoun"></option>
          <option value="Taourirt Ighil"></option>
          <option value="Chellata"></option>
          <option value="Tamokra"></option>
          <option value="Timezrit"></option>
          <option value="Souk El Ténine"></option>
          <option value="M'cisna"></option>
          <option value="Tinabdher"></option>
          <option value="Tichy"></option>
          <option value="Semaoun"></option>
          <option value="Kendira"></option>
          <option value="Tifra"></option>
          <option value="Ighram"></option>
          <option value="Amalou"></option>
          <option value="Ighil Ali"></option>
          <option value="Fenaïa Ilmaten"></option>
          <option value="Toudja"></option>
          <option value="Darguina"></option>
          <option value="Sidi-Ayad"></option>
          <option value="Aokas"></option>
          <option value="Beni Djellil"></option>
          <option value="Adekar"></option>
          <option value="Akbou"></option>
          <option value="Seddouk"></option>
          <option value="Tazmalt"></option>
          <option value="Aït-R'zine"></option>
          <option value="Chemini"></option>
          <option value="Souk-Oufella"></option>
          <option value="Taskriout"></option>
          <option value="Tibane"></option>
          <option value="Tala Hamza"></option>
          <option value="Barbacha"></option>
          <option value="Beni Ksila"></option>
          <option value="Ouzellaguen"></option>
          <option value="Bouhamza"></option>
          <option value="Beni Mellikeche"></option>
          <option value="Sidi-Aïch"></option>
          <option value="El Kseur"></option>
          <option value="Melbou"></option>
          <option value="Akfadou"></option>
          <option value="Leflaye"></option>
          <option value="Kherrata"></option>
          <option value="Draâ El-Kaïd"></option>
          <option value="Tamridjet"></option>
          <option value="Aït-Smail"></option>
          <option value="Boukhelifa"></option>
          <option value="Tizi N'Berber"></option>
          <option value="Beni Maouche"></option>
          <option value="Oued Ghir"></option>
          <option value="Boudjellil"></option>
        </datalist>
      </div>
    </div>


    
  <!-- Edit Modal (copy of Add Modal layout, fields will be prefilled by JS) -->
  <div id="editModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full" style="max-width:980px; width:calc(100% - 48px); max-height:95vh; overflow:hidden; display:flex; flex-direction:column; font-family: 'Roboto', Roboto, system-ui, -apple-system, 'Segoe UI', sans-serif;">
      <h1 class="text-2xl font-bold text-center mb-4">Modifier l'étudiant</h1>
      <form id="editForm" enctype="multipart/form-data" style="display:flex;flex-direction:column;flex:1 1 auto;overflow:auto;padding-bottom:12px;">
        {% csrf_token %}
        <input type="hidden" name="id" />
        <div style="display:grid;grid-template-columns:14rem 1fr;grid-template-rows:auto auto auto auto;gap:1rem;align-items:start;">
          <div style="grid-row:1 / span 4; display:flex;flex-direction:column;align-items:center;justify-content:flex-start;">
            <label for="photoInputEdit" style="width:14rem;height:14rem;border-radius:9999px;border:2px dashed #d1d5db;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f8fafb;margin-bottom:0.75rem;cursor:pointer;overflow:hidden;">
              <span class="material-icons" style="font-size:4.2rem;color:#4b5563;">school</span>
              <p class="text-sm text-gray-500 mt-2" style="margin:0">Photo</p>
              <p class="text-xs text-gray-400" style="margin:0">PNG, JPG</p>
            </label>
            <input id="photoInputEdit" type="file" name="photo" accept="image/*" class="hidden" />
          </div>
          <div style="grid-column:2;grid-row:1 / span 2;display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;">
            <div>
              <label class="block text-sm font-medium text-gray-700" for="nom">Nom</label>
              <input name="nom" id="nom_edit" tabindex="1" required style="font-size:19px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Entrez votre nom" type="text" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 text-right" for="nom_ar">اللقب</label>
              <input name="nom_arabe" id="nom_ar_edit" tabindex="3" dir="rtl" class="mt-1 block w-full ml-auto px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" type="text" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700" for="prenom">Prénom</label>
              <input name="prenom" id="prenom_edit" tabindex="2" required style="font-size:15px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Entrez votre prénom" type="text" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 text-right" for="prenom_ar">الاسم</label>
              <input name="prenom_arabe" id="prenom_ar_edit" tabindex="4" dir="rtl" class="mt-1 block w-full ml-auto px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" type="text" />
            </div>
          </div>
          <div style="grid-column:2;grid-row:4;">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2 items-center">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="sexe">Genre</label>
                  <div class="relative mt-1">
                    <select name="sexe" id="sexe_edit" style="font-size:15px" class="block w-full appearance-none px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                      <option value="">-- Sexe --</option>
                      <option value="M">Masculin</option>
                      <option value="F">Féminin</option>
                    </select>
                  </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="lieu_naissance">Lieu de Naissance</label>
                <input name="lieu_naissance" id="lieu_naissance_edit2" list="lieu_list" style="font-size:15px" class="block w-full mt-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Entrez lieu de naissance" type="text" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1" for="date_naissance">Date de Naissance</label>
                <div style="position:relative">
                  <input name="date_naissance" id="date_naissance_edit" style="padding-right:2.6rem" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="JJ/MM/AAAA" type="date" />
                  
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div class="md:col-span-1">
            <label class="block text-sm font-medium text-gray-700" for="nin">NIN</label>
            <input name="nin" id="nin_edit" style="font-size:15px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Ex: 123456789" type="text" />
            <div id="ninErrorEdit" class="text-sm text-red-600 mt-1 hidden" role="alert" aria-live="polite">
              <span class="material-icons" style="font-size:16px;vertical-align:middle;margin-right:6px;">error_outline</span>
              <span id="ninErrorEditMsg"></span>
            </div>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700" for="nationalite">Nationalité</label>
            <input name="nationalite" id="nationalite_edit2" list="nationalite_list" style="font-size:15px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Entrez nationalité" type="text" />
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <div>
            <label class="block text-sm font-medium text-gray-700" for="telephone">Téléphone</label>
            <input name="telephone" id="telephone_edit" style="font-size:15px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="+33 6 12 34 56 78" type="tel" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700" for="email">Email</label>
            <input name="email" id="email_edit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="nom.prenom@email.com" type="email" />
          </div>
          <div x-data="{ social: '', profile: '' }">
            <label class="block text-sm font-medium text-gray-700" for="social_network">Réseaux sociaux</label>
            <div class="relative mt-1 w-full">
              <select name="social_network" id="social_network_edit" x-model="social" class="block w-full appearance-none px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                <option value="">Sélectionnez</option>
                <option value="instagram">Instagram</option>
                <option value="facebook">Facebook</option>
                <option value="whatsapp">WhatsApp</option>
                <option value="telegram">Telegram</option>
              </select>
            </div>
            <div class="mt-2 w-full" x-show="social">
              <input name="social_profile" id="social_profile_edit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Nom du profil" type="text" x-model="profile" />
            </div>
          </div>
        </div>
        <!-- Ligne ajoutée pour edit: niveau d'etude, situation, dernier diplome -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <div>
            <label class="block text-sm font-medium text-gray-700" for="niveau_etude_edit">Niveau d'étude</label>
            <select name="niveau_etude" id="niveau_etude_edit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
              <option value="">Sélectionnez</option>
              <option value="terminal">Terminal</option>
              <option value="universitaire">Universitaire</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700" for="situation_edit">Situation</label>
            <select name="situation" id="situation_edit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
              <option value="">Sélectionnez</option>
              <option value="fonctionnaire">Fonctionnaire</option>
              <option value="etudiant">Etudiant</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700" for="dernier_diplome_edit">Dernier diplôme</label>
            <select name="dernier_diplome" id="dernier_diplome_edit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
              <option value="">Sélectionnez</option>
              <option value="bac">Bac</option>
              <option value="licence">Licence</option>
              <option value="master">Master</option>
              <option value="doctorat">Doctorat</option>
            </select>
          </div>
        </div>

        <div class="mt-4">
          <label class="block text-sm font-medium text-gray-700" for="adresse">Adresse</label>
          <input name="adresse" id="adresse_edit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="123 Rue de l'Exemple, 75001 Paris" type="text" />
        </div>
        <div class="mt-4 mb-8">
          <label class="block text-sm font-medium text-gray-700" for="infos_supplementaires">Infos supplémentaires</label>
          <textarea name="remarques" id="infos_supplementaires_edit" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Allergies, conditions médicales, etc." rows="2"></textarea>
        </div>
        <div style="position:sticky;bottom:0;background:linear-gradient(rgba(255,255,255,0.9), rgba(255,255,255,1));padding-top:10px;margin-top:6px;border-top:1px solid #eef2f7;" class="flex justify-between items-center">
          <button type="button" onclick="closeEditModal()" class="modal-action-btn secondary">Annuler</button>
          <button type="submit" class="modal-action-btn primary">Modifier</button>
        </div>
      </form>
    </div>
  </div>



  
  
  <script>
    // Stagger modal-section animations inside addModal for a pleasant entrance
    (function(){
      const addModal = document.getElementById('addModal');
      if (!addModal) return;
      const sections = addModal.querySelectorAll('.modal-section');
      sections.forEach((el, idx) => {
        const d = 0.04 * idx;
        el.style.animationDelay = d + 's';
      });
    })();
    // Format number to DZD: 1234.56 -> "1 234,56 DZD"
    function formatDZD(v){
      const n = Number(v) || 0;
      return n.toFixed(2) + ' DZD';
    }
    function toggleView(mode) {
      const table = document.getElementById('tableView');
      const cards = document.getElementById('cardView');
      const gridIcon = document.getElementById('viewGridIcon');
      const listIcon = document.getElementById('viewListIcon');

      if (!table || !cards) return;

      // Check current computed visibility
      const tableHidden = window.getComputedStyle(table).display === 'none';

      if (mode === 'grid') {
        // hide table, show cards
        if (table) { table.style.display = 'none'; table.classList.add('hidden'); }
        if (cards) { cards.classList.remove('hidden'); cards.style.display = ''; }
      } else if (mode === 'list') {
        // show table, hide cards
        if (table) { table.style.display = ''; table.classList.remove('hidden'); }
        if (cards) { cards.style.display = 'none'; cards.classList.add('hidden'); }
      } else {
        // toggle
        if (tableHidden) {
          if (table) { table.style.display = ''; table.classList.remove('hidden'); }
          if (cards) { cards.style.display = 'none'; cards.classList.add('hidden'); }
        } else {
          if (table) { table.style.display = 'none'; table.classList.add('hidden'); }
          if (cards) { cards.classList.remove('hidden'); cards.style.display = ''; }
        }
      }

      // Update icon aria-pressed and animate selection
      const showingCards = window.getComputedStyle(cards).display !== 'none';
      if (gridIcon) gridIcon.setAttribute('aria-pressed', showingCards ? 'true' : 'false');
      if (listIcon) listIcon.setAttribute('aria-pressed', showingCards ? 'false' : 'true');

      // move the green indicator to the selected icon with smooth transform
      try{
        const indicator = document.getElementById('viewIndicator');
        if (indicator){
          const target = showingCards ? gridIcon : listIcon;
          moveIndicatorTo(target);
        }
      }catch(e){/* ignore */}

      // persist selection so pagination/refresh keeps the same view
      try{ sessionStorage.setItem('students_view', showingCards ? 'grid' : 'list'); }catch(e){}

      // Re-apply filters after switching view so elements hidden by previous searches
      try{ if(window.applyFilters) window.applyFilters(); else document.dispatchEvent(new Event('studentsViewChanged')); }catch(e){}
    }

    function moveIndicatorTo(el){
      if (!el) return;
      const wrap = document.querySelector('.view-icons-wrap');
      const indicator = document.getElementById('viewIndicator');
      if (!wrap || !indicator) return;
      // compute relative position inside wrap
      const wrapRect = wrap.getBoundingClientRect();
      const elRect = el.getBoundingClientRect();
      const offsetX = elRect.left - wrapRect.left;
      const offsetY = elRect.top - wrapRect.top;
      // center the indicator under the icon (use icon width)
      const translateX = offsetX;
      const translateY = 0; // keep top for consistent vertical position
      indicator.style.transform = `translate3d(${translateX}px, ${translateY}px, 0)`;
      // match indicator width to icon width for better visual
      indicator.style.width = (elRect.width) + 'px';
    }

    // initialize indicator position on load
    window.addEventListener('load', function(){
      // restore view from sessionStorage or URL param (?view=grid|list)
      try{
        const params = new URLSearchParams(window.location.search);
        const urlView = params.get('view');
        const stored = sessionStorage.getItem('students_view');
        // Determine desired view (grid | list | null)
        const desired = (urlView === 'grid' || urlView === 'list') ? urlView : (stored === 'grid' ? 'grid' : (stored === 'list' ? 'list' : null));

        // If on a narrow viewport, prefer mobileList by default
        const isMobile = window.matchMedia && window.matchMedia('(max-width: 640px)').matches;

        if (isMobile) {
          // Show mobile stacked list and hide desktop/table/card views using inline styles
          const table = document.getElementById('tableView'); if(table) table.style.display = 'none';
          const cards = document.getElementById('cardView'); if(cards) cards.style.display = 'none';
          const mobileList = document.getElementById('mobileList'); if(mobileList) mobileList.style.display = '';
          // position indicator based on desired if present
          const target = (desired === 'grid') ? document.getElementById('viewGridIcon') : document.getElementById('viewListIcon');
          setTimeout(()=>{ moveIndicatorTo(target); }, 80);
          return;
        }

        // Desktop/tablet: if user explicitly requested grid/list, apply it
        if(desired){
          toggleView(desired);
        } else {
          // Default: show table (list) and hide card grid using inline styles
          const table = document.getElementById('tableView'); if(table) table.style.display = '';
          const cards = document.getElementById('cardView'); if(cards) cards.style.display = 'none';
          const gridIcon = document.getElementById('viewGridIcon');
          const listIcon = document.getElementById('viewListIcon');
          const target = listIcon || gridIcon;
          setTimeout(()=>{ moveIndicatorTo(target); }, 80);
        }
      }catch(e){
        // fallback: default to table on desktop
        const table = document.getElementById('tableView'); if(table) table.classList.remove('hidden');
        const cards = document.getElementById('cardView'); if(cards) cards.classList.add('hidden');
        const target = document.getElementById('viewListIcon') || document.getElementById('viewGridIcon');
        setTimeout(()=>{ moveIndicatorTo(target); }, 80);
      }
    });

  // Modal controls (animations removed)
  const addModalEl = document.getElementById('addModal');
  const DEFAULT_AVATAR = "{% static 'images/delete_18986470.gif' %}";
  const editModal = document.getElementById('editModal');
  document.getElementById('openAddBtn').addEventListener('click', () => { 
    // set default nationalite if empty
    try{ const nat = document.getElementById('nationalite'); if(nat && !nat.value) nat.value = 'Algérien'; }catch(e){}
    // clear date field formatting guidance
    try{ const d = document.getElementById('date_naissance'); if(d && !d.value) d.placeholder = 'JJ/MM/AAAA'; }catch(e){}
    addModalEl.classList.remove('hidden'); 
  });
  function closeAddModal(){
    try{
      const form = document.getElementById('addForm');
      if(form){
        const globalErr = document.getElementById('addFormGlobalError'); if(globalErr) globalErr.remove();
        const telWrap = document.getElementById('telErrorAdd'); if(telWrap) telWrap.classList.add('hidden');
        const ninWrap = document.getElementById('ninErrorAdd'); if(ninWrap) ninWrap.classList.add('hidden');
        const telMsg = document.getElementById('telErrorAddMsg'); if(telMsg) telMsg.textContent = '';
        const ninMsg = document.getElementById('ninErrorAddMsg'); if(ninMsg) ninMsg.textContent = '';
        try{ form.reset(); }catch(e){}
      }
      addModalEl.classList.add('hidden');
      const openAdd = document.getElementById('openAddBtn'); if(openAdd) openAdd.focus();
    }catch(e){ }
  }
  function closeEditModal(){
    try{
      // Reset and clear inline errors so modal appears clean next time
      const form = document.getElementById('editForm');
      if(form){
        // remove any global error banner
        const globalErr = document.getElementById('editFormGlobalError'); if(globalErr) globalErr.remove();
        // hide field-specific error wrappers if present
        const telWrap = document.getElementById('telErrorEdit'); if(telWrap) telWrap.classList.add('hidden');
        const ninWrap = document.getElementById('ninErrorEdit'); if(ninWrap) ninWrap.classList.add('hidden');
        const telMsg = document.getElementById('telErrorEditMsg'); if(telMsg) telMsg.textContent = '';
        const ninMsg = document.getElementById('ninErrorEditMsg'); if(ninMsg) ninMsg.textContent = '';
        // reset the form fields (preserve file input display handled elsewhere)
        try{ form.reset(); }catch(e){}
      }
      // actually hide the modal
      editModal.classList.add('hidden');
      // briefly remove any focus trap by returning focus to the table or add button
      const openAdd = document.getElementById('openAddBtn');
      if(openAdd) openAdd.focus(); else {
        const firstRow = document.querySelector('#studentsTbody tr.student-row'); if(firstRow) firstRow.focus && firstRow.focus();
      }
    }catch(e){ /* swallow errors to avoid breaking callers */ }
  }

  // Date normalization: accept many formats and return ISO (YYYY-MM-DD) for input[type=date]
  function normalizeDateToISO(raw){
    if(!raw) return '';
    const s = String(raw).trim();
    // ISO yyyy-mm-dd
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    // dd/mm/yyyy or dd-mm-yyyy
    if(/^\d{2}[\/\-]\d{2}[\/\-]\d{4}$/.test(s)){
      const parts = s.split(/[-\/]/);
      return `${parts[2]}-${parts[1].padStart(2,'0')}-${parts[0].padStart(2,'0')}`;
    }
    // digits only, try to parse ddmmyyyy or yyyymmdd
    const digits = s.replace(/[^0-9]/g,'');
    if(digits.length === 8){
      // detect ddmmyyyy (first two <=31)
      const d1 = digits.substr(0,2); const m1 = digits.substr(2,2); const y1 = digits.substr(4,4);
      if(Number(d1) >= 1 && Number(d1) <= 31 && Number(m1) >= 1 && Number(m1) <= 12) return `${y1}-${m1}-${d1}`;
      // fallback to yyyymmdd
      const y2 = digits.substr(0,4); const m2 = digits.substr(4,2); const d2 = digits.substr(6,2);
      return `${y2}-${m2}-${d2}`;
    }
    // as last resort, try Date parsing and format
    const parsed = new Date(s);
    if (!isNaN(parsed.getTime())){
      const y = parsed.getFullYear(); const m = String(parsed.getMonth()+1).padStart(2,'0'); const d = String(parsed.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    return '';
  }

  // attach blur handlers to date inputs to normalize user input into ISO (YYYY-MM-DD)
  try{
    const dAdd = document.getElementById('date_naissance');
    if (dAdd){ dAdd.addEventListener('blur', function(){ const iso = normalizeDateToISO(this.value); if (iso) this.value = iso; }); }
    const dEdit = document.getElementById('date_naissance_edit');
    if (dEdit){ dEdit.addEventListener('blur', function(){ const iso = normalizeDateToISO(this.value); if (iso) this.value = iso; }); }
  }catch(e){ console.error('date normalize attach failed', e); }

    // Inline Add Inscription Modal (opens on students page when clicking 'Non inscrit')
    (function(){
      const inlineInsModal = document.createElement('div');
      inlineInsModal.id = 'addInsInlineModal';
      inlineInsModal.className = 'hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop';
      inlineInsModal.innerHTML = `
        <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-lg p-6">
          <h2 class="text-xl font-semibold mb-4">Nouvelle inscription</h2>
          <form id="addInsInlineForm">
            {% csrf_token %}
            <div class="grid grid-cols-1 gap-3">
              <input type="hidden" name="etudiant" id="inlineEtudiantId" />
              <div><strong>Étudiant:</strong> <span id="inlineEtudiantName"></span></div>
              <label>Formation</label>
              <select name="formation" class="border px-3 py-2 rounded">
                <option value="">-- Choisir formation --</option>
                {% for f in formations %}
                <option value="{{ f.id }}">{{ f.nom }}</option>
                {% endfor %}
              </select>
              <label>Session</label>
              <select name="session" id="inlineSessionSelect" class="border px-3 py-2 rounded">
                <option value="session normale">Session normale</option>
                <option value="session estivale">Session estivale</option>
              </select>
              <label>Groupe</label>
              <select name="groupe" id="inlineGroupeSelect" class="border px-3 py-2 rounded" required>
                <option value="">-- Choisir formation d'abord --</option>
              </select>
              <label>Formateur (optionnel)</label>
              <select name="formateur" id="inlineFormateurSelect" class="border px-3 py-2 rounded">
                {% if formateurs %}
                  <option value="">-- Choisir formateur --</option>
                  {% for fo in formateurs %}
                    <option value="{{ fo.id }}">{{ fo.prenom }} {{ fo.nom }}</option>
                  {% endfor %}
                {% else %}
                  <option value="" disabled>Aucun formateur disponible</option>
                {% endif %}
              </select>
              <label>École</label>
              <select name="ecole" id="inlineEcoleSelect" class="border px-3 py-2 rounded">
                <option value="">-- Choisir école --</option>
                <option value="Genie Systeme">Genie Systeme</option>
                <option value="Pixel School">Pixel School</option>
                <option value="Jura School">Jura School</option>
              </select>
              <label>Date d'inscription</label>
              <input type="date" name="date_inscription" id="inlineDateIns" class="mt-2 block w-full border rounded-md px-3 py-2 focus:ring-1 focus:ring-green-400" />
            </div>
            <div class="mt-4 flex justify-between items-center">
              <div class="flex items-center gap-3">
                <input type="checkbox" id="inline_followup" name="followup" />
                <label for="inline_followup" class="text-sm">Inscription suivante</label>
              </div>
              <div>
                <button type="button" id="cancelAddInsInline" class="btn-secondary py-2 px-4 rounded mr-2">Annuler</button>
                <button type="submit" class="btn-primary py-2 px-4 rounded">Enregistrer</button>
              </div>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(inlineInsModal);

      // Populate inline groupe options when a formation is selected.
      (function(){
        const inlineForm = document.getElementById('addInsInlineForm');
        if (!inlineForm) return;
        const inlineFormation = inlineForm.querySelector('select[name="formation"]');
        const inlineGroupe = document.getElementById('inlineGroupeSelect');
        // ensure there's a session and formateur element (already in template)
        const inlineSession = document.getElementById('inlineSessionSelect');
        const inlineFormateur = document.getElementById('inlineFormateurSelect');

        // Try to use server-provided formation_groups_json (same format as in inscriptions.html)
        let formationGroupsInline = {};
        try { formationGroupsInline = JSON.parse('{{ formation_groups_json|default:"{}"|escapejs }}'); } catch(e) { formationGroupsInline = {}; }

        function buildInlineGroupsFromFormation(formationId){
          inlineGroupe.innerHTML = '';
          const placeholder = document.createElement('option');
          placeholder.value = '';
          placeholder.textContent = '-- Choisir groupe --';
          inlineGroupe.appendChild(placeholder);
          if(!formationId) return;
          const opts = formationGroupsInline[String(formationId)] || [];
          if (opts && opts.length){
            opts.forEach(o => {
              const opt = document.createElement('option');
              opt.value = o.code;
              // show code and capacity/occupancy like inscriptions page
              opt.textContent = (o.count !== undefined) ? `${o.code} (${o.count}/${o.capacity || 16})` : o.code;
              if (o.disabled) opt.disabled = true;
              inlineGroupe.appendChild(opt);
            });
            return;
          }
          // fallback: generate simple groups based on formation name initial
          const sel = inlineFormation.options[inlineFormation.selectedIndex];
          const name = sel ? sel.text : '';
          const first = (name.trim().charAt(0) || '').toUpperCase();
          ['1','2','3'].forEach(n => {
            const o = document.createElement('option');
            o.value = `G${first}${n}`;
            o.textContent = `G${first}${n}`;
            inlineGroupe.appendChild(o);
          });
        }

        if(inlineFormation && inlineGroupe){
          inlineFormation.addEventListener('change', function(){
            buildInlineGroupsFromFormation(this.value);
          });
        }
        // If the page opened with a formation pre-selected (or if opening modal triggers change), ensure groups populate
        try{ if(inlineFormation) inlineFormation.dispatchEvent(new Event('change')); }catch(e){}
      
        // Also attach logic for the main addIns modal (if present on this page) using the same formation_groups_json
        try{
          let formationGroupsMain = {};
          try { formationGroupsMain = JSON.parse('{{ formation_groups_json|default:"{}"|escapejs }}'); } catch(e) { formationGroupsMain = {}; }
          const mainForm = document.getElementById('addInsForm');
          const mainFormation = mainForm ? mainForm.querySelector('select[name="formation"]') : null;
          const mainGroupe = document.getElementById('addInsGroupeSelect');
          if (mainFormation && mainGroupe){
            mainFormation.addEventListener('change', function(){
              mainGroupe.innerHTML = '';
              const placeholder = document.createElement('option'); placeholder.value=''; placeholder.textContent='-- Choisir groupe --'; mainGroupe.appendChild(placeholder);
              const opts = formationGroupsMain[String(this.value)] || [];
              if (opts && opts.length){
                opts.forEach(o=>{
                  const opt = document.createElement('option'); opt.value = o.code; opt.textContent = (o.count !== undefined) ? `${o.code} (${o.count}/${o.capacity || 16})` : o.code; if(o.disabled) opt.disabled = true; mainGroupe.appendChild(opt);
                });
              } else {
                // fallback to simple generated groups using selected formation name
                const sel = this.options[this.selectedIndex]; const name = sel ? sel.text : ''; const first = (name.trim().charAt(0) || '').toUpperCase(); ['1','2','3'].forEach(n=>{ const o = document.createElement('option'); o.value = `G${first}${n}`; o.textContent = `G${first}${n}`; mainGroupe.appendChild(o); });
              }
            });
            // trigger initial population if a value already selected
            try{ mainFormation.dispatchEvent(new Event('change')); }catch(e){}
          }
        }catch(e){ /* fail quietly */ }
      })();

      // open modal when clicking Non inscrit links
      document.addEventListener('click', function(e){
        const a = e.target.closest('.open-add-inscription');
        if (!a) return;
        e.preventDefault();
        const etuId = a.dataset.etudiant;
        const name = a.dataset.etudiantName || '';
        document.getElementById('inlineEtudiantId').value = etuId;
        document.getElementById('inlineEtudiantName').textContent = name;
          // default date_inscription to today when opening the inline modal
          try{
            const iso = new Date().toISOString().split('T')[0];
            const d = document.getElementById('inlineDateIns'); if(d) d.value = iso;
          }catch(e){}
        // When opening inline modal, populate its groupe select for the current formation value (if any)
        const inlineForm = document.getElementById('addInsInlineForm');
        const inlineFormation = inlineForm.querySelector('select[name="formation"]');
        const inlineGroupe = document.getElementById('inlineGroupeSelect');
        if (inlineFormation && inlineGroupe){
          // build options using the same formationGroups object if available
          const evt = new Event('change');
          // trigger change handler to populate options
          inlineFormation.dispatchEvent(evt);
        }
        inlineInsModal.classList.remove('hidden');
      });

      document.getElementById('cancelAddInsInline').addEventListener('click', function(){ inlineInsModal.classList.add('hidden'); });

  document.getElementById('addInsInlineForm').addEventListener('submit', function(e){
    e.preventDefault();
    const form = e.target;
    // ensure groupe value is read from whichever control exists
    const groupeEl = form.querySelector('[name="groupe"]');
    const groupeVal = groupeEl ? (groupeEl.value || '') : '';
    const formationVal = form.querySelector('select[name="formation"]') ? form.querySelector('select[name="formation"]').value : '';
    if (!formationVal){
      let g = document.getElementById('addInsInlineFormGlobalError'); if(!g){ g = document.createElement('div'); g.id='addInsInlineFormGlobalError'; g.className='text-sm text-red-600 mt-2'; form.insertBefore(g, form.firstChild); }
      g.textContent = 'Veuillez choisir une formation.'; return;
    }
    if (!groupeVal){
      let g = document.getElementById('addInsInlineFormGlobalError'); if(!g){ g = document.createElement('div'); g.id='addInsInlineFormGlobalError'; g.className='text-sm text-red-600 mt-2'; form.insertBefore(g, form.firstChild); }
      g.textContent = 'Veuillez choisir un groupe.'; return;
    }
    // groupe is optional here (label says optionnel) so we only warn if explicitly required by server; do not block
    const data = new FormData(form);
    // include credentials and CSRF header for same-origin
    fetch('{% url "inscriptions_add" %}', { method: 'POST', headers: { 'X-CSRFToken': csrftoken }, body: data, credentials: 'same-origin' }).then(r=>r.json()).then(json=>{
          if (json.success){
            // Update the student row status to "Inscrit" if present on the page
            const tr = document.querySelector('tr[data-id="'+data.get('etudiant')+'"]');
            if (tr){
              const status = tr.querySelector('td:nth-child(7)');
              if (status) status.innerHTML = '<span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Inscrit</span>';
            }

            // If user checked follow-up, reset the form for next inscription and keep modal open
            const followUp = document.getElementById('inline_followup');
            if (followUp && followUp.checked){
              // clear inputs but preserve student id so the next inscription is for the same student
              try{ form.querySelector('select[name="formation"]').value = ''; }catch(e){}
              try{ form.querySelector('select[name="groupe"]').innerHTML = '<option value="">-- Choisir formation d\'abord --</option>'; }catch(e){}
              try{ form.querySelector('select[name="session"]').value = 'session normale'; }catch(e){}
              try{ form.querySelector('select[name="formateur"]').value = ''; }catch(e){}
              try{ form.querySelector('select[name="ecole"]').value = ''; }catch(e){}
              try{ form.querySelector('input[name="date_inscription"]').value = (new Date()).toISOString().split('T')[0]; }catch(e){}
              // remove any error messages
              const errEl = document.getElementById('addInsInlineFormGlobalError'); if (errEl) errEl.remove();
              // focus formation to help rapid entry
              try{ form.querySelector('select[name="formation"]').focus(); }catch(e){}
            } else {
              inlineInsModal.classList.add('hidden');
            }
          } else {
              let g = document.getElementById('addInsInlineFormGlobalError'); if(!g){ g = document.createElement('div'); g.id='addInsInlineFormGlobalError'; g.className='text-sm text-red-600 mt-2'; form.insertBefore(g, form.firstChild); }
              g.textContent = 'Erreur: '+(json.error||'');
            }
          }).catch(err=>{ console.error(err);
            try{
              const raw = (err && err.message) ? String(err.message) : 'vérifier la connexion';
              let parsed = null; try{ parsed = JSON.parse(raw); }catch(e){ parsed = null; }
              const msg = (parsed && (parsed.error||parsed.message)) ? (parsed.error||parsed.message) : raw;
              let g = document.getElementById('addInsInlineFormGlobalError'); if(!g){ g = document.createElement('div'); g.id='addInsInlineFormGlobalError'; g.className='text-sm text-red-600 mt-2'; form.insertBefore(g, form.firstChild); }
              g.textContent = 'Erreur réseau: ' + msg;
            }catch(e){}
          });
      });
    })();

    // CSRF helper
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

  // Handle add submit -> POST to server (animations removed)
  const addFormEl = document.getElementById('addForm');

    document.getElementById('addForm').addEventListener('submit', function(e){
  e.preventDefault();
  // client-side validation: email format, NIN length (18 digits), telephone length (10 or 11 digits)
  const emailEl = this.querySelector('input[name="email"]');
  const ninEl = this.querySelector('input[name="nin"]');
  const telEl = this.querySelector('input[name="telephone"]');
  // clear previous inline messages
  const ninMsg = document.getElementById('ninErrorAddMsg'); if(ninMsg) ninMsg.textContent=''; const ninErr = document.getElementById('ninErrorAdd'); if(ninErr) ninErr.classList.add('hidden');
  const telMsg = document.getElementById('telErrorAddMsg'); if(telMsg) telMsg.textContent=''; const telErr = document.getElementById('telErrorAdd'); if(telErr) telErr.classList.add('hidden');
  if (emailEl && emailEl.value && !emailEl.checkValidity()) { let g = document.getElementById('addFormGlobalError'); if(!g){ g = document.createElement('div'); g.id='addFormGlobalError'; g.className='text-sm text-red-600 mt-2'; document.getElementById('addForm').insertBefore(g, document.getElementById('addForm').firstChild); } g.textContent = 'Email invalide'; return; }
  if (ninEl && ninEl.value && (!/^\d{18}$/.test(ninEl.value.trim()))) { if(ninMsg){ ninMsg.textContent='Le NIN doit contenir exactement 18 chiffres'; ninErr.classList.remove('hidden'); ninEl.focus(); } return; }
  if (telEl && telEl.value){ const digits = telEl.value.replace(/\D/g,''); if(!/^\d{10,11}$/.test(digits)){ if(telMsg){ telMsg.textContent='Le téléphone doit contenir 10 ou 11 chiffres'; telErr.classList.remove('hidden'); telEl.focus(); } return; } }
      const form = e.target;
      const data = new FormData(form);
      const submitBtn = form.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      // POST to server (no animations)
      fetch('{% url "etudiants_add" %}', {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken },
        body: data,
        credentials: 'same-origin'
      }).then(r => {
        if (!r.ok) return r.text().then(text => { throw new Error(text || r.statusText); });
        return r.json();
      }).then(json => {
        if (json.success) {
          appendStudentRow(json.student);
          // show success toast and include email send status if available
          try{
            const toast = document.createElement('div');
            toast.className = 'text-sm py-2 px-3 rounded shadow-md';
            toast.style.position = 'fixed';
            toast.style.right = '18px';
            toast.style.top = '18px';
            toast.style.background = '#10b981';
            toast.style.color = '#fff';
            toast.style.zIndex = 120;
            let msg = json.message || 'Ajouté avec succès';
            if (typeof json.email_scheduled !== 'undefined' && json.email_scheduled){
              msg += ' — Email planifié';
              toast.style.background = '#10b981';
            }
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(()=>{ try{ toast.remove(); }catch(e){} }, 3200);
          }catch(e){}
          closeAddModal();
        } else {
          // show NIN specific error inline when backend reports it
          const ninErrEl = document.getElementById('ninErrorAdd');
          if (ninErrEl) {
            const serverMsg = String(json.error || json.message || '');
            const lowerSrv = serverMsg.toLowerCase();
            if (lowerSrv.indexOf('nin') !== -1 || lowerSrv.indexOf('déjà utilisé') !== -1) {
              // place NIN error inline and remove any global banner
              const ninErrMsg = document.getElementById('ninErrorAddMsg'); if(ninErrMsg){ ninErrMsg.textContent = serverMsg; } ninErrEl.classList.remove('hidden'); const gRem = document.getElementById('addFormGlobalError'); if(gRem) gRem.remove();
            } else if (lowerSrv.indexOf('tel') !== -1 || lowerSrv.indexOf('télé') !== -1) {
              // telephone-related server error: show in telephone container; remove global banner
              const telErrMsg2 = document.getElementById('telErrorAddMsg'); if(telErrMsg2){ telErrMsg2.textContent = serverMsg; } const telWrap = document.getElementById('telErrorAdd'); if(telWrap) telWrap.classList.remove('hidden'); const gRem2 = document.getElementById('addFormGlobalError'); if(gRem2) gRem2.remove();
            } else {
              // form-level inline error fallback: clear field-specific errors
              const ninErrMsgClear = document.getElementById('ninErrorAddMsg'); if(ninErrMsgClear) ninErrMsgClear.textContent=''; ninErrEl.classList.add('hidden'); let g = document.getElementById('addFormGlobalError');
              if(!g){ g = document.createElement('div'); g.id='addFormGlobalError'; g.className='text-sm text-red-600 mt-2'; const ref = document.getElementById('addForm').firstChild; document.getElementById('addForm').insertBefore(g, ref); }
              g.textContent = 'Erreur: ' + (serverMsg || 'Impossible d\'ajouter');
            }
          } else {
            let g = document.getElementById('addFormGlobalError');
            const serverMsg2 = String(json.error || json.message || '');
            if(!g){ g = document.createElement('div'); g.id='addFormGlobalError'; g.className='text-sm text-red-600 mt-2'; const ref = document.getElementById('addForm').firstChild; document.getElementById('addForm').insertBefore(g, ref); }
            g.textContent = 'Erreur: ' + (serverMsg2 || 'Impossible d\'ajouter');
          }
        }
      }).catch(err => { console.error(err);
        try{
          const raw = (err && err.message) ? String(err.message) : 'réseau';
          let parsed = null; try{ parsed = JSON.parse(raw); }catch(e){ parsed = null; }
          const msg = parsed && (parsed.error||parsed.message) ? (parsed.error||parsed.message) : raw;
          // if message refers to nin or telephone, display inline under the field
          const lower = (String(msg||'')).toLowerCase();
          if(lower.indexOf('nin') !== -1 || lower.indexOf('numéro d\'ident') !== -1 || lower.indexOf('déjà utilisé') !== -1){
            const ninErrEl = document.getElementById('ninErrorAdd');
            const ninMsgEl = document.getElementById('ninErrorAddMsg');
            if(ninErrEl && ninMsgEl){ ninMsgEl.textContent = msg; ninErrEl.classList.remove('hidden'); }
          } else if(lower.indexOf('tel') !== -1 || lower.indexOf('télé') !== -1){
            const telErrEl = document.getElementById('telErrorAdd');
            const telMsgEl = document.getElementById('telErrorAddMsg');
            if(telErrEl && telMsgEl){ telMsgEl.textContent = msg; telErrEl.classList.remove('hidden'); }
          } else {
            let g = document.getElementById('addFormGlobalError');
            if(!g){ g = document.createElement('div'); g.id='addFormGlobalError'; g.className='text-sm text-red-600 mt-2'; const ref = document.getElementById('addForm').firstChild; document.getElementById('addForm').insertBefore(g, ref); }
            g.textContent = 'Erreur serveur: ' + msg;
          }
        }catch(e){}
        // show a toast with the error and close the modal so user is returned to the list
        try{
          const toast = document.createElement('div');
          toast.className = 'text-sm py-2 px-3 rounded shadow-md';
          toast.style.position = 'fixed'; toast.style.right = '18px'; toast.style.top = '18px'; toast.style.background = '#ef4444'; toast.style.color = '#fff'; toast.style.zIndex = 120;
          toast.textContent = 'Erreur serveur: ' + (String((err && err.message) ? err.message : 'réseau'));
          document.body.appendChild(toast);
          setTimeout(()=>{ try{ toast.remove(); }catch(e){} }, 4200);
        }catch(e){}
        try{ closeAddModal(); }catch(e){}
      })
      .finally(() => { submitBtn.disabled = false; });
    });

    // Clear inline NIN error messages when user types
    (function(){
      const ninAddInput = document.getElementById('nin');
      if (ninAddInput){ ninAddInput.addEventListener('input', function(){ const wrapper = document.getElementById('ninErrorAdd'); const msg = document.getElementById('ninErrorAddMsg'); if(msg) msg.textContent=''; if(wrapper) wrapper.classList.add('hidden'); }); }
      const ninEditInput = document.getElementById('nin_edit');
      if (ninEditInput){ ninEditInput.addEventListener('input', function(){ const wrapper = document.getElementById('ninErrorEdit'); const msg = document.getElementById('ninErrorEditMsg'); if(msg) msg.textContent=''; if(wrapper) wrapper.classList.add('hidden'); }); }
      const telAddInput = document.getElementById('telephone');
      if (telAddInput){ telAddInput.addEventListener('input', function(){ const wrapper = document.getElementById('telErrorAdd'); const msg = document.getElementById('telErrorAddMsg'); if(msg) msg.textContent=''; if(wrapper) wrapper.classList.add('hidden'); }); }
  const telEditInput = document.getElementById('telephone_edit');
  if (telEditInput){ telEditInput.addEventListener('input', function(){ const wrapper = document.getElementById('telErrorEdit'); const msg = document.getElementById('telErrorEditMsg'); if(msg) msg.textContent=''; if(wrapper) wrapper.classList.add('hidden'); }); }
    })();

    // close icons simply close modals
    document.querySelectorAll('button[aria-label="Fermer"]').forEach(btn => {
      btn.addEventListener('click', function(e){
        e.preventDefault();
        closeAddModal();
      });
    });

    // Edit logic: open modal and prefill from row/card dataset
    function openEditModalWithData(data){
      const form = document.getElementById('editForm');
  console.debug('[debug] openEditModalWithData called', data);
  const idInput = form.querySelector('input[name="id"]');
  if (idInput) idInput.value = data.id || '';
    if (form.querySelector('input[name="nom"]')) form.querySelector('input[name="nom"]').value = data.nom || data.name || '';
  if (form.querySelector('input[name="nom_arabe"]')) form.querySelector('input[name="nom_arabe"]').value = data.nom_arabe || '';
    if (form.querySelector('input[name="prenom"]')) form.querySelector('input[name="prenom"]').value = data.prenom || '';
  if (form.querySelector('input[name="prenom_arabe"]')) form.querySelector('input[name="prenom_arabe"]').value = data.prenom_arabe || '';
    if (form.querySelector('input[name="email"]')) form.querySelector('input[name="email"]').value = data.email || '';
    if (form.querySelector('input[name="telephone"]')) form.querySelector('input[name="telephone"]').value = data.telephone || data.phone || '';
  // new fields
  // sex/genre: try multiple selectors (some templates use name="genre", others name="sexe") and match by value or by option text
  function setSelectValueByValueOrText(sel, val){
    if (!sel) return;
    if (val === null || val === undefined || val === '') { sel.value = ''; return; }
    const v = String(val).trim();
    // exact value match
    const opts = Array.from(sel.options || []);
    let found = opts.find(o => o.value === v);
    if (!found) found = opts.find(o => (o.value || '').toLowerCase() === v.toLowerCase());
    if (!found) found = opts.find(o => ((o.textContent||'').toLowerCase().indexOf(v.toLowerCase()) !== -1));
    if (found) { sel.value = found.value; return; }
    // fallback: try first char (M/F)
    const short = v.charAt(0).toLowerCase();
    found = opts.find(o => (o.value||'').toLowerCase() === short);
    if (found) { sel.value = found.value; return; }
    sel.value = '';
  }
  const sexSel = form.querySelector('select[name="sexe"]') || form.querySelector('select[name="genre"]') || form.querySelector('#genre_edit') || form.querySelector('#genre');
  if (sexSel) setSelectValueByValueOrText(sexSel, data.sexe || data.genre || '');
  if (form.querySelector('input[name="date_naissance"]')){
    try{ const iso = (typeof normalizeDateToISO === 'function') ? normalizeDateToISO(data.date_naissance || '') : (data.date_naissance || ''); form.querySelector('input[name="date_naissance"]').value = iso || (data.date_naissance || ''); }catch(e){ form.querySelector('input[name="date_naissance"]').value = data.date_naissance || ''; }
  }
  // show existing photo (if any) inside the edit modal's label so user sees current avatar before changing it
  try{
    const editLabel = document.querySelector('label[for="photoInputEdit"]');
    if (editLabel){
      if (data.photo){
        const url = data.photo;
        editLabel.style.backgroundImage = `url(${url})`;
        editLabel.style.backgroundSize = 'cover';
        editLabel.style.backgroundPosition = 'center';
        // remove inner icon/text so the photo is visible (consistent with file-change preview)
        editLabel.querySelectorAll('*').forEach(n => n.remove());
        editLabel.setAttribute('aria-label','Photo existante');
      } else {
        // restore a neutral background if no photo
        editLabel.style.backgroundImage = '';
      }
    }
  }catch(e){ /* ignore preview errors */ }
  // write into edit inputs (new ids) if present, fall back to existing selectors
  const lieuEdit = form.querySelector('#lieu_naissance_edit') || form.querySelector('#lieu_naissance_edit2') || form.querySelector('input[name="lieu_naissance"], select[name="lieu_naissance"]');
  if (lieuEdit) lieuEdit.value = data.lieu_naissance || '';
  const natEdit = form.querySelector('#nationalite_edit') || form.querySelector('#nationalite_edit2') || form.querySelector('input[name="nationalite"], select[name="nationalite"]');
  if (natEdit) natEdit.value = data.nationalite || '';
  // ensure arabic name inputs present in edit modal also reflect dataset
  try{ const nomAr = form.querySelector('input[name="nom_arabe"]') || form.querySelector('#nom_ar_edit'); if(nomAr) nomAr.value = data.nom_arabe || ''; const prenAr = form.querySelector('input[name="prenom_arabe"]') || form.querySelector('#prenom_ar_edit'); if(prenAr) prenAr.value = data.prenom_arabe || ''; }catch(e){}
  if (form.querySelector('input[name="nin"]')) form.querySelector('input[name="nin"]').value = data.nin || '';
  // adresse: support both input and textarea variants and common ids
  const addrEl = form.querySelector('input[name="adresse"], textarea[name="adresse"], #adresse_edit, #adresse_edit2');
  if (addrEl) addrEl.value = data.adresse || '';
  // bio / remarques: support multiple name variants used across templates
  (function(){
    const bioEl = form.querySelector('textarea[name="infos_supplementaires"], textarea[name="remarques"], textarea[name="bio"], #infos_supplementaires_edit, #bio_edit, textarea[name="remarques_edit"]');
    const rawBio = (data.remarques || data.infos_supplementaires || data.bio || '');
    console.debug('[debug] bio selectors ->', { found: !!bioEl, rawBio: rawBio });
    if (!bioEl) return;
    try{
      const dec = document.createElement('textarea');
      dec.innerHTML = rawBio || '';
      const finalVal = dec.value || rawBio || '';
      bioEl.value = finalVal;
      console.debug('[debug] bio assigned', finalVal);
    }catch(e){ bioEl.value = rawBio || ''; console.debug('[debug] bio assign error', e); }
  })();
  // new selects: niveau_etude, situation, dernier_diplome (edit)
  const nivEdit = form.querySelector('#niveau_etude_edit') || form.querySelector('select[name="niveau_etude"]');
  if (nivEdit) nivEdit.value = data.niveau_etude || '';
  const sitEdit = form.querySelector('#situation_edit') || form.querySelector('select[name="situation"]');
  if (sitEdit) sitEdit.value = data.situation || '';
  const dipEdit = form.querySelector('#dernier_diplome_edit') || form.querySelector('select[name="dernier_diplome"]');
  if (dipEdit) dipEdit.value = data.dernier_diplome || '';
  // set disabled display select and hidden value
  const disp = form.querySelector('select[name="formation_display"]');
  const hidden = form.querySelector('input[name="formation"]');
  if (disp) { disp.value = data.formation || ''; }
  if (hidden) { hidden.value = data.formation || ''; }
      editModal.classList.remove('hidden');
    }

  // ...existing code...

    // Attach handlers to edit buttons (table and cards)
    // NOTE: edit/verify buttons were removed in favor of status badge interactions.
    // Keep a stub to avoid errors where this function is called; delete handling is attached elsewhere.
    function attachEditHandlers(){
      // no-op: editing is now accessed via other UI paths (status badge / dedicated forms)
      return;
    }

    function openEditModalWithRow(row){
      const fullName = row.dataset.name || '';
      const parts = fullName.split(' ');
      const prenom = parts.length > 1 ? parts.pop() : '';
      const nom = parts.join(' ') || fullName;
      const data = {
        id: row.dataset.id,
        name: fullName,
        nom: nom,
        prenom: prenom,
        email: row.dataset.email,
        telephone: row.dataset.phone,
        formation: row.dataset.formation || row.dataset.display_formation || '',
        status: row.dataset.status,
        // forward common dataset fields so the edit modal can prefill them
        date_naissance: row.dataset.date_naissance || '',
        lieu_naissance: row.dataset.lieu_naissance || '',
        nationalite: row.dataset.nationalite || '',
        sexe: row.dataset.sexe || '',
        nin: row.dataset.nin || '',
        adresse: row.dataset.address || row.dataset.adresse || '',
        remarques: row.dataset.remarques || '',
        niveau_etude: row.dataset.niveau || '',
        situation: row.dataset.situation || '',
        dernier_diplome: row.dataset.dernier_diplome || '',
        photo: row.dataset.photo || ''
        , nom_arabe: row.dataset.nom_arabe || ''
        , prenom_arabe: row.dataset.prenom_arabe || ''
      };
      openEditModalWithData(data);
    }

    // date icon focus handlers: clicking the calendar svg focuses the nearest date input
    function attachDateIconHandlers(root){
      const container = root || document;
      // ensure only one visible date-icon exists per parent container (dedupe accidental duplicates)
      container.querySelectorAll('div, label, .relative').forEach(parent => {
        try{
          const icons = Array.from(parent.querySelectorAll && parent.querySelectorAll('.date-icon') || []);
          if (icons.length > 1){
            // keep the first, remove the rest
            for (let i = 1; i < icons.length; i++) try{ icons[i].remove(); }catch(e){}
          }
        }catch(e){}
      });

      container.querySelectorAll('.date-icon').forEach(icon => {
        // avoid double-binding
        if (icon.__dateHandlerAttached) return; icon.__dateHandlerAttached = true;
        icon.addEventListener('click', function(e){
          // prefer explicit target by id if provided
          const targetId = this.getAttribute('data-target');
          let input = null;
          if (targetId) input = document.getElementById(targetId) || document.querySelector(`#${CSS.escape(targetId)}`);
          if (!input){ // fallback: look near the icon
            const parent = this.closest('div') || this.parentElement;
            input = parent && parent.querySelector('input[name="date_naissance"]') ? parent.querySelector('input[name="date_naissance"]') : (parent && parent.querySelector('input[id^="date_naissance"]') ? parent.querySelector('input[id^="date_naissance"]') : null);
          }
          if (input) {
            openNativeDatePicker(input);
          }
        });
        icon.addEventListener('keydown', function(e){ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); this.click(); } });
      });
    }

    // Use a temporary input[type=date] to show the native date picker, then copy value back formatted
    function openNativeDatePicker(targetTextInput){
      try{
        const temp = document.createElement('input');
        temp.type = 'date';
        temp.style.position = 'absolute'; temp.style.left = '-9999px'; temp.style.width = '1px';
        // try to seed value from current text input if parseable (DD/MM/YYYY or ISO)
        const cur = (targetTextInput.value || '').trim();
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(cur)){
          const parts = cur.split('/'); // dd/mm/yyyy
          temp.value = `${parts[2]}-${parts[1]}-${parts[0]}`;
        } else if (/^\d{4}-\d{2}-\d{2}$/.test(cur)){
          temp.value = cur;
        }
        document.body.appendChild(temp);
        // open picker: focus then dispatch click (some browsers open on focus)
        temp.focus();
        temp.addEventListener('change', function onChange(){
          const v = this.value; // yyyy-mm-dd
          if (v && /^\d{4}-\d{2}-\d{2}$/.test(v)){
            try{ targetTextInput.value = v; targetTextInput.dispatchEvent(new Event('input', { bubbles: true })); targetTextInput.dispatchEvent(new Event('change', { bubbles: true })); }catch(e){}
          }
          setTimeout(()=>{ temp.remove(); }, 50);
        });
        // also remove if focusout without change
        temp.addEventListener('blur', function(){ setTimeout(()=>{ if (document.body.contains(temp)) temp.remove(); }, 200); });
        // some browsers open datepicker on click
        temp.click();
      }catch(e){ console.error('openNativeDatePicker failed', e); }
    }

    // attach initially and after DOM mutations that insert modals or rows
    attachDateIconHandlers(document);

// Photo input preview for add modal
// Helper: default avatar SVG markup used when no photo is present
function insertDefaultAvatarIntoLabel(label){
  if(!label) return;
  // clear background-image and inner nodes first
  label.style.backgroundImage = '';
  label.style.backgroundSize = '';
  label.style.backgroundPosition = '';
  label.innerHTML = `
    <svg aria-hidden="true" focusable="false" width="72" height="72" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color:#4b5563">
      <circle cx="12" cy="8" r="3.6" fill="#E6EEF3" stroke="#CBD5E1"></circle>
      <path d="M4 20c0-3.3 3.6-6 8-6s8 2.7 8 6" fill="#F8FAFB" stroke="#CBD5E1"></path>
    </svg>
    <p class="text-sm text-gray-500 mt-2" style="margin:0">Photo</p>
    <p class="text-xs text-gray-400" style="margin:0">PNG, JPG</p>
  `;
  label.removeAttribute('aria-label');
}

const addPhotoInput = document.getElementById('photoInput');
if (addPhotoInput){
  addPhotoInput.addEventListener('change', function(e){
    const file = this.files && this.files[0];
    const label = document.querySelector('label[for="photoInput"]');
    if(!file){
      // restore default avatar
      insertDefaultAvatarIntoLabel(label);
      return;
    }
    const reader = new FileReader();
    reader.onload = function(ev){
      if(label){
        label.style.backgroundImage = `url(${ev.target.result})`;
        label.style.backgroundSize = 'cover';
        label.style.backgroundPosition = 'center';
        // remove inner icon/text so the uploaded photo is fully visible; keep the label as clickable placeholder
        label.querySelectorAll('*').forEach(n => n.remove());
        // keep accessibility: set an aria-label indicating a photo is present
        label.setAttribute('aria-label', 'Photo uploadée');
      }
    };
    reader.readAsDataURL(file);
  });
}
// Photo input preview for edit modal (if present)
const photoEditInput = document.getElementById('photoInputEdit');
if (photoEditInput){
  photoEditInput.addEventListener('change', function(e){
    const file = this.files && this.files[0];
    const label = document.querySelector('label[for="photoInputEdit"]');
    if(!file){
      insertDefaultAvatarIntoLabel(label);
      return;
    }
    const reader = new FileReader();
    reader.onload = function(ev){
      if(label){
        label.style.backgroundImage = `url(${ev.target.result})`;
        label.style.backgroundSize = 'cover';
        label.style.backgroundPosition = 'center';
        label.querySelectorAll('*').forEach(n => n.remove());
        label.setAttribute('aria-label', 'Photo uploadée');
      }
      // if an img preview element exists inside edit modal, update it too
      const imgPreview = document.getElementById('v_photo');
      if (imgPreview) imgPreview.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  });
}
// Note: JS alignment/enforcement removed — layout is handled via CSS grid for predictable alignment.

    // Insert delete confirmation modal
    const deleteConfirmModal = document.createElement('div');
    deleteConfirmModal.id = 'deleteConfirmModal';
    deleteConfirmModal.className = 'hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop';
    deleteConfirmModal.innerHTML = `
      <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-md p-6">
        <h3 class="text-lg font-semibold mb-2">Confirmer la suppression</h3>
        <p class="text-sm text-gray-600 mb-4">Êtes-vous sûr de vouloir supprimer cet étudiant ? Cette action est irréversible.</p>
        <div class="flex justify-end space-x-3">
          <button id="cancelDeleteBtn" class="btn-secondary py-2 px-4 rounded">Annuler</button>
          <button id="confirmDeleteBtn" class="btn-danger py-2 px-4 rounded">Supprimer</button>
        </div>
      </div>
    `;
    document.body.appendChild(deleteConfirmModal);
    let _pendingDeleteRow = null;

    // When delete icon clicked, show modal instead of native confirm
    document.addEventListener('click', function(e){
      if (e.target.closest('.delete-btn')){
        e.stopPropagation();
        const row = e.target.closest('tr') || e.target.closest('div[ data-name ]');
        if (!row) return;
        _pendingDeleteRow = row;
        deleteConfirmModal.classList.remove('hidden');
      }
    });

    document.getElementById('cancelDeleteBtn').addEventListener('click', function(){
      _pendingDeleteRow = null;
      deleteConfirmModal.classList.add('hidden');
    });

    document.getElementById('confirmDeleteBtn').addEventListener('click', function(){
      if (!_pendingDeleteRow) { deleteConfirmModal.classList.add('hidden'); return; }
      const row = _pendingDeleteRow;
      const id = row.dataset.id;
      const fd = new FormData(); fd.append('id', id);
      fetch('{% url "etudiants_delete" %}', {
        method: 'POST', headers: { 'X-CSRFToken': csrftoken }, body: fd, credentials: 'same-origin'
      }).then(r => {
        if (!r.ok) return r.text().then(text => { throw new Error(text || r.statusText); });
        return r.json();
      }).then(json => {
        if (json.success) {
          row.remove();
        } else {
          // inline error inside modal
          let g = document.getElementById('deleteRowError');
          if(!g){ g = document.createElement('div'); g.id='deleteRowError'; g.className='text-sm text-red-600 mt-2'; const ref = deleteConfirmModal.querySelector('div'); if(ref) ref.appendChild(g); }
          g.textContent = 'Erreur: ' + (json.error || 'Impossible de supprimer');
        }
      }).catch(err => { console.error(err);
        try{
          const raw = (err && err.message) ? String(err.message) : 'réseau'; let parsed=null; try{ parsed = JSON.parse(raw); }catch(e){ parsed = null; }
          const msg = parsed && (parsed.error||parsed.message) ? (parsed.error||parsed.message) : raw;
          let g = document.getElementById('deleteRowError'); if(!g){ g = document.createElement('div'); g.id='deleteRowError'; g.className='text-sm text-red-600 mt-2'; const ref = deleteConfirmModal.querySelector('div'); if(ref) ref.appendChild(g); }
          g.textContent = 'Erreur serveur: ' + msg;
        }catch(e){}
      })
      .finally(() => { _pendingDeleteRow = null; deleteConfirmModal.classList.add('hidden'); });
    });

    // Edit submit -> POST to server
    document.getElementById('editForm').addEventListener('submit', function(e){
  e.preventDefault();
    // client-side validation for edit form: email, NIN, telephone (use inline messages)
  const emailEl = this.querySelector('input[name="email"]');
  const ninEl = this.querySelector('input[name="nin"]');
  const telEl = this.querySelector('input[name="telephone"]');
  // clear previous inline messages
  const ninEditMsg = document.getElementById('ninErrorEditMsg'); if(ninEditMsg){ ninEditMsg.textContent=''; const wrap = document.getElementById('ninErrorEdit'); if(wrap) wrap.classList.add('hidden'); }
  // add tel error container for edit if missing
  let telEditErr = document.getElementById('telErrorEdit'); if(!telEditErr){ const wrap = document.getElementById('telephone_edit'); if(wrap){ const div = document.createElement('div'); div.id='telErrorEdit'; div.className='text-sm text-red-600 mt-1 hidden'; div.innerHTML = '<span class="material-icons" style="font-size:16px;vertical-align:middle;margin-right:6px;">error_outline</span><span id="telErrorEditMsg"></span>'; wrap.parentNode.insertBefore(div, wrap.nextSibling); telEditErr = div; } }
  if (emailEl && emailEl.value && !emailEl.checkValidity()) { let g = document.getElementById('editFormGlobalError'); if(!g){ g = document.createElement('div'); g.id='editFormGlobalError'; g.className='text-sm text-red-600 mt-2'; document.getElementById('editForm').insertBefore(g, document.getElementById('editForm').firstChild);} g.textContent = 'Email invalide'; return; }
  if (ninEl && ninEl.value && (!/^\d{18}$/.test(ninEl.value.trim()))) { const ne = document.getElementById('ninErrorEdit'); const nem = document.getElementById('ninErrorEditMsg'); if(ne && nem){ nem.textContent='Le NIN doit contenir exactement 18 chiffres'; ne.classList.remove('hidden'); ninEl.focus(); } return; }
  if (telEl && telEl.value){ const digits = telEl.value.replace(/\D/g,''); if(!/^\d{10,11}$/.test(digits)){ const te = document.getElementById('telErrorEditMsg'); const telWrap = document.getElementById('telErrorEdit'); if(te && telWrap){ te.textContent = 'Le téléphone doit contenir 10 ou 11 chiffres'; telWrap.classList.remove('hidden'); telEl.focus(); } return; } }
      const form = e.target;
      const data = new FormData(form);
  // include id
  const idInput = form.querySelector('input[name="id"]');
  const id = idInput ? idInput.value : '';
  if (id) data.append('id', id);
      fetch('{% url "etudiants_edit" %}', {
        method: 'POST', headers: { 'X-CSRFToken': csrftoken }, body: data, credentials: 'same-origin'
      }).then(r => {
        if (!r.ok) return r.text().then(text => { throw new Error(text || r.statusText); });
        return r.json();
      }).then(json => {
        if (json.success) {
          const s = json.student;
          updateStudentRow(s);
          // show a small success toast
          try{
            const toast = document.createElement('div');
            toast.className = 'text-sm py-2 px-3 rounded shadow-md';
            toast.style.position = 'fixed';
            toast.style.right = '18px';
            toast.style.top = '18px';
            toast.style.color = '#fff';
            toast.style.zIndex = 120;
            let msg = json.message || 'Modifié avec succès';
            if (typeof json.email_scheduled !== 'undefined' && json.email_scheduled){
              msg += ' — Email planifié';
              toast.style.background = '#10b981';
            } else {
              toast.style.background = '#10b981';
            }
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(()=>{ try{ toast.remove(); }catch(e){} }, 3200);
          }catch(e){}
          // always close the modal after handling success
          closeEditModal();
        } else {
          const ninErrEl = document.getElementById('ninErrorEdit');
          const serverMsg = String(json.error || json.message || ''); const lowerSrv = serverMsg.toLowerCase();
          if (ninErrEl) {
            if (lowerSrv.indexOf('nin') !== -1 || lowerSrv.indexOf('déjà utilisé') !== -1) {
              // NIN-specific error: inline and clear any global banner
              const ninErrMsg3 = document.getElementById('ninErrorEditMsg'); if(ninErrMsg3) ninErrMsg3.textContent = serverMsg; ninErrEl.classList.remove('hidden'); const gRem = document.getElementById('editFormGlobalError'); if(gRem) gRem.remove();
            } else {
              // clear field-specific and show global error
              const ninErrMsgClear2 = document.getElementById('ninErrorEditMsg'); if(ninErrMsgClear2) ninErrMsgClear2.textContent=''; ninErrEl.classList.add('hidden'); const telRem = document.getElementById('telErrorEdit'); if(telRem) { const tmsg = document.getElementById('telErrorEditMsg'); if(tmsg) tmsg.textContent=''; telRem.classList.add('hidden'); }
              let g = document.getElementById('editFormGlobalError');
              if(!g){ g = document.createElement('div'); g.id='editFormGlobalError'; g.className='text-sm text-red-600 mt-2'; document.getElementById('editForm').insertBefore(g, document.getElementById('editForm').firstChild); }
              g.textContent = 'Erreur: ' + (serverMsg || 'Impossible de modifier');
            }
          } else {
            let g = document.getElementById('editFormGlobalError');
            if(!g){ g = document.createElement('div'); g.id='editFormGlobalError'; g.className='text-sm text-red-600 mt-2'; document.getElementById('editForm').insertBefore(g, document.getElementById('editForm').firstChild); }
            g.textContent = 'Erreur: ' + (serverMsg || 'Impossible de modifier');
          }
        }
      }).catch(err => { console.error(err);
        try{
          const raw = (err && err.message) ? String(err.message) : 'réseau'; let parsed=null; try{ parsed = JSON.parse(raw); }catch(e){ parsed = null; }
          const msg = parsed && (parsed.error||parsed.message) ? (parsed.error||parsed.message) : raw;
          const lower = (String(msg||'')).toLowerCase();
          if(lower.indexOf('nin') !== -1 || lower.indexOf('déjà utilisé') !== -1 || lower.indexOf('numéro d\'ident') !== -1){
            const ninErr = document.getElementById('ninErrorEdit'); const ninMsg = document.getElementById('ninErrorEditMsg'); if(ninErr && ninMsg){ ninMsg.textContent = msg; ninErr.classList.remove('hidden'); }
          } else if(lower.indexOf('tel') !== -1 || lower.indexOf('télé') !== -1){
            const telWrap = document.getElementById('telErrorEdit'); const telMsg = document.getElementById('telErrorEditMsg'); if(telWrap && telMsg){ telMsg.textContent = msg; telWrap.classList.remove('hidden'); }
          } else {
            let g = document.getElementById('editFormGlobalError');
            if(!g){ g = document.createElement('div'); g.id='editFormGlobalError'; g.className='text-sm text-red-600 mt-2'; document.getElementById('editForm').insertBefore(g, document.getElementById('editForm').firstChild); }
            g.textContent = 'Erreur serveur: ' + msg;
          }
        }catch(e){}
      });
    });

    // Helpers to add/update DOM rows/cards
    function appendStudentRow(s){
      const tbody = document.getElementById('studentsTbody');
      const tr = document.createElement('tr');
  tr.className = 'border-b student-row';
      tr.dataset.id = s.id;
      tr.dataset.name = (s.nom||'') + ' ' + (s.prenom||'');
  tr.dataset.nom_arabe = s.nom_arabe || '';
  tr.dataset.prenom_arabe = s.prenom_arabe || '';
      tr.dataset.email = s.email || '';
      tr.dataset.phone = s.telephone || '';
  tr.dataset.sexe = s.sexe || '';
  tr.dataset.date_naissance = s.date_naissance || '';
  tr.dataset.lieu_naissance = s.lieu_naissance || '';
  tr.dataset.nationalite = s.nationalite || '';
  tr.dataset.nin = s.nin || '';
  tr.dataset.remarques = s.remarques || '';
  tr.dataset.extrait = s.extrait_naissance_photo || s.extrait || '';
  tr.dataset.carte = s.carte_identite_photo || s.carte || '';
  tr.dataset.verify = s.verification_step || 0;
      tr.dataset.formation = s.formation || '';
          tr.dataset.ecole = s.ecole || '';
      // expose human-friendly formation name and id for client-side matching
      tr.dataset.formationText = s.display_formation || s.formation_text || '';
      tr.dataset.displayFormation = s.display_formation || s.formation_text || '';
      tr.dataset.formationId = s.formation_id || s.formation_id_for_filter || '';
      tr.dataset.status = s.statut || 'Actif';
      tr.dataset.photo = s.photo || '';
      const remaining = formatDZD(s.remaining || 0);
      tr.innerHTML = `
        <td class="px-6 py-4 font-mono text-sm">${s.id}</td>
        <td class="px-6 py-4"><img src="${s.photo || DEFAULT_AVATAR}" class="w-10 h-10 rounded-full"/></td>
        <td class="px-6 py-4 font-semibold">${s.nom || ''} ${s.prenom || ''}
          <div class="text-xs text-gray-500">${s.email || ''}</div>
        </td>
        <td class="px-6 py-4">${s.telephone || s.mobile || s.phone || '-'}</td>
        <td class="px-6 py-4">${s.adresse || '-'}</td>
    <td class="px-6 py-4 text-red-600 font-semibold">${remaining}</td>
  <td class="px-6 py-4"><span class="${s.inscription_status=='inscrit' ? 'status-actif' : 'status-inactif'} px-3 py-1 rounded-full text-xs font-semibold" role="button" tabindex="0">${s.inscription_status=='inscrit' ? 'Inscrit' : 'Non inscrit'}</span></td>
  <td class="px-6 py-4">${ Number(s.verification_step || 0) === 3 ? '<span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Vérifié</span>' : '<span class="status-inactif px-3 py-1 rounded-full text-xs font-semibold">Non vérifié</span>' }</td>
    <td class="px-6 py-4 text-right">
         
          <!-- Edit/Verify removed in favor of status-badge interactions; keep delete only -->
          <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
            <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="6" y="7" width="12" height="12" rx="2" stroke="#ef4444" stroke-width="1.4" fill="#fff5f5" />
              <path d="M9 10v6M15 10v6" stroke="#ef4444" stroke-width="1.4" stroke-linecap="round" />
              <path d="M8 7l1-2h6l1 2" stroke="#ef4444" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none" />
            </svg>
          </button>
        </td>
      `;
    tbody.prepend(tr);
  // make any date icons interactive on newly added row
  attachDateIconHandlers(tr);
  // Also add a card to the card view grid so newly added students show up without reload
  try{
    const cardGrid = document.querySelector('#cardView .grid');
    if (cardGrid){
      const card = document.createElement('div');
      card.className = 'group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row';
      card.setAttribute('role','button'); card.setAttribute('tabindex','0');
      card.dataset.id = s.id;
      card.dataset.name = (s.nom||'') + ' ' + (s.prenom||'');
      card.dataset.nom_arabe = s.nom_arabe || '';
      card.dataset.prenom_arabe = s.prenom_arabe || '';
      card.dataset.email = s.email || '';
      card.dataset.phone = s.telephone || '';
      card.dataset.formation = s.formation || '';
      card.dataset.ecole = s.ecole || '';
      card.dataset.formationText = s.display_formation || s.formation_text || '';
      card.dataset.displayFormation = s.display_formation || s.formation_text || '';
      card.dataset.formationId = s.formation_id || s.formation_id_for_filter || '';
      card.dataset.status = s.statut || 'Actif';
      card.dataset.photo = s.photo || '';
      const photo = s.photo || DEFAULT_AVATAR;
      const statusHtml = (s.inscription_status=='inscrit') ?
        `<span class="mt-2 inline-block status-actif px-3 py-1 text-xs font-semibold">Inscrit</span>` :
        `<a href="/inscriptions/?etudiant_id=${s.id}" class="mt-2 inline-block status-inactif px-3 py-1 text-xs font-semibold open-add-inscription" data-etudiant="${s.id}" data-etudiant-name="${(s.nom||'') + ' ' + (s.prenom||'')}">Non inscrit</a>`;
      card.innerHTML = `
        <div class="flex h-40 items-center justify-center pt-4">
          <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="${photo}"/>
        </div>
        <div class="p-4 text-center">
          <h3 class="text-base font-semibold text-gray-800">${s.nom || ''} ${s.prenom || ''}</h3>
          <p class="text-sm text-gray-500">${s.telephone || s.mobile || s.phone || '-'}</p>
          ${statusHtml}
            <div class="mt-3 flex items-center justify-center gap-2">
              <!-- print button intentionally removed from card actions -->
            </div>
        </div>
      `;
      // prepend so newest appear first (matching table prepend)
      cardGrid.prepend(card);
      attachDateIconHandlers(card);
    }
  }catch(e){ /* ignore card insertion errors */ }
    }

    function updateStudentRow(s){
      const selector = `tr[data-id="${s.id}"]`;
      const tr = document.querySelector(selector);
  if (!tr) return;
      tr.dataset.name = (s.nom||'') + ' ' + (s.prenom||'');
  tr.dataset.nom_arabe = s.nom_arabe || '';
  tr.dataset.prenom_arabe = s.prenom_arabe || '';
      tr.dataset.email = s.email || '';
      tr.dataset.phone = s.telephone || '';
  tr.dataset.sexe = s.sexe || '';
  tr.dataset.date_naissance = s.date_naissance || '';
  tr.dataset.lieu_naissance = s.lieu_naissance || '';
  tr.dataset.nationalite = s.nationalite || '';
  tr.dataset.nin = s.nin || '';
  tr.dataset.remarques = s.remarques || '';
  tr.dataset.extrait = s.extrait_naissance_photo || s.extrait || '';
  tr.dataset.carte = s.carte_identite_photo || s.carte || '';
  tr.dataset.verify = s.verification_step || 0;
      tr.dataset.formation = s.formation || '';
      tr.dataset.ecole = s.ecole || '';
      tr.dataset.status = s.statut || 'Actif';
  const remainingU = formatDZD(s.remaining || 0);
      tr.classList.add('student-row');
      tr.classList.add('student-row');
      tr.innerHTML = `
        <td class="px-6 py-4 font-mono text-sm">${s.id}</td>
  <td class="px-6 py-4"><img src="${s.photo || DEFAULT_AVATAR}" class="w-10 h-10 rounded-full"/></td>
        <td class="px-6 py-4 font-semibold">${s.nom || ''} ${s.prenom || ''}
          <div class="text-xs text-gray-500">${s.email || ''}</div>
        </td>
        <td class="px-6 py-4">${s.telephone || s.mobile || s.phone || '-'}</td>
        <td class="px-6 py-4">${s.adresse || '-'}</td>
  <td class="px-6 py-4"><span class="${ (s.remaining || 0) < 0 ? 'text-red-600 font-semibold' : 'text-green-700 font-semibold' }">${remainingU}</span></td>
        <td class="px-6 py-4"><span class="${s.inscription_status=='inscrit' ? 'status-actif' : 'status-inactif'} px-3 py-1 rounded-full text-xs font-semibold" role="button" tabindex="0">${s.inscription_status=='inscrit' ? 'Inscrit' : 'Non inscrit'}</span></td>
        <td class="px-6 py-4">${ Number(s.verification_step || 0) === 3 ? '<span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Vérifié</span>' : '<span class="status-inactif px-3 py-1 rounded-full text-xs font-semibold">Non vérifié</span>' }</td>
              <td class="px-6 py-4 text-right">
          <button class="delete-btn icon-btn" title="Supprimer" aria-label="Supprimer" data-tooltip="Supprimer">
            <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12z" fill="#ef4444"/><path d="M19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="#ef4444"/></svg>
          </button>
        </td>
      `;
  // attachEditHandlers is not required here because we removed edit/verify buttons; badge clicks are handled by delegated listener
  // rebind date icon handlers for the updated row
  attachDateIconHandlers(tr);
  // Also update any existing card element in the grid
  try{
    const card = document.querySelector('#cardView [data-id="'+String(s.id)+'"]');
    if (card){
      const photo = s.photo || DEFAULT_AVATAR;
      card.dataset.name = (s.nom||'') + ' ' + (s.prenom||'');
      card.dataset.email = s.email || '';
      card.dataset.phone = s.telephone || '';
      card.dataset.formation = s.formation || '';
      card.dataset.ecole = s.ecole || '';
      card.dataset.status = s.statut || 'Actif';
      card.dataset.photo = s.photo || '';
      const statusHtml2 = (s.inscription_status=='inscrit') ?
        `<span class="mt-2 inline-block status-actif px-3 py-1 text-xs font-semibold">Inscrit</span>` :
        `<a href="/inscriptions/?etudiant_id=${s.id}" class="mt-2 inline-block status-inactif px-3 py-1 text-xs font-semibold open-add-inscription" data-etudiant="${s.id}" data-etudiant-name="${(s.nom||'') + ' ' + (s.prenom||'')}">Non inscrit</a>`;
      card.innerHTML = `
        <div class="flex h-40 items-center justify-center pt-4">
          <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="${photo}"/>
        </div>
        <div class="p-4 text-center">
          <h3 class="text-base font-semibold text-gray-800">${s.nom || ''} ${s.prenom || ''}</h3>
          <p class="text-sm text-gray-500">${s.telephone || s.mobile || s.phone || '-'}</p>
          ${statusHtml2}
            <div class="mt-3 flex items-center justify-center gap-2">
              <!-- print button intentionally removed from injected card -->
            </div>
        </div>
      `;
      attachDateIconHandlers(card);
    }
  }catch(e){ /* ignore */ }
    }

    // Filters: search (by name, phone, address) and status
    (function(){
      const input = document.getElementById('searchInput');
      if(!input) return;

      // helper to detect date-like strings: YYYY-MM-DD or DD/MM/YYYY or DD-MM-YYYY
      function looksLikeDate(q){
        if(!q) return false;
        q = q.trim();
        return /^\d{4}-\d{2}-\d{2}$/.test(q) || /^\d{2}[\/\-]\d{2}[\/\-]\d{4}$/.test(q);
      }

      // merge API results into current view by showing rows that match, and hiding others
      function applyApiResults(results){
        // remove any previously injected rows to avoid duplicates
        document.querySelectorAll('.injected-row').forEach(r => r.remove());

        // hide all original rows and clear previous api-match flags
        document.querySelectorAll('.student-row').forEach(el => { el.style.display = 'none'; try{ el.dataset.apiMatch = ''; }catch(e){} });

        results.forEach(r => {
          // find all elements (table rows and cards) that represent this student id
          const matchedEls = Array.from(document.querySelectorAll('.student-row[data-id="'+String(r.id)+'"]'));
          if(matchedEls && matchedEls.length){
            matchedEls.forEach(row => {
              // show and mark existing elements, update important visible columns/datasets
              row.style.display = '';
              try{ row.dataset.apiMatch = '1'; }catch(e){}
              try{ row.dataset.phone = r.telephone || r.phone || ''; }catch(e){}
              try{ row.dataset.address = r.address || ''; }catch(e){}
                try{ row.dataset.ecole = r.ecole || ''; }catch(e){}
              try{ row.dataset.remaining = r.remaining || ''; }catch(e){}
              try{ row.dataset.status = (r.inscription_status || row.dataset.status || '').toString().trim().toLowerCase().replace(/\s+/g,'_'); }catch(e){}
              try{ row.dataset.verify = r.verification || row.dataset.verify || ''; }catch(e){}

              // update visible content depending on element type
              try{
                if(row.tagName === 'TR' || row.tagName === 'tr'){
                  // td indices: 0:id,1:photo,2:name,3:phone,4:address,5:remaining,6:statut,7:verification,8:actions
                  const tds = row.children;
                  if(tds && tds.length >= 9){
                    tds[3].textContent = r.telephone || r.phone || '-';
                    tds[4].textContent = r.address || '-';
                    try{
                      if(r.remaining){
                        const remStr = String(r.remaining);
                        const cls = remStr.indexOf('-') !== -1 ? 'balance-credite' : 'balance-solde';
                        tds[5].innerHTML = '<span class="'+cls+'">'+remStr+'</span>';
                      } else {
                        tds[5].innerHTML = '<span class="text-gray-700">-</span>';
                      }
                    }catch(e){ tds[5].innerHTML = '<span class="text-gray-700">-</span>'; }
                    tds[6].innerHTML = (r.inscription_status === 'inscrit') ? '<span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Inscrit</span>' : '<a href="/inscriptions/?etudiant_id='+r.id+'" class="status-inactif px-3 py-1 rounded-full text-xs font-semibold open-add-inscription" data-etudiant="'+r.id+'">Non inscrit</a>';
                    tds[7].innerHTML = (r.verification == 3 || r.verification === '3') ? '<span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Vérifié</span>' : '<span class="status-inactif px-3 py-1 rounded-full text-xs font-semibold">Non vérifié</span>';
                  }
                } else {
                  // likely a card (div). update phone text and dataset; keep name unchanged
                  const phoneEl = row.querySelector('p');
                  if(phoneEl) phoneEl.textContent = r.telephone || r.phone || '-';
                  // update status element inside card if present
                  const statusEl = row.querySelector('.status-actif, .status-inactif, .open-add-inscription');
                  if(statusEl){
                    if(r.inscription_status === 'inscrit'){
                      statusEl.outerHTML = '<span class="mt-2 inline-block status-actif px-3 py-1 text-xs font-semibold">Inscrit</span>';
                    } else {
                      statusEl.outerHTML = '<a href="/inscriptions/?etudiant_id='+r.id+'" class="mt-2 inline-block status-inactif px-3 py-1 text-xs font-semibold open-add-inscription" data-etudiant="'+r.id+'">Non inscrit</a>';
                    }
                  }
                }
              }catch(e){ /* ignore update errors for this element */ }
            });

          } else {
            // If row not present on this page (different pagination), inject a full row at top of tbody
            try{
              const tbody = document.getElementById('studentsTbody');
              if(tbody){
                const tr = document.createElement('tr');
                tr.className = 'border-b student-row injected-row';
                tr.dataset.id = r.id;
                tr.dataset.name = (r.nom || '') + ' ' + (r.prenom || '');
                tr.dataset.email = r.email || '';
                tr.dataset.phone = r.telephone || r.phone || '';
                tr.dataset.address = r.address || '';
                tr.dataset.ecole = r.ecole || '';
                tr.dataset.remaining = r.remaining || '';
                tr.dataset.status = (r.inscription_status || '').toString().trim().toLowerCase().replace(/\s+/g,'_');
                tr.dataset.verify = r.verification || '';
                tr.dataset.apiMatch = '1';
                tr.innerHTML = `\n                  <td class="px-6 py-4 font-mono text-sm">${r.id}</td>\n                  <td class="px-6 py-4"><img src="${r.photo || '/static/images/delete_18986470.gif'}" class="w-10 h-10 rounded-full"/></td>\n                  <td class="px-6 py-4 font-semibold">${(r.nom||'')+' '+(r.prenom||'')}<div class="text-xs text-gray-500">${r.email || ''}</div></td>\n                  <td class="px-6 py-4">${r.telephone || r.phone || '-'}</td>\n                  <td class="px-6 py-4">${r.address || '-'}</td>\n                  <td class="px-6 py-4">${r.remaining ? ('<span class="balance-solde">'+r.remaining+'</span>') : '<span class="text-gray-700">-</span>'}</td>\n                  <td class="px-6 py-4">${(r.inscription_status === 'inscrit') ? '<span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Inscrit</span>' : '<a href="/inscriptions/?etudiant_id='+r.id+'" class="status-inactif px-3 py-1 rounded-full text-xs font-semibold open-add-inscription" data-etudiant="'+r.id+'">Non inscrit</a>'}</td>\n                  <td class="px-6 py-4">${(r.verification == 3 || r.verification === '3') ? '<span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Vérifié</span>' : '<span class="status-inactif px-3 py-1 rounded-full text-xs font-semibold">Non vérifié</span>'}</td>\n                  <td class="px-6 py-4 text-right">-</td>\n                `;
                tbody.insertAdjacentElement('afterbegin', tr);
              }
            }catch(e){ /* ignore injection errors */ }
            // Also inject a card into the card grid so card view will display the match
            try{
              const cardGrid = document.querySelector('#cardView .grid');
              if(cardGrid && !document.querySelector('#cardView [data-id="'+String(r.id)+'"]')){
                const photo = r.photo || r.photo_url || '/static/images/delete_18986470.gif';
                const card = document.createElement('div');
                card.className = 'group relative overflow-hidden rounded-lg bg-white shadow-sm transition-all hover:shadow-md hover:bg-green-50 student-row injected-row';
                card.setAttribute('role','button'); card.setAttribute('tabindex','0');
                card.dataset.id = r.id; card.dataset.name = (r.nom||'') + ' ' + (r.prenom||''); card.dataset.email = r.email || ''; card.dataset.phone = r.telephone || r.phone || '';
                card.dataset.formation = r.formation || r.display_formation || '';
                card.dataset.ecole = r.ecole || '';
                card.dataset.status = r.statut || r.status || '';
                card.dataset.photo = photo;
                const statusHtml = (r.inscription_status === 'inscrit') ? '<span class="mt-2 inline-block status-actif px-3 py-1 text-xs font-semibold">Inscrit</span>' : '<a href="/inscriptions/?etudiant_id='+r.id+'" class="mt-2 inline-block status-inactif px-3 py-1 text-xs font-semibold open-add-inscription" data-etudiant="'+r.id+'">Non inscrit</a>';
                card.innerHTML = `\n+                  <div class="flex h-40 items-center justify-center pt-4">\n+                    <img alt="Student Avatar" class="h-32 w-32 rounded-full object-cover" src="${photo}"/>\n+                  </div>\n+                  <div class="p-4 text-center">\n+                    <h3 class="text-base font-semibold text-gray-800">${(r.nom||'')+' '+(r.prenom||'')}</h3>\n+                    <p class="text-sm text-gray-500">${r.telephone || r.phone || '-'}</p>\n+                    ${statusHtml}\n+                    <div class="mt-3 flex items-center justify-center gap-2">\n+                      <!-- print button removed -->\n+                    </div>\n+                  </div>\n+                `;
                card.dataset.apiMatch = '1';
                cardGrid.prepend(card);
                attachDateIconHandlers(card);
              }
            }catch(e){ /* ignore card injection errors */ }
          }
        });
      }

      // fallback local filter for non-date queries: keep existing behaviour
      function applyLocalFilter(q){
        const qq = (q || '').trim();
        // If query looks like a date, try to match date_naissance on visible rows before any API response
        const parsed = parseDateQuery(qq);
        if(parsed.type !== 'none'){
          // show rows whose data-date_naissance matches the requested precision
          document.querySelectorAll('.student-row').forEach(el => {
            try{
              const raw = (el.dataset.date_naissance || el.dataset.dateNaissance || '').trim();
              const elParsed = parseDateQuery(raw);
              let match = false;
              if(parsed.type === 'day' && elParsed.type === 'day'){
                match = (elParsed.iso === parsed.iso);
              } else if(parsed.type === 'month'){
                match = (elParsed.year === parsed.year && elParsed.month === parsed.month);
              } else if(parsed.type === 'year'){
                match = (elParsed.year === parsed.year);
              }
              el.style.display = match ? '' : 'none';
            }catch(e){ el.style.display = 'none'; }
          });
          return;
        }

        const qlow = qq.toLowerCase();
        document.querySelectorAll('.student-row').forEach(el => {
          const name = (el.dataset.name || '').toLowerCase();
          const phone = (el.dataset.phone || '').toLowerCase();
          const addr = (el.dataset.address || '').toLowerCase();
          const match = !qlow || name.includes(qlow) || phone.includes(qlow) || addr.includes(qlow);
          el.style.display = match ? '' : 'none';
        });
      }

      // Try to parse various date string inputs and return a normalized object
      // Recognizes: YYYY-MM-DD, D/M/YYYY, DD/MM/YYYY, YYYY-MM, YYYY
      function parseDateQuery(s){
        const res = {type: 'none', iso: '', year: null, month: null, day: null};
        if(!s) return res;
        s = s.trim();
        // ISO full
        let m = s.match(/^\s*(\d{4})-(\d{1,2})-(\d{1,2})\s*$/);
        if(m){
          const y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]);
          res.type = 'day'; res.year = y; res.month = mo; res.day = d;
          res.iso = y.toString().padStart(4,'0') + '-' + String(mo).padStart(2,'0') + '-' + String(d).padStart(2,'0');
          return res;
        }
        // D/M/YYYY or DD/MM/YYYY or D-M-YYYY
        m = s.match(/^\s*(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})\s*$/);
        if(m){
          const d = Number(m[1]), mo = Number(m[2]), y = Number(m[3]);
          res.type = 'day'; res.year = y; res.month = mo; res.day = d;
          res.iso = y.toString().padStart(4,'0') + '-' + String(mo).padStart(2,'0') + '-' + String(d).padStart(2,'0');
          return res;
        }
        // YYYY-MM (month precision)
        m = s.match(/^\s*(\d{4})[\/\-](\d{1,2})\s*$/);
        if(m){
          const y = Number(m[1]), mo = Number(m[2]);
          res.type = 'month'; res.year = y; res.month = mo; return res;
        }
        // YYYY (year precision)
        m = s.match(/^\s*(\d{4})\s*$/);
        if(m){
          res.type = 'year'; res.year = Number(m[1]); return res;
        }
        return res;
      }

      let pendingTimer = null;
      input.addEventListener('input', function(){
        const q = (this.value || '').trim();
        if(pendingTimer) clearTimeout(pendingTimer);
        pendingTimer = setTimeout(function(){
          if(!q){
              // empty query: clear API marker, remove injected rows and restore normal filtered view
              window.__lastApiSearchQ = '';
              // remove any injected rows that came from previous API searches
              document.querySelectorAll('.injected-row').forEach(r => r.remove());
              // clear apiMatch flags on existing rows and show them
              document.querySelectorAll('.student-row').forEach(el => { try{ el.dataset.apiMatch = ''; el.style.display = ''; }catch(e){} });
              applyFilters();
              return;
            }
          // For any non-empty query call the server API (covers name, phone, id, DOB)
          window.__lastApiSearchQ = q;
          const url = '{% url "api_etudiants_search" %}?q=' + encodeURIComponent(q);
          fetch(url).then(r=>r.json()).then(data=>{
            console.debug('[api_etudiants_search] q=', q, 'resp=', data);
            if(data && Array.isArray(data.results) && data.results.length){
              applyApiResults(data.results);
              try{ window.applyFilters && window.applyFilters(); }catch(e){}
            } else {
              applyLocalFilter(q);
              try{ window.applyFilters && window.applyFilters(); }catch(e){}
            }
          }).catch(err=>{
            console.warn('Search API failed', err);
            applyLocalFilter(q);
            try{ window.applyFilters && window.applyFilters(); }catch(e){}
          });
        }, 180);
      });
    })();

    // --- Verification fiche modal ---
    // create modal element
    const verifyModal = document.createElement('div');
    verifyModal.id = 'verifyModal';
    verifyModal.className = 'hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop';
    verifyModal.innerHTML = `
      <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-4xl p-6" style="max-height:88vh;overflow:auto;">
        <div style="position:sticky;top:0;z-index:60;background:#fff;padding:10px 12px;border-bottom:1px solid #eef2f7;margin-bottom:12px;">
          <div id="verifyProgress" style="display:flex;gap:12px;margin:0;padding:0 6px;align-items:center;width:100%;justify-content:space-between;"> <!-- steps inserted here --> </div>
        </div>
        <div class="flex justify-between items-center mb-2" style="margin-top:8px;">
          <h3 class="text-lg font-semibold">Fiche vérification</h3>
          <div class="verify-top-actions">
            <button id="verifyCancelTop" class="btn-secondary">Annuler</button>
            <button id="closeVerify" class="icon-btn">✕</button>
          </div>
        </div>
        <div id="verifyContent" style="padding-top:8px;">
          <div style="display:flex;gap:20px;align-items:flex-start;">
            <div style="flex:1; display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px;">
              <div style="">
                <div style="font-size:12px;color:#6b7280;font-weight:700;">Nom</div>
                <div id="v_nom" style="font-size:14px;color:#111827;font-weight:600;"></div>
              </div>
              <div>
                <div style="font-size:12px;color:#6b7280;font-weight:700;">Prénom</div>
                <div id="v_prenom" style="font-size:14px;color:#111827;font-weight:600;"></div>
              </div>
              <div>
                <div style="font-size:12px;color:#6b7280;font-weight:700;">Sexe</div>
                <div id="v_sexe" style="font-size:14px;color:#111827;"></div>
              </div>
              <div>
                <div style="font-size:12px;color:#6b7280;font-weight:700;">Date de naissance</div>
                <div id="v_dob" style="font-size:14px;color:#111827;"></div>
              </div>
              <div>
                <div style="font-size:12px;color:#6b7280;font-weight:700;">Lieu</div>
                <div id="v_lieu" style="font-size:14px;color:#111827;"></div>
              </div>
              <div>
                <div style="font-size:12px;color:#6b7280;font-weight:700;">Nationalité</div>
                <div id="v_nat" style="font-size:14px;color:#111827;"></div>
              </div>
              <div>
                <div style="font-size:12px;color:#6b7280;font-weight:700;">NIN</div>
                <div id="v_nin" style="font-size:14px;color:#111827;"></div>
              </div>
              <div>
                <div style="font-size:12px;color:#6b7280;font-weight:700;">Email</div>
                <div id="v_email" style="font-size:14px;color:#111827;"></div>
              </div>
              <div style="grid-column: 1 / -1;">
                <div style="font-size:12px;color:#6b7280;font-weight:700;">Adresse</div>
                <div id="v_addr" style="font-size:14px;color:#111827;"></div>
              </div>
            </div>
            <div style="width:220px;text-align:center;flex-shrink:0;">
              <img id="v_photo" src="{{ STATIC_URL }}images/delete_18986470.gif" style="width:220px;height:220px;border-radius:12px;object-fit:cover;"/>
            </div>
          </div>
          <hr style="margin:12px 0"/>
          <div>
            <h4 class="font-semibold">Documents</h4>
            <div style="display:flex;gap:12px;margin-top:8px;align-items:flex-start;">
              <div style="flex:1">
                <div><strong>Extrait de naissance</strong></div>
                <div id="v_extrait_preview" style="margin-top:6px;"></div>
                <div style="margin-top:6px;display:flex;gap:8px;align-items:center;">
                  <label class="file-picker">
                    <span class="file-label">Choisir un fichier</span>
                    <input class="file-input" id="picker_extrait" type="file" accept="image/*" />
                  </label>
                  <button id="upload_extrait_btn" class="upload-btn">Upload</button>
                  <div id="extrait_filename" style="font-size:13px;color:#6b7280;">Aucun fichier choisi</div>
                </div>
              </div>
              <div style="flex:1">
                <div><strong>Carte d'identité</strong></div>
                <div id="v_carte_preview" style="margin-top:6px;"></div>
                <div style="margin-top:6px;display:flex;gap:8px;align-items:center;">
                  <label class="file-picker">
                    <span class="file-label">Choisir un fichier</span>
                    <input class="file-input" id="picker_carte" type="file" accept="image/*" />
                  </label>
                  <button id="upload_carte_btn" class="upload-btn">Upload</button>
                  <div id="carte_filename" style="font-size:13px;color:#6b7280;">Aucun fichier choisi</div>
                </div>
              </div>
            </div>
          </div>
          <div style="margin-top:12px;text-align:right;">
            <div class="step-controls">
              <button id="stepBack" class="step-btn" title="Précédent">Précédent</button>
              <button id="stepNext" class="step-btn primary" title="Suivant">Suivant</button>
              <button id="verifySave" class="step-btn primary" style="margin-left:4px;">Enregistrer</button>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(verifyModal);

  let currentVerifyId = null;
  let currentVerifyStep = 0; // keeps the current numeric step for Next/Prev actions
  let _editDelegate = null;

  // Custom styled datalist dropdown to ensure consistent appearance inside modals
  (function(){
    const STYLE_ID = 'custom-datalist-styles';
    if (!document.getElementById(STYLE_ID)){
      const s = document.createElement('style'); s.id = STYLE_ID; s.textContent = `
      .custom-datalist { position: absolute; z-index: 99999; background: #fff; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 10px 30px rgba(2,6,23,0.08); border-radius:8px; overflow:auto; max-height:320px; font-size:14px; color:#111827; }
      .custom-datalist .item { padding:10px 14px; cursor:pointer; border-bottom:1px solid rgba(0,0,0,0.04); }
      .custom-datalist .item:hover, .custom-datalist .item.active{ background: #f8fafc; }
      `; document.head.appendChild(s);
    }

    function buildDropdown(input){
      const listId = input.getAttribute('list');
      if (!listId) return null;
      const dl = document.getElementById(listId);
      if (!dl) return null;
      // collect options and remove duplicates (case-insensitive, trimmed)
      const raw = Array.from(dl.querySelectorAll('option')).map(o=> (o.value||o.textContent||'').toString());
      const seen = new Set();
      const opts = [];
      raw.forEach(v => {
        const key = (v||'').trim().toLowerCase();
        if (!key) return;
        if (!seen.has(key)) { seen.add(key); opts.push({ value: v }); }
      });
      const box = document.createElement('div'); box.className = 'custom-datalist'; box.style.display='none'; document.body.appendChild(box);
      function render(filter){
        box.innerHTML = '';
        const f = (filter||'').toLowerCase();
        const matches = opts.filter(o=> o.value.toLowerCase().includes(f));
        matches.forEach(o=>{ const it = document.createElement('div'); it.className='item'; it.textContent = o.value; it.dataset.value = o.value; box.appendChild(it); });
        if (!matches.length){ const it = document.createElement('div'); it.className='item'; it.textContent='(Aucune suggestion)'; it.style.opacity=0.6; box.appendChild(it); }
      }
      function position(){
        const r = input.getBoundingClientRect(); const docEl = document.documentElement; const scrollTop = window.scrollY || docEl.scrollTop; const scrollLeft = window.scrollX || docEl.scrollLeft;
        box.style.minWidth = Math.max(r.width, 220) + 'px';
        box.style.left = (r.left + scrollLeft) + 'px';
        // prefer showing below input; if not enough space, show above
        const belowSpace = window.innerHeight - r.bottom; const aboveSpace = r.top;
        if (belowSpace > 200 || belowSpace >= aboveSpace){ box.style.top = (r.bottom + scrollTop + 6) + 'px'; }
        else { box.style.top = (r.top + scrollTop - box.offsetHeight - 6) + 'px'; }
      }
      let activeIdx = -1;
      // store original list value so we can restore it when hiding custom dropdown
      try { input.__origList = input.getAttribute && input.getAttribute('list'); } catch(e){ input.__origList = null; }
      const showCustom = ()=>{ try{ if (input.hasAttribute && input.hasAttribute('list')){ input.removeAttribute('list'); input.__listRemoved = true; } }catch(_){}; render(input.value); position(); box.style.display='block'; activeIdx = -1; };
      const hideCustom = ()=>{ box.style.display='none'; try{ if (input.__listRemoved && input.__origList){ input.setAttribute('list', input.__origList); input.__listRemoved = false; } }catch(_){} };

      input.addEventListener('input', e=>{ showCustom(); });
      input.addEventListener('focus', e=>{ showCustom(); });
      input.addEventListener('blur', e=>{ setTimeout(hideCustom, 180); });
      box.addEventListener('mousedown', e=>{ // use mousedown so blur hasn't hidden it yet
        const it = e.target.closest('.item'); if(!it) return; const v = it.dataset.value; if (v) input.value = v; hideCustom(); input.focus(); e.preventDefault(); });
      input.addEventListener('keydown', e=>{
        const items = Array.from(box.querySelectorAll('.item')).filter(i=> i.dataset.value);
        if (!items.length) return;
        if (e.key === 'ArrowDown'){ e.preventDefault(); activeIdx = Math.min(activeIdx+1, items.length-1); items.forEach((it,i)=> it.classList.toggle('active', i===activeIdx)); items[activeIdx].scrollIntoView({block:'nearest'}); }
        else if (e.key === 'ArrowUp'){ e.preventDefault(); activeIdx = Math.max(activeIdx-1, 0); items.forEach((it,i)=> it.classList.toggle('active', i===activeIdx)); items[activeIdx].scrollIntoView({block:'nearest'}); }
        else if (e.key === 'Enter'){ if (activeIdx>=0 && items[activeIdx]){ e.preventDefault(); input.value = items[activeIdx].dataset.value; hideCustom(); } }
      });
      // reposition on resize/scroll
      window.addEventListener('resize', position); window.addEventListener('scroll', position, true);
      return box;
    }

    // Bind to inputs inside modals and also top-level inputs to keep Add behaviour
    const selector = 'input[list]';
    document.querySelectorAll(selector).forEach(inp=>{ try{ buildDropdown(inp); }catch(e){ /* ignore */ } });
  })();

    function renderProgress(step){
      const labels = ['Info personnelles','Documents','Email','Vérifié'];
      const c = document.getElementById('verifyProgress');
      c.innerHTML = '';
      // update the tracked step so other controls can rely on it
      currentVerifyStep = Number(step) || 0;
      // make container a horizontal flex so we can insert connectors between steps
      c.style.display = 'flex';
      c.style.alignItems = 'center';
      c.style.gap = '8px';

      const connectors = [];
  labels.forEach((lbl, i)=>{
        const el = document.createElement('div');
        el.style.display = 'flex';
        el.style.flexDirection = 'column';
        el.style.alignItems = 'center';
        el.style.minWidth = '60px';
        // circle + label
  const active = i <= step;
  el.innerHTML = `<div class='verify-circle' style='width:30px;height:30px;border-radius:15px;border:2px solid ${active?"#10b981":"#e6e8eb"};display:flex;align-items:center;justify-content:center;background:${active?"#10b981":"transparent"};color:${active?"#fff":"#374151"};font-weight:700;transition:transform 250ms ease, background 250ms ease,border-color 250ms ease'>${i+1}</div><div style='font-size:12px;margin-top:8px;color:#374151;'>${lbl}</div>`;
        el.addEventListener('click', ()=>{ setVerifyStep(currentVerifyId, i); });
        c.appendChild(el);

        // create connector between this and next, except after last
        if (i < labels.length - 1){
          const conn = document.createElement('div');
          conn.className = 'verify-connector';
          conn.style.flex = '1 1 auto';
          conn.style.height = '6px';
          conn.style.borderRadius = '4px';
          conn.style.background = '#e6e8eb';
          conn.style.transform = 'scaleX(0)';
          conn.style.transformOrigin = 'left center';
          conn.style.transition = 'transform 420ms ease, background 420ms ease';
          // small wrapper so the layout spacing remains consistent
          const wrapper = document.createElement('div');
          wrapper.style.display = 'flex';
          wrapper.style.alignItems = 'center';
          wrapper.appendChild(conn);
          c.appendChild(wrapper);
          connectors.push({el: conn, index: i});
        }
      });

      // trigger animations: grow connectors up to current step
      // start collapsed then expand the active ones so the transition plays
      setTimeout(()=>{
        connectors.forEach(item => {
      if (item.index < currentVerifyStep){
        item.el.style.transform = 'scaleX(1)';
        item.el.style.background = '#10b981';
          } else {
            item.el.style.transform = 'scaleX(0)';
        item.el.style.background = '#e6e8eb';
          }
        });
        // subtle pulse on the active circle
        try{
          const activeCircle = c.querySelectorAll('.verify-circle')[currentVerifyStep];
          if (activeCircle){
            activeCircle.style.transform = 'scale(1.06)';
            setTimeout(()=>{ activeCircle.style.transform = 'scale(1)'; }, 220);
          }
        }catch(e){/* ignore */}
      }, 30);
  // update Prev/Next disabled state
  try{ updateStepButtons(); }catch(e){/* ignore if not defined yet */}
    }

  function openVerifyModal(id){
      currentVerifyId = id;
      console.debug('[verify] openVerifyModal start id=', id);
      verifyModal.classList.remove('hidden'); document.body.style.overflow = 'hidden';
      fetch(`/etudiants/${id}/json/`).then(r=>{
        if (!r.ok) return r.text().then(t=>{ throw new Error(t||r.statusText); });
        return r.json();
      }).then(json=>{
        console.debug('[verify] etudiant_detail_json', json);
        if (!json.success) return alert('Erreur chargement');
        const e = json.etudiant;
  document.getElementById('v_nom').textContent = e.nom || '';
        document.getElementById('v_prenom').textContent = e.prenom || '';
        document.getElementById('v_sexe').textContent = e.sexe || '';
        // show a human-friendly date (DD/MM/YYYY) when possible
        function formatDateForDisplay(raw){
          if(!raw) return '';
          try{
            const iso = (typeof normalizeDateToISO === 'function') ? normalizeDateToISO(raw) : raw;
            if(/^\d{4}-\d{2}-\d{2}$/.test(iso)){ const p = iso.split('-'); return `${p[2]}/${p[1]}/${p[0]}`; }
            return raw;
          }catch(e){ return raw || ''; }
        }
        document.getElementById('v_dob').textContent = formatDateForDisplay(e.date_naissance || '');
        document.getElementById('v_lieu').textContent = e.lieu_naissance || '';
        document.getElementById('v_nat').textContent = e.nationalite || '';
        document.getElementById('v_nin').textContent = e.nin || '';
  document.getElementById('v_addr').textContent = e.adresse || '';
  document.getElementById('v_email').textContent = e.email || '';
  // photo
  const photoUrl = e.photo_url || (e.photo ? ('/' + e.photo) : DEFAULT_AVATAR);
  document.getElementById('v_photo').src = photoUrl;
  // extrait
  const extraitUrl = e.extrait_naissance_photo_url || (e.extrait_naissance_photo ? ('/' + e.extrait_naissance_photo) : '');
  if (extraitUrl){ document.getElementById('v_extrait_preview').innerHTML = `<img src="${extraitUrl}" style="max-width:180px;max-height:140px;"/>`; if(document.getElementById('extrait_filename')) document.getElementById('extrait_filename').textContent = extractBasename(extraitUrl); } else { document.getElementById('v_extrait_preview').innerHTML = '<div class="muted">Aucun</div>'; if(document.getElementById('extrait_filename')) document.getElementById('extrait_filename').textContent = 'Aucun fichier choisi'; }
  // carte
  const carteUrl = e.carte_identite_photo_url || (e.carte_identite_photo ? ('/' + e.carte_identite_photo) : '');
  if (carteUrl){ document.getElementById('v_carte_preview').innerHTML = `<img src="${carteUrl}" style="max-width:180px;max-height:140px;"/>`; if(document.getElementById('carte_filename')) document.getElementById('carte_filename').textContent = extractBasename(carteUrl); } else { document.getElementById('v_carte_preview').innerHTML = '<div class="muted">Aucun</div>'; if(document.getElementById('carte_filename')) document.getElementById('carte_filename').textContent = 'Aucun fichier choisi'; }
  // initialize the tracked step then render
  currentVerifyStep = Number(e.verification_step) || 0;
  renderProgress(currentVerifyStep);
      }).catch(err=>{ console.error(err); alert('Erreur chargement'); });
    }

    document.addEventListener('click', function(e){
      const v = e.target.closest('.verify-btn');
      if (v){ const id = v.dataset.id; openVerifyModal(id); }
    });

    // Clicking the status badge should open the verification modal (table rows and cards)
    // But if the clicked badge is an inscription link (class 'open-add-inscription'), let that link open the inscription flow.
    document.addEventListener('click', function(e){
      const badge = e.target.closest('.status-actif, .status-inactif');
      if (!badge) return;
      // If the badge (or an ancestor) is the 'open-add-inscription' link, don't intercept
      if (e.target.closest('.open-add-inscription') || badge.closest('.open-add-inscription')) return;
      // prevent clicks on links inside badges (if any) that are not the inscription link
      if (e.target.closest('a')) return;
      const row = badge.closest('[data-id]');
      if (!row) return;
      const id = row.dataset.id;
      try{ openVerifyModal(id); }catch(err){ console.warn('openVerifyModal failed', err); }
    });

    // Keyboard accessibility: Enter/Space on the status badge opens verify modal
    document.addEventListener('keydown', function(e){
      if (e.key !== 'Enter' && e.key !== ' ') return;
      const active = document.activeElement;
      if (!active) return;
      if (!active.classList.contains('status-actif') && !active.classList.contains('status-inactif')) return;
      e.preventDefault();
      const row = active.closest('[data-id]'); if (!row) return; const id = row.dataset.id; try{ openVerifyModal(id); }catch(err){ console.warn('openVerifyModal failed', err); }
    });

  document.getElementById('closeVerify').addEventListener('click', ()=>{ console.debug('[verify] close clicked'); verifyModal.classList.add('hidden'); });
  document.getElementById('verifyCancelTop').addEventListener('click', ()=>{ console.debug('[verify] cancel top clicked'); verifyModal.classList.add('hidden'); });

  // restore body scrolling when modal closes
  function closeVerifyModal(){ verifyModal.classList.add('hidden'); try{ document.body.style.overflow = ''; }catch(e){} }
  document.getElementById('closeVerify').addEventListener('click', closeVerifyModal);
  document.getElementById('verifyCancelTop').addEventListener('click', closeVerifyModal);

  function extractBasename(path){ if(!path) return ''; try{ const parts = String(path).split(/[\\/]/); return parts[parts.length-1].substr(0,60); }catch(e){ return path; } }

    // file picker display handlers
    const pickerEx = document.getElementById('picker_extrait');
    const pickerCa = document.getElementById('picker_carte');
    const extraitFilename = document.getElementById('extrait_filename');
    const carteFilename = document.getElementById('carte_filename');
    if (pickerEx){ pickerEx.addEventListener('change', function(){ const f = this.files[0]; extraitFilename.textContent = f ? f.name : 'Aucun fichier choisi'; console.debug('[verify] picker_extrait change', f && f.name); }); }
    if (pickerCa){ pickerCa.addEventListener('change', function(){ const f = this.files[0]; carteFilename.textContent = f ? f.name : 'Aucun fichier choisi'; console.debug('[verify] picker_carte change', f && f.name); }); }

    // delegated handlers (robust if elements are recreated)
    document.addEventListener('click', function delegatedUploads(e){
      const btn = e.target.closest('#upload_extrait_btn');
  if (btn){ e.preventDefault(); console.debug('[verify] upload_extrait_btn clicked'); const f = (document.getElementById('picker_extrait')||{}).files && document.getElementById('picker_extrait').files[0]; if(!f){ const preview = document.getElementById('v_extrait_preview'); let m = document.getElementById('v_extrait_error'); if(!m){ m = document.createElement('div'); m.id='v_extrait_error'; m.className='text-sm text-red-600 mt-1'; preview.parentNode.insertBefore(m, preview.nextSibling); } m.textContent = 'Choisir un fichier'; return; } try{ const r = new FileReader(); r.onload = ev => { document.getElementById('v_extrait_preview').innerHTML = `<img src="${ev.target.result}" style="max-width:180px;max-height:140px;"/>`; }; r.readAsDataURL(f); }catch(e){} const fd = new FormData(); fd.append('file', f); fd.append('type', 'extrait'); fetch(`/etudiants/${currentVerifyId}/upload-doc/`, { method:'POST', body: fd, credentials:'same-origin', headers: { 'X-CSRFToken': csrftoken } }).then(r=>{ if (!r.ok) return r.text().then(t=>{ throw new Error(t||r.statusText); }); return r.json(); }).then(json=>{ console.debug('[verify] upload_extrait response', json); if (json.success){ const url = json.url || ('/' + (json.path||'')).replace(/\\/g,'/'); document.getElementById('v_extrait_preview').innerHTML = `<img src="${url}" style="max-width:180px;max-height:140px;"/>`; if (document.getElementById('extrait_filename')) document.getElementById('extrait_filename').textContent = 'Aucun fichier choisi'; if (document.getElementById('picker_extrait')) document.getElementById('picker_extrait').value = ''; const errEl = document.getElementById('v_extrait_error'); if(errEl) errEl.remove(); } else { const preview = document.getElementById('v_extrait_preview'); let m = document.getElementById('v_extrait_error'); if(!m){ m = document.createElement('div'); m.id='v_extrait_error'; m.className='text-sm text-red-600 mt-1'; preview.parentNode.insertBefore(m, preview.nextSibling); } m.textContent = 'Erreur upload: '+(json.error||''); } }).catch(err=>{ console.error(err); const preview = document.getElementById('v_extrait_preview'); let m = document.getElementById('v_extrait_error'); if(!m){ m = document.createElement('div'); m.id='v_extrait_error'; m.className='text-sm text-red-600 mt-1'; preview.parentNode.insertBefore(m, preview.nextSibling); } m.textContent = 'Erreur upload'; }); return; }
      const btn2 = e.target.closest('#upload_carte_btn');
  if (btn2){ e.preventDefault(); console.debug('[verify] upload_carte_btn clicked'); const f = (document.getElementById('picker_carte')||{}).files && document.getElementById('picker_carte').files[0]; if(!f){ const preview = document.getElementById('v_carte_preview'); let m = document.getElementById('v_carte_error'); if(!m){ m = document.createElement('div'); m.id='v_carte_error'; m.className='text-sm text-red-600 mt-1'; preview.parentNode.insertBefore(m, preview.nextSibling); } m.textContent = 'Choisir un fichier'; return; } try{ const r = new FileReader(); r.onload = ev => { document.getElementById('v_carte_preview').innerHTML = `<img src="${ev.target.result}" style="max-width:180px;max-height:140px;"/>`; }; r.readAsDataURL(f); }catch(e){} const fd = new FormData(); fd.append('file', f); fd.append('type', 'carte'); fetch(`/etudiants/${currentVerifyId}/upload-doc/`, { method:'POST', body: fd, credentials:'same-origin', headers: { 'X-CSRFToken': csrftoken } }).then(r=>{ if (!r.ok) return r.text().then(t=>{ throw new Error(t||r.statusText); }); return r.json(); }).then(json=>{ console.debug('[verify] upload_carte response', json); if (json.success){ const url = json.url || ('/' + (json.path||'')).replace(/\\/g,'/'); document.getElementById('v_carte_preview').innerHTML = `<img src="${url}" style="max-width:180px;max-height:140px;"/>`; if (document.getElementById('carte_filename')) document.getElementById('carte_filename').textContent = 'Aucun fichier choisi'; if (document.getElementById('picker_carte')) document.getElementById('picker_carte').value = ''; const errEl = document.getElementById('v_carte_error'); if(errEl) errEl.remove(); } else { const preview = document.getElementById('v_carte_preview'); let m = document.getElementById('v_carte_error'); if(!m){ m = document.createElement('div'); m.id='v_carte_error'; m.className='text-sm text-red-600 mt-1'; preview.parentNode.insertBefore(m, preview.nextSibling); } m.textContent = 'Erreur upload: '+(json.error||''); } }).catch(err=>{ console.error(err); const preview = document.getElementById('v_carte_preview'); let m = document.getElementById('v_carte_error'); if(!m){ m = document.createElement('div'); m.id='v_carte_error'; m.className='text-sm text-red-600 mt-1'; preview.parentNode.insertBefore(m, preview.nextSibling); } m.textContent = 'Erreur upload'; }); return; }
    });

    // Legacy form-based upload handlers — guard in case forms exist (we now use styled pickers)
    const legacyUploadEx = document.getElementById('upload_extrait');
    if (legacyUploadEx){
      legacyUploadEx.addEventListener('submit', function(e){
        e.preventDefault();
        const f = e.target.querySelector('input[type=file]').files[0];
  if (!f){ const preview = document.getElementById('v_extrait_preview'); let m = document.getElementById('v_extrait_error'); if(!m){ m = document.createElement('div'); m.id='v_extrait_error'; m.className='text-sm text-red-600 mt-1'; preview.parentNode.insertBefore(m, preview.nextSibling); } m.textContent = 'Choisir un fichier'; return; }
        try{ const reader = new FileReader(); reader.onload = ev => { document.getElementById('v_extrait_preview').innerHTML = `<img src="${ev.target.result}" style="max-width:180px;max-height:140px;"/>`; }; reader.readAsDataURL(f); }catch(err){ console.debug('preview failed', err); }
        const fd = new FormData(); fd.append('file', f); fd.append('type', 'extrait');
        fetch(`/etudiants/${currentVerifyId}/upload-doc/`, { method:'POST', body: fd, credentials:'same-origin', headers: { 'X-CSRFToken': csrftoken } }).then(r => { if (!r.ok) return r.text().then(t => { throw new Error(t || r.statusText); }); return r.json(); }).then(json=>{ console.log('upload_extrait response', json); if (json.success){ if (json.url) { document.getElementById('v_extrait_preview').innerHTML = `<img src="${json.url}" style="max-width:180px;max-height:140px;"/>`; } else if (json.path) { const p = ('/' + String(json.path)).replace(/\\/g, '/'); document.getElementById('v_extrait_preview').innerHTML = `<img src="${p}" style="max-width:180px;max-height:140px;"/>`; } } else { alert('Erreur upload: '+(json.error||'')); } }).catch(err=>{ console.error(err); alert('Erreur upload'); });
      });
    }

    const legacyUploadCarte = document.getElementById('upload_carte');
    if (legacyUploadCarte){
      legacyUploadCarte.addEventListener('submit', function(e){
        e.preventDefault();
        const f = e.target.querySelector('input[type=file]').files[0];
  if (!f){ const preview = document.getElementById('v_carte_preview'); let m = document.getElementById('v_carte_error'); if(!m){ m = document.createElement('div'); m.id='v_carte_error'; m.className='text-sm text-red-600 mt-1'; preview.parentNode.insertBefore(m, preview.nextSibling); } m.textContent = 'Choisir un fichier'; return; }
        try{ const reader = new FileReader(); reader.onload = ev => { document.getElementById('v_carte_preview').innerHTML = `<img src="${ev.target.result}" style="max-width:180px;max-height:140px;"/>`; }; reader.readAsDataURL(f); }catch(err){ console.debug('preview failed', err); }
        const fd = new FormData(); fd.append('file', f); fd.append('type', 'carte');
        fetch(`/etudiants/${currentVerifyId}/upload-doc/`, { method:'POST', body: fd, credentials:'same-origin', headers: { 'X-CSRFToken': csrftoken } }).then(r => { if (!r.ok) return r.text().then(t => { throw new Error(t || r.statusText); }); return r.json(); }).then(json=>{ console.log('upload_carte response', json); if (json.success){ if (json.url) { document.getElementById('v_carte_preview').innerHTML = `<img src="${json.url}" style="max-width:180px;max-height:140px;"/>`; } else if (json.path) { const p = ('/' + String(json.path)).replace(/\\/g, '/'); document.getElementById('v_carte_preview').innerHTML = `<img src="${p}" style="max-width:180px;max-height:140px;"/>`; } } else { alert('Erreur upload: '+(json.error||'')); } }).catch(err=>{ console.error(err); alert('Erreur upload'); });
      });
    }

    // Save button in verify modal: simply close the modal (state already persisted by uploads/step changes)
    document.getElementById('verifySave').addEventListener('click', function(){ verifyModal.classList.add('hidden'); });

    // step controls
    function setVerifyStep(id, step){
      const targetId = id || currentVerifyId;
      if (!targetId) return alert('Aucun étudiant sélectionné');
      const fd = new FormData(); fd.append('step', step);
      fetch(`/etudiants/${targetId}/update-step/`, { method:'POST', body: fd, credentials:'same-origin', headers: { 'X-CSRFToken': csrftoken } }).then(r=>{
        if (!r.ok) return r.text().then(t=>{ throw new Error(t||r.statusText); });
        return r.json();
      }).then(json=>{
        if (json.success){
          renderProgress(json.step);
        } else { alert('Erreur étape'); }
      }).catch(err=>{ console.error('setVerifyStep', err); alert('Erreur mise à jour'); });
    }

    function updateStepButtons(){
      const back = document.getElementById('stepBack');
      const next = document.getElementById('stepNext');
      if (!back || !next) return;
      back.disabled = (currentVerifyStep <= 0);
      next.disabled = (currentVerifyStep >= 3);
      if (back.disabled) back.classList.add('disabled'); else back.classList.remove('disabled');
      if (next.disabled) next.classList.add('disabled'); else next.classList.remove('disabled');
    }

    document.getElementById('stepNext').addEventListener('click', function(){ if (currentVerifyId !== null){ const next = Math.min(3, Number(currentVerifyStep) + 1); setVerifyStep(currentVerifyId, next); } });
    document.getElementById('stepBack').addEventListener('click', function(){ if (currentVerifyId !== null){ const prev = Math.max(0, Number(currentVerifyStep) - 1); setVerifyStep(currentVerifyId, prev); } });
    // Single-click on a student (card or table row) should open edit modal
    // Ignore clicks on interactive controls or on status/inscription elements so we don't intercept normal actions
    document.addEventListener('click', function(e){
      if (e.target.closest('a, button, input, textarea, select, .icon-btn, .status-actif, .status-inactif, .open-add-inscription')) return;
      const card = e.target.closest('.student-row');
      if (!card) return;
      try{ openEditModalWithRow(card); }catch(err){ console.warn('openEditModalWithRow failed', err); }
    });

    // Printing support removed from students cards view. All print controls and helpers have been removed from this template.
  // statusFilter change is handled by the centralized applyFilters() in the filtering module

    // Init
    attachEditHandlers();
    // Niveau filter change -> reload with query param
    // Auto-open add student modal when ?open_add_student=1
    (function(){
      try{
        const params = new URLSearchParams(window.location.search);
        if (params.get('open_add_student') === '1'){
          const btn = document.getElementById('openAddBtn');
          if (btn) btn.click();
        }
      }catch(e){ console.error(e); }
    })();
    // Hidden niveauFilter removed; use fraisFilterVisible for client-side filtering instead.

    // --- Populate searchable selects (keep visual select but add a small search input) ---
    (function(){
      // helper: read values from a datalist into an array
      function valuesFromDatalist(id){
        const dl = document.getElementById(id);
        if(!dl) return [];
        return Array.from(dl.querySelectorAll('option')).map(o=>o.value).filter(Boolean);
      }

      // populate all selects that have matching datalist sources
      const natValues = valuesFromDatalist('nationalite_list');
      const lieuValues = valuesFromDatalist('lieu_list');

      function populateSelect(sel, items){
        if(!sel) return;
        // keep first placeholder option if present
        const first = sel.querySelector('option') && sel.querySelector('option').value === '' ? sel.querySelector('option') : null;
        sel.innerHTML = '';
        if(first) sel.appendChild(first);
        items.forEach(v=>{ const o = document.createElement('option'); o.value = v; o.textContent = v; sel.appendChild(o); });
      }

      // populate all matching selects (nationalite / lieu_naissance)
      document.querySelectorAll('select[name="nationalite"]').forEach(s => populateSelect(s, natValues));
      document.querySelectorAll('select[name="lieu_naissance"]').forEach(s => populateSelect(s, lieuValues));

      // attach filter behavior: each .select-search targets the following select element
      document.querySelectorAll('.select-search').forEach(inp => {
        const sel = inp.nextElementSibling && inp.nextElementSibling.tagName === 'SELECT' ? inp.nextElementSibling : null;
        const targetName = sel ? sel.getAttribute('name') : inp.dataset.target;
        // on input, rebuild options from the master array to avoid hiding issues
        inp.addEventListener('input', function(){
          const q = (this.value || '').toLowerCase();
          const master = (targetName === 'nationalite') ? natValues : (targetName === 'lieu_naissance' ? lieuValues : []);
          if(!sel) return;
          // preserve placeholder (empty) option if present
          const placeholder = sel.querySelector('option') && sel.querySelector('option').value === '' ? sel.querySelector('option').outerHTML : '<option value="">--</option>';
          // rebuild
          const html = [placeholder].concat(master.filter(v => !q || v.toLowerCase().indexOf(q) !== -1).map(v => `<option value="${v}">${v}</option>`)).join('');
          sel.innerHTML = html;
        });
      });
    })();
        // Arabic-only input enforcement for Arabic name fields
        (function(){
          function normalizeArabicInput(str){
            // allow Arabic letters, spaces, hyphen, shadda, long vowels and common punctuation
            // Ranges: \u0600-\u06FF, \u0750-\u077F, \u08A0-\u08FF
            const allowed = /[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\s\-\u064B-\u0652\u0621-\u063A\u0641-\u064A\u0670]/g;
            const matches = str.match(allowed);
            return matches ? matches.join('') : '';
          }
          ['nom_arabe','prenom_arabe'].forEach(function(name){
            const el = document.querySelector('input[name="'+name+'"]');
            if(!el) return;
            // on input: filter characters
            el.addEventListener('input', function(e){
              const val = this.value || '';
              const clean = normalizeArabicInput(val);
              if (clean !== val) { this.value = clean; }
            });
            // on paste: sanitize paste content
            el.addEventListener('paste', function(e){
              e.preventDefault();
              const text = (e.clipboardData || window.clipboardData).getData('text') || '';
              this.value = normalizeArabicInput(text);
            });
          });
        })();
        // Client-side filtering and export
        (function(){
          const sortFilter = document.getElementById('sortFilter');
          const formationFilter = document.getElementById('formationFilter');
          const ecoleFilter = document.getElementById('ecoleFilter');
          const statusFilter = document.getElementById('statusFilter');
          const niveauFilterVisible = null; // deprecated
          const fraisFilterVisible = document.getElementById('fraisFilterVisible');
          const exportCsvBtn = document.getElementById('exportCsvBtn');
          const exportJsonBtn = document.getElementById('exportJsonBtn');
          const searchInput = document.getElementById('searchInput');

          function getAllRows(){
            // table rows and card elements
            const rows = Array.from(document.querySelectorAll('#studentsTbody tr.student-row'));
            const cards = Array.from(document.querySelectorAll('#cardView .student-row'));
            return rows.concat(cards);
          }

          function matchesFormation(el){
            if(!formationFilter) return true;
            const selected = formationFilter && formationFilter.selectedOptions ? Array.from(formationFilter.selectedOptions).map(o=>o.value).filter(Boolean) : [];
            if(selected.length === 0) return true;
            // strict matching: student data-formation should contain the formation id (string)
            const f = (el.dataset.formation || '').toString();
            const fId = (el.dataset.formationId || '').toString();
            // if student has formation_text (non-numeric), allow matching by text
            const fText = (el.dataset.formationText || el.dataset.displayFormation || '').toString();
            for (let v of selected){
              if (!v) continue;
              // numeric compare first
              if (f && String(f) === String(v)) return true;
              if (fId && String(fId) === String(v)) return true;
              if (fText && String(fText) === String(v)) return true;
            }
            return false;
          }

          function matchesStatus(el){
            const val = (statusFilter && statusFilter.value) || 'all';
            if(val === 'all') return true;
            // prefer explicit data-inscription when present (normalized: 'inscrit' or 'non_inscrit')
            const inscriptionRaw = (el.dataset.inscription || el.dataset.status || '').toString();
            // normalize whitespace to underscores and lowercase to match server-side normalization
            const inscription = inscriptionRaw.trim().toLowerCase().replace(/\s+/g,'_');
            const verified = el.dataset.verify && String(el.dataset.verify) === '3';
            if(val === 'inscrit') return inscription === 'inscrit' || inscription === 'actif';
            if(val === 'non_inscrit') return inscription === 'non_inscrit' || !(inscription === 'inscrit' || inscription === 'actif');
            if(val === 'verifie') return !!verified;
            if(val === 'non_verifie') return !verified;
            return true;
          }

          function matchesEcole(el){
            if(!ecoleFilter) return true;
            const val = (ecoleFilter.value || '').toString().trim();
            if(!val) return true;
            const ecole = (el.dataset.ecole || el.dataset.address || el.dataset.adresse || '').toString().trim();
            return String(ecole) === String(val);
          }

          function matchesFrais(el){
            const val = (fraisFilterVisible && (''+fraisFilterVisible.value).toLowerCase()) || '';
            if(!val) return true;
            // parse data-remaining as number; fallback to 0
            const raw = (el.dataset.remaining || el.dataset.remainingFees || el.dataset.remaining_fees || '0').toString().replace(',', '.');
            const num = parseFloat(raw) || 0;
            // If the user selected 'regle', use explicit data-regle boolean exposed by server
            if(val === 'regle'){
              // dataset values rendered by Django will be 'True'/'False' or '1'/'0'
              const r = (el.dataset.regle || '').toString().toLowerCase();
              return r === 'true' || r === '1' || r === 'y' || r === 'yes';
            }
            // Normal semantics: 'negatif' => remaining > 0 (student owes money), 'positif' => remaining < 0 (credit)
            if(val === 'negatif') return num > 0;
            if(val === 'positif') return num < 0;
            return true;
          }

          function matchesSearch(el){
            const q = (searchInput && searchInput.value || '').toLowerCase().trim();
            // empty query -> match everything
            if(!q) return true;
            // If a date search was performed and this row was returned by the API, keep it visible
            try{
              if(window.__lastApiSearchQ && el.dataset && el.dataset.apiMatch === '1') return true;
            }catch(e){ /* ignore */ }

            // Aggregate possible name fields (supports table rows and card elements)
            const nameParts = [
              el.dataset.name || '',
              el.dataset.nom || '',
              el.dataset.prenom || '',
              el.dataset.nom_arabe || '',
              el.dataset.prenom_arabe || ''
            ].join(' ').toLowerCase();

            // Phones and emails (different dataset keys exist across templates)
            const phone = ((el.dataset.phone || '') + ' ' + (el.dataset.telephone || '') + ' ' + (el.dataset.mobile || '')).toLowerCase();
            const email = (el.dataset.email || '').toLowerCase();
            const addr = (el.dataset.address || el.dataset.adresse || '').toLowerCase();

            // Also fall back to visible text inside the card/row
            const text = (el.textContent || '').toLowerCase();

            return nameParts.indexOf(q) !== -1 || phone.indexOf(q) !== -1 || email.indexOf(q) !== -1 || addr.indexOf(q) !== -1 || text.indexOf(q) !== -1;
          }

          function applyFilters(){
            const all = getAllRows();
            all.forEach(el => {
              const ok = matchesFormation(el) && matchesEcole(el) && matchesStatus(el) && matchesFrais(el) && matchesSearch(el);
              if(ok) el.style.display = '';
              else el.style.display = 'none';
            });
            // sorting table rows
            const table = document.getElementById('studentsTbody');
            if(table && sortFilter && typeof sortFilter.value !== 'undefined'){
              const key = sortFilter.value;
              const trs = Array.from(table.querySelectorAll('tr.student-row'));
              trs.sort((a,b)=>{
                if(key === 'alpha'){
                  const an = (a.dataset.name||'').toLowerCase();
                  const bn = (b.dataset.name||'').toLowerCase();
                  return an.localeCompare(bn);
                }
                if(key === 'oldest'){
                  return Number(a.dataset.id||0) - Number(b.dataset.id||0);
                }
                if(key === 'recent'){
                  return Number(b.dataset.id||0) - Number(a.dataset.id||0);
                }
                return 0;
              });
              trs.forEach(r=> table.appendChild(r));
            }
          }

          function collectVisibleData(){
            const items = [];
            getAllRows().forEach(el => {
              if(el.style.display === 'none') return;
              const obj = {
                id: el.dataset.id || '',
                nom: el.dataset.name || '',
                email: el.dataset.email || '',
                telephone: el.dataset.phone || '',
                adresse: el.dataset.address || '',
                formation: el.dataset.formation || el.dataset.formationName || '',
                statut: el.dataset.status || '',
                verification: el.dataset.verify || '',
                niveau: el.dataset.niveau || '',
                situation: el.dataset.situation || '',
                dernier_diplome: el.dataset.dernierDiplome || el.dataset.dernier_diplome || ''
              };
              items.push(obj);
            });
            return items;
          }

          function downloadCSV(items, filename){
            if(!items || items.length === 0) { alert('Aucun élément à exporter'); return; }
            const keys = Object.keys(items[0]);
            const lines = [keys.join(',')].concat(items.map(it => keys.map(k=> '"'+String(it[k]||'').replace(/"/g,'""')+'"').join(',')));
            const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename || 'students.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
          }

          if(sortFilter) sortFilter.addEventListener('change', applyFilters);
          if(formationFilter) formationFilter.addEventListener('change', applyFilters);
          if(statusFilter) statusFilter.addEventListener('change', applyFilters);
          if(fraisFilterVisible) fraisFilterVisible.addEventListener('change', applyFilters);
          // Note: search input has its own handler above which calls API for date queries.

          if(exportCsvBtn) exportCsvBtn.addEventListener('click', function(){ const items = collectVisibleData(); downloadCSV(items, 'etudiants_export.csv'); });
          // Ensure typing in search input will trigger the client-side filter pass as well
          if(searchInput) searchInput.addEventListener('input', function(){ try{ window.applyFilters && window.applyFilters(); }catch(e){ setTimeout(function(){ try{ applyFilters(); }catch(e2){} }, 10); } });
          if(exportJsonBtn) exportJsonBtn.addEventListener('click', function(){ const items = collectVisibleData(); const blob = new Blob([JSON.stringify(items, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'etudiants_export.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); });

          // server-side exports: XLSX / PDF buttons
          const exportXlsxBtn = document.getElementById('exportXlsxBtn');
          const exportPdfBtn = document.getElementById('exportPdfBtn');
          function buildExportUrl(base){
            const params = new URLSearchParams();
            // add selected formation filters
            if (formationFilter){
              Array.from(formationFilter.selectedOptions).forEach(o => { if (o.value) params.append('formation', o.value); });
            }
            // add status filter
            if (statusFilter && statusFilter.value && statusFilter.value !== 'all') params.set('status', statusFilter.value);
            // add search
            if (searchInput && searchInput.value) params.set('q', searchInput.value);
            return base + (params.toString() ? ('?' + params.toString()) : '');
          }
          if (exportXlsxBtn){ exportXlsxBtn.addEventListener('click', function(){ window.location = buildExportUrl('{% url "etudiants_export_xlsx" %}'); }); }
          if (exportPdfBtn){ exportPdfBtn.addEventListener('click', function(){ window.location = buildExportUrl('{% url "etudiants_export_pdf" %}'); }); }

          // initial filter pass and expose globally so other UI helpers can call it
          window.applyFilters = applyFilters;
          setTimeout(applyFilters, 30);
        })();

        // Make status badges clickable: open verification modal when clicked (delegated)
        document.addEventListener('click', function(e){
          const badge = e.target.closest('.status-actif, .status-inactif');
          if(!badge) return;
          // find row element that contains this badge
          const row = badge.closest('[data-id]') || badge.closest('.student-row');
          if(!row) return;
          const id = row.dataset.id;
          if(!id) return;
          // If the badge is the inscription link (Non inscrit anchor), let its default behaviour (open inscription) run
          if(badge.tagName === 'A' && badge.classList.contains('open-add-inscription')) return;
          // otherwise open verify modal for this student
          try{ openVerifyModal(id); }catch(err){ console.warn('openVerifyModal failed', err); }
        });
        // Show full datalist options on focus/click for specific inputs (nationalite, lieu_naissance)
        (function(){
          // buildDropdown is already defined above; bind it to every input[list] once
          try{
            document.querySelectorAll('input[list]').forEach(inp => {
              try{ buildDropdown(inp); }catch(e){}
            });
          }catch(e){ /* ignore */ }
        })();
        // --- Enforce name casing: NOM => UPPERCASE, Prénom => Capitalize first letters ---
        (function(){
          function capitalizePrenom(s){
            if(!s) return '';
            return s.toLowerCase().split(/(\s|\-)/).map(part => {
              return part.replace(/^[\s\-]*([a-zàâäáéèêëìíîïòóôöùúûüçœ])/i, function(m, c){ return c ? c.toUpperCase() : m; });
            }).join('');
          }

          function attachUppercase(el){ if(!el) return; el.addEventListener('blur', function(){ this.value = (this.value||'').toUpperCase(); }); }
          function attachCapitalize(el){ if(!el) return; el.addEventListener('blur', function(){ this.value = capitalizePrenom(this.value||''); }); }

          try{
            // Add form
            const nomAdd = document.getElementById('nom');
            const prenomAdd = document.getElementById('prenom');
            attachUppercase(nomAdd);
            attachCapitalize(prenomAdd);
          }catch(e){ /* ignore */ }

          try{
            // Edit form
            const editForm = document.getElementById('editForm');
            if(editForm){
              const nomEdit = editForm.querySelector('input[name="nom"]');
              const prenomEdit = editForm.querySelector('input[name="prenom"]');
              attachUppercase(nomEdit);
              attachCapitalize(prenomEdit);

              // Normalize values after edit modal is populated
              if(typeof openEditModalWithData === 'function'){
                const _orig = openEditModalWithData;
                window.openEditModalWithData = function(data){
                  _orig(data);
                  setTimeout(function(){ if(nomEdit) nomEdit.value = (nomEdit.value||'').toUpperCase(); if(prenomEdit) prenomEdit.value = capitalizePrenom(prenomEdit.value||''); }, 8);
                };
              }
            }
          }catch(e){ /* ignore */ }
        })();
  </script>

<script>
  // Update the displayed "Total restant à payer" when client-side filters/search change.
  (function(){
    function parseNumber(v){
      if(v === undefined || v === null || v === '') return 0;
      // ensure dot decimal separator
      var n = String(v).replace(/\s|\u00A0|,/g, '');
      var f = parseFloat(n);
      return isNaN(f) ? 0 : f;
    }

    function isVisible(el){
      if(!el) return false;
      // consider visible if in DOM and not display:none
      return !!(el.offsetParent || el.getClientRects().length);
    }

    function updateTotalFromVisible(){
      var rows = Array.from(document.querySelectorAll('.student-row'));
      var total = 0.0;
      rows.forEach(function(r){
        if(!isVisible(r)) return;
        var v = r.dataset && r.dataset.remaining !== undefined ? r.dataset.remaining : r.getAttribute('data-remaining');
        var num = parseNumber(v);
        // total_reste_a_payer = - sum(values)
        total -= num;
      });
      // format number for display (no decimals)
      try{
        var fmt = new Intl.NumberFormat('fr-FR', {maximumFractionDigits:0}).format(Math.round(total));
      }catch(e){
        var fmt = String(Math.round(total));
      }
      var el = document.getElementById('totalResteValue');
      if(el) el.textContent = fmt;
    }

    function attachEvents(){
      var controls = ['searchInput','sortFilter','formationFilter','fraisFilterVisible','statusFilter'];
      controls.forEach(function(id){
        var el = document.getElementById(id);
        if(!el) return;
        el.addEventListener('input', updateTotalFromVisible);
        el.addEventListener('change', updateTotalFromVisible);
      });

      // observe DOM changes to students list (in case filtering code manipulates rows)
      var tbody = document.getElementById('studentsTbody');
      if(tbody && window.MutationObserver){
        var mo = new MutationObserver(function(){ updateTotalFromVisible(); });
        mo.observe(tbody, {childList:true, subtree:true, attributes:true, attributeFilter:['style','class','data-remaining']});
      }

      // Recompute on window resize since visibility may change
      window.addEventListener('resize', function(){ setTimeout(updateTotalFromVisible, 80); });
    }

    if(document.readyState === 'loading'){
      document.addEventListener('DOMContentLoaded', function(){ attachEvents(); updateTotalFromVisible(); });
    } else {
      attachEvents(); updateTotalFromVisible();
    }
  })();
</script>

<script>
  // Toggle 'Réglé' marker via AJAX using Etudiant.remarques (no DB changes)
  (function(){
    function getCookie(name) {
      var cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
          var cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    document.addEventListener('click', function(e){
      var btn = e.target.closest('.mark-paid-btn');
      if(!btn) return;
      e.preventDefault();
      var sid = btn.dataset.studentId;
      if(!sid) return;
      if(!confirm('Confirmer marquer cet étudiant comme réglé ?')) return;
      var url = '/etudiants/' + sid + '/toggle-paiement/';
      fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken') || getCookie('csrfmiddlewaretoken') || '',
          'Accept': 'application/json'
        }
      }).then(function(resp){ return resp.json(); }).then(function(data){
        if(data && data.ok){
          // update the UI: replace button by badge on success
          var badge = document.createElement('span');
          badge.className = 'balance-regle px-3 py-1 rounded-full text-xs font-semibold';
          badge.textContent = 'Réglé';
          try{ btn.parentNode.replaceChild(badge, btn); }catch(e){ btn.style.display='none'; }
          // also update any matching table/mobile row data attribute
          try{
            var tr = document.querySelector('[data-id="' + sid + '"]');
            if(tr) tr.dataset.remaining = '0';
          }catch(e){}
        } else {
          alert(data && data.error ? data.error : 'Erreur lors de la requête');
        }
      }).catch(function(err){ console.error('toggle-paiement error', err); alert('Erreur réseau'); });
    });
  })();
</script>

<script>
  // Client-side filtering for table + card views (ensures formation filter affects card/grid view)
  (function(){
    const sortFilter = document.getElementById('sortFilter');
    const formationFilter = document.getElementById('formationFilter');
    const statusFilter = document.getElementById('statusFilter');
    const niveauFilterVisible = document.getElementById('niveauFilterVisible');
    const searchInput = document.getElementById('searchInput');

    function getAllRows(){
      const rows = Array.from(document.querySelectorAll('#studentsTbody tr.student-row'));
      const cards = Array.from(document.querySelectorAll('#cardView .student-row'));
      return rows.concat(cards);
    }

    function matchesFormation(el){
      if(!formationFilter) return true;
      const selected = formationFilter && formationFilter.selectedOptions ? Array.from(formationFilter.selectedOptions).map(o=>o.value).filter(Boolean) : [];
      if(selected.length === 0) return true;
      const f = (el.dataset.formation || '').toString();
      const fText = (el.dataset.formationText || el.dataset.displayFormation || '').toString();
      for (let v of selected){
        if(!v) continue;
        if(f && String(f) === String(v)) return true;
        if(fText && String(fText) === String(v)) return true;
      }
      return false;
    }

    function matchesStatus(el){
      if(!statusFilter) return true;
      const val = (statusFilter.value || 'all');
      if(val === 'all') return true;
      const inscription = (el.dataset.inscription || el.dataset.status || '').toString().trim().toLowerCase();
      const verified = el.dataset.verify && String(el.dataset.verify) === '3';
      if(val === 'inscrit') return inscription === 'inscrit' || inscription === 'actif';
      if(val === 'non_inscrit') return !(inscription === 'inscrit' || inscription === 'actif');
      if(val === 'verifie') return !!verified;
      if(val === 'non_verifie') return !verified;
      return true;
    }

    function matchesNiveau(el){
      if(!niveauFilterVisible) return true;
      const val = (''+niveauFilterVisible.value).toLowerCase() || '';
      if(!val) return true;
      return (''+(el.dataset.niveau || '')).toLowerCase() === val;
    }

    function matchesSearch(el){
      if(!searchInput) return true;
      const q = (searchInput.value || '').toLowerCase().trim();
      if(!q) return true;
      const name = (el.dataset.name || '').toLowerCase();
      const phone = (el.dataset.phone || '').toLowerCase();
      const addr = (el.dataset.address || '').toLowerCase();
      return name.indexOf(q) !== -1 || phone.indexOf(q) !== -1 || addr.indexOf(q) !== -1;
    }

    function applyFilters(){
      const all = getAllRows();
      all.forEach(el => {
        const ok = matchesFormation(el) && matchesStatus(el) && matchesNiveau(el) && matchesSearch(el);
        el.style.display = ok ? '' : 'none';
      });
      // sort table rows only
      const table = document.getElementById('studentsTbody');
      if(table && sortFilter && typeof sortFilter.value !== 'undefined'){
        const key = sortFilter.value;
        const trs = Array.from(table.querySelectorAll('tr.student-row'));
        trs.sort((a,b)=>{
          if(key === 'alpha'){
            const an = (a.dataset.name||'').toLowerCase();
            const bn = (b.dataset.name||'').toLowerCase();
            return an.localeCompare(bn);
          }
          if(key === 'oldest') return Number(a.dataset.id||0) - Number(b.dataset.id||0);
          if(key === 'recent') return Number(b.dataset.id||0) - Number(a.dataset.id||0);
          return 0;
        });
        trs.forEach(r=> table.appendChild(r));
      }
      // update totals based on visible rows/cards
      try{ if(window.updateTotalFromVisible) window.updateTotalFromVisible(); }catch(e){}
    }

    if(sortFilter) sortFilter.addEventListener('change', applyFilters);
    if(formationFilter) formationFilter.addEventListener('change', applyFilters);
    if(statusFilter) statusFilter.addEventListener('change', applyFilters);
    if(niveauFilterVisible) niveauFilterVisible.addEventListener('change', applyFilters);
    if(searchInput) searchInput.addEventListener('input', function(){ setTimeout(applyFilters, 10); });

    // initial run
    setTimeout(applyFilters, 40);
  })();
</script>

{% endblock %}



