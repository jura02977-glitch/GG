{% extends 'base.html' %}
{% load static %}
{% block title %}Inscriptions - GénieSchool{% endblock %}
{% block content %}

<style>
  .btn-primary { background-color: var(--accent-2); color: white; }
  .btn-primary:hover { background-color: #15803d; }
  .btn-secondary { background-color: #e5e7eb; color: #374151; }
  .btn-secondary:hover { background-color: #d1d5db; }
  .status-inscrit { background-color: #dcfce7; color: #16a34a; }
  .status-autre { background-color: #fee2e2; color: #dc2626; }
  /* Search box styles - colorful & animated */
  .search-wrapper { position: relative; }
  /* outer glow border (animated via opacity) */
  /* neutral tones, keep animations */
  .search-wrapper::before{ content:''; position:absolute; inset: -4px; border-radius:14px; background: linear-gradient(90deg,#f3f4f6,#eef2f7); opacity:0; transition: opacity .18s ease, transform .18s ease; pointer-events:none; }
  .search-input { padding-left: 44px; padding-right: 44px; border-radius: 10px; border: 1px solid rgba(15,23,42,0.06); transition: box-shadow .18s ease, transform .12s ease, border-color .12s ease, background .18s ease; background: linear-gradient(180deg,#ffffff,#fbfdff); position:relative; z-index:1; }
  .search-input:focus{ outline: none; box-shadow: 0 14px 40px rgba(15,23,42,0.06); transform: translateY(-3px); border-color: transparent; }
  .search-wrapper.focused::before{ opacity:1; transform:translateY(-2px); }
  .search-icon{ position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#9ca3af; font-size:18px; pointer-events:none; z-index:2; }
  .search-wrapper.focused .search-icon{ color:#6b7280; transform:translateY(-50%) scale(1.02); }
  .ins-clear{ position:absolute; right:8px; top:50%; transform:translateY(-50%); background:transparent; border:none; font-size:20px; color:#6b7280; cursor:pointer; display:none; z-index:2; padding:6px; border-radius:999px; transition: transform .12s ease, opacity .12s ease; }
  .ins-clear.show{ display:block; opacity:1; }
  .ins-clear:active{ transform:scale(.92); }
  /* ripple for clear button */
  .ripple{ position:absolute; width:12px; height:12px; border-radius:50%; background:rgba(15,23,42,0.06); transform:scale(0); opacity:0.9; pointer-events:none; }
  /* subtle placeholder animation */
  .search-input::placeholder{ color:#9ca3af; transition: opacity .2s ease, transform .25s ease; }
  .search-wrapper.focused .search-input::placeholder{ opacity:0.7; transform:translateY(-1px); }

  /* Quick inscription button hover (pill) */
  #modalQuickInsBtn { transition: transform .12s ease, box-shadow .12s ease, filter .12s ease; }
  #modalQuickInsBtn:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(6,95,70,0.08); filter:brightness(0.98); }
  #modalQuickInsBtn:hover .material-icons { transform: translateY(-1px); color: #065f46; }

  /* Ensure decorative separators are visible when printing.
     Some designs use shadows, gradients or pseudo-elements that do not
     print by default — force a solid rule and visible diamond if present. */
  @media print {
    hr, .divider, .section-divider, .line-sep, .sep { display:block !important; height:1px !important; background:#222 !important; border:none !important; margin:12px 0 !important; }
    /* If the separator uses pseudo-elements (diamond or ornament), make sure they print */
    .divider::before, .divider::after,
    .section-divider::before, .section-divider::after,
    .sep::before, .sep::after { content: '' !important; display:inline-block !important; width:8px !important; height:8px !important; background:#222 !important; box-shadow:none !important; vertical-align:middle !important; margin:0 8px !important; }
    /* Defensive: remove box-shadows that may be invisible in print */
    .section-divider, .divider, .line-sep, .sep { box-shadow: none !important; background-image: none !important; }
  }
  
  /* Mobile Responsive Styles */
  @media (max-width: 640px) {
    main {
      padding: 1rem !important;
    }
    
    /* Header */
    header.flex {
      flex-direction: column !important;
      align-items: flex-start !important;
      gap: 1rem !important;
      margin-bottom: 1.5rem !important;
    }
    
    h1 {
      font-size: 1.75rem !important;
    }
    
    /* Search and filters */
    .search-wrapper {
      width: 100% !important;
      margin-bottom: 1rem !important;
    }
    
    .search-input {
      padding: 14px 44px !important;
      font-size: 16px !important; /* Prevent zoom on iOS */
    }
    
    /* Buttons */
    .btn-primary,
    .btn-secondary,
    #modalQuickInsBtn {
      width: 100% !important;
      padding: 14px 20px !important;
      font-size: 15px !important;
      border-radius: 12px !important;
      margin-bottom: 0.5rem !important;
    }
    
    /* Table adjustments */
    #tableView.table-polished {
      border-radius: 16px !important;
      overflow: hidden !important;
    }
    
    #tableView thead {
      display: none !important;
    }
    
    #inscriptionsTbody tr {
      display: block !important;
      margin-bottom: 16px !important;
      padding: 16px !important;
      border-radius: 16px !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08) !important;
      background: linear-gradient(135deg, rgba(16,185,129,0.03), rgba(5,150,105,0.03)) !important;
      border-left: 4px solid #10b981 !important;
      animation: inscriptionCardSlide 0.4s ease-out backwards;
    }
    
    @keyframes inscriptionCardSlide {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    /* Stagger animations */
    #inscriptionsTbody tr:nth-child(1) { animation-delay: 0.1s; }
    #inscriptionsTbody tr:nth-child(2) { animation-delay: 0.2s; }
    #inscriptionsTbody tr:nth-child(3) { animation-delay: 0.3s; }
    #inscriptionsTbody tr:nth-child(4) { animation-delay: 0.4s; }
    
    #inscriptionsTbody tr:hover {
      transform: translateY(-4px) !important;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12) !important;
    }
    
    #inscriptionsTbody td {
      display: flex !important;
      justify-content: space-between !important;
      padding: 12px 0 !important;
      border: none !important;
      align-items: center !important;
    }
    
    #inscriptionsTbody td::before {
      content: attr(data-label);
      font-weight: 700;
      color: #6b7280;
      margin-right: 12px;
      flex: 0 0 40%;
      font-size: 0.9rem;
    }
    
    /* Status badges */
    .status-inscrit,
    .status-autre {
      padding: 8px 12px !important;
      font-size: 0.85rem !important;
      border-radius: 12px !important;
    }
    
    /* Action buttons */
    .action-btn-group {
      flex-wrap: wrap !important;
      gap: 0.5rem !important;
      margin-top: 8px !important;
      padding-top: 12px !important;
      border-top: 1px solid rgba(0,0,0,0.06) !important;
    }
    
    /* Touch feedback */
    #inscriptionsTbody tr:active {
      transform: scale(0.98) !important;
    }
    
    /* Modal adjustments */
    .modal.card {
      width: 100% !important;
      max-width: 100% !important;
      margin: 0 !important;
      border-radius: 20px 20px 0 0 !important;
      max-height: 90vh !important;
      overflow-y: auto !important;
    }
    
    .modal-backdrop {
      align-items: flex-end !important;
      padding: 0 !important;
    }
  }
</style>

<main>
  <script src="{% static 'vendor/js/qrcode.min.js' %}"></script>
  <script>
    // Global helper to format a date-like string to DD/MM/YYYY
    window.fmtDateString = function(d){
      if(!d) return '';
      try{
        var s = String(d).trim();
        var m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
        if(m) return m[3] + '/' + m[2] + '/' + m[1];
        var m2 = s.match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{4})/);
        if(m2) return m2[1] + '/' + m2[2] + '/' + m2[3];
        var dt = new Date(s);
        if(isNaN(dt)) return s;
        var dd = String(dt.getDate()).padStart(2,'0');
        var mm = String(dt.getMonth()+1).padStart(2,'0');
        var yy = dt.getFullYear();
        return dd + '/' + mm + '/' + yy;
      }catch(e){ return String(d); }
    };
  </script>
  <style>
  /* Polished table header and row animations for inscriptions */
  #tableView.table-polished { border-radius: 12px; overflow: hidden; }
  /* increase header size slightly for readability */
  #tableView.table-polished thead th { background: linear-gradient(90deg,#eef2ff,#f0fdf4); color:#0f172a; border-bottom:0; font-size:15px; }
  #inscriptionsTbody tr { transition: transform .22s cubic-bezier(.2,.9,.25,1), box-shadow .22s ease, background-color .2s ease; }
  #inscriptionsTbody tr:hover { transform: translateY(-6px); box-shadow: 0 12px 30px rgba(2,6,23,0.06); background: linear-gradient(90deg, rgba(255,255,255,0.6), rgba(250,250,255,0.8)); }
  /* increase body text size and add a bit more vertical padding for clarity */
  #inscriptionsTbody td { transition: color .18s ease, background .18s ease; font-size:16px; line-height:1.4; padding-top:1rem; padding-bottom:1rem; }
  /* ensure cells and header reflect the larger font-size */
  #tableView td, #tableView th { font-size:16px; }

  /* Row animations removed per user request (new-row and updated-row) */

    /* Status badges: colorful and animated */
    .status-inscrit { background: linear-gradient(90deg,#d1fae5,#bbf7d0); color:#065f46; transition: transform .18s ease, box-shadow .18s ease; }
    .status-autre { background: linear-gradient(90deg,#fee2e2,#fed7d7); color:#991b1b; transition: transform .18s ease, box-shadow .18s ease; }
    .status-inscrit.pulse, .status-autre.pulse { transform: translateY(-2px) scale(1.02); box-shadow:0 10px 24px rgba(6,95,70,0.08); }

  /* Action buttons refinement: compact icon buttons */
  .action-icon-btn { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:8px; background:var(--action-icon-bg, #ffffff); border:1px solid rgba(15,23,42,0.04); cursor:pointer; transition: transform .12s ease, box-shadow .12s ease, background .12s ease; }
  .action-icon-btn .material-icons { font-size:18px; line-height:1; }
  .action-icon-btn + .action-icon-btn { margin-left:8px; }
  /* Keep action buttons on a single line even when zooming */
  .action-btn-group { display: inline-flex; align-items: center; gap: 8px; flex-wrap: nowrap; white-space: nowrap; }
  /* In case the table cell is too narrow, allow the group to overflow rather than wrap */
  td .action-btn-group { overflow: visible; }
  .action-print { color: #4f46e5; }
  .action-print:hover { background: rgba(79,70,229,0.06); box-shadow: 0 6px 18px rgba(79,70,229,0.06); transform: translateY(-2px); }
  .action-view { color: #059669; }
  .action-view:hover { background: rgba(5,150,105,0.06); box-shadow: 0 6px 18px rgba(5,150,105,0.06); transform: translateY(-2px); }
  .action-delete { color: #dc2626; }
  .action-delete:hover { background: rgba(220,38,38,0.06); box-shadow: 0 6px 18px rgba(220,38,38,0.06); transform: translateY(-2px); }

    /* Subtle zebra for large lists */
    #inscriptionsTbody tr:nth-child(odd) td { background: rgba(250,250,255,0.02); }
  </style>
  <style>
    /* Large decorative count for inscriptions */
    .ins-count-decor { display:inline-flex; align-items:center; }
    .ins-count-decor-badge { background: linear-gradient(90deg,#fff,#f8fafc); padding:8px 14px; border-radius:12px; display:flex; align-items:center; gap:12px; box-shadow: 0 8px 24px rgba(2,6,23,0.06); border:1px solid rgba(15,23,42,0.04); }
    .ins-count-number { font-size:28px; font-weight:800; color:#0f172a; letter-spacing:-0.02em; }
    .ins-count-sub { font-size:14px; font-weight:700; color:#475569; text-transform:lowercase; }
    @media (max-width:640px){ .ins-count-number{ font-size:20px; } .ins-count-sub{ font-size:12px; } }
  </style>
    <style>
      /* School badge decorations */
      .ecole-badge { display:inline-flex; align-items:center; gap:8px; padding:6px 8px; border-radius:999px; font-weight:600; font-size:0.9rem; }
      .ecole-dot { width:10px; height:10px; border-radius:50%; box-shadow: 0 2px 6px rgba(2,6,23,0.12); }
      /* subtle hover accent on the row when it contains a known school */
      #inscriptionsTbody tr.ecole-known:hover { box-shadow: 0 10px 30px rgba(2,6,23,0.06); transform: translateY(-4px); }
    </style>
  <style>
    /* Hide the old inline detail copies when printing to avoid duplication; photo bottom summary will be printed */
    @media print {
      #insViewFormation { display:none !important; }
      /* the photo-bottom summary is placed near the photo and will be printed */
      .ins-photo-bottom { background: transparent !important; box-shadow: none !important; }
    }
    /* On screen, keep the detail formation hidden (we use photo-bottom) to avoid duplicate visual info */
    #insViewFormation { display:none; }
  </style>
  <header class="flex justify-between items-center mb-8">
    <div class="flex items-baseline gap-4">
      <h1 class="text-4xl font-bold text-gray-800">Inscriptions</h1>
      <div id="insCount" class="ins-count-decor" aria-live="polite">
        <div class="ins-count-decor-badge">
          <div class="ins-count-number">0</div>
          <div class="ins-count-sub">inscriptions</div>
        </div>
      </div>
      <!-- removed: total 'DA à payer' badge as requested -->
    </div>
    <div class="flex space-x-4">  
      <button id="openAddInsBtn" class="btn-primary py-2 px-4 rounded-lg flex items-center font-semibold"><span class="material-icons mr-2">add</span>Nouvelle inscriptions</button>
      <button id="exportCsvBtn" class="py-2 px-4 rounded-lg border bg-white flex items-center" title="Exporter CSV"><span class="material-icons mr-2">file_download</span>Exporter</button>
      <button id="exportPdfBtn" class="py-2 px-4 rounded-lg border bg-white flex items-center" title="Exporter PDF"><span class="material-icons mr-2">picture_as_pdf</span>PDF</button>
    </div>
  </header>

  <!-- Read-only Inscription Fiche Modal (informative display elements) -->
  <div id="insViewModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop ins-view-modal">
    <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-4xl p-0 ins-print-card" style="max-height:80vh; overflow:hidden;">
      <div class="ins-view-wrapper" style="display:flex; height:100%; min-height:360px;">
        <div class="ins-view-photo-col" style="flex:0 0 132px; background:#f8fafb; display:flex; flex-direction:column; align-items:center; padding:12px; overflow:hidden; border-top-left-radius:8px; border-bottom-left-radius:8px; height:100%; box-sizing:border-box;">
          <div class="ins-photo-frame" style="width:132px; height:170px; overflow:hidden; border-radius:6px; background:#fff; display:flex; align-items:center; justify-content:center;">
            <img id="insViewPhoto" src="{% static 'images/happy.gif' %}" style="width:100%; height:100%; object-fit:cover; display:block; border-radius:6px;" class="shadow-md cursor-pointer" />
          </div>
          <!-- photo-bottom summary placed in normal flow and pushed to the bottom of the column -->
          <div class="ins-photo-bottom" style="width:132px; margin-top:auto; margin-bottom:6px; background:rgba(255,255,255,0.95); padding:8px; border-radius:6px; box-shadow:0 8px 20px rgba(2,6,23,0.06); font-size:13px;">
            <div style="font-size:11px;color:#6b7280;margin-bottom:4px;">E-mail</div>
            <div id="insViewPhotoBottomEmail" style="font-weight:600;color:#0f172a;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;">—</div>
            <div style="height:6px"></div>
            <div style="font-size:11px;color:#6b7280;margin-bottom:4px;">Formations</div>
            <div id="insViewPhotoBottomFormation" style="font-weight:600;color:#0f172a;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;">—</div>
            <div style="height:6px"></div>
            <div style="font-size:11px;color:#6b7280;margin-bottom:4px;">Adresse</div>
            <div id="insViewPhotoBottomAddress" style="font-weight:600;color:#0f172a;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;">—</div>
          </div>
        </div>
        <div class="ins-view-details" style="flex:1 1 auto; padding:20px 24px; overflow:auto;">
          <div class="flex justify-between items-start">
            <h2 class="text-2xl font-semibold text-gray-800">Fiche d'inscription</h2>
            <button id="closeInsView" class="text-gray-500 hover:text-gray-700 text-2xl leading-none">&times;</button>
          </div>
          <div class="mt-4">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <div class="text-xs text-gray-500">Étudiant</div>
                <div id="insViewEtudiant" class="font-semibold text-gray-800"></div>
              </div>
              <div>
                <div class="text-xs text-gray-500">Téléphone</div>
                <div id="insViewPhone" class="text-gray-700"></div>
              </div>
              <div>
                <div class="text-xs text-gray-500">Date</div>
                <div id="insViewDate" class="text-gray-700"></div>
              </div>
              <div>
                <div class="text-xs text-gray-500">Groupe</div>
                <div id="insViewGroupe" class="text-gray-700"></div>
              </div>
              <!-- Email / Formation / Adresse moved to the photo column for print/layout reasons -->
              <div class="col-span-2">
                <div class="text-xs text-gray-500">Formateur</div>
                <div id="insViewFormateur" class="text-gray-700"></div>
              </div>
              <div class="col-span-2">
                <div class="text-xs text-gray-500">Remarques</div>
                <div id="insViewRemarques" class="text-gray-700 whitespace-pre-wrap"></div>
              </div>
            </div>
          </div>
          <div class="mt-6 flex justify-end">
            <button id="insViewCloseBtn" class="btn-secondary py-2 px-4 rounded">Fermer</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Print tweaks for the inscription fiche: widen the photo and fields so printed page
       doesn't show extra left whitespace. Scoped to this template. */
    @media print {
    .ins-print-card { width: 100% !important; max-width: 100% !important; margin: 0 !important; border-radius: 0 !important; box-shadow: none !important; }
      /* Fix the photo column to the exact printed photo size so the left column
         doesn't occupy a large percentage of the page when printing. */
    .ins-view-photo-col { flex: 0 0 132px !important; min-width: 132px !important; width: 132px !important; height: 170px !important; display:flex !important; flex-direction:column !important; align-items:center !important; justify-content:flex-start !important; overflow:hidden !important; }
      .ins-view-details { flex: 1 1 auto !important; padding: 12px !important; }
      /* Force the image itself to the exact target size and center it. Use
         !important so inline styles won't override when printing. */
  img#insViewPhoto { width: 132px !important; height: 170px !important; max-width:132px !important; max-height:170px !important; object-fit: cover !important; display:block !important; margin:0 !important; }
  .ins-photo-bottom { background: transparent !important; box-shadow: none !important; }
      body > :not(.ins-view-modal) { display: none !important; }
      .ins-view-modal, .ins-print-card { display: block !important; }
      html, body { background: #fff !important; }
      * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        /* Move email and formation slightly left so they sit visually under the photo bottom */
        .ins-field-email, .ins-field-formation { display:block !important; margin-left: -8px !important; }
    }
      /* Screen adjustments: nudge left slightly and vertically align under photo bottom */
      .ins-field-email, .ins-field-formation { margin-left: -8px; }
      /* For smaller cards, reduce the offset to avoid overlap */
      @media (max-width: 640px) {
        .ins-field-email, .ins-field-formation { margin-left: -4px; }
      }
  </style>

  <!-- Filters: search, date type (today/week/month), groupe -->
  <div class="flex items-center justify-between mb-4">
    <div class="search-wrapper w-1/3">
      <span class="material-icons search-icon">search</span>
      <input id="insSearch" type="text" placeholder="Rechercher une inscription..." class="search-input w-full shadow-sm py-2" />
      <button id="insClearBtn" class="ins-clear" title="Effacer">&times;</button>
    </div>
    <div class="flex items-center space-x-3">
      <!-- Formation filter inserted before other filters -->
      <select id="insFormationFilter" class="rounded-lg border-gray-300 px-3 py-2">
        <option value="">Toutes les formations</option>
        {% for f in formations %}
          <option value="{{ f.nom }}">{{ f.nom }}</option>
        {% endfor %}
      </select>

      <select id="insEcoleFilter" class="rounded-lg border-gray-300 px-3 py-2">
        <option value="">Toutes les écoles</option>
        <option value="Genie Systeme">Genie Systeme</option>
        <option value="Pixel School">Pixel School</option>
        <option value="Jura School">Jura School</option>
      </select>
      <select id="insSoldeFilter" class="rounded-lg border-gray-300 px-3 py-2">
        <option value="">Tous les soldes</option>
        <option value="negatif">Solde négatif (à payer)</option>
        <option value="regle">Réglé (0)</option>
        <option value="positif">Solde positif (crédit)</option>
      </select>
      <select id="insDateType" class="rounded-lg border-gray-300 px-3 py-2">
        <option value="">Toutes les dates</option>
        <option value="today">Ce jour</option>
        <option value="this_week">Cette semaine</option>
        <option value="this_month">Ce mois</option>
      </select>
      <select id="insGroupeFilter" class="rounded-lg border-gray-300 px-3 py-2">
        <option value="">Tous les groupes</option>
        {% for g in groupe_options %}
        <option value="{{ g }}">{{ g }}</option>
        {% endfor %}
      </select>
    </div>
  </div>





  <div id="tableView" class="overflow-x-auto bg-white rounded-xl shadow">
    <table class="min-w-full text-sm text-left text-gray-700">
      <thead class="bg-gray-100 text-gray-600 uppercase text-xs font-semibold">
        <tr>
          <th class="px-6 py-3">Étudiant</th>
          <th class="px-6 py-3">Téléphone</th>
          <th class="px-6 py-3">Formation</th>
          <th class="px-6 py-3">Groupe</th>
          <th class="px-6 py-3">Date</th>
          <th class="px-6 py-3">Formateur</th>
          <th class="px-6 py-3">École</th>
          <th class="px-6 py-3 text-right">Actions</th>
        </tr>
      </thead>
      <tbody id="inscriptionsTbody">
  {% for ins in inscriptions %}
  <tr data-id="{{ ins.id }}" data-etudiant-id="{{ ins.etudiant.id }}" data-etudiant-name="{{ ins.etudiant.nom }} {{ ins.etudiant.prenom }}" data-etudiant-email="{{ ins.etudiant.email }}" data-etudiant-phone="{{ ins.etudiant.telephone }}" data-formation="{{ ins.formation.nom }}" data-formation-id="{{ ins.formation.id }}" data-statut="{{ ins.statut }}" data-groupe-id="{{ ins.groupe.id|default:'' }}" data-groupe="{{ ins.groupe.nom|default:ins.groupe|default:'' }}" data-date="{{ ins.date_inscription|date:'Y-m-d' }}" data-formateur-name="{{ ins.formateur_name|default:'' }}" data-formateur-id="{{ ins.formateur_id|default:'' }}" data-prix-total="{{ ins.prix_total|default:'' }}" data-remarques="{{ ins.remarques|default:''|escape }}" data-photo="{% if ins.etudiant.photo %}{{ ins.etudiant.photo }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" data-date_naissance="{{ ins.etudiant.date_naissance|default:'' }}" data-lieu_naissance="{{ ins.etudiant.lieu_naissance|default:'' }}" data-situation="{% if ins.etudiant.situation %}{{ ins.etudiant.situation }}{% else %}{{ ins.etudiant.situation_professionnelle|default:'' }}{% endif %}" data-nin="{{ ins.etudiant.nin|default:'' }}" data-address="{{ ins.etudiant.adresse|default:'' }}" data-nom_ar="{{ ins.etudiant.nom_arabe|default:'' }}" data-prenom_ar="{{ ins.etudiant.prenom_arabe|default:'' }}" data-ecole="{{ ins.ecole|default:'' }}" data-remaining="{{ ins.remaining_fees|default:'0' }}">
    <td class="px-6 py-4 font-semibold">{{ ins.etudiant.nom }} {{ ins.etudiant.prenom }}</td>
    <td class="px-6 py-4">{{ ins.etudiant.telephone }}</td>
    <td class="px-6 py-4">{{ ins.formation.nom }}</td>
    <td class="px-6 py-4">{{ ins.groupe|default:'' }}</td>
  <td class="px-6 py-4">{% if ins.date_inscription %}{{ ins.date_inscription|date:"d/m/Y" }}{% else %}&ndash;{% endif %}</td>
    <td class="px-6 py-4">{% if ins.formateur_name %}{{ ins.formateur_name }}{% else %}{{ ins.etudiant.email }}{% endif %}</td>
  <td class="px-6 py-4">{{ ins.ecole|default:'-' }}</td>
    <td class="px-6 py-4 text-right">
            <div class="action-btn-group">
              <button class="action-icon-btn action-print ins-print-btn" data-id="{{ ins.id }}" title="Imprimer" aria-label="Imprimer">
                <span class="material-icons">print</span>
              </button>
              <button class="action-icon-btn action-delete delete-ins-btn delete-btn icon-btn" data-id="{{ ins.id }}" title="Supprimer" aria-label="Supprimer">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12z" fill="#ef4444"/><path d="M19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="#ef4444"/></svg>
              </button>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Aucune inscription.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <style>
    /* Modern badge for live final price in the add-inscription modal */
    .prix-final-live { background: linear-gradient(90deg,#f0fdf4,#ecfeff); padding:8px 12px; border-radius:10px; box-shadow: 0 8px 20px rgba(2,6,23,0.06); border:1px solid rgba(6,95,70,0.08); }
    .prix-final-value { font-size:20px; color:#059669; font-weight:800; letter-spacing:-0.01em; }
    .prix-final-label { font-size:12px; color:#6b7280; font-weight:700; text-transform:uppercase; letter-spacing:0.02em; }
    .prix-final-currency { font-size:12px; color:#6b7280; }
    @media (max-width:640px){ .prix-final-live{ display:inline-flex; } .prix-final-label{ display:none; } }
  </style>

  <!-- Add Inscription Modal (simple & elegant) -->
  <div id="addInsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop" aria-hidden="true">
    <div class="w-full max-w-2xl mx-4" style="max-height:90vh;">
      <div class="bg-white rounded-xl shadow-xl overflow-hidden" role="dialog" aria-modal="true" aria-labelledby="addInsTitle" style="display:flex; flex-direction:column; max-height:90vh;">
        <div class="px-6 py-4 bg-white border-b">
          <div class="flex items-center justify-between">
            <div>
              <h3 id="addInsTitle" class="text-lg font-semibold text-gray-800">Nouvelle inscription</h3>
              <p class="text-sm text-gray-500">Complétez les informations ci-dessous</p>
            </div>
            <button type="button" onclick="closeAddInsModal()" aria-label="Fermer" class="text-gray-400 hover:text-gray-600">✕</button>
          </div>
        </div>
  <form id="addInsForm" class="p-6 grid grid-cols-1 gap-4 sm:grid-cols-2" novalidate style="overflow:auto;">
          {% csrf_token %}

          <div class="sm:col-span-2">
            <label class="block text-sm font-medium text-gray-700">Étudiant (taper ou sélectionner)</label>
            <div class="relative mt-2">
              <input id="studentComboInput" type="text" placeholder="Nom, email ou id" class="w-full border rounded-md px-3 py-2 focus:ring-1 focus:ring-green-400" autocomplete="off" />
              <input type="hidden" name="etudiant" id="studentComboValue" />
              <div id="studentComboList" class="absolute left-0 right-0 mt-1 bg-white rounded-md shadow max-h-56 overflow-auto hidden z-50" style="min-width:220px;">
                {% for s in students %}
                <div class="combo-item flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer" data-id="{{ s.id }}" data-name="{{ s.nom }} {{ s.prenom }}" data-photo="{% if s.photo_url %}{{ s.photo_url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}">
                  <img src="{% if s.photo_url %}{{ s.photo_url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" class="w-10 h-10 rounded-full mr-3 object-cover"/>
                  <div class="text-sm">
                    <div class="font-medium text-gray-800">{{ s.nom }} {{ s.prenom }}</div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Formation</label>
            <select name="formation" class="mt-2 block w-full border rounded-md px-3 py-2 focus:ring-1 focus:ring-green-400" required>
              <option value="">-- Choisir formation --</option>
              {% for f in formations %}
                <option value="{{ f.id }}">{{ f.nom }}</option>
              {% endfor %}
            </select>
          </div>

            <div id="formationPriceBlock">
              <label class="block text-sm font-medium text-gray-700">Prix formation (DA)</label>
              <div class="mt-2 flex items-center justify-between gap-4">
                <div id="prixFinalLive" class="prix-final-live inline-flex items-baseline gap-3">
                  <span class="prix-final-label">Prix final</span>
                  <span id="prixFinalDisplay" class="prix-final-value">-</span>
                  <span class="prix-final-currency">DA</span>
                </div>
                <div id="formationPriceDisplay" class="font-semibold text-gray-800 text-sm">-</div>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">Réduction</label>
              <div class="mt-2 flex items-center gap-2 flex-wrap">
                <select id="remiseType" name="remise_type" class="border rounded-md px-2 py-1">
                  <option value="none">Aucune</option>
                  <option value="amount">Montant (DA)</option>
                  <option value="percent">Pourcentage (%)</option>
                </select>
                <input id="remiseValue" name="remise_value" type="number" step="0.01" min="0" placeholder="0.00" class="border rounded-md px-3 py-2" style="width:140px; min-width:120px;" />
              </div>
              <input type="hidden" name="prix_total" id="prixTotalHidden" />
            </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Session</label>
            <select name="session" id="addInsSessionSelect" class="mt-2 block w-full border rounded-md px-3 py-2 focus:ring-1 focus:ring-green-400" required>
              <option value="session normale">Session normale</option>
              <option value="session estivale">Session estivale</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Date d'inscription</label>
            <input type="date" name="date_inscription" id="addDateIns" class="mt-2 block w-full border rounded-md px-3 py-2 focus:ring-1 focus:ring-green-400" />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Groupe</label>
            <select name="groupe" id="addInsGroupeSelect" class="mt-2 block w-full border rounded-md px-3 py-2 focus:ring-1 focus:ring-green-400" required>
              <option value="">-- Choisir formation d'abord --</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">Formateur (optionnel)</label>
            <select name="formateur" class="mt-2 block w-full border rounded-md px-3 py-2 focus:ring-1 focus:ring-green-400">
              <option value="">-- Aucun --</option>
              {% for fo in formateurs %}
                <option value="{{ fo.id }}">{{ fo.prenom }} {{ fo.nom }}</option>
              {% endfor %}
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">École</label>
            <select name="ecole" id="addInsEcole" class="mt-2 block w-full border rounded-md px-3 py-2 focus:ring-1 focus:ring-green-400">
              <option value="">-- Choisir école --</option>
              <option value="Genie Systeme">Genie Systeme</option>
              <option value="Pixel School">Pixel School</option>
              <option value="Jura School">Jura School</option>
            </select>
          </div>

          <div class="sm:col-span-2 flex items-center justify-between pt-4 border-t" style="position:sticky; bottom:0; background:linear-gradient(rgba(255,255,255,0.96), rgba(255,255,255,1)); padding-top:12px; z-index:50;">
            <a href="{% url 'etudiants' %}?open_add_student=1" id="modalQuickInsBtn" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-sm font-medium shadow-sm" style="background:linear-gradient(90deg,#ecfccb,#bbf7d0); color:#065f46; border:1px solid rgba(6,95,70,0.08);">
              <span class="inline-flex w-6 h-6 items-center justify-center rounded-full bg-white/70 text-green-700 drop-shadow-sm"><span class="material-icons" style="font-size:16px;">bolt</span></span>
              Inscription rapide
            </a>
            <div class="flex gap-3 items-center">
              <div class="flex items-center gap-2">
                <input type="checkbox" id="addins_followup" name="followup" />
                <label for="addins_followup" class="text-sm">Inscription suivante</label>
              </div>
              <div>
                <button type="button" onclick="closeAddInsModal()" class="px-4 py-2 bg-gray-100 rounded-md">Annuler</button>
                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md">Enregistrer</button>
              </div>
            </div>
          </div>

        </form>
      </div>
    </div>
  </div>

  <!-- Edit Inscription Modal (separate from add modal) -->
  <div id="editInsModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop" aria-hidden="true">
    <div class="w-full max-w-2xl mx-4">
      <div class="bg-white rounded-xl shadow-xl overflow-hidden" role="dialog" aria-modal="true" aria-labelledby="editInsTitle">
        <div class="px-6 py-4 bg-white border-b">
          <div class="flex items-center justify-between">
            <div>
              <h3 id="editInsTitle" class="text-lg font-semibold text-gray-800">Modifier inscription</h3>
              <p class="text-sm text-gray-500">Mettez à jour les informations puis cliquez sur Enregistrer</p>
            </div>
            <button type="button" onclick="closeEditInsModal()" aria-label="Fermer" class="text-gray-400 hover:text-gray-600">✕</button>
          </div>
        </div>
        <form id="editInsForm" class="p-6 grid grid-cols-1 gap-4 sm:grid-cols-2" novalidate>
          {% csrf_token %}
          <input type="hidden" name="id" id="editInsId" />
          <input type="hidden" name="etudiant" id="editEtudiantId" />
          <div class="sm:col-span-2">
            <label class="block text-sm font-medium text-gray-700">Étudiant</label>
            <div id="editEtudiantDisplay" class="mt-2 text-gray-800 font-semibold">—</div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Formation</label>
            <select name="formation" id="editFormation" class="mt-2 block w-full border rounded-md px-3 py-2 focus:ring-1 focus:ring-green-400" required>
              <option value="">-- Choisir formation --</option>
              {% for f in formations %}
                <option value="{{ f.id }}">{{ f.nom }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Session</label>
            <select name="session" id="editSession" class="mt-2 block w-full border rounded-md px-3 py-2 focus:ring-1 focus:ring-green-400">
              <option value="session normale">Session normale</option>
              <option value="session estivale">Session estivale</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Groupe</label>
            <select name="groupe" id="editGroupeSelect" class="mt-2 block w-full border rounded-md px-3 py-2 focus:ring-1 focus:ring-green-400">
              <option value="">-- Choisir formation d'abord --</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Formateur</label>
            <select name="formateur" id="editFormateur" class="mt-2 block w-full border rounded-md px-3 py-2 focus:ring-1 focus:ring-green-400">
              <option value="">-- Aucun --</option>
              {% for fo in formateurs %}
                <option value="{{ fo.id }}">{{ fo.prenom }} {{ fo.nom }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Date d'inscription</label>
            <input type="date" name="date_inscription" id="editDateIns" class="mt-2 block w-full border rounded-md px-3 py-2 focus:ring-1 focus:ring-green-400" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">École</label>
            <select name="ecole" id="editEcole" class="mt-2 block w-full border rounded-md px-3 py-2 focus:ring-1 focus:ring-green-400">
              <option value="">-- Choisir école --</option>
              <option value="Genie Systeme">Genie Systeme</option>
              <option value="Pixel School">Pixel School</option>
              <option value="Jura School">Jura School</option>
            </select>
          </div>
          <div class="sm:col-span-2 flex items-center justify-end pt-4 border-t">
            <div style="display:flex;align-items:center;gap:12px;width:100%;justify-content:center;">
              <div style="flex:0 0 auto;">
                <button type="button" onclick="closeEditInsModal()" class="px-4 py-2 bg-gray-100 rounded-md">Annuler</button>
                <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md">Enregistrer</button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Inline Add Student Modal (copied from etudiants.html to match exact UI) -->
  <div id="addStudentModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full" style="max-width:980px; width:calc(100% - 48px); max-height:95vh; overflow:hidden; display:flex; flex-direction:column; font-family: 'Roboto', Roboto, system-ui, -apple-system, 'Segoe UI', sans-serif;">
        <h1 class="text-2xl font-bold text-center mb-4">Etudiant</h1>
        <form id="addStudentInlineForm" enctype="multipart/form-data" style="display:flex;flex-direction:column;flex:1 1 auto;overflow:auto;padding-bottom:12px;">
          {% csrf_token %}
          <div style="display:grid;grid-template-columns:14rem 1fr;grid-template-rows:auto auto auto auto;gap:1rem;align-items:start;">
            <div style="grid-row:1 / span 4; display:flex;flex-direction:column;align-items:center;justify-content:flex-start;">
              <label for="photoInput" style="width:14rem;height:14rem;border-radius:9999px;border:2px dashed #d1d5db;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f8fafb;margin-bottom:0.75rem;cursor:pointer;overflow:hidden;">
                <svg aria-hidden="true" focusable="false" width="72" height="72" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color:#4b5563">
                  <circle cx="12" cy="8" r="3.6" fill="#E6EEF3" stroke="#CBD5E1"></circle>
                  <path d="M4 20c0-3.3 3.6-6 8-6s8 2.7 8 6" fill="#F8FAFB" stroke="#CBD5E1"></path>
                </svg>
                <p class="text-sm text-gray-500 mt-2" style="margin:0">Photo</p>
                <p class="text-xs text-gray-400" style="margin:0">PNG, JPG</p>
              </label>
              <input id="photoInput" type="file" name="photo" accept="image/*" class="hidden" />
            </div>
            <div style="grid-column:2;grid-row:1 / span 2;display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;">
              <div>
                <label class="block text-sm font-medium text-gray-700" for="nom">Nom</label>
                <input name="nom" id="nom" required style="font-size:15px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Entrez votre nom" type="text" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 text-right" for="nom_ar">اللقب</label>
                <input name="nom_arabe" id="nom_ar" dir="rtl" class="mt-1 block w-full ml-auto px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" type="text" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700" for="prenom">Prénom</label>
                <input name="prenom" id="prenom" required style="font-size:15px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Entrez votre prénom" type="text" />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 text-right" for="prenom_ar">الاسم</label>
                <input name="prenom_arabe" id="prenom_ar" dir="rtl" class="mt-1 block w-full ml-auto px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" type="text" />
              </div>
            </div>
            <div style="grid-column:2;grid-row:4;">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2 items-center">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="genre">Genre</label>
                  <div class="relative mt-1">
                    <select name="genre" id="genre" style="font-size:15px" class="block w-full appearance-none px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                      <option value="">-- Sexe --</option>
                      <option value="M">Masculin</option>
                      <option value="F">Féminin</option>
                    </select>
                    <!-- decorative arrow removed to avoid duplication with native select arrow -->
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="lieu_naissance">Lieu de Naissance</label>
                  <input name="lieu_naissance" id="lieu_naissance" style="font-size:15px" class="block w-full mt-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Entrez lieu de naissance" type="text" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1" for="date_naissance">Date de Naissance</label>
                  <input name="date_naissance" id="date_naissance" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="JJ/MM/AAAA" type="date" />
                </div>
              </div>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div class="md:col-span-1">
                <label class="block text-sm font-medium text-gray-700" for="nin">NIN</label>
              <input name="nin" id="nin" style="font-size:15px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Ex: 123456789" type="text" />
                  <div id="ninErrorAdd" class="text-sm text-red-600 mt-1 hidden" role="alert" aria-live="polite">
                    <span class="material-icons" style="font-size:16px;vertical-align:middle;margin-right:6px;">error_outline</span>
                    <span id="ninErrorAddMsg"></span>
                  </div>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700" for="nationalite">Nationalité</label>
              <input name="nationalite" id="nationalite" style="font-size:15px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Entrez nationalité" type="text" />
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div>
              <label class="block text-sm font-medium text-gray-700" for="telephone">Téléphone</label>
              <input name="telephone" id="telephone" style="font-size:15px" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="+33 6 12 34 56 78" type="tel" />
              <div id="telErrorAdd" class="text-sm text-red-600 mt-1 hidden" role="alert" aria-live="polite">
                <span class="material-icons" style="font-size:16px;vertical-align:middle;margin-right:6px;">error_outline</span>
                <span id="telErrorAddMsg"></span>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700" for="email">Email</label>
              <input name="email" id="email" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="nom.prenom@email.com" type="email" />
            </div>
            <div x-data="{ social: '', profile: '' }">
              <label class="block text-sm font-medium text-gray-700" for="social_network">Réseaux sociaux</label>
              <div class="relative mt-1 w-full">
                <select name="social_network" id="social_network" x-model="social" class="block w-full appearance-none px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                  <option value="">Sélectionnez</option>
                  <option value="instagram">Instagram</option>
                  <option value="facebook">Facebook</option>
                  <option value="whatsapp">WhatsApp</option>
                  <option value="telegram">Telegram</option>
                </select>
                <!-- removed duplicate visual arrow; native select arrow retained -->
              </div>
              <div class="mt-2 w-full" x-show="social">
                <input name="social_profile" id="social_profile" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Nom du profil" type="text" x-model="profile" />
              </div>
            </div>
          </div>
          <!-- Ligne ajoutée : niveau d'etude, situation et dernier diplome -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
            <div>
              <label class="block text-sm font-medium text-gray-700" for="niveau_etude">Niveau d'étude</label>
              <select name="niveau_etude" id="niveau_etude" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                <option value="">Sélectionnez</option>
                <option value="terminal">Terminal</option>
                <option value="universitaire">Universitaire</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700" for="situation">Situation</label>
              <select name="situation" id="situation" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                <option value="">Sélectionnez</option>
                <option value="fonctionnaire">Fonctionnaire</option>
                <option value="etudiant">Etudiant</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700" for="dernier_diplome">Dernier diplôme</label>
              <select name="dernier_diplome" id="dernier_diplome" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm">
                <option value="">Sélectionnez</option>
                <option value="bac">Bac</option>
                <option value="licence">Licence</option>
                <option value="master">Master</option>
                <option value="doctorat">Doctorat</option>
              </select>
            </div>
          </div>

          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700" for="adresse">Adresse</label>
            <input name="adresse" id="adresse" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="123 Rue de l'Exemple, 75001 Paris" type="text" />
          </div>
          <div class="mt-4 mb-8">
            <label class="block text-sm font-medium text-gray-700" for="infos_supplementaires">Infos supplémentaires</label>
            <textarea name="infos_supplementaires" id="infos_supplementaires" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm" placeholder="Allergies, conditions médicales, etc." rows="2"></textarea>
          </div>
          <div style="position:sticky;bottom:0;background:linear-gradient(rgba(255,255,255,0.9), rgba(255,255,255,1));padding-top:10px;margin-top:6px;border-top:1px solid #eef2f7;" class="flex justify-between items-center">
            <button type="button" onclick="hideAddStudentModal()" class="modal-action-btn secondary">Annuler</button>
            <button type="submit" class="modal-action-btn primary">Valider</button>
          </div>
        </form>
    <style>
      .modal-action-btn{
        padding: .7rem 1.4rem !important;
        font-size:15px !important;
        border-radius:8px !important;
        transition: transform .14s ease, box-shadow .14s ease, background .14s ease;
        cursor: pointer;
        min-width:160px;
      }
      .modal-action-btn.primary{ background: #10b981; color:#fff; border: 1px solid rgba(0,0,0,0.04); }
      .modal-action-btn.primary:hover{ background: linear-gradient(90deg,#059669,#10b981); transform: translateY(-3px); box-shadow: 0 10px 30px rgba(6,95,70,0.12); }
      .modal-action-btn.secondary{ background: #fff; color:#374151; border: 1px solid #d1d5db; }
      .modal-action-btn.secondary:hover{ background: linear-gradient(90deg,#f87171,#ef4444); color:#fff; transform: translateY(-2px); box-shadow: 0 8px 22px rgba(239,68,68,0.12); border-color: rgba(0,0,0,0.06); }
      @media (max-width: 640px){
        .modal-action-btn{ min-width:140px; width:140px; }
      }
    </style>
    <datalist id="nationalite_list">
      <option value="Afghan"></option>
      <option value="Albanais"></option>
  <option value="Algérien"></option>
  <option value="Allemand"></option>
  <option value="Américain"></option>
      <option value="Andorran"></option>
      <option value="Angolais"></option>
      <option value="Antiguais-et-Barbudien"></option>
      <option value="Saoudien"></option>
      <option value="Argentin"></option>
  <option value="Arménien"></option>
      <option value="Australien"></option>
      <option value="Autrichien"></option>
  <option value="Azerbaïdjanais"></option>
  <option value="Bahaméen"></option>
  <option value="Bahreïni"></option>
      <option value="Bangladais"></option>
      <option value="Barbadien"></option>
      <option value="Belge"></option>
  <option value="Bélizien"></option>
  <option value="Béninois"></option>
      <option value="Bhoutanais"></option>
  <option value="Biélorusse"></option>
      <option value="Birman"></option>
      <option value="Bolivien"></option>
  <option value="Bosnien-Herzégovinien"></option>
      <option value="Botswanais"></option>
  <option value="Brésilien"></option>
      <option value="Britannique"></option>
  <option value="Brunéien"></option>
      <option value="Bulgare"></option>
  <option value="Burkinabè"></option>
      <option value="Burundais"></option>
      <option value="Cambodgien"></option>
      <option value="Camerounais"></option>
      <option value="Canadien"></option>
      <option value="Cap-Verdien"></option>
      <option value="Centrafricain"></option>
      <option value="Chilien"></option>
      <option value="Chinois"></option>
      <option value="Chypriote"></option>
      <option value="Colombien"></option>
      <option value="Comorien"></option>
      <option value="Congolais"></option>
      <option value="Costaricien"></option>
      <option value="Croate"></option>
      <option value="Cubain"></option>
      <option value="Danois"></option>
      <option value="Djiboutien"></option>
      <option value="Dominicain"></option>
      <option value="Dominiquais"></option>
  <option value="Égyptien"></option>
  <option value="Émirien"></option>
  <option value="Équatorien"></option>
  <option value="Érythréen"></option>
      <option value="Espagnol"></option>
      <option value="Estonien"></option>
      <option value="Eswatini"></option>
  <option value="Éthiopien"></option>
      <option value="Fidjien"></option>
      <option value="Finlandais"></option>
  <option value="Français"></option>
      <option>Gabonais</option>
      <option>Gambien</option>
  <option>Géorgien</option>
  <option>Ghanéen</option>
      <option>Grec</option>
      <option>Grenadien</option>
      <option>Guat\u00e9malt\u00e8que</option>
      <option>Guin\u00e9en</option>
      <option>Bissau-Guin\u00e9en</option>
      <option>\u00c9quato-Guin\u00e9en</option>
      <option>Guyanien</option>
      <option>Ha\u00eftien</option>
      <option>Hondurien</option>
      <option>Hongrois</option>
      <option>Indien</option>
      <option>Indon\u00e9sien</option>
      <option>Irakien</option>
      <option>Iranien</option>
      <option>Irlandais</option>
      <option>Islandais</option>
      <option>Isra\u00e9lien</option>
      <option>Italien</option>
      <option>Ivoirien</option>
      <option>Jama\u00efcain</option>
      <option>Japonais</option>
      <option>Jordanien</option>
      <option>Kazakh</option>
      <option>K\u00e9nyan</option>
      <option>Kirghiz</option>
      <option>Kiribatien</option>
      <option>Kowe\u00eftien</option>
      <option>Laotien</option>
      <option>Letton</option>
      <option>Libanais</option>
      <option>Lib\u00e9rien</option>
      <option>Libyen</option>
      <option>Liechtensteinois</option>
      <option>Lituanien</option>
      <option>Luxembourgeois</option>
      <option>Mac\u00e9donien</option>
      <option>Malaisien</option>
      <option>Malawite</option>
      <option>Maldivien</option>
      <option>Malien</option>
      <option>Maltais</option>
      <option>Marocain</option>
      <option>Marshallais</option>
      <option>Mauricien</option>
      <option>Mauritanien</option>
      <option>Mongol</option>
      <option>Mont\u00e9n\u00e9grin</option>
      <option>Mozambicain</option>
      <option>Namibien</option>
      <option>Nauruan</option>
      <option>N\u00e9erlandais</option>
      <option>N\u00e9o-Z\u00e9landais</option>
      <option>N\u00e9palais</option>
      <option>Nig\u00e9rian</option>
      <option>Nig\u00e9rien</option>
      <option>Nord-Cor\u00e9en</option>
      <option>Norv\u00e9gien</option>
      <option>Palestinien</option>
    </datalist>
        <datalist id="lieu_list">
          <option value="Béjaïa"></option>
          <option value="Amizour"></option>
          <option value="Ferraoun"></option>
          <option value="Taourirt Ighil"></option>
          <option value="Chellata"></option>
          <option value="Tamokra"></option>
          <option value="Timezrit"></option>
          <option value="Souk El Ténine"></option>
          <option value="M'cisna"></option>
          <option value="Tinabdher"></option>
          <option value="Tichy"></option>
          <option value="Semaoun"></option>
          <option value="Kendira"></option>
          <option value="Tifra"></option>
          <option value="Ighram"></option>
          <option value="Amalou"></option>
          <option value="Ighil Ali"></option>
          <option value="Fenaïa Ilmaten"></option>
          <option value="Toudja"></option>
          <option value="Darguina"></option>
          <option value="Sidi-Ayad"></option>
          <option value="Aokas"></option>
          <option value="Beni Djellil"></option>
          <option value="Adekar"></option>
          <option value="Akbou"></option>
          <option value="Seddouk"></option>
          <option value="Tazmalt"></option>
          <option value="Aït-R'zine"></option>
          <option value="Chemini"></option>
          <option value="Souk-Oufella"></option>
          <option value="Taskriout"></option>
          <option value="Tibane"></option>
          <option value="Tala Hamza"></option>
          <option value="Barbacha"></option>
          <option value="Beni Ksila"></option>
          <option value="Ouzellaguen"></option>
          <option value="Bouhamza"></option>
          <option value="Beni Mellikeche"></option>
          <option value="Sidi-Aïch"></option>
          <option value="El Kseur"></option>
          <option value="Melbou"></option>
          <option value="Akfadou"></option>
          <option value="Leflaye"></option>
          <option value="Kherrata"></option>
          <option value="Draâ El-Kaïd"></option>
          <option value="Tamridjet"></option>
          <option value="A\u00eft-Smail"></option>
          <option value="Boukhelifa"></option>
          <option value="Tizi N'Berber"></option>
          <option value="Beni Maouche"></option>
          <option value="Oued Ghir"></option>
          <option value="Boudjellil"></option>
        </datalist>
      </div>
    </div>
    <style>
      /* Match infos_supplementaires textarea size with etudiants add/edit modals */
      #addStudentModal textarea#infos_supplementaires { min-height: 8rem; }
    </style>

      <script>
        // Styled student combo widget
        ;(function(){
          const input = document.getElementById('studentComboInput');
          const hidden = document.getElementById('studentComboValue');
          const list = document.getElementById('studentComboList');
          let items = Array.from(list.querySelectorAll('.combo-item'));

          // Allow adding a new combo item dynamically when a student is created
          window.addComboItemToStudentCombo = function(s){
            try{
              if(!list) return;
              const DEFAULT_AVATAR = "{% static 'images/happy.gif' %}";
              const photo = s.photo || DEFAULT_AVATAR;
              const name = (s.nom||'') + ' ' + (s.prenom||'');
              const div = document.createElement('div');
              div.className = 'combo-item flex items-center px-3 py-2 hover:bg-gray-50 cursor-pointer';
              div.dataset.id = s.id; div.dataset.name = name; div.dataset.email = s.email || ''; div.dataset.photo = photo;
              div.innerHTML = `
                <img src="${photo}" class="w-12 h-12 rounded-full mr-3 object-cover"/>
                <div class="text-sm">
                  <div class="font-semibold">${name}</div>
                </div>
              `;
              // prepend so recent appears first
              list.prepend(div);
              // attach same handlers as existing items
              div.addEventListener('click', ()=> selectItem(div));
              div.addEventListener('mouseenter', ()=>{
                let src = div.dataset.photo;
                let prev = document.getElementById('comboHoverPreview');
                if(!prev){ prev = document.createElement('img'); prev.id='comboHoverPreview'; prev.style.position='absolute'; prev.style.width='220px'; prev.style.height='220px'; prev.style.borderRadius='8px'; prev.style.objectFit='cover'; prev.style.boxShadow='0 10px 30px rgba(0,0,0,0.35)'; prev.style.zIndex=99999; prev.style.pointerEvents='none'; document.body.appendChild(prev); }
                prev.src = src; const rect = div.getBoundingClientRect();
                const preferredLeft = rect.right + 12;
                const maxRight = window.innerWidth - 8;
                const previewWidth = parseInt(prev.style.width,10) || 140;
                let left = preferredLeft;
                if (preferredLeft + previewWidth > maxRight) { left = rect.left - 12 - previewWidth; if (left < 8) left = 8; }
                let top = rect.top;
                const maxTop = window.innerHeight - (parseInt(prev.style.height,10) || 140) - 8;
                if (top > maxTop) top = maxTop; if (top < 8) top = 8;
                prev.style.left = left + 'px'; prev.style.top = top + 'px'; prev.style.display='block';
              });
              div.addEventListener('mouseleave', ()=>{ const prev = document.getElementById('comboHoverPreview'); if(prev) prev.style.display='none'; });
              // refresh items array
              items = Array.from(list.querySelectorAll('.combo-item'));
            }catch(e){ console.warn('addComboItemToStudentCombo failed', e); }
          };
          let selectedIndex = -1;

          function openList(){ list.classList.remove('hidden'); }
          function closeList(){ list.classList.add('hidden'); selectedIndex = -1; items.forEach(i=>i.classList.remove('bg-gray-100')); }

          function filter(q){
            const lower = q.trim().toLowerCase();
            items.forEach(it=>{
              const name = (it.dataset.name||'').toLowerCase();
              const email = (it.dataset.email||'').toLowerCase();
              const id = (it.dataset.id||'').toString();
              const ok = !lower || name.includes(lower) || email.includes(lower) || id.includes(lower);
              it.style.display = ok ? 'flex' : 'none';
            });
          }

          function highlight(index){
            items.forEach(i=>i.classList.remove('bg-gray-100'));
            if(index>=0 && items[index] && items[index].style.display!=='none'){
              items[index].classList.add('bg-gray-100');
              items[index].scrollIntoView({block:'nearest'});
            }
          }

          input.addEventListener('input', (e)=>{ filter(e.target.value); openList(); });
          input.addEventListener('focus', ()=>{ filter(input.value); openList(); });
          document.addEventListener('click', (e)=>{ if(!e.target.closest('#studentComboList') && e.target!==input) closeList(); });

          // keyboard nav
          input.addEventListener('keydown', (e)=>{
            const visible = items.filter(it=>it.style.display!=='none');
            if(e.key==='ArrowDown'){ e.preventDefault(); selectedIndex = Math.min(selectedIndex+1, visible.length-1); highlight(items.indexOf(visible[selectedIndex])); }
            else if(e.key==='ArrowUp'){ e.preventDefault(); selectedIndex = Math.max(selectedIndex-1, 0); highlight(items.indexOf(visible[selectedIndex])); }
            else if(e.key==='Enter'){ e.preventDefault(); if(selectedIndex===-1){ const first = visible[0]; if(first) selectItem(first); } else { selectItem(visible[selectedIndex]); } }
            else if(e.key==='Escape'){ closeList(); }
          });

          function selectItem(el){
            const id = el.dataset.id; const name = el.dataset.name; const photo = el.dataset.photo;
            hidden.value = id; input.value = name; closeList();
            // fill other form fields if present (try to find form inputs by name)
            const preview = document.getElementById('studentPreviewLarge');
            if(preview){ preview.src = photo; }
          }

          items.forEach(it=>{
            it.addEventListener('click', ()=> selectItem(it));
            it.addEventListener('mouseenter', ()=>{
              // show enlarged preview tooltip near list, clamped to viewport
              let src = it.dataset.photo;
              let prev = document.getElementById('comboHoverPreview');
              if(!prev){ prev = document.createElement('img'); prev.id='comboHoverPreview'; prev.style.position='absolute'; prev.style.width='220px'; prev.style.height='220px'; prev.style.borderRadius='8px'; prev.style.objectFit='cover'; prev.style.boxShadow='0 10px 30px rgba(0,0,0,0.35)'; prev.style.zIndex=99999; prev.style.pointerEvents='none'; document.body.appendChild(prev); }
              prev.src = src; const rect = it.getBoundingClientRect();
              const preferredLeft = rect.right + 12;
              const maxRight = window.innerWidth - 8; // margin
              const previewWidth = parseInt(prev.style.width,10) || 140;
              let left = preferredLeft;
              if (preferredLeft + previewWidth > maxRight) {
                // place to the left of the item if not enough space on the right
                left = rect.left - 12 - previewWidth;
                if (left < 8) left = 8;
              }
              let top = rect.top;
              // clamp vertically
              const maxTop = window.innerHeight - (parseInt(prev.style.height,10) || 140) - 8;
              if (top > maxTop) top = maxTop;
              if (top < 8) top = 8;
              prev.style.left = left + 'px'; prev.style.top = top + 'px'; prev.style.display='block';
            });
            it.addEventListener('mouseleave', ()=>{
              const prev = document.getElementById('comboHoverPreview'); if(prev) prev.style.display='none';
            });
          });

        })();

        // Export visible table as PDF (client-side using html2pdf)
        (function(){
          const btn = document.getElementById('exportPdfBtn'); if(!btn) return;
          // dynamically load html2pdf bundle if not present
          function loadScript(src, cb){ const s = document.createElement('script'); s.src = src; s.onload = cb; s.onerror = cb; document.head.appendChild(s); }
          btn.addEventListener('click', function(){
            try{
              const tbl = document.querySelector('#tableView table'); if(!tbl) return alert('Table non trouvée');
              // Build a printable clone that contains ONLY the visible rows (so numbering starts at 1
              // and the total reflects the exported set). We clone the header and then append clones
              // of original tbody rows that are currently visible (computed style != 'none').
              const clone = document.createElement('table');
              // copy classes from original so styles are preserved
              clone.className = tbl.className || '';
              // clone thead
              const thead = tbl.querySelector('thead');
              if(thead) clone.appendChild(thead.cloneNode(true));
              // build tbody with only visible rows
              const newTbody = document.createElement('tbody');
              const originalRows = Array.from(tbl.querySelectorAll('tbody tr'));
              originalRows.forEach(function(origRow){
                try{
                  const cs = window.getComputedStyle(origRow);
                  if(cs && cs.display === 'none') return; // skip hidden rows
                }catch(e){ /* if computed style fails, include row as fallback */ }
                // clone the original row and append
                const clonedRow = origRow.cloneNode(true);
                newTbody.appendChild(clonedRow);
              });
              clone.appendChild(newTbody);
              // remove actions column from cloned header/body if present
              const header = clone.querySelector('thead'); if(header){ const lastTh = header.querySelector('th:last-child'); if(lastTh) lastTh.remove(); }
              clone.querySelectorAll('tbody tr').forEach(r=>{ const lastTd = r.querySelector('td:last-child'); if(lastTd) lastTd.remove(); });
              // remove interactive elements inside clone (buttons/links/inputs)
              clone.querySelectorAll('button, a, input, select').forEach(n=>{ n.replaceWith(document.createTextNode(n.textContent || '')); });

              function generate(){
                const opt = {
                  margin: 12,
                  filename: 'inscriptions.pdf',
                  image: { type: 'jpeg', quality: 0.95 },
                  html2canvas: { scale: 1, useCORS: true },
                  // Force landscape so wide tables fit on a single page horizontally
                  jsPDF: { unit: 'pt', format: 'a4', orientation: 'landscape' }
                };

                // build dynamic title from filters
                function buildFilters(){
                  try{
                    const parts = [];
                    const formationSel = document.getElementById('insFormationFilter') && document.getElementById('insFormationFilter').value;
                    if(formationSel) parts.push(formationSel);
                    const ecole = document.getElementById('insEcoleFilter') && document.getElementById('insEcoleFilter').value;
                    if(ecole) parts.push(ecole);
                    const groupe = document.getElementById('insGroupeFilter') && document.getElementById('insGroupeFilter').value;
                    if(groupe) parts.push(groupe);
                    const dateType = document.getElementById('insDateType') && document.getElementById('insDateType').value;
                    if(dateType){ const map = {'today':"aujourd'hui", 'this_week':'cette semaine', 'this_month':'ce mois'}; parts.push(map[dateType] || dateType); }
                    const search = document.getElementById('insSearch') && document.getElementById('insSearch').value.trim();
                    if(search) parts.push('recherche: ' + search);
                    return parts.join(' - ');
                  }catch(e){ return ''; }
                }

                const filters = buildFilters();
                const schoolName = "{{ school_name|default:''|escapejs }}";
                // only append school name when it's meaningful (avoid accidental short codes like 'GG')
                const appendSchool = schoolName && schoolName.trim() && schoolName.trim().toLowerCase() !== 'gg';
                const titleText = 'Liste des etudiants' + (filters ? ' de ' + filters : '') + (appendSchool ? (' de ' + schoolName) : '');

                // create container to ensure printable width and include a print header (logo + title)
                const container = document.createElement('div');
                container.style.padding = '12px';
                container.style.boxSizing = 'border-box';

                // header
                const header = document.createElement('div');
                header.style.display = 'flex'; header.style.alignItems = 'center'; header.style.justifyContent = 'space-between'; header.style.gap = '12px'; header.style.marginBottom = '10px';
                header.style.borderBottom = '1px solid #e5e7eb'; header.style.paddingBottom = '8px';

                const logoWrap = document.createElement('div');
                const img = document.createElement('img');
                img.src = "{{ school_logo|default:'/static/school_logo.png' }}";
                img.alt = 'Logo'; img.style.height = '48px'; img.style.objectFit = 'contain';
                logoWrap.appendChild(img);

                const titleEl = document.createElement('div');
                titleEl.style.flex = '1'; titleEl.style.textAlign = 'center'; titleEl.style.fontSize = '18px'; titleEl.style.fontWeight = '700'; titleEl.style.color = '#0f172a';
                titleEl.innerText = titleText;

                // right area: display total count of items in the table
                const countDiv = document.createElement('div');
                countDiv.style.minWidth = '110px'; countDiv.style.textAlign = 'right'; countDiv.style.fontSize = '13px'; countDiv.style.fontWeight = '700'; countDiv.style.color = '#0f172a';
                // we'll set the text after computing rows

                header.appendChild(logoWrap); header.appendChild(titleEl); header.appendChild(countDiv);
                container.appendChild(header);

                // adjust clone styling for print-fit
                clone.style.width = '100%'; clone.style.boxSizing = 'border-box'; clone.style.fontSize = '13px';
                // reduce cell padding for printable export so more fits on page
                clone.querySelectorAll('th, td').forEach(function(cell){ cell.style.padding = '6px'; cell.style.fontSize = '12px'; });

                // Adjust columns for PDF export requirements:
                // - Merge student name + telephone on one line and include student code (from data-etudiant-id)
                // - Prepend a sequential number (numero d'ordre) to each row
                // - Show only the short groupe code (e.g., GF1) instead of full formation text
                try{
                  // Rebuild header to: N° | Code étudiant | Étudiant (tél) | Formation | Groupe | Date | École | ...
                  const theadRow = clone.querySelector('thead tr');
                  let oldThs = [];
                  if(theadRow){
                    try{
                      oldThs = Array.from(theadRow.querySelectorAll('th'));
                      // create new header row with primary columns
                      const newTr = document.createElement('tr');
                      const primary = ['N°', 'Code étudiant', 'Étudiant', 'Téléphone'];
                      primary.forEach(function(h){ const th = document.createElement('th'); th.textContent = h; th.style.padding = '6px'; th.style.fontSize = '12px'; newTr.appendChild(th); });
                      // append the remaining old headers starting from the original 3rd column (index 2), skipping 'Formateur' and 'Téléphone'
                      for(let i = 2; i < oldThs.length; i++){
                        const txt = (oldThs[i].textContent || '').trim();
                        const low = txt.toLowerCase();
                        if(low.indexOf('formateur') !== -1) continue;
                        if(low.indexOf('téléphone') !== -1 || low.indexOf('telephone') !== -1) continue;
                        if(low.indexOf('actions') !== -1) continue; // skip actions column
                        const copy = document.createElement('th'); copy.textContent = txt; copy.style.padding = '6px'; copy.style.fontSize = '12px'; newTr.appendChild(copy);
                      }
                      theadRow.parentNode.replaceChild(newTr, theadRow);
                    }catch(e){ console.warn('adjust header failed', e); }
                  }

                  // Process body rows: build new td list for each row in the desired order
                  const bodyRows = Array.from(clone.querySelectorAll('tbody tr'));
                  // set count in header right area
                  try{ countDiv.textContent = 'Total: ' + String(bodyRows.length); }catch(e){}

                  bodyRows.forEach(function(r, idx){
                    const oldTds = Array.from(r.querySelectorAll('td'));
                    if(oldTds.length === 0) return;

                    // Extract original cell texts using original header positions
                    const etudiantText = (oldTds[0] && oldTds[0].textContent) ? oldTds[0].textContent.trim() : '';
                    const phoneText = (oldTds[1] && oldTds[1].textContent) ? oldTds[1].textContent.trim() : '';
                    // student code from data attribute on tr
                    const studentCode = r.getAttribute('data-etudiant-id') || r.dataset.etudiantId || '';

                    // Clear current row and append new cells in desired order
                    try{
                      r.innerHTML = '';
                      // N°
                      const tdNum = document.createElement('td'); tdNum.textContent = String(idx + 1); tdNum.style.padding = '6px'; tdNum.style.fontSize = '12px'; r.appendChild(tdNum);
                      // Code étudiant
                      const tdCode = document.createElement('td'); tdCode.textContent = studentCode; tdCode.style.padding = '6px'; tdCode.style.fontSize = '12px'; r.appendChild(tdCode);
                      // Étudiant (Name)
                      const tdName = document.createElement('td');
                      tdName.textContent = etudiantText;
                      tdName.style.padding = '6px'; tdName.style.fontSize = '12px';
                      tdName.style.whiteSpace = 'nowrap';
                      tdName.style.overflow = 'hidden';
                      tdName.style.textOverflow = 'ellipsis';
                      tdName.title = tdName.textContent;
                      r.appendChild(tdName);

                      // Téléphone (separate column)
                      const tdPhone = document.createElement('td');
                      tdPhone.textContent = phoneText;
                      tdPhone.style.padding = '6px'; tdPhone.style.fontSize = '12px';
                      tdPhone.style.whiteSpace = 'nowrap';
                      tdPhone.style.overflow = 'hidden';
                      tdPhone.style.textOverflow = 'ellipsis';
                      tdPhone.title = tdPhone.textContent;
                      r.appendChild(tdPhone);

                      // append the remaining original cells corresponding to oldThs indices >=2, skipping Formateur/Telephone/Actions
                      for(let i = 2; i < oldThs.length; i++){
                        const hdrTxt = (oldThs[i].textContent || '').trim();
                        const low = hdrTxt.toLowerCase();
                        if(low.indexOf('formateur') !== -1) continue;
                        if(low.indexOf('téléphone') !== -1 || low.indexOf('telephone') !== -1) continue;
                        if(low.indexOf('actions') !== -1) continue;
                        // pick the matching td if it exists
                        const srcTd = (i < oldTds.length) ? oldTds[i] : null;
                        const td = document.createElement('td');
                        td.textContent = (srcTd && srcTd.textContent) ? srcTd.textContent.trim() : '';
                        td.style.padding = '6px'; td.style.fontSize = '12px'; r.appendChild(td);
                      }
                    }catch(e){ console.warn('rebuild row failed', e); }
                  });
                }catch(e){ console.warn('PDF column adjust failed', e); }

                container.appendChild(clone);
                html2pdf().set(opt).from(container).save().catch(e=>{ console.error('pdf save error', e); alert('Erreur lors de la génération PDF'); });
              }

              if(typeof html2pdf === 'undefined'){
                loadScript('{% static 'vendor/js/html2pdf.bundle.min.js' %}', function(){
                  setTimeout(generate, 250);
                });
              } else { generate(); }
            }catch(e){ console.error('export pdf error', e); alert('Erreur lors de l\'export PDF'); }
          }, { passive: true });
        })();

        const addInsModal = document.getElementById('addInsModal');
        document.getElementById('openAddInsBtn').addEventListener('click', ()=> {
          // ensure groupe select is populated for the currently selected formation (if any)
          try{
            const mainForm = document.getElementById('addInsForm');
            const mainFormation = mainForm.querySelector('select[name="formation"]');
            const mainGroupe = document.getElementById('addInsGroupeSelect');
            if (mainFormation && mainGroupe){
              // trigger change to populate options (handler defined in the bottom script)
              mainFormation.dispatchEvent(new Event('change'));
            }
          }catch(e){}
          // set default date to today for the add modal
          try{
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth()+1).padStart(2,'0');
            const dd = String(today.getDate()).padStart(2,'0');
            const iso = `${yyyy}-${mm}-${dd}`;
            const addDate = document.getElementById('addDateIns'); if(addDate) addDate.value = iso;
          }catch(e){}
          addInsModal.classList.remove('hidden');
        });
        function closeAddInsModal(){ addInsModal.classList.add('hidden'); }

        // CSRF helper
        function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
              }
            }
          }
          return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Inline error helper for addInsForm (replaces alert())
        function showAddInsError(msg, focusSelector){
          try{
            const formEl = document.getElementById('addInsForm');
            if(!formEl) return;
            let g = document.getElementById('addInsFormGlobalError');
            if(!g){ g = document.createElement('div'); g.id = 'addInsFormGlobalError'; g.className = 'text-sm text-red-600 mt-2'; formEl.insertBefore(g, formEl.firstChild); }
            g.textContent = msg || 'Erreur';
            if (focusSelector){ try{ const el = formEl.querySelector(focusSelector); if(el && el.focus) el.focus(); }catch(e){} }
          }catch(e){ console.warn('showAddInsError failed', e); }
        }

        document.getElementById('addInsForm').addEventListener('submit', function(e){
          e.preventDefault();
          // client-side validation: etudiant, formation and groupe are required per request
            const form = e.target;
            const etudiantVal = form.querySelector('input[name="etudiant"]') ? form.querySelector('input[name="etudiant"]').value : '';
            const formationVal = form.querySelector('select[name="formation"]') ? form.querySelector('select[name="formation"]').value : '';
            // groupe may be a select or input depending on UI; query any element with name="groupe"
            const groupeEl = form.querySelector('[name="groupe"]');
            const groupeVal = groupeEl ? (groupeEl.value || '') : '';
          if (!etudiantVal) { showAddInsError('Veuillez sélectionner un étudiant.', 'input[name="etudiant"]'); return; }
          if (!formationVal) { showAddInsError('Veuillez choisir une formation.', 'select[name="formation"]'); return; }
          if (!groupeVal) { showAddInsError('Veuillez renseigner le groupe.', '[name="groupe"]'); return; }
          const data = new FormData(form);
          // if editing (inscription_id present), call edit endpoint
          const insId = form.querySelector('input[name="inscription_id"]') ? form.querySelector('input[name="inscription_id"]').value : '';
          const endpoint = insId ? '{% url "inscriptions_edit" %}' : '{% url "inscriptions_add" %}';
          if (insId) data.append('id', insId);
          fetch(endpoint, { method: 'POST', headers: {'X-CSRFToken': csrftoken}, body: data, credentials: 'same-origin' }).then(r=>{
            // try to parse JSON if possible; otherwise show server text/html
            const ctype = r.headers.get('content-type') || '';
            if (!r.ok){
              return r.text().then(txt => { throw new Error(txt || r.statusText); });
            }
            if (ctype.indexOf('application/json') !== -1){
              return r.json();
            }
            return r.text().then(txt => { try{ return JSON.parse(txt); }catch(e){ throw new Error(txt || 'Invalid JSON response'); } });
          }).then(json=>{
            if (json.success){
              // prepend row
              const ins = json.inscription;
      const tbody = document.getElementById('inscriptionsTbody');
      const tr = document.createElement('tr');
    // set consistent data-* attributes using setAttribute so delegated code that queries attributes works reliably
    tr.setAttribute('data-id', ins.id || '');
    tr.setAttribute('data-etudiant-id', ins.etudiant_id || '');
    tr.setAttribute('data-etudiant-name', ins.etudiant_nom || '');
    tr.setAttribute('data-etudiant-email', ins.etudiant_email || '');
    tr.setAttribute('data-etudiant-phone', ins.etudiant_phone || '');
    tr.setAttribute('data-photo', ins.etudiant_photo || '');
    tr.setAttribute('data-formation', ins.formation || '');
    tr.setAttribute('data-formation-id', ins.formation_id || '');
    tr.setAttribute('data-statut', ins.statut || '');
    tr.setAttribute('data-groupe', ins.groupe || '');
  const _dateIso = ins.date_inscription ? (ins.date_inscription.split ? ins.date_inscription.split('T')[0] : ins.date_inscription) : '';
  tr.setAttribute('data-date', _dateIso);
  tr.setAttribute('data-date_naissance', ins.etudiant_date_naissance || ins.date_naissance || '');
  tr.setAttribute('data-lieu_naissance', ins.etudiant_lieu_naissance || ins.lieu_naissance || '');
  tr.setAttribute('data-situation', ins.etudiant_situation || ins.situation || '');
  tr.setAttribute('data-nin', ins.etudiant_nin || ins.nin || '');
  tr.setAttribute('data-address', ins.etudiant_address || ins.address || '');
  // if editing, update existing row instead of prepending
              if (insId){
                const existing = document.querySelector('#inscriptionsTbody tr[data-id="'+insId+'"]');
                if (existing){
          // update dataset attributes
          existing.setAttribute('data-groupe', ins.groupe || '');
          existing.setAttribute('data-statut', ins.statut || '');
          existing.setAttribute('data-formation', ins.formation || '');
          existing.setAttribute('data-formation-id', ins.formation_id || '');
          existing.setAttribute('data-date', ins.date_inscription ? (ins.date_inscription.split ? ins.date_inscription.split('T')[0] : ins.date_inscription) : '');
                // compute a friendly display name for formateur: server -> selected option -> etudiant email
          const selFormateur = form.querySelector('select[name="formateur"]');
          const fallbackFormateurText = (selFormateur && selFormateur.options && selFormateur.options[selFormateur.selectedIndex] && selFormateur.options[selFormateur.selectedIndex].text) ? selFormateur.options[selFormateur.selectedIndex].text.trim() : (ins.etudiant_email || '');
          const displayFormateurEdit = ins.formateur_name || fallbackFormateurText || '';
          existing.setAttribute('data-formateur-name', displayFormateurEdit);
          // update visible cells based on new column order: 1:Etudiant, 2:Téléphone, 3:Formation, 4:Groupe, 5:Date, 6:Formateur, 7:Statut
          if(existing.querySelector('td:nth-child(3)')) existing.querySelec
          tor('td:nth-child(3)').textContent = ins.formation || '';
          if(existing.querySelector('td:nth-child(4)')) existing.querySelector('td:nth-child(4)').textContent = ins.groupe || '';
          if(existing.querySelector('td:nth-child(2)')) existing.querySelector('td:nth-child(2)').textContent = ins.etudiant_phone || '';
          if(existing.querySelector('td:nth-child(6)')) existing.querySelector('td:nth-child(6)').textContent = displayFormateurEdit || '';
          if(existing.querySelector('td:nth-child(5)')) existing.querySelector('td:nth-child(5)').textContent = (window.fmtDateString && _dateIso) ? window.fmtDateString(_dateIso) : (_dateIso || '');
          if(existing.querySelector('td:nth-child(7)')) existing.querySelector('td:nth-child(7)').textContent = ins.ecole || '-';
                  // close modal and cleanup
                  closeAddInsModal();
                  const hid = form.querySelector('input[name="inscription_id"]'); if(hid) hid.remove();
                  // re-run filters and reattach handlers
                  try{ attachDblclickForEdit(); }catch(e){}
                  try{ filterInscriptions(); }catch(e){}
                  return;
                }
              }
              // set full dataset attributes for the new row so client code can rely on them
              tr.setAttribute('data-id', ins.id || '');
              tr.setAttribute('data-etudiant-id', ins.etudiant_id || '');
              tr.setAttribute('data-etudiant-name', ins.etudiant_nom || '');
              tr.setAttribute('data-etudiant-email', ins.etudiant_email || '');
              tr.setAttribute('data-etudiant-phone', ins.etudiant_phone || '');
              tr.setAttribute('data-photo', ins.etudiant_photo || '');
              tr.setAttribute('data-formation', ins.formation || '');
              tr.setAttribute('data-formation-id', ins.formation_id || '');
              tr.setAttribute('data-groupe', ins.groupe || '');
              tr.setAttribute('data-date', ins.date_inscription ? (ins.date_inscription.split ? ins.date_inscription.split('T')[0] : ins.date_inscription) : '');
              tr.setAttribute('data-statut', ins.statut || '');
              tr.setAttribute('data-prix-total', ins.prix_total || '');
              if (typeof ins.formateur_id !== 'undefined') tr.setAttribute('data-formateur-id', ins.formateur_id || '');
              if (typeof ins.formateur_name !== 'undefined') tr.setAttribute('data-formateur-name', ins.formateur_name || '');

              // compute display formateur for the new row: prefer server name, otherwise use the selected option text or student email
              const selFormateurNew = form.querySelector('select[name="formateur"]');
              const fallbackNew = (selFormateurNew && selFormateurNew.options && selFormateurNew.options[selFormateurNew.selectedIndex] && selFormateurNew.options[selFormateurNew.selectedIndex].text) ? selFormateurNew.options[selFormateurNew.selectedIndex].text.trim() : (ins.etudiant_email || '');
              const displayFormateur = ins.formateur_name || fallbackNew || '';

              // build full row HTML (same structure as server-rendered rows) for immediate, consistent display
              const etuName = ins.etudiant_nom || ins.etudiant_email || '';
              const etuPhone = ins.etudiant_phone || '';
              const formationText = ins.formation || '';
              const dateText = ins.date_inscription || '';

                  // populate edit modal date input (expecting YYYY-MM-DD or ISO)
                  try{
                    const editDateInput = document.getElementById('editDateIns');
                    if(editDateInput){
                      // prefer the dataset value (tr.dataset.date)
                      const ds = tr.getAttribute('data-date') || tr.dataset.date || dateText || '';
                      // normalize to YYYY-MM-DD if ISO provided
                      let norm = ds;
                      if(norm && norm.indexOf('T')!==-1) norm = norm.split('T')[0];
                      editDateInput.value = norm;
                    }
                  }catch(e){}
              const groupeText = ins.groupe || '';
              const statutBadge = normalizeStatutBadge(ins.statut || '');
              const statutText = statutBadge.text;
              const statutCls = statutBadge.cls;

              tr.innerHTML = `
                <td class="px-6 py-4 font-semibold">${etuName}</td>
                <td class="px-6 py-4">${etuPhone}</td>
                <td class="px-6 py-4">${formationText}</td>
                <td class="px-6 py-4">${groupeText}</td>
                <td class="px-6 py-4">${dateText}</td>
                <td class="px-6 py-4">${displayFormateur}</td>
                <td class="px-6 py-4">${ins.ecole || '-'}</td>
                <td class="px-6 py-4 text-right">
                  <div class="action-btn-group">
                    <button class="action-icon-btn action-print ins-print-btn" data-id="${ins.id}" title="Imprimer" aria-label="Imprimer"><span class="material-icons">print</span></button>
                    <button class="action-icon-btn action-view view-btn" title="Voir" aria-label="Voir"><span class="material-icons">visibility</span></button>
                    <button class="action-icon-btn action-delete delete-ins-btn delete-btn icon-btn" data-id="${ins.id}" title="Supprimer" aria-label="Supprimer">
                      <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12z" fill="#ef4444"/><path d="M19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="#ef4444"/></svg>
                    </button>
                  </div>
                </td>
              `;

              // set helpful dataset attributes for later print/view actions
              try{
                tr.setAttribute('data-etudiant-name', ins.etudiant_nom || ins.etudiant_email || '');
                tr.setAttribute('data-etudiant-email', ins.etudiant_email || '');
                tr.setAttribute('data-etudiant-phone', ins.etudiant_phone || '');
                tr.setAttribute('data-photo', ins.etudiant_photo || '');
                tr.setAttribute('data-date_naissance', ins.etudiant_date_naissance || ins.date_naissance || '');
                tr.setAttribute('data-lieu_naissance', ins.etudiant_lieu_naissance || ins.lieu_naissance || '');
                tr.setAttribute('data-situation', ins.etudiant_situation || ins.situation || '');
                tr.setAttribute('data-nin', ins.etudiant_nin || ins.nin || '');
                tr.setAttribute('data-address', ins.etudiant_adresse || ins.address || '');
                tr.setAttribute('data-nom_ar', ins.etudiant_nom_ar || ins.nom_ar || '');
                tr.setAttribute('data-prenom_ar', ins.etudiant_prenom_ar || ins.prenom_ar || '');
              }catch(e){ console.warn('failed to set extra attributes on new row', e); }
              // ensure formateur-name is set
              if (displayFormateur) tr.setAttribute('data-formateur-name', displayFormateur);
              // insert at top and animate the new row for better UX
              tbody.insertBefore(tr, tbody.firstChild);
              try{ attachDblclickForEdit(); }catch(e){ console.warn('re-attach dblclick failed', e); }
              try{ filterInscriptions(); }catch(e){}
              // expose ecole on the row dataset
              try{ tr.setAttribute('data-ecole', ins.ecole || ''); }catch(e){}
              // no animation requested: keep row static
              // If the user checked 'Inscription suivante' and this was an add (not edit), reset the form and keep modal open
              const follow = document.getElementById('addins_followup');
              if (!insId && follow && follow.checked){
                try{ document.getElementById('addInsForm').reset(); }catch(e){}
                try{ document.getElementById('addInsGroupeSelect').innerHTML = '<option value="">-- Choisir formation d\'abord --</option>' }catch(e){}
                try{ const g = document.getElementById('addInsFormGlobalError'); if (g) g.textContent = ''; }catch(e){}
                try{ document.getElementById('studentComboValue').value = ins.etudiant_id || ''; }catch(e){}
              } else {
                closeAddInsModal();
              }
            } else {
              alert('Erreur: '+(json.error||'')); 
            }
          }).catch(err=>{ console.error(err);
            // show non-blocking inline error on the form instead of native alert
            try{
              const formEl = document.getElementById('addInsForm');
              let g = document.getElementById('addInsFormGlobalError');
              if(!g){ g = document.createElement('div'); g.id = 'addInsFormGlobalError'; g.className = 'text-sm text-red-600 mt-2'; formEl.insertBefore(g, formEl.firstChild); }
              const raw = (err && err.message) ? String(err.message) : 'vérifier la connexion';
              // If server returned HTML, show a short excerpt
              let msg = raw;
              if (raw && raw.trim().startsWith('<')){
                const firstLine = raw.trim().split('\n').slice(0,3).join(' ');
                msg = 'Réponse serveur non-JSON: ' + firstLine;
              } else {
                try{ const parsed = JSON.parse(raw); if(parsed && (parsed.error||parsed.message)) msg = parsed.error||parsed.message; }catch(e){}
              }
              g.textContent = 'Erreur réseau: ' + msg;
            }catch(e){ /* fallback to console if DOM update fails */ }
          });
        });

        // Double-click on a row to edit inscription -> open dedicated editInsModal
        function attachDblclickForEdit(){
          document.querySelectorAll('#inscriptionsTbody tr').forEach(tr=>{
            tr.removeEventListener('dblclick', tr._dblHandler || function(){});
            const handler = function(e){
              try{
                // debug: dump dataset for this row to help diagnose missing groupe/ecole
                try{ console.debug('[open edit] row dataset', { id: this.dataset.id, formationId: this.dataset.formationId||this.dataset.formation_id, groupe: this.dataset.groupe, groupeId: this.dataset.groupeId||this.dataset.groupe_id, ecole: this.dataset.ecole }); }catch(e){}
                const id = this.dataset.id;
                const modal = document.getElementById('editInsModal');
                // hidden id
                const hid = document.getElementById('editInsId'); if(hid) hid.value = id;
                // etudiant id and display
                const etuId = this.dataset.etudiantId || this.dataset.etudiant_id || '';
                const etuName = this.dataset.etudiantName || this.dataset.etudiant_name || (this.dataset.etudiantName || '');
                const edtEid = document.getElementById('editEtudiantId'); if(edtEid) edtEid.value = etuId;
                const edtDisplay = document.getElementById('editEtudiantDisplay'); if(edtDisplay) edtDisplay.textContent = etuName || ('#'+etuId);

                // helper: normalize string (remove accents, lowercase, trim) for fuzzy matching
                function normalizeStr(s){ try{ return String(s||'').normalize('NFD').replace(/\p{Diacritic}/gu, '').toLowerCase().replace(/[()"'`\[\]\-–—]+/g,'').trim(); }catch(e){ return String(s||'').toLowerCase().trim(); } }

                // helper: try to set select value by direct value, or find option by normalized text/value
                function selectOptionByValueOrText(selectEl, wanted){ if(!selectEl || !wanted) return false; try{ selectEl.value = wanted; }catch(e){}; if(String(selectEl.value) === String(wanted)) return true; const normWanted = normalizeStr(wanted);
                  const opts = Array.from(selectEl.options || []);
                  // first exact text match, then normalized contains
                  let found = opts.find(o => normalizeStr(o.text||'') === normWanted || normalizeStr(o.value||'') === normWanted);
                  if(!found) found = opts.find(o => normalizeStr(o.text||'').indexOf(normWanted) !== -1 || normalizeStr(o.value||'').indexOf(normWanted) !== -1);
                  if(found){ selectEl.value = found.value; return true; } return false; }

                // formation -> set select by id and populate groupe options
                const formationId = this.dataset.formationId || this.dataset.formation_id || '';
                if (formationId){
                  const fsel = document.getElementById('editFormation');
                  if(fsel) {
                    fsel.value = formationId;
                    // dispatch change so buildOptionsFor handler repopulates groups
                    fsel.dispatchEvent(new Event('change'));
                  }
                  // set groupe value after a short tick to allow options to be populated
          (function(currentGroup, currentGroupId, formateurId, formateurName){
                      setTimeout(function(){
            const gsel = document.getElementById('editGroupeSelect');
            if (gsel){ try{ console.debug('[edit modal] groupe options', Array.from(gsel.options||[]).map(o=>({v:o.value,t:o.text})) , 'wanted=', currentGroup, 'wantedId=', currentGroupId); }catch(e){} }
            // prefer id match if provided
            if (gsel && currentGroupId){ try{ selectOptionByValueOrText(gsel, currentGroupId); }catch(e){} }
            if (gsel && !gsel.value && currentGroup){ try{ selectOptionByValueOrText(gsel, currentGroup); }catch(e){} }
                      // set formateur: prefer id, otherwise try to match displayed text
                      const ftor = document.getElementById('editFormateur');
                      if(ftor){
                        if(formateurId){ try{ ftor.value = formateurId; }catch(e){}
                        } else if(formateurName){
                          // try to find option whose text matches the name
                          const opts = Array.from(ftor.options||[]);
                          const found = opts.find(o => (o.text||'').trim() === formateurName.trim());
                          if(found) ftor.value = found.value;
                        }
                      }
                    }, 250);
                    })(this.dataset.groupe || '', (this.dataset.groupeId || this.dataset.groupe_id || ''), (this.dataset.formateurId || this.dataset.formateur_id || this.dataset.formateurid || ''), (this.dataset.formateurName || this.dataset.formateur_name || ''));
                }

                // if formation not provided above, set formateur immediately
                if (!formationId){
                  const formateurId = this.dataset.formateurId || this.dataset.formateur_id || this.dataset.formateurid || '';
                  if (formateurId){ const ftor = document.getElementById('editFormateur'); if(ftor) ftor.value = formateurId; }
                }

                // session
                const sess = this.dataset.session || '';
                const ssel = document.getElementById('editSession'); if(ssel && sess) ssel.value = sess;

                // optional fields: prix, statut - set if inputs exist
                const pfield = document.getElementById('editPrixTotal'); if(pfield) pfield.value = this.dataset.prixTotal || '';
                const stField = document.getElementById('editStatut'); if(stField) stField.value = this.dataset.statut || 'inscrit';

                // prefill edit date input from dataset (prefer dataset.date)
                try{
                  const editDateInput = document.getElementById('editDateIns');
                  if(editDateInput){
                    const d = this.dataset.date || this.getAttribute('data-date') || '';
                    let norm = d;
                    if(norm && norm.indexOf('T') !== -1) norm = norm.split('T')[0];
                    editDateInput.value = norm;
                  }
                }catch(e){}

                // ecole: set editEcole (try by value then by option text)
                try{
                  const ecoleVal = this.dataset.ecole || this.getAttribute('data-ecole') || '';
                  if(ecoleVal){
                    const eSel = document.getElementById('editEcole');
                    if(eSel){
                      try{ eSel.value = ecoleVal; }
                      catch(e){}
                      if(String(eSel.value) !== String(ecoleVal)){
                        const opts = Array.from(eSel.options || []);
                        const found = opts.find(o => ((o.text||'').trim() === String(ecoleVal).trim()) || (String(o.value||'').trim() === String(ecoleVal).trim()));
                        if(found) eSel.value = found.value;
                      }
                    }
                  }
                }catch(e){}

                if(modal) modal.classList.remove('hidden');
              }catch(err){ console.warn('open edit modal failed', err); }
            };
            tr.addEventListener('dblclick', handler);
            tr._dblHandler = handler;
          });
        }
        attachDblclickForEdit();
        // Delegated dblclick handler: ensures newly added rows open the edit modal without needing re-attachment
        document.addEventListener('dblclick', function(e){
          const tr = e.target.closest('#inscriptionsTbody tr'); if(!tr) return;
          try{
            try{ console.debug('[open edit - delegated] row dataset', { id: tr.dataset.id, formationId: tr.dataset.formationId||tr.dataset.formation_id, groupe: tr.dataset.groupe, groupeId: tr.dataset.groupeId||tr.dataset.groupe_id, ecole: tr.dataset.ecole }); }catch(e){}
            const id = tr.dataset.id;
            const modal = document.getElementById('editInsModal');
            const hid = document.getElementById('editInsId'); if(hid) hid.value = id;
            const etuId = tr.dataset.etudiantId || tr.dataset.etudiant_id || '';
            const etuName = tr.dataset.etudiantName || tr.dataset.etudiant_name || '';
            const edtEid = document.getElementById('editEtudiantId'); if(edtEid) edtEid.value = etuId;
            const edtDisplay = document.getElementById('editEtudiantDisplay'); if(edtDisplay) edtDisplay.textContent = etuName || ('#'+etuId);

            const formationId = tr.dataset.formationId || tr.dataset.formation_id || '';
            if (formationId){
              const fsel = document.getElementById('editFormation');
              if(fsel){ fsel.value = formationId; fsel.dispatchEvent(new Event('change')); }
              (function(currentGroup, currentGroupId, formateurId, formateurName){
                setTimeout(function(){
                  const gsel = document.getElementById('editGroupeSelect'); if (gsel){ try{ console.debug('[delegated edit] groupe options', Array.from(gsel.options||[]).map(o=>({v:o.value,t:o.text})) , 'wanted=', currentGroup, 'wantedId=', currentGroupId); }catch(e){} }
                  if (gsel && currentGroupId){ try{ selectOptionByValueOrText(gsel, currentGroupId); }catch(e){} }
                  if (gsel && !gsel.value && currentGroup){ try{ selectOptionByValueOrText(gsel, currentGroup); }catch(e){} }
                  const ftor = document.getElementById('editFormateur');
                  if(ftor){
                    if(formateurId){ try{ ftor.value = formateurId; }catch(e){} }
                    else if(formateurName){ const opts = Array.from(ftor.options||[]); const found = opts.find(o => (o.text||'').trim() === formateurName.trim()); if(found) ftor.value = found.value; }
                  }
                }, 80);
              })(tr.dataset.groupe || '', (tr.dataset.formateurId || tr.dataset.formateur_id || tr.dataset.formateurid || ''), (tr.dataset.formateurName || tr.dataset.formateur_name || ''));
            }

            if (!formationId){ const formateurId = tr.dataset.formateurId || tr.dataset.formateur_id || tr.dataset.formateurid || ''; if (formateurId){ const ftor = document.getElementById('editFormateur'); if(ftor) ftor.value = formateurId; } }

            // set ecole with robust matching
            try{
              const ecoleVal = tr.dataset.ecole || tr.getAttribute('data-ecole') || '';
              if(ecoleVal){ const eSel = document.getElementById('editEcole'); if(eSel){ try{ selectOptionByValueOrText(eSel, ecoleVal); }catch(e){} } }
            }catch(e){}

            const sess = tr.dataset.session || '';
            const ssel = document.getElementById('editSession'); if(ssel && sess) ssel.value = sess;
            const pfield = document.getElementById('editPrixTotal'); if(pfield) pfield.value = tr.dataset.prixTotal || '';
            const stField = document.getElementById('editStatut'); if(stField) stField.value = tr.dataset.statut || 'inscrit';

            // prefill edit date input from tr dataset
            try{
              const editDateInput = document.getElementById('editDateIns');
              if(editDateInput){
                const d = tr.dataset.date || tr.getAttribute('data-date') || '';
                let norm = d;
                if(norm && norm.indexOf('T') !== -1) norm = norm.split('T')[0];
                editDateInput.value = norm;
              }
            }catch(e){}

            if(modal) modal.classList.remove('hidden');
          }catch(err){ console.warn('open edit modal (delegated) failed', err); }
        });

        function closeEditInsModal(){ const m = document.getElementById('editInsModal'); if(m) m.classList.add('hidden'); }

        document.getElementById('editInsForm').addEventListener('submit', function(e){
          e.preventDefault();
          const form = e.target; const fd = new FormData(form);
          fetch('{% url "inscriptions_edit" %}', { method: 'POST', headers: {'X-CSRFToken': csrftoken}, body: fd, credentials: 'same-origin' }).then(r=>{
            const ctype = r.headers.get('content-type') || '';
            if (!r.ok) return r.text().then(txt => { throw new Error(txt || r.statusText); });
            if (ctype.indexOf('application/json') !== -1) return r.json();
            return r.text().then(txt => { try{ return JSON.parse(txt); }catch(e){ throw new Error(txt || 'Invalid JSON response'); } });
          }).then(json=>{
            if(json.success){
              const ins = json.inscription;
              const tr = document.querySelector('#inscriptionsTbody tr[data-id="'+ins.id+'"]');
              if(tr){
                // update dataset attributes (keep keys consistent with template data-*)
                tr.setAttribute('data-groupe', ins.groupe || '');
                tr.setAttribute('data-statut', ins.statut || '');
                tr.setAttribute('data-session', ins.session || '');
                tr.setAttribute('data-formation', ins.formation || '');
                tr.setAttribute('data-formation-id', (typeof ins.formation_id !== 'undefined') ? (ins.formation_id || '') : (tr.getAttribute('data-formation-id') || ''));
                tr.setAttribute('data-date', ins.date_inscription || '');
                if(ins.prix_total !== undefined) tr.setAttribute('data-prix-total', ins.prix_total || '');
                if(typeof ins.formateur_id !== 'undefined'){
                  tr.setAttribute('data-formateur-id', ins.formateur_id || '');
                }
                if(typeof ins.formateur_name !== 'undefined'){
                  tr.setAttribute('data-formateur-name', ins.formateur_name || '');
                }
                // also update etudiant-related attributes when the edit changed student
                if(typeof ins.etudiant_id !== 'undefined'){
                  tr.setAttribute('data-etudiant-id', ins.etudiant_id || '');
                }
                // update visible groupe cell (4th column) if present
                try{
                  const groupeText = ins.groupe || '';
                  const targetRow = tr;
                  if(targetRow && targetRow.querySelector('td:nth-child(4)')){
                    targetRow.querySelector('td:nth-child(4)').textContent = groupeText;
                  }
                }catch(e){ console.warn('update groupe cell failed', e); }
                if(typeof ins.etudiant_nom !== 'undefined'){
                  tr.setAttribute('data-etudiant-name', ins.etudiant_nom || '');
                }
                if(typeof ins.etudiant_email !== 'undefined'){
                  tr.setAttribute('data-etudiant-email', ins.etudiant_email || '');
                }
                if(typeof ins.etudiant_phone !== 'undefined'){
                  tr.setAttribute('data-etudiant-phone', ins.etudiant_phone || '');
                }
                if(typeof ins.etudiant_photo !== 'undefined'){
                  tr.setAttribute('data-photo', ins.etudiant_photo || '');
                }
                if(typeof ins.remarques !== 'undefined'){
                  tr.setAttribute('data-remarques', ins.remarques || '');
                }

                // compute friendly formateur display: server -> match option text by id -> dataset fallback -> etudiant email
                let formateurDisplay = '';
                if (ins.formateur_name) formateurDisplay = ins.formateur_name;
                else if (ins.formateur_id){
                  try{
                    const fsel = document.getElementById('editFormateur') || document.querySelector('#addInsForm select[name="formateur"]');
                    if(fsel){ const opt = Array.from(fsel.options||[]).find(o => String(o.value) === String(ins.formateur_id)); if(opt) formateurDisplay = (opt.text||'').trim(); }
                  }catch(e){}
                }
                if(!formateurDisplay) formateurDisplay = tr.getAttribute('data-formateur-name') || tr.getAttribute('data-etudiant-email') || '';

                // Rebuild the row HTML so all visible cells are consistent with returned data
                const etuName = (typeof ins.etudiant_nom !== 'undefined') ? (ins.etudiant_nom || '') : (tr.getAttribute('data-etudiant-name') || '');
                const etuPhone = (typeof ins.etudiant_phone !== 'undefined') ? (ins.etudiant_phone || '') : (tr.getAttribute('data-etudiant-phone') || '');
                const formationText = ins.formation || '';
                const dateText = ins.date_inscription || '';
                const groupeText = ins.groupe || '';
                const statutBadge = normalizeStatutBadge(ins.statut || '');
                const statutText = statutBadge.text;
                const statutCls = statutBadge.cls;

                tr.innerHTML = `
                  <td class="px-6 py-4 font-semibold">${etuName}</td>
                  <td class="px-6 py-4">${formateurDisplay}</td>
                  <td class="px-6 py-4">${etuPhone}</td>
                  <td class="px-6 py-4">${formationText}</td>
                  <td class="px-6 py-4">${dateText}</td>
                  <td class="px-6 py-4">${groupeText}</td>
                  <td class="px-6 py-4"><span class="${statutCls} px-3 py-1 rounded-full text-xs font-semibold">${statutText}</span></td>
                  <td class="px-6 py-4 text-right">
                    <button class="action-icon-btn action-view view-btn" title="Voir" aria-label="Voir"><span class="material-icons">visibility</span></button>
                    <button class="action-icon-btn action-delete delete-ins-btn delete-btn icon-btn" data-id="${ins.id}" title="Supprimer" aria-label="Supprimer">
                      <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12z" fill="#ef4444"/><path d="M19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="#ef4444"/></svg>
                    </button>
                  </td>
                `;

                // re-run filters and reattach handlers so UI immediately reflects changes
                try{ filterInscriptions(); }catch(e){}
                try{ attachDblclickForEdit(); }catch(e){}
                // no animation requested for updated row
              }
              closeEditInsModal();
            } else {
              alert('Erreur: '+(json.error||''));
            }
          }).catch(err=>{ console.error(err);
            try{
              const raw = (err && err.message) ? String(err.message) : 'vérifier la connexion';
              // If server returned HTML (non-JSON) we ignore the JSON error and close the edit modal
              if (raw && raw.trim().startsWith('<')){
                console.warn('Server returned non-JSON response for editInsForm; closing edit modal.');
                try{ closeEditInsModal(); }catch(e){}
                return;
              }
              let g = document.getElementById('editInsFormGlobalError');
              const formEl = document.getElementById('editInsForm');
              if(!g){ g = document.createElement('div'); g.id = 'editInsFormGlobalError'; g.className = 'text-sm text-red-600 mt-2'; formEl.insertBefore(g, formEl.firstChild); }
              let msg = raw;
              try{ const p = JSON.parse(raw); if(p && (p.error||p.message)) msg = p.error||p.message; }catch(e){}
              g.textContent = msg;
            }catch(e){ alert('Erreur réseau'); }
          });
        });

        // Delete inscription flow: show confirmation modal and POST to server
        const insDeleteModal = document.createElement('div');
        insDeleteModal.id = 'insDeleteModal';
        insDeleteModal.className = 'hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop';
        insDeleteModal.innerHTML = `
          <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-md p-6">
            <h3 class="text-lg font-semibold mb-2">Confirmer la suppression</h3>
            <p class="text-sm text-gray-600 mb-4">Voulez-vous supprimer cette inscription ? Cette action ne peut pas être annulée.</p>
            <div class="flex justify-end space-x-3">
              <button id="cancelInsDeleteBtn" class="btn-secondary py-2 px-4 rounded">Annuler</button>
              <button id="confirmInsDeleteBtn" class="btn-danger py-2 px-4 rounded">Supprimer</button>
            </div>
          </div>
        `;
        document.body.appendChild(insDeleteModal);
        let _pendingInsDeleteId = null;

        document.addEventListener('click', function(e){
          const del = e.target.closest('.delete-ins-btn');
          if (del){
            e.preventDefault();
            _pendingInsDeleteId = del.dataset.id;
            insDeleteModal.classList.remove('hidden');
          }
        });

        document.getElementById('cancelInsDeleteBtn').addEventListener('click', function(){
          _pendingInsDeleteId = null; insDeleteModal.classList.add('hidden');
        });

        document.getElementById('confirmInsDeleteBtn').addEventListener('click', function(){
          if (!_pendingInsDeleteId){ insDeleteModal.classList.add('hidden'); return; }
          const fd = new FormData(); fd.append('id', _pendingInsDeleteId);
          fetch('{% url "inscriptions_delete" %}', { method: 'POST', headers: {'X-CSRFToken': csrftoken}, body: fd }).then(r=>r.json()).then(json=>{
            if (json.success){
              const tr = document.querySelector('#inscriptionsTbody tr[data-id="'+_pendingInsDeleteId+'"]');
              if (tr) tr.remove();
            } else {
              alert('Erreur: '+(json.error||''));
            }
          }).catch(err=>{ console.error(err);
            try{
              const md = document.getElementById('insDeleteModal');
              if(md){
                let errEl = md.querySelector('.ins-delete-error');
                if(!errEl){ errEl = document.createElement('div'); errEl.className = 'ins-delete-error text-sm text-red-600 mt-2'; md.querySelector('div').appendChild(errEl); }
                const raw = (err && err.message) ? String(err.message) : 'vérifier la connexion';
                let parsed = null;
                try{ parsed = JSON.parse(raw); }catch(e){ parsed = null; }
                const msg = (parsed && (parsed.error||parsed.message)) ? (parsed.error||parsed.message) : raw;
                errEl.textContent = 'Erreur réseau: ' + msg;
              }
            }catch(e){}
          }).finally(()=>{ _pendingInsDeleteId = null; insDeleteModal.classList.add('hidden'); });
        });

        // Manage showing/hiding of addInsModal when addStudentModal is opened
        (function(){
          const btn = document.getElementById('quickInsBtn') || document.getElementById('modalQuickInsBtn');
          const addStudentModal = document.getElementById('addStudentModal');
          const addInsModalEl = document.getElementById('addInsModal');
          // track whether we hid the inscriptions modal so we only restore when appropriate
          let _weHiddenInsModal = false;

          window.showAddStudentModal = function(){
            if (addInsModalEl && !addInsModalEl.classList.contains('hidden')){
              addInsModalEl.classList.add('hidden');
              _weHiddenInsModal = true;
            } else {
              _weHiddenInsModal = false;
            }
            if (addStudentModal) addStudentModal.classList.remove('hidden');
          };

          window.hideAddStudentModal = function(){
            if (addStudentModal) addStudentModal.classList.add('hidden');
            if (_weHiddenInsModal && addInsModalEl) addInsModalEl.classList.remove('hidden');
            _weHiddenInsModal = false;
          };

          if(btn && addStudentModal){
            btn.addEventListener('click', function(e){
              if(e && e.preventDefault) e.preventDefault();
              showAddStudentModal();
            });
          }

          // Also if user clicks outside modal to close (optional UX), ensure restore
          addStudentModal.addEventListener('click', function(e){
            if (e.target === addStudentModal){ hideAddStudentModal(); }
          });
        })();

        // Client-side filtering for inscriptions table
  const insSearch = document.getElementById('insSearch');
  const insDateType = document.getElementById('insDateType');
  const insGroupeFilter = document.getElementById('insGroupeFilter');
  const insEcoleFilter = document.getElementById('insEcoleFilter');
  const insFormationFilter = document.getElementById('insFormationFilter');

        function computeRangeForType(type){
          const now = new Date();
          if(!type) return { from: null, to: null };
          if(type === 'today'){
            const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const end = new Date(start); end.setHours(23,59,59,999);
            return { from: start, to: end };
          }
          if(type === 'this_week'){
            const day = now.getDay(); // 0..6 (Sun..Sat)
            const diffToMonday = (day + 6) % 7; // Monday as first day
            const monday = new Date(now); monday.setDate(now.getDate() - diffToMonday); monday.setHours(0,0,0,0);
            const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6); sunday.setHours(23,59,59,999);
            return { from: monday, to: sunday };
          }
          if(type === 'this_month'){
            const start = new Date(now.getFullYear(), now.getMonth(), 1); start.setHours(0,0,0,0);
            const end = new Date(now.getFullYear(), now.getMonth()+1, 0); end.setHours(23,59,59,999);
            return { from: start, to: end };
          }
          return { from: null, to: null };
        }

        function filterInscriptions(){
          const q = insSearch.value.toLowerCase();
          const type = insDateType ? insDateType.value : '';
          const range = computeRangeForType(type);
          const from = range.from; const to = range.to;
          const grp = insGroupeFilter.value;
          const ecole = insEcoleFilter ? insEcoleFilter.value : '';
          const formationFilterVal = insFormationFilter ? insFormationFilter.value : '';
          document.querySelectorAll('#inscriptionsTbody tr').forEach(tr => {
            const name = (tr.dataset.etudiantName || '').toLowerCase();
            const formation = (tr.dataset.formation || '').toLowerCase();
            const dateStr = tr.dataset.date || (tr.children[4] ? tr.children[4].textContent.trim() : '');
            let dateOk = true;
            if ((from || to) && dateStr){
              const d = new Date(dateStr);
              if (from && d < from) dateOk = false;
              if (to && d > to) dateOk = false;
            }
            const grpOk = !grp || (tr.dataset.groupe && tr.dataset.groupe === grp);
            const formationVal = (tr.dataset.formation || '').trim();
            const formationOk = !formationFilterVal || (formationVal && formationVal === formationFilterVal);
            const textOk = q === '' || name.includes(q) || formation.includes(q) || (tr.dataset.etudiantEmail||'').toLowerCase().includes(q);
            const ecoleVal = (tr.dataset.ecole || '').trim();
            const ecoleOk = !ecole || (ecoleVal && ecoleVal === ecole);
            tr.style.display = (textOk && dateOk && grpOk && ecoleOk && formationOk) ? '' : 'none';
          });
          // update visible count after filtering
          try{ updateInsCount(); }catch(e){}
        }
        // Normalize statut to friendly label + class
        function normalizeStatutBadge(raw){
          const s = (raw||'').toString().trim();
          const lower = s.toLowerCase();
          if (lower === 'inscrit' || lower === 'inscription' || lower === 'ok') return { text: 'Inscrit', cls: 'status-inscrit' };
          if (lower === 'non inscrit' || lower === 'non-inscrit' || lower === 'non' || lower === 'no') return { text: 'Non inscrit', cls: 'status-autre' };
          // default: reuse provided text but decide class by presence of word 'inscrit'
          return { text: s || '', cls: (lower.indexOf('inscrit') !== -1) ? 'status-inscrit' : 'status-autre' };
        }
  if (insSearch) insSearch.addEventListener('input', filterInscriptions);
  if (insDateType) insDateType.addEventListener('change', filterInscriptions);
  if (insGroupeFilter) insGroupeFilter.addEventListener('change', filterInscriptions);
  if (insEcoleFilter) insEcoleFilter.addEventListener('change', filterInscriptions);
  if (insFormationFilter) insFormationFilter.addEventListener('change', filterInscriptions);
  // initialize filters on page load
  try{ filterInscriptions(); }catch(e){}

  // Apply decorative badges for École column (color per school)
  (function(){
    const schoolColors = {
      'Genie Systeme': '#0ea5a4', // teal
      'Pixel School': '#6366f1', // indigo
      'Jura School': '#f97316' // orange
    };
    function decorateSchools(){
      document.querySelectorAll('#inscriptionsTbody tr').forEach(tr=>{
        const ecell = tr.querySelector('td:nth-child(7)');
        if(!ecell) return;
        const name = (ecell.textContent||ecell.innerText||'').trim();
        const color = schoolColors[name] || null;
        // build badge
        const badge = document.createElement('span'); badge.className = 'ecole-badge';
        const dot = document.createElement('span'); dot.className = 'ecole-dot';
        if(color) dot.style.background = color; else dot.style.background = '#94a3b8';
        const text = document.createElement('span'); text.textContent = name || '-';
        // subtle decorative underline for known schools
        if(color){ badge.style.background = 'linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0))'; badge.style.border = '1px solid rgba(0,0,0,0.04)'; }
        // clear cell and insert badge
        ecell.innerHTML = ''; ecell.appendChild(badge);
        badge.appendChild(dot); badge.appendChild(text);
        // mark row as known to apply hover style
        if(color) tr.classList.add('ecole-known'); else tr.classList.remove('ecole-known');
      });
    }
    // run after filtering and after rows modified
    try{ window.decorateSchools = decorateSchools; }catch(e){}
    const origFilter = filterInscriptions;
    filterInscriptions = function(){ origFilter(); try{ decorateSchools(); }catch(e){} }; 
      // Update the counter after decorations/filtering
      const origDecorate = decorateSchools;
      decorateSchools = function(){ origDecorate(); try{ updateInsCount(); }catch(e){} };
    // ensure decoration runs on initial load and after dynamic inserts
    try{ decorateSchools(); }catch(e){}
  })();

  // Update the inscriptions counter in the header (number of visible rows)
  function updateInsCount(){
    const el = document.getElementById('insCount');
    if(!el) return;
    const rows = Array.from(document.querySelectorAll('#inscriptionsTbody tr'));
    const visible = rows.filter(r => r.style.display !== 'none').length;
    const numEl = el.querySelector('.ins-count-number');
    const subEl = el.querySelector('.ins-count-sub');
    if(numEl) numEl.textContent = visible;
    if(subEl) subEl.textContent = (visible <= 1 ? 'inscription' : 'inscriptions');
  }

  // Search input micro-interactions
  (function(){
    const wrapper = document.querySelector('.search-wrapper');
    const input = document.getElementById('insSearch');
    const clearBtn = document.getElementById('insClearBtn');
    if (!input) return;
    function updateClear(){ if(input.value && clearBtn){ clearBtn.classList.add('show'); } else if(clearBtn){ clearBtn.classList.remove('show'); } }
    input.addEventListener('input', function(){ updateClear(); });
    input.addEventListener('focus', function(){ if(wrapper) wrapper.classList.add('focused'); updateClear(); });
    input.addEventListener('blur', function(){ if(wrapper) wrapper.classList.remove('focused'); });
  if (clearBtn){ clearBtn.addEventListener('click', function(e){ e.preventDefault();
    // ripple animation
    const r = document.createElement('span'); r.className='ripple'; clearBtn.appendChild(r);
    r.style.left = '50%'; r.style.top = '50%'; r.style.transform = 'translate(-50%,-50%) scale(0)';
    requestAnimationFrame(()=>{ r.style.transform = 'translate(-50%,-50%) scale(10)'; r.style.opacity='0'; r.style.transition='transform .45s ease, opacity .45s ease'; });
    setTimeout(()=>{ try{ clearBtn.removeChild(r); }catch(e){} }, 500);
    input.value = ''; input.focus(); updateClear(); filterInscriptions(); }); }
    updateClear();
  })();

        // If page opened with ?etudiant_id=... then auto-open add modal and prefill etudiant field
        (function(){
          try{
            const params = new URLSearchParams(window.location.search);
            const etuId = params.get('etudiant_id');
            if (etuId){
              // open modal and prefill input
              addInsModal.classList.remove('hidden');
              const input = document.querySelector('#addInsForm input[name="etudiant"]');
              if (input) input.value = etuId;
            }
          }catch(e){ console.error(e); }
        })();

        // (print handler removed) 

        // Export visible table as CSV (Excel-friendly, semicolon-separated, UTF-8 BOM)
        (function(){
          const btn = document.getElementById('exportCsvBtn'); if(!btn) return;
          function escapeCsvSemicolon(val){ if(val === null || val === undefined) return ''; const s = String(val).replace(/"/g, '""'); return '"'+s+'"'; }
          btn.addEventListener('click', function(){
            try{
              const tbl = document.querySelector('#tableView table'); if(!tbl) return alert('Table non trouvée');
              const rows = [];
              // header: take th texts except last 'Actions'
              const ths = Array.from(tbl.querySelectorAll('thead th'));
              if(ths.length>0){
                const header = ths.slice(0, ths.length-1).map(h => (h.textContent||h.innerText||'').trim());
                rows.push(header.map(escapeCsvSemicolon).join(';'));
              }
              // body: only visible rows (use computed style to detect hidden)
              tbl.querySelectorAll('tbody tr').forEach(tr=>{
                const style = window.getComputedStyle(tr);
                if(style && style.display === 'none') return; // skip hidden
                const tds = Array.from(tr.querySelectorAll('td'));
                const useTds = tds.slice(0, Math.max(0, tds.length-1));
                const values = useTds.map(td => {
                  const badge = td.querySelector('.ecole-badge');
                  if(badge) return (badge.textContent||'').trim();
                  return (td.textContent||td.innerText||'').trim();
                });
                rows.push(values.map(escapeCsvSemicolon).join(';'));
              });
              // prepend UTF-8 BOM for Excel compatibility
              const BOM = '\uFEFF';
              const csv = BOM + rows.join('\r\n');
              const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a'); a.href = url; a.download = 'inscriptions.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
            }catch(e){ console.error('export csv error', e); alert('Erreur lors de l\'export'); }
          }, { passive: true });
        })();

        // Handle inline add student from inscriptions page: submit to etudiants_add and optionally prefill inscription form
        document.getElementById('addStudentInlineForm').addEventListener('submit', function(e){
          e.preventDefault();
          const form = e.target;
          // client-side validation: NIN must be 18 digits, telephone must be 10 or 11 digits
          const ninInput = form.querySelector('input[name="nin"]');
          const telInput = form.querySelector('input[name="telephone"]');
          const ninErrEl = document.getElementById('ninErrorAdd');
          const ninMsg = document.getElementById('ninErrorAddMsg');
          const telErrEl = document.getElementById('telErrorAdd');
          const telMsg = document.getElementById('telErrorAddMsg');
          if (ninErrEl && ninMsg) { ninMsg.textContent=''; ninErrEl.classList.add('hidden'); }
          if (telErrEl && telMsg) { telMsg.textContent=''; telErrEl.classList.add('hidden'); }
          if (ninInput && ninInput.value){ if(!/^\d{18}$/.test(ninInput.value.trim())){ if(ninErrEl && ninMsg){ ninMsg.textContent='Le NIN doit contenir exactement 18 chiffres'; ninErrEl.classList.remove('hidden'); ninInput.focus(); } return; } }
          if (telInput && telInput.value){ const digits = (telInput.value || '').replace(/\D/g,''); if(!/^\d{10,11}$/.test(digits)){ if(telErrEl && telMsg){ telMsg.textContent='Le téléphone doit contenir 10 ou 11 chiffres'; telErrEl.classList.remove('hidden'); telInput.focus(); } return; } }
          const data = new FormData(form);
          fetch('{% url "etudiants_add" %}', {
            method: 'POST', headers: {'X-CSRFToken': csrftoken}, body: data, credentials: 'same-origin'
          }).then(r => {
            if (!r.ok) return r.text().then(text => { throw new Error(text || r.statusText); });
            return r.json();
          }).then(json => {
            if (json.success){
              // if the add-inscription modal is open, prefill its etudiant field with newly created id
              const insModal = document.getElementById('addInsModal');
              if (insModal && !insModal.classList.contains('hidden')){
                const hidden = document.querySelector('#addInsForm input[name="etudiant"]');
                if (hidden) hidden.value = json.student.id;
                const combo = document.getElementById('studentComboInput'); if(combo) combo.value = (json.student.nom||'') + ' ' + (json.student.prenom||'');
              }
              // ensure the combo list is updated so the new student can be selected without reload
              if (typeof addComboItemToStudentCombo === 'function'){
                addComboItemToStudentCombo(json.student);
                // also update hidden value if present
                const hiddenComboVal = document.getElementById('studentComboValue'); if(hiddenComboVal) hiddenComboVal.value = json.student.id;
              }
              // close modal (use helper to restore inscriptions modal if needed)
              if (typeof hideAddStudentModal === 'function') hideAddStudentModal();

              // If the students list exists on this page, insert the new student row/card so it's visible immediately
              try{
                const s = json.student; // returned by add_etudiant: id, nom, prenom, email, telephone, formation, photo, statut
                const inscriptionsUrl = "{% url 'inscriptions' %}";
                const DEFAULT_AVATAR = "{% static 'images/happy.gif' %}";
                const tbody = document.getElementById('studentsTbody');
                const avatar = s.photo || DEFAULT_AVATAR;
                const remainingFees = (typeof s.remaining_fees !== 'undefined') ? s.remaining_fees : 0;
                const inscriptionStatus = s.inscription_status || (s.statut && s.statut.toLowerCase() === 'inscrit' ? 'inscrit' : 'non inscrit');

                if (tbody){
                  const tr = document.createElement('tr');
                  tr.className = 'border-b student-row';
                  tr.dataset.id = s.id; tr.dataset.name = (s.nom||'') + ' ' + (s.prenom||''); tr.dataset.email = s.email || ''; tr.dataset.phone = s.telephone || '';
                  tr.dataset.address = s.adresse || ''; tr.dataset.remaining = remainingFees; tr.dataset.status = s.statut || 'Actif'; tr.dataset.photo = s.photo || '';
                  tr.innerHTML = `
                    <td class="px-6 py-4 font-mono text-sm">${s.id}</td>
                    <td class="px-6 py-4"><img src="${avatar}" onerror="this.src='${DEFAULT_AVATAR}'" class="w-10 h-10 rounded-full"/></td>
                    <td class="px-6 py-4 font-semibold">${(s.nom||'') + ' ' + (s.prenom||'')}</td>
                    <td class="px-6 py-4">${s.telephone || '-'}</td>
                    <td class="px-6 py-4">${s.adresse || '-'}</td>
                    <td class="px-6 py-4 text-red-600 font-semibold">${(Number(remainingFees)||0).toFixed(2)} DZD</td>
                    <td class="px-6 py-4">${inscriptionStatus === 'inscrit' ? '<span class="status-actif px-3 py-1 rounded-full text-xs font-semibold">Inscrit</span>' : `<a href="${inscriptionsUrl}?etudiant_id=${s.id}" class="status-inactif px-3 py-1 rounded-full text-xs font-semibold open-add-inscription" data-etudiant="${s.id}" data-etudiant-name="${(s.nom||'') + ' ' + (s.prenom||'')}">Non inscrit</a>`}</td>
                    <td class="px-6 py-4 text-right"><button class="edit-btn icon-btn" title="Modifier">...</button></td>
                  `;
                  tbody.prepend(tr);
                }

                // Card view
                const cardView = document.getElementById('cardView');
                if (cardView){
                  const card = document.createElement('div');
                  card.className = 'bg-white rounded-xl shadow p-6 flex flex-col items-center student-row';
                  card.dataset.id = s.id;
                  card.innerHTML = `
                    <img src="${avatar}" onerror="this.src='${DEFAULT_AVATAR}'" class="w-20 h-20 rounded-full mb-4"/>
                    <h3 class="text-lg font-semibold">${(s.nom||'') + ' ' + (s.prenom||'')}</h3>
                    <p class="text-gray-500">${s.telephone || '-'}</p>
                    <p class="text-gray-500">${s.adresse || '-'}</p>
                    <p class="text-gray-500">Frais restants: <span class="text-red-600 font-semibold">${(Number(remainingFees)||0).toFixed(2)} DZD</span></p>
                    ${inscriptionStatus === 'inscrit' ? '<span class="status-actif px-3 py-1 rounded-full text-xs font-semibold mt-3">Inscrit</span>' : `<a href="${inscriptionsUrl}?etudiant_id=${s.id}" class="status-inactif px-3 py-1 rounded-full text-xs font-semibold mt-3 open-add-inscription" data-etudiant="${s.id}" data-etudiant-name="${(s.nom||'') + ' ' + (s.prenom||'')}">Non inscrit</a>`}
                    <div class="flex space-x-4 mt-4"><button class="edit-btn icon-btn">...</button><button class="delete-btn icon-btn">...</button></div>
                  `;
                  cardView.prepend(card);
                }
              }catch(e){ console.warn('Could not append student to students list:', e); }
            } else {
              // inline NIN error if present in response
              const ninErrEl = document.getElementById('ninErrorAdd');
              const ninMsg = document.getElementById('ninErrorAddMsg');
              if (ninErrEl && ninMsg && json.error && json.error.toLowerCase().indexOf('nin') !== -1){
                ninMsg.textContent = json.error; ninErrEl.classList.remove('hidden');
              } else if (ninErrEl && ninMsg && json.error && json.error.toLowerCase().indexOf('tel') !== -1){
                // if server mentions telephone, reuse same container but show message
                ninMsg.textContent = json.error; ninErrEl.classList.remove('hidden');
              } else {
                // fallback: show simple inline form-level error if available, otherwise console
                const formErrId = 'addStudentInlineFormGlobalError';
                let g = document.getElementById(formErrId);
                if(!g){ g = document.createElement('div'); g.id = formErrId; g.className='text-sm text-red-600 mt-2'; const ref = form.querySelector('div'); form.insertBefore(g, ref); }
                g.textContent = json.error || 'Erreur lors de la création';
              }
            }
          }).catch(err => {
            console.error(err);
            // err.message may contain server JSON text when we threw Error(text)
            const raw = (err && err.message) ? String(err.message) : '';
            let parsed = null;
            try{ parsed = JSON.parse(raw); }catch(e){ parsed = null; }
            const ninErrEl = document.getElementById('ninErrorAdd');
            const ninMsg = document.getElementById('ninErrorAddMsg');
            if(parsed && parsed.error){
              const errText = String(parsed.error || parsed.message || raw || 'Erreur serveur');
              if(ninErrEl && ninMsg && errText.toLowerCase().indexOf('nin') !== -1){ ninMsg.textContent = errText; ninErrEl.classList.remove('hidden'); }
              else if(ninErrEl && ninMsg && (errText.toLowerCase().indexOf('tel') !== -1 || errText.toLowerCase().indexOf('télé') !== -1)) { ninMsg.textContent = errText; ninErrEl.classList.remove('hidden'); }
              else {
                const formErrId = 'addStudentInlineFormGlobalError';
                let g = document.getElementById(formErrId);
                if(!g){ g = document.createElement('div'); g.id = formErrId; g.className='text-sm text-red-600 mt-2'; const ref = form.querySelector('div'); form.insertBefore(g, ref); }
                g.textContent = errText;
              }
            } else {
              // network fallback: show inline message rather than blocking alert
              const formErrId = 'addStudentInlineFormGlobalError';
              let g = document.getElementById(formErrId);
              if(!g){ g = document.createElement('div'); g.id = formErrId; g.className='text-sm text-red-600 mt-2'; const ref = form.querySelector('div'); form.insertBefore(g, ref); }
              g.textContent = 'Erreur réseau: ' + (raw || 'vérifier la connexion');
            }
          });
        });

        // Clear inline NIN and telephone errors when user types in the inline add student modal
        (function(){
          const ninInline = document.querySelector('#addStudentInlineForm #nin');
          if (ninInline){ ninInline.addEventListener('input', function(){ const el = document.getElementById('ninErrorAdd'); if (el){ const msg = document.getElementById('ninErrorAddMsg'); if(msg) msg.textContent=''; el.classList.add('hidden'); } }); }
          const telInline = document.querySelector('#addStudentInlineForm #telephone');
          if (telInline){ telInline.addEventListener('input', function(){ const el = document.getElementById('telErrorAdd'); if (el){ const msg = document.getElementById('telErrorAddMsg'); if(msg) msg.textContent=''; el.classList.add('hidden'); } }); }
        })();

        // Open read-only inscription fiche when clicking 'Voir'
        (function(){
          function tryPrefixMedia(path){
            if(!path) return path || '';
            const p = String(path || '');
            if(p.startsWith('http') || p.startsWith('/')) return p;
            try{ return ("{{ MEDIA_URL|default:'' }}"||'') + p; }catch(e){ return p; }
          }

          function formatDate(d){
            if(!d) return '';
            try{ if(window.fmtDateString) return window.fmtDateString(d); }catch(e){}
            try{ const dt = new Date(d); if(!isNaN(dt)) return dt.toLocaleString(); }catch(e){}
            return d;
          }

          function openFichaFromRow(tr){
            try{
              const photo = tryPrefixMedia(tr.dataset.photo || '');
              const etu = tr.dataset.etudiantName || '';
              const phone = tr.dataset.etudiantPhone || '';
              const email = tr.dataset.etudiantEmail || '';
              const formation = tr.dataset.formation || '';
              const date = tr.dataset.date || '';
              const groupe = tr.dataset.groupe || '';
              const formateur = tr.dataset.formateurName || '';
              const statut = tr.dataset.statut || '';
              const remarques = tr.dataset.remarques || '';

              const photoEl = document.getElementById('insViewPhoto'); if(photoEl) { photoEl.src = photo || '{% static "images/happy.gif" %}'; photoEl.style.transform='scale(1)'; }
              const etuEl = document.getElementById('insViewEtudiant'); if(etuEl) etuEl.textContent = etu;
              const phoneEl = document.getElementById('insViewPhone'); if(phoneEl) phoneEl.textContent = phone;
              // main details grid - remove email/formation/address from here (they are shown near photo)
              const dateEl = document.getElementById('insViewDate'); if(dateEl) dateEl.textContent = formatDate(date);
              const formationEl = document.getElementById('insViewFormation'); if(formationEl) formationEl.textContent = formation; // kept for accessibility but will be hidden in print layout
              // fill photo-bottom summary
              const photoEmailEl = document.getElementById('insViewPhotoBottomEmail'); if(photoEmailEl) photoEmailEl.textContent = email || '-';
              const photoFormationEl = document.getElementById('insViewPhotoBottomFormation'); if(photoFormationEl) photoFormationEl.textContent = formation || '-';
              const photoAddressEl = document.getElementById('insViewPhotoBottomAddress'); if(photoAddressEl) photoAddressEl.textContent = (tr.dataset.address || '-') || '-';
              const groupeEl = document.getElementById('insViewGroupe'); if(groupeEl) groupeEl.textContent = groupe;
              // Resolve formateur name: prefer dataset value, otherwise extract token from remarques and try to match select options
              function resolveFormateurName(tokenOrId, remarquesText){
                // if tokenOrId is present and not a digit-only id, return as-is
                if (tokenOrId && String(tokenOrId).trim()) return String(tokenOrId).trim();
                // try to parse remarques for a token like 'formateur:123' or 'formateur: 123'
                try{
                  const m = String(remarquesText||'').match(/formateur\s*:\s*(\d+)/i);
                  const id = m ? m[1] : null;
                  if (id){
                    // try to find a select option with that value in either edit or add formateur selects
                    const selects = Array.from(document.querySelectorAll('select[name="formateur"]'));
                    for(const s of selects){ const opt = Array.from(s.options||[]).find(o => String(o.value) === String(id)); if(opt) return (opt.text||opt.innerText||'').trim(); }
                  }
                }catch(e){ /* ignore */ }
                return '';
              }

              const resolvedFormateur = resolveFormateurName(formateur, remarques) || formateur || '';
              const formateurEl = document.getElementById('insViewFormateur'); if(formateurEl) { formateurEl.textContent = resolvedFormateur || '-'; }

              // Status badge polish
              const statusEl = document.getElementById('insViewStatus'); if(statusEl){
                const st = (statut||'').toString().trim();
                const isInscrit = st.toLowerCase() === 'inscrit';
                statusEl.textContent = st || '';
                statusEl.className = 'mt-3 px-3 py-1 rounded-full text-xs font-semibold';
                statusEl.classList.toggle('status-inscrit', isInscrit);
                statusEl.classList.toggle('status-autre', !isInscrit);
              }

              // Clean up and display remarques (remove any internal tokens like formateur:123)
              const remEl = document.getElementById('insViewRemarques');
              if(remEl){
                let cleaned = String(remarques || '').replace(/formateur\s*:\s*\d+/ig, '').trim();
                // remove leading punctuation or stray separators
                cleaned = cleaned.replace(/^[\s\-:;,\.]+/, '').trim();
                if(!cleaned){
                  // hide the remarks container row when empty
                  const parent = remEl.parentElement; if(parent) parent.style.display = 'none';
                } else {
                  // ensure parent visible
                  const parent = remEl.parentElement; if(parent) parent.style.display = '';
                  remEl.textContent = cleaned;
                }
              }

              const modal = document.getElementById('insViewModal'); if(modal) modal.classList.remove('hidden');
            }catch(e){ console.warn('openFichaFromRow error', e); }
          }

          // Click on photo to open a simple lightbox
          document.addEventListener('click', function(e){
            const p = e.target.closest('#insViewPhoto');
            if(p){
              const src = p.src;
              // create lightbox
              let lb = document.getElementById('simpleLightbox');
              if(!lb){ lb = document.createElement('div'); lb.id='simpleLightbox'; lb.style.position='fixed'; lb.style.inset='0'; lb.style.display='flex'; lb.style.alignItems='center'; lb.style.justifyContent='center'; lb.style.background='rgba(0,0,0,0.85)'; lb.style.zIndex=99999; lb.addEventListener('click', ()=>{ lb.remove(); }); const img = document.createElement('img'); img.id='simpleLightboxImg'; img.style.maxWidth='90%'; img.style.maxHeight='90%'; img.style.boxShadow='0 20px 60px rgba(0,0,0,0.6)'; lb.appendChild(img); document.body.appendChild(lb); }
              const img = document.getElementById('simpleLightboxImg'); if(img) img.src = src;
            }
          });

          document.addEventListener('click', function(e){
            const btn = e.target.closest('.view-btn');
            if(!btn) return;
            const tr = btn.closest('tr'); if(!tr) return;
            openFichaFromRow(tr);
          });

          const closeBtn = document.getElementById('closeInsView'); if(closeBtn) closeBtn.addEventListener('click', ()=>{ const m = document.getElementById('insViewModal'); if(m) m.classList.add('hidden'); });
          const closeFooterBtn = document.getElementById('insViewCloseBtn'); if(closeFooterBtn) closeFooterBtn.addEventListener('click', ()=>{ const m = document.getElementById('insViewModal'); if(m) m.classList.add('hidden'); });
          const modalRoot = document.getElementById('insViewModal'); if(modalRoot) modalRoot.addEventListener('click', function(e){ if(e.target === modalRoot) modalRoot.classList.add('hidden'); });

          // previously we used dynamic transforms to reposition fields; now fields are in the photo column so no extra JS required
        })();

  </script>

  <script>
    // Populate group selects based on formation selection using formation_groups_json
    (function(){
  // `formation_groups_json` is a JSON string produced server-side; insert it safely as a JS object
  let formationGroups = {};
  try { formationGroups = JSON.parse('{{ formation_groups_json|default:"{}"|escapejs }}'); } catch(e) { formationGroups = {}; }

      const mainFormationSelect = document.querySelector('#addInsForm select[name="formation"]');
      const mainGroupeSelect = document.getElementById('addInsGroupeSelect');
      const inlineFormation = document.querySelector('#addInsInlineForm select[name="formation"]');
      const inlineGroupe = document.getElementById('inlineGroupeSelect');

      function buildOptionsFor(formationId, selectEl){
        selectEl.innerHTML = '';
        const opts = formationGroups[String(formationId)] || [];
        const placeholder = document.createElement('option'); placeholder.value=''; placeholder.textContent='-- Choisir groupe --'; selectEl.appendChild(placeholder);
        opts.forEach(o=>{
          // server sends: { id, nom, disabled, count, capacity }
          const opt = document.createElement('option');
          opt.value = o.id || (o.nom || '');
          const cap = (o.capacity !== undefined && o.capacity !== null) ? o.capacity : 16;
          opt.textContent = `${o.nom || opt.value} (${o.count || 0}/${cap})`;
          if(o.disabled) opt.disabled = true;
          selectEl.appendChild(opt);
        });
      }

      if (mainFormationSelect && mainGroupeSelect){
        mainFormationSelect.addEventListener('change', function(){ buildOptionsFor(this.value, mainGroupeSelect); });
      }
      // formation prices map for client-side display and discount calculation
      const formationPrices = {};
      try{
        {% for f in formations %}
          formationPrices['{{ f.id }}'] = parseFloat('{{ f.prix_etudiant|default_if_none:"0.00" }}') || 0.0;
        {% endfor %}
      }catch(e){ formationPrices = formationPrices || {}; }

      function computeFinalPrice(base, type, val){
        try{
          base = parseFloat(base) || 0.0;
          if(!type || type === 'none') return base.toFixed(2);
          const v = parseFloat(val) || 0.0;
          if(type === 'amount'){
            const p = Math.max(0, base - v);
            return p.toFixed(2);
          }
          if(type === 'percent'){
            const p = Math.max(0, base - (base * (v/100)));
            return p.toFixed(2);
          }
          return base.toFixed(2);
        }catch(e){ return (base||0).toFixed(2); }
      }

      // update add form price display when formation changes
      if (mainFormationSelect){
        mainFormationSelect.addEventListener('change', function(){
          try{
            const fid = this.value || '';
            const base = formationPrices[fid] || 0.0;
            const priceEl = document.getElementById('formationPriceDisplay');
            if(priceEl) priceEl.textContent = (base ? base.toFixed(2) : '-');
            const remiseType = document.getElementById('remiseType');
            const remiseValue = document.getElementById('remiseValue');
            const finalEl = document.getElementById('prixFinalDisplay');
            const hidden = document.getElementById('prixTotalHidden');
            const final = computeFinalPrice(base, remiseType ? remiseType.value : 'none', remiseValue ? remiseValue.value : 0);
            if(finalEl) finalEl.textContent = final;
            if(hidden) hidden.value = final;
          }catch(e){}
        });
          // initialize display for pre-selected formation
          try{ if(mainFormationSelect.value) mainFormationSelect.dispatchEvent(new Event('change')); }catch(e){}
      }

      // update final price when remise inputs change
      const remiseTypeEl = document.getElementById('remiseType');
      const remiseValueEl = document.getElementById('remiseValue');
      if(remiseTypeEl) remiseTypeEl.addEventListener('change', function(){
        try{
          const fid = mainFormationSelect ? (mainFormationSelect.value || '') : '';
          const base = formationPrices[fid] || 0.0;
          const final = computeFinalPrice(base, this.value, remiseValueEl ? remiseValueEl.value : 0);
          const finalEl = document.getElementById('prixFinalDisplay'); if(finalEl) finalEl.textContent = final;
          const hidden = document.getElementById('prixTotalHidden'); if(hidden) hidden.value = final;
        }catch(e){}
      });
      if(remiseValueEl) remiseValueEl.addEventListener('input', function(){
        try{
          const fid = mainFormationSelect ? (mainFormationSelect.value || '') : '';
          const base = formationPrices[fid] || 0.0;
          const type = remiseTypeEl ? remiseTypeEl.value : 'none';
          const final = computeFinalPrice(base, type, this.value);
          const finalEl = document.getElementById('prixFinalDisplay'); if(finalEl) finalEl.textContent = final;
          const hidden = document.getElementById('prixTotalHidden'); if(hidden) hidden.value = final;
        }catch(e){}
      });
      // edit modal: repopulate groupe when formation changes
      const editFormationSelect = document.getElementById('editFormation');
      const editGroupeSelect = document.getElementById('editGroupeSelect');
      if (editFormationSelect && editGroupeSelect){
        editFormationSelect.addEventListener('change', function(){ buildOptionsFor(this.value, editGroupeSelect); });
      }
      // recompute final price when session changes (keeps prix display live)
      const sessionSelect = document.getElementById('addInsSessionSelect');
      if(sessionSelect){
        sessionSelect.addEventListener('change', function(){
          try{
            const fid = mainFormationSelect ? (mainFormationSelect.value || '') : '';
            const base = formationPrices[fid] || 0.0;
            const type = remiseTypeEl ? remiseTypeEl.value : 'none';
            const val = remiseValueEl ? remiseValueEl.value : 0;
            const final = computeFinalPrice(base, type, val);
            const finalEl = document.getElementById('prixFinalDisplay'); if(finalEl) finalEl.textContent = final;
            const hidden = document.getElementById('prixTotalHidden'); if(hidden) hidden.value = final;
          }catch(e){}
        });
      }
      // inline form: the inline modal uses a select in the inline DOM (if present)
      const inlineSelect = document.querySelector('#addInsInlineModal select[name="formation"]');
      if(inlineSelect && inlineGroupe){ inlineSelect.addEventListener('change', function(){ buildOptionsFor(this.value, inlineGroupe); }); }
    })();
  </script>

  <script>
    // Print helper for inscriptions: fetch QR data URL and build a printable inscription card
    async function fetchQrDataUrlForIns(text){
      try{
        const data = encodeURIComponent(String(text || ''));
        const api = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${data}`;
        const resp = await fetch(api);
        if (!resp.ok) throw new Error('QR fetch failed');
        const blob = await resp.blob();
        return await new Promise((res, rej) => {
          const reader = new FileReader();
          reader.onload = () => res(reader.result);
          reader.onerror = rej;
          reader.readAsDataURL(blob);
        });
      }catch(err){ console.warn('fetchQrDataUrlForIns failed', err); return null; }
    }

    function buildPrintableInscription(i, qrDataUrl){
  const name = (i.name || i.etudiant_name || '').trim() || '';
      const formation = (i.formation || '').trim();
      const formateur = (i.formateur || '').trim();
      const groupe = (i.groupe || '').trim();
  const session = (i.session || '').trim();
  const dateIns = i.date_inscription ? (window.fmtDateString ? window.fmtDateString(i.date_inscription) : ((new Date(i.date_inscription)).toLocaleDateString())) : (i.date_inscription || '');
      const statut = i.statut || i.status || '';
      const remarques = i.remarques || '';
      const targetUrl = window.location.origin + '/etudiants/' + (i.etudiant_id || i.id || '') + '/';
      const qrImg = qrDataUrl || `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(targetUrl)}`;

      return `
  <div class="print-card" style="width:340px;min-height:180px;border:1px solid #e6eef6;padding:12px;border-radius:8px;margin:8px;display:inline-block;vertical-align:top;font-family:Arial,Helvetica,sans-serif;background:var(--print-card-bg, #fff);box-shadow:0 2px 6px rgba(2,6,23,0.04)">
      <div style="display:flex;gap:12px;align-items:flex-start">
    <div style="flex:1;min-width:0">
              <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
                <div style="min-width:0">
                  <div style="font-weight:800;font-size:15px;color:#0f172a;white-space:normal;word-break:break-word;">${name}</div>
                  <div style="font-size:12px;color:#374151;margin-top:6px">Inscription ID: ${i.id || ''}</div>
                  <div style="font-size:12px;color:#6b7280;margin-top:6px">Date d'inscription: ${dateIns}</div>
                  <div style="font-size:12px;color:#6b7280;margin-top:6px">Formation: ${formation}</div>
                  <div style="font-size:12px;color:#6b7280;margin-top:6px">Groupe: ${groupe}</div>
      <div style="font-size:12px;color:#6b7280;margin-top:6px">Session: ${session}</div>
                  <div style="font-size:12px;color:#6b7280;margin-top:6px">Formateur: ${formateur}</div>
                  <div style="font-size:12px;color:#6b7280;margin-top:6px">Statut: ${statut}</div>
                </div>
                <div style="flex:0 0 100px;text-align:center">
                  <img src="${qrImg}" alt="QR" style="width:90px;height:90px;object-fit:contain;border:1px solid #f1f5f9;padding:6px;background:var(--print-img-bg, #fff);border-radius:6px"/>
                </div>
              </div>
              ${remarques ? `<div style="margin-top:8px;font-size:12px;color:#1f2937">Remarques: <div style="font-size:12px;color:#374151;margin-top:4px;white-space:pre-wrap">${String(remarques).replace(/</g,'&lt;')}</div></div>` : ''}
            </div>
          </div>
        </div>
      `;
    }

    // static asset URLs used in JS (defined before handlers so defaults are available)
  const LOGO_URL = "{% if school_logo %}{{ school_logo }}{% else %}{% static 'school_logo.png' %}{% endif %}";
    const DEFAULT_AVATAR = "{% static 'images/default-avatar.png' %}";

    // Helper to open a printable window and inject minimal styles (matches rapports.html)
    function printHtml(html, title){
      const w = window.open('', '_blank');
      if(!w) { alert('Autorisez les pop-ups pour imprimer.'); return; }
      w.document.write('<!doctype html><html><head><meta charset="utf-8"><title>'+ (title||'Impression') +'</title>');
      w.document.write('<link href="{% static 'static/vendor/js/tailwind.js' %}" rel="stylesheet">');
      w.document.write('</head><body class="p-6">');
      w.document.write(html);
      w.document.write('</body></html>');
      w.document.close();
      // Delay to ensure styles load
      setTimeout(function(){ w.print(); }, 250);
    }

  // Delegated handler: open rapports page to print the fiche for this inscription
    document.addEventListener('click', function(e){
      const btn = e.target.closest('.ins-print-btn');
      if(!btn) return;
      e.preventDefault(); e.stopPropagation();
      const id = btn.dataset.id || btn.getAttribute('data-id');
      if(!id){ alert('ID introuvable'); return; }
      // try to build payload from DOM row and expose it to the opener so rapports.html can use it
      let payload = { id: id };
      try{
        const tr = document.querySelector(`tr[data-id="${CSS.escape(id)}"]`);
        if(tr){
          // read commonly available dataset attributes (support multiple attribute name variants)
          const rawName = tr.dataset.etudiantName || tr.getAttribute('data-etudiant-name') || tr.dataset.name || tr.getAttribute('data-name') || '';
          let nomVal = '';
          let prenomVal = '';
          if(rawName){
            const parts = rawName.trim().split(/\s+/);
            // If multiple tokens, treat last token as prenom and the rest as nom
            if(parts.length > 1){
              prenomVal = parts.pop() || '';
              nomVal = parts.join(' ') || '';
            } else {
              nomVal = parts.shift() || '';
              prenomVal = '';
            }
          }
          // Ensure photo path is prefixed with MEDIA_URL when necessary (same logic as the "voir" modal)
          function prefixMedia(path){
            if(!path) return path || '';
            const p = String(path || '');
            if(p.startsWith('http') || p.startsWith('/')) return p;
            try{ return ("{{ MEDIA_URL|default:'' }}" || '') + p; }catch(e){ return p; }
          }
          const rawPhoto = tr.dataset.photo || tr.getAttribute('data-photo') || "{% static 'images/default-avatar.png' %}";
          const photo = prefixMedia(rawPhoto);
          const email = tr.dataset.etudiantEmail || tr.getAttribute('data-etudiant-email') || tr.dataset.email || tr.getAttribute('data-email') || '';
          const tel = tr.dataset.etudiantPhone || tr.getAttribute('data-etudiant-phone') || tr.dataset.phone || tr.getAttribute('data-phone') || '';
          const adresse = tr.dataset.address || tr.getAttribute('data-address') || tr.getAttribute('data-adresse') || '';
          const dateNaiss = tr.dataset.dateNaissance || tr.getAttribute('data-date_naissance') || tr.getAttribute('data-date-naissance') || '';
          const lieuNaiss = tr.dataset.lieuNaissance || tr.getAttribute('data-lieu_naissance') || tr.getAttribute('data-lieu-naissance') || '';
          const situation = tr.dataset.situation || tr.getAttribute('data-situation') || tr.getAttribute('data-situation_etudiant') || '';
          const nin = tr.dataset.nin || tr.getAttribute('data-nin') || '';
          const nomAr = tr.dataset.nomAr || tr.getAttribute('data-nom_ar') || tr.getAttribute('data-nom-ar') || tr.dataset.nom_ar || '';
          const prenomAr = tr.dataset.prenomAr || tr.getAttribute('data-prenom_ar') || tr.getAttribute('data-prenom-ar') || tr.dataset.prenom_ar || '';

          payload = {
            id: id,
            etudiant_id: tr.dataset.etudiantId || tr.getAttribute('data-etudiant-id') || '',
            nom: nomVal,
            prenom: prenomVal,
            photo_url: photo,
            formation_text: tr.dataset.formation || tr.getAttribute('data-formation') || '',
            formateur_name: tr.dataset.formateurName || tr.getAttribute('data-formateur-name') || '',
            groupe: tr.dataset.groupe || tr.getAttribute('data-groupe') || '',
            date_inscription: tr.dataset.date || tr.getAttribute('data-date') || '',
            statut: tr.dataset.statut || tr.getAttribute('data-statut') || '',
            remarques: tr.dataset.remarques || tr.getAttribute('data-remarques') || '',
            email: email,
            telephone: tel,
            adresse: adresse,
            date_naissance: dateNaiss,
            lieu_naissance: lieuNaiss,
            profession: situation,
            nin: nin,
            nom_ar: nomAr,
            prenom_ar: prenomAr
          };
        }
      }catch(err){ console.warn('Could not read row dataset for print:', err); }

      // Build and print the full fiche locally via a hidden iframe (avoid popups)
  // static asset URLs used in JS

      function buildAndPrintFiche(s){
        try{
          // Use the same fiche markup as rapports.html (identical layout and content)
          const studentId = s.id || '';
          const fullname = ((s.nom||'') + ' ' + (s.prenom||'')).trim();
          const formation = s.formation_text || s.formation || '-';
          const email = s.email || '-';
          const tel = s.telephone || '-';
          const adresse = s.adresse || s.address || '-';
          const profession = s.profession || '';
          const pays = s.pays || s.country || 'Algérie';
          const wilaya = s.wilaya || s.region || '';
          const code_lecteur = s.code_lecteur || s.code || studentId || '';
          const date_naissance = s.date_naissance || s.date_naissance_string || '';
          const date_inscription = s.date_inscription || s.date_inscription_string || '';
          const nin = s.nin || s.national_id || '';
          const nom_ar = s.nom_ar || s.nom_arabic || '';
          const prenom_ar = s.prenom_ar || s.prenom_arabic || '';

          const qrPayloadObj = { id: studentId, name: fullname, code: code_lecteur };
          const qrPayload = JSON.stringify(qrPayloadObj);

          // helper to embed photo as data URL when possible (same-origin or relative URLs)
          function ensurePhotoDataUrl(src, cb){
            try{
              if(!src) return cb(src);
              if(String(src).startsWith('data:')) return cb(src);
              const isHttp = /^https?:\/\//i.test(src);
              const isSameOrigin = !isHttp || src.indexOf(window.location.origin) === 0;
              if(!isSameOrigin) return cb(src);
              fetch(src, { credentials: 'same-origin' }).then(function(res){
                if(!res.ok) return cb(src);
                return res.blob();
              }).then(function(blob){
                if(!blob) return cb(src);
                var reader = new FileReader();
                reader.onload = function(){ cb(reader.result); };
                reader.onerror = function(){ cb(src); };
                reader.readAsDataURL(blob);
              }).catch(function(){ cb(src); });
            }catch(e){ cb(src); }
          }

          const origPhoto = s.photo_url || DEFAULT_AVATAR;
          console.debug('[inscriptions] buildAndPrintFiche origPhoto:', origPhoto);

          function doPrintWithPhoto(photoForPrint){
            console.debug('[inscriptions] doPrintWithPhoto photoForPrint:', photoForPrint);
            // use QRCode lib to generate data URL asynchronously if available, fallback to google chart
            if(typeof QRCode !== 'undefined' && QRCode.toDataURL){
              QRCode.toDataURL(qrPayload, { width: 150 }, function(err, qrDataUrl){
                const qrSrc = (!err && qrDataUrl) ? qrDataUrl : ('https://chart.googleapis.com/chart?cht=qr&chs=150x150&chl=' + encodeURIComponent(qrPayload));
                const html = buildFicheHtml({SCHOOL_LOGO: LOGO_URL, photo: photoForPrint, fullname, formation, email, tel, adresse, profession, pays, wilaya, code_lecteur, date_naissance, date_inscription, nin, nom_ar, prenom_ar, qrSrc, s});
                if(typeof printHtml === 'function') return printHtml(html, ('fiche - ' + (s.nom||'')));
                var iframe = document.createElement('iframe');
                iframe.style.position = 'fixed'; iframe.style.right='0'; iframe.style.bottom='0'; iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0'; iframe.style.visibility='hidden';
                document.body.appendChild(iframe);
                var idoc = iframe.contentWindow.document; idoc.open(); idoc.write(html); idoc.close();
                setTimeout(function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ console.warn('print iframe failed', e); } setTimeout(function(){ try{ iframe.remove(); }catch(e){} }, 600); }, 500);
              });
              return;
            }

            // If QR lib not present, build directly with Google Charts QR src
            const qrSrc = 'https://chart.googleapis.com/chart?cht=qr&chs=150x150&chl=' + encodeURIComponent(qrPayload);
            const html = buildFicheHtml({SCHOOL_LOGO: LOGO_URL, photo: photoForPrint, fullname, formation, email, tel, adresse, profession, pays, wilaya, code_lecteur, date_naissance, date_inscription, nin, nom_ar, prenom_ar, qrSrc, s});
            var iframe = document.createElement('iframe');
            iframe.style.position = 'fixed'; iframe.style.right='0'; iframe.style.bottom='0'; iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0'; iframe.style.visibility='hidden';
            document.body.appendChild(iframe);
            var idoc = iframe.contentWindow.document; idoc.open(); idoc.write(html); idoc.close();
            setTimeout(function(){ try{ iframe.contentWindow.focus(); iframe.contentWindow.print(); }catch(e){ console.warn('print iframe failed', e); } setTimeout(function(){ try{ iframe.remove(); }catch(e){} }, 600); }, 500);
          }

          // Try to convert the photo to a data URL when possible (same-origin) to ensure printing works inside iframe/window.
          try{
            ensurePhotoDataUrl(origPhoto, function(photoResolved){
              doPrintWithPhoto(photoResolved || origPhoto);
            });
          }catch(e){
            doPrintWithPhoto(origPhoto);
          }
        }catch(ex){ console.warn('buildAndPrintFiche error', ex); throw ex; }
      }

      // helper to build the fiche HTML (copied from rapports.html)
      function buildFicheHtml(ctx){
        const SCHOOL_LOGO = ctx.SCHOOL_LOGO;
        const s = ctx.s || {};
        const photo = ctx.photo || '';
        const fullname = ctx.fullname || ((s.nom||'') + (s.prenom ? (' ' + s.prenom) : '')).trim();
        // Derive nom / prenom: prefer explicit s.nom and s.prenom, otherwise split fullname
        let nomDisplay = (s.nom || '').trim();
        let prenomDisplay = (s.prenom || '').trim();
        // If explicit nom/prenom not provided, split fullname by whitespace.
        // Use the LAST token as prenom (given name) and the rest as nom (family name)
        if(!nomDisplay && fullname){
          const parts = fullname.split(/\s+/);
          if(parts.length > 1){
            prenomDisplay = parts.pop() || '';
            nomDisplay = parts.join(' ') || '';
          } else {
            nomDisplay = parts.shift() || '';
            prenomDisplay = '';
          }
        }
        const formation = ctx.formation || s.formation_text || s.formation || '';
        const email = ctx.email || s.email || s.etudiant_email || '-';
        const tel = ctx.telephone || ctx.tel || s.telephone || s.telephone || s.etudiant_phone || '-';
        const adresse = ctx.adresse || s.adresse || s.address || '-';
        const profession = ctx.profession || s.profession || s.situation || '';
        const pays = ctx.pays || s.pays || s.country || 'Algérie';
        const wilaya = ctx.wilaya || s.wilaya || s.region || '';
        const lieu_naissance = ctx.lieu_naissance || s.lieu_naissance || s.region || '';
        const code_lecteur = ctx.code_lecteur || ctx.code || s.code_lecteur || s.code || (s.id ? String(s.id) : '');
        const date_naissance = ctx.date_naissance || s.date_naissance || s.date_naissance_string || '';
        const date_inscription = ctx.date_inscription || s.date_inscription || s.date_inscription_string || '';

        // helper: format date to DD/MM/YYYY when possible
        function fmtDate(d){
          if(!d) return '';
          const s = String(d).trim();
          // ISO YYYY-MM-DD
          const m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
          if(m) return m[3] + '/' + m[2] + '/' + m[1];
          // already DD/MM/YYYY or DD-MM-YYYY
          const m2 = s.match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{4})/);
          if(m2) return m2[1] + '/' + m2[2] + '/' + m2[3];
          // fallback to Date parse
          const dt = new Date(s);
          if(isNaN(dt)) return s;
          const dd = String(dt.getDate()).padStart(2,'0');
          const mm = String(dt.getMonth()+1).padStart(2,'0');
          const yy = dt.getFullYear();
          return dd + '/' + mm + '/' + yy;
        }

  const date_naissance_display = (fmtDate(date_naissance) || '') + (lieu_naissance ? (' à ' + lieu_naissance) : '');
        const date_inscription_display = fmtDate(date_inscription) || '';
        const nin = ctx.nin || s.nin || s.national_id || '';
        // Arabic name fallbacks (some templates use nom_arabe/prenom_arabe)
        const nom_ar = ctx.nom_ar || s.nom_ar || s.nom_arabe || '';
        const prenom_ar = ctx.prenom_ar || s.prenom_ar || s.prenom_arabe || '';
        const qrSrc = ctx.qrSrc;

        // normalize photo src: if it's a relative path without leading slash, prefix origin so new window can load it
        let photoSrc = photo || '';
        try{
          if(photoSrc && !photoSrc.match(/^(data:|https?:|\/)/)){
            photoSrc = window.location.origin.replace(/\/$/, '') + '/' + photoSrc.replace(/^\/+/, '');
          }
          if(!photoSrc) photoSrc = DEFAULT_AVATAR;
        }catch(e){ photoSrc = photo || DEFAULT_AVATAR; }

        // Return a fragment (no full <!doctype html>) so it can be printed with printHtml which wraps the document
        let html = '';
        html += '<style>';
  html += '@page { margin: 0; }';
  html += '@media print { body { margin: 0; } }';
        html += '@media print { .genie-commitments, .genie-commitments-box, .genie-observation, .genie-signatures, .disponibilites-box { page-break-inside:avoid; page-break-after:avoid; break-inside:avoid; } }';
  html += '.genie-header { text-align:center; margin:0 0 8px 0; }';
  html += '.genie-title { font-weight:bold; font-size:32px; margin-bottom:6px; }';
  html += '.genie-subtitle { font-family:\'Gothic Heaven\', Arial, sans-serif; font-size:16px; line-height:1.2; color:#333; margin:2px 0 0 0; }';
  html += '.genie-form-title { text-align:center; font-weight:bold; font-size:24px; margin:6px 0 28px 0; text-decoration:underline; }';
  html += '.genie-soussigne { font-size:14px; margin-bottom:20px; font-weight:600; }';
  html += '.genie-main-grid { display:flex; gap:10px; margin-bottom:18px; align-items:flex-start; }';
        html += '.genie-photo-container { flex-shrink:0; }';
  html += '.genie-photo { width:132px; height:170px; border:1px solid #000; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#f6f6f6; }';
  // reduce right padding so the middle details can expand horizontally when printing
  html += '.genie-middle-section { flex:1; padding-right:60px; }';
  html += '.genie-middle-section * { font-size:12px !important; line-height:1.35 !important; font-family:"Trebuchet MS", Arial, sans-serif !important; }';
    html += '.genie-arabic-section { width:140px; flex-shrink:0; display:flex; flex-direction:column; justify-content:flex-start; }';
    html += '.genie-row { display:flex; gap:12px; margin-bottom:8px; }';
    html += '.genie-col { flex:1; }';
  // Labels normal weight, values bold
  html += '.genie-label { font-family:"Trebuchet MS", Arial, sans-serif; font-size:12px; color:#000; display:block; margin-bottom:6px; font-weight:400; }';
  html += '.genie-input { font-family:"Trebuchet MS", Arial, sans-serif; border:none; border-bottom:1px solid #000; padding:6px 8px; font-size:12px; background:transparent; min-height:20px; font-weight:700; }';
        html += '.genie-input-inline { display:inline-block; min-width:120px; border-bottom:1px solid #000; padding:2px 4px; }';
  html += '.genie-commitments { margin-top:80px; }';
  html += '.genie-commitments-table { width:100%; border-collapse:collapse; margin-top:12px; }';
  html += '.genie-commitments-table td { vertical-align:top; padding:10px; font-size:13px; }';
  html += '.genie-commitments-box { border:1px solid #000; padding:8px; }';
  html += '.genie-commitments-head { font-weight:bold; margin-bottom:6px; font-size:14px; }';
  html += '.genie-commitments-note { margin-top:8px; font-weight:bold; text-align:center; font-size:13px; }';
  // Keep signatures in normal flow on screen and during print so they appear once at the end
  html += '@media print { .genie-signatures { position:relative; } }';
  html += '.genie-signatures { display:flex; justify-content:space-between; margin:0 24px; page-break-inside:avoid; page-break-after:avoid; }';
  html += '.genie-signature-line { width:160px; border-bottom:1px solid #000; height:48px; margin-bottom:6px; }';
  html += '.genie-observation { margin-top:12px; font-size:13px; }';
        html += '</style>';

  // make the fiche container full-width so absolutely-positioned logo/QR can sit at page edges
  // make fiche container full page height so absolute positioning inside can anchor to page edges
  html += '<div style="width:100%;position:relative;height:100vh;background:#fff;">';
  // Place logo and QR inside the fiche container (absolute) so they print once on the fiche
  // (using absolute instead of fixed prevents duplication across printed pages)
  // position logo and QR at the very top so header sits close to the page edge
  html += '<img src="'+ SCHOOL_LOGO +'" alt="Logo" style="position:absolute; left:13px; top:5px; width:140px; height:140px; object-fit:cover; object-position:center center; background:#fff; border-radius:0; margin:0; padding:0;"/>';
  // keep QR at the top-right inside the container (fixed size to match logo)
  html += '<img src="'+ qrSrc +'" alt="QR Code" style="position:absolute; right:19px; top:15px; width:120px; height:120px; object-fit:contain; margin:0; padding:0;"/>';
  // minimal top spacer so header sits at the top of the printable area
  html += '<div style="height:0px; display:block; width:100%;"></div>';
  // inner centered content wrapper (fixed printable width)
  // render the centered header (kept at the top under logo/QR)
  // lift the text-only header higher without touching logo/QR
  html += '<div style="width:96%; max-width:820px; position:absolute; left:50%; transform:translateX(-50%); top:6px; margin:0; padding:6px 12px; box-sizing:border-box; font-family:Arial, sans-serif; color:#000; z-index:10;">';
  html += '<div class="genie-header">';
  html += '<div  style="font-family:Cooper"class="genie-title">Génie Système School</div>';
  html += '<div class="genie-subtitle">Ecole de Langues et Consulting dans les nouvelles technologies</div>';
  html += '<div class="genie-subtitle">Bureau d\'étude en informatique, incubateur d\'entreprise</div>';
  html += '<div class="genie-subtitle">developemment logiciels et sites web</div>';
  html += '</div>';
  html += '</div>';
  // gg my man: centered and absolutely anchored to the bottom of the page
  html += '<div style="width:96%; max-width:880px;position:absolute;left:50%;transform:translateX(-50%);top:120px;padding:10px 12px;box-sizing:border-box;font-family:Arial, sans-serif;color:#000;">';
  html += '<div class="genie-form-title">Fiche d\'engagement et d\'inscription de l\'étudiant</div>';
        html += '<div class="genie-main-grid">';
        // helper to escape text used in HTML fragments
        function escHtmlRaw(s){ try{ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }catch(e){ return ''; } }
        html += '<div class="genie-photo-container">';
        html += '<div class="genie-photo"><img src="'+ photoSrc + '" alt="Photo" onerror="this.src=\''+ DEFAULT_AVATAR +'\'" style="width:100%; height:100%; object-fit:cover;"/></div>';
  // (removed photo-bottom narrow block) — fields will be displayed full-width below the main grid
        html += '</div>';
        html += '<div class="genie-middle-section">';
  const LABEL_W = 90;
  // place the 'Je soussigné(e)' immediately above the name field so it aligns with the Nom column
  html += '<div class="genie-soussigne">Je soussigné(e) :</div>';
          html += '<div style="display:flex; gap:4px; margin-bottom:12px;">';
        html += '<div style="flex:1; display:flex; align-items:center;">';
    html += '<div style="width:56px; font-size:13px; color:#111; font-weight:400; line-height:18px; display:inline-block; vertical-align:middle">Nom :</div>';
  html += '<div style="flex:1; font-size:13px; color:#222; padding-left:2px; line-height:18px; display:inline-block; vertical-align:middle; font-weight:700">' + (nomDisplay || '') + '</div>';
        html += '</div>';
  // Arabic name block: render LTR inside so the Arabic value sits on the LEFT and the Arabic title on the RIGHT
  html += '<div style="flex:0 0 auto; display:flex; align-items:center; gap:6px; flex-direction:row-reverse; white-space:nowrap; overflow:visible;">';
  html += '<div style="font-size:16px !important; color:#111; font-weight:400;">: اللقب</div>';
  html += '<div style="font-size:16px !important; color:#222; font-weight:700; direction:rtl; white-space:nowrap;">' + (nom_ar || '') + '</div>';
    html += '</div>';
        html += '</div>';
        // Prénom
  html += '<div style="display:flex; gap:4px; margin-bottom:12px;">';
        html += '<div style="flex:1; display:flex; align-items:center;">';
    html += '<div style="width:56px; font-size:13px; color:#111; font-weight:400; line-height:18px; display:inline-block; vertical-align:middle">Prénom :</div>';
  html += '<div style="flex:1; font-size:13px; color:#222; padding-left:2px; line-height:18px; display:inline-block; vertical-align:middle; font-weight:700">' + (prenomDisplay || '') + '</div>';
        html += '</div>';
  // Arabic first name block: render LTR so the Arabic value sits on the LEFT and the Arabic title on the RIGHT
  html += '<div style="flex:0 0 auto; display:flex; align-items:center; gap:6px; flex-direction:row-reverse; white-space:nowrap; overflow:visible;">';
  html += '<div style="font-size:16px !important; color:#111; font-weight:400;">: الاسم</div>';
  html += '<div style="font-size:16px !important; color:#222; font-weight:700; direction:rtl; white-space:nowrap;">' + (prenom_ar || '') + '</div>';
    html += '</div>';
        html += '</div>';
        // Date lines
    html += '<div style="display:flex; gap:14px; margin-bottom:12px; align-items:center;">';
    html += '<div style="flex:1; white-space:nowrap; display:flex; align-items:center;">';
    html += '<div style="flex:0 0:'+LABEL_W+'px; width:'+LABEL_W+'px; font-size:13px; color:#111; font-weight:400; line-height:18px;">Date de naissance :</div>';
  html += '<div style="flex:1; font-size:12px; color:#222; padding-left:60px; text-align:left; line-height:18px; font-weight:700;">' + date_naissance_display + '</div>';
    html += '</div>';
    html += '<div style="flex:1; white-space:nowrap; display:flex; align-items:center;">';
    html += '<div style="flex:0 0:'+LABEL_W+'px; width:'+LABEL_W+'px; font-size:13px; color:#111; font-weight:400; line-height:18px;">Date d\'inscription :</div>';
  html += '<div style="flex:1; font-size:12px; color:#222; padding-left:60px; text-align:left; line-height:18px; font-weight:700;">' + date_inscription_display + '</div>';
    html += '</div>';
    html += '</div>';
        // Code / Profession row
        html += '<div style="display:flex; gap:14px; margin-bottom:10px;">';
        html += '<div style="flex:1; white-space:nowrap; display:flex; align-items:center;">';
    html += '<div style="width:'+LABEL_W+'px; font-size:13px; color:#111; font-weight:400; line-height:18px; display:inline-block; vertical-align:middle">Code Etudiant :</div>';
  html += '<div style="font-size:12px; color:#222; padding-left:39px; line-height:18px; display:inline-block; vertical-align:middle; font-weight:700">' + code_lecteur + '</div>';
        html += '</div>';
        html += '<div style="flex:1; white-space:nowrap; display:flex; align-items:center;">';
  html += '<div style="width:'+LABEL_W+'px; font-size:13px; color:#111; font-weight:400; line-height:18px; display:inline-block; vertical-align:middle">Profession :</div>';
  html += '<div style="font-size:12px; color:#222; padding-left:17px; line-height:18px; display:inline-block; vertical-align:middle; font-weight:700">' + profession + '</div>';
        html += '</div>';
        html += '</div>';
    // Pays / NIN / Téléphone
    // Reduce the Pays column width and give more room to Téléphone
    html += '<div style="display:flex; gap:8px; margin-bottom:12px; align-items:center;">';
    html += '<div style="flex:0 0 100px; white-space:nowrap; display:flex; align-items:center;">';
  html += '<div style="width:44px; font-size:13px; color:#111; font-weight:400; line-height:18px; display:inline-block; vertical-align:middle">Pays :</div>';
  html += '<div style="font-size:12px; color:#222; padding-left:4px; line-height:18px; display:inline-block; vertical-align:middle; font-weight:700">' + pays + '</div>';
    html += '</div>';
  html += '<div style="flex:2; display:flex; align-items:center;">';
  html += '<div style="width:44px; font-size:13px; color:#111; font-weight:400; line-height:18px; display:inline-block; vertical-align:middle">NIN :</div>';
  html += '<div style="flex:1; font-size:13px; color:#222; padding-left:4px; font-family:monospace; letter-spacing:1px; line-height:18px; display:inline-block; vertical-align:middle; font-weight:700">' + (nin || '') + '</div>';
  html += '</div>';
  html += '<div style="flex:2.2; display:flex; align-items:center;">';
  html += '<div style="width:60px; white-space:nowrap; font-size:13px; color:#111; font-weight:400; line-height:18px; display:inline-block; vertical-align:middle">Téléphone :</div>';
  html += '<div style="flex:1; font-size:13px; color:#222; padding-left:6px; line-height:18px; display:inline-block; vertical-align:middle; font-weight:700">' + tel + '</div>';
  html += '</div>';
        html += '</div>';
    // (Email / Adresse / Formations are displayed in the photo-bottom block above)
        html += '</div>'; // end middle
    html += '</div>'; // end main-grid
  // Full-width contact/info row: Adresse | E-mail | Formations (useful for printing across the page)
  // Lift the address/email fields slightly upward for tighter layout when printing
  html += '<div style="display:flex; flex-direction:column; gap:6px; margin-top:-6px; margin-bottom:10px;">';
  // top row: Adresse | E-mail with labels on left and values on right
  // nudge this row slightly upward so Adresse and E-mail sit a bit higher than Formations
  html += '<div style="display:flex; gap:18px; margin-top:-8px;">';
  html += '<div style="flex:1; display:flex; align-items:center;">';
  html += '<div style="flex:0 0:'+LABEL_W+'px; width:'+LABEL_W+'px; font-size:13px; color:#111; font-weight:400; white-space:nowrap">Adresse :</div>';
  html += '<div style="flex:1; font-size:12px; color:#222; padding-left:6px; font-weight:700; word-break:break-word;">' + escHtmlRaw(adresse) + '</div>';
  html += '</div>';
  html += '<div style="flex:1; display:flex; align-items:center;">';
  html += '<div style="flex:0 0:'+LABEL_W+'px; width:'+LABEL_W+'px; font-size:13px; color:#111; font-weight:400; white-space:nowrap">E-mail :</div>';
  html += '<div style="flex:1; font-size:12px; color:#222; padding-left:6px; font-weight:700; word-break:break-word;">' + escHtmlRaw(email) + '</div>';
  html += '</div>';
  html += '</div>';
  // second row: Formations full width with label left and value right
  html += '<div style="display:flex; align-items:center;">';
  html += '<div style="flex:0 0:'+LABEL_W+'px; width:'+LABEL_W+'px; font-size:13px; color:#111; font-weight:400; white-space:nowrap">Formations :</div>';
  html += '<div style="flex:1; font-size:12px; color:#222; padding-left:6px; font-weight:700; word-break:break-word;">' + escHtmlRaw(formation) + '</div>';
  html += '</div>';
  html += '</div>';
  // Small centered divider above Conditions Générales limited to the commitments/table width
  // keeps the rule short (doesn't span the whole page) and visually separates sections
  html += '<div style="text-align:center; margin-top:12px; margin-bottom:6px;">';
  html += '<div style="display:inline-flex; align-items:center; gap:8px;">';
  // Use borders instead of backgrounds so the rule prints even when background printing is disabled
  html += '<div style="width:200px; height:0; border-top:2px solid #222;"></div>';
  html += '<div style="width:12px; height:12px; transform:rotate(45deg); border:2px solid #222; background:transparent; box-shadow:none; margin:0 6px;"></div>';
  html += '<div style="width:200px; height:0; border-top:2px solid #222;"></div>';
  html += '</div>';
  html += '</div>';
  // Conditions Générales - add extra top margin so there's more space from the upper fields
  // use a larger inline margin to ensure space in all rendering contexts
  html += '<div class="genie-commitments" style="margin-top:18px;">';
        html += '<div style="text-align:center; font-weight:bold; margin-bottom:4px; font-size:14px;">Conditions Générales</div>';
        html += '<div class="genie-commitments-box">';
        html += '<table class="genie-commitments-table" role="presentation">';
        html += '<tr>';
        html += '<td style="width:50%; border-right:1px solid #000;">';
    html += '<div class="genie-commitments-head">Modalités de paiement :</div>';
    html += '<ul style="margin:0; padding-left:18px; font-size:12px; line-height:1.45;">';
    html += '<li>Le versement de la moitié (½) du tarif à l\'inscription, le reste à solder impérativement avant le debut des TP de simulation</li>';
    html += '<li>Les frais de préinscription (500,00 DA) ne sont pas remboursables.</li>';
    html += '<li>Les droits d\'inscriptions ne peuvent faire l\'objet d\'un remboursement.</li>';
    html += '<li>En cas de désistement en cours de formation, les mois versés ne seront pas remboursés.</li>';
    html += '</ul>';
    html += '</td>';
    html += '<td style="width:50%; padding-left:12px;">';
    html += '<div class="genie-commitments-head">Sanctions en cas de non-paiement :</div>';
    html += '<ul style="margin:0; padding-left:18px; font-size:12px; line-height:1.45;">';
    html += '<li>L\'étudiant qui ne se conforme pas aux modalités de paiement ou qui ne respecte pas les échéances de versement :</li>';
    html += '<li style="margin-top:6px;">Ne pourra obtenir de certificat de scolarité ;</li>';
    html += '<li>Ne pourra obtenir d\'attestation de formation.</li>';
    html += '</ul>';
        html += '</td>';
        html += '</tr>';
        html += '<tr>';
        html += '<td style="width:50%; border-top:1px solid #000; border-right:1px solid #000; padding-top:10px;">';
        html += '<div class="genie-commitments-head"></div>';
        html += '<ul style="margin:0; padding-left:18px; font-size:12px; line-height:1.45;">';
        html += '<li>Toute absence doit étre justifié pour la récupération.</li>';
        html += '</ul>';
        html += '</td>';
        html += '<td style="width:50%; border-top:1px solid #000; padding-top:10px; padding-left:12px;">';
        html += '<div class="genie-commitments-head">Séances de récupération et /ou rattrapage :</div>';
        html += '<div style="font-size:12px; line-height:1.45;">Sauf cas de force majeur, les cours ratés ne feront pas l\'objet de récupération.</div>';
        html += '</td>';
        html += '</tr>';
        html += '</table>';
        html += '<div style="padding-top:8px;">';
        html += '<div style="text-align:center; font-weight:bold; font-size:12px;">Toute absence doit faire l\'objet de justification valable afin d\'être récupérée avec un autre groupe dans la mesure du possible.</div>';
        html += '</div>';
        html += '</div>';
        html += '</div>';

  // Disponibilités block (copied from rapports.html)
  html += '<div style="margin-top:10px;">';
  html += '<div style="border:1px solid #000; padding:8px; position:relative; font-size:12px;">';
  html += '<div style="text-align:center; font-weight:bold; margin-bottom:8px;">Disponibilités</div>';
  html += '<table style="width:100%; border-collapse:collapse; font-size:12px;">';
  html += '<tr><td style="width:20%; padding:8px; border:1px solid #000;">&nbsp;</td>';
  html += '<td style="text-align:center; border:1px solid #000; padding:8px;">Dim</td>';
  html += '<td style="text-align:center; border:1px solid #000; padding:8px;">Lun</td>';
  html += '<td style="text-align:center; border:1px solid #000; padding:8px;">Mar</td>';
  html += '<td style="text-align:center; border:1px solid #000; padding:8px;">Mer</td>';
  html += '<td style="text-align:center; border:1px solid #000; padding:8px;">Jeu</td>';
  html += '<td style="text-align:center; border:1px solid #000; padding:8px;">Ven</td>';
  html += '<td style="text-align:center; border:1px solid #000; padding:8px;">Sam</td></tr>';
  html += '<tr><td style="padding:6px; border:1px solid #000;">Matin</td>';
  for(let i=0;i<7;i++){ html += '<td style="height:20px; border:1px solid #000; text-align:center; font-size:14px;">□</td>'; }
  html += '</tr>';
  html += '<tr><td style="padding:6px; border:1px solid #000;">Après-midi</td>';
  for(let i=0;i<7;i++){ html += '<td style="height:20px; border:1px solid #000; text-align:center; font-size:14px;">□</td>'; }
  html += '</tr>';
  html += '</table>';
  html += '<div style="margin-top:8px; font-size:12px;">Êtes-vous disponible pour suivre un programme de 1 à 6 mois ? &nbsp; Oui □ &nbsp; Non □ &nbsp;&nbsp; Avec stage □ &nbsp; Sans stage □</div>';
        html += '</div>';
        html += '</div>';


  html += '</div>';
  // close the bottom-pushed block so signatures can be positioned independently
  html += '</div>';

  // (removed flexible spacer so signatures remain in the document flow and appear on the same page)
  // Signatures (positioning handled by stylesheet; @media print pins them to bottom)
  // position signatures at the bottom of the centered wrapper so they appear at the page bottom
  // Signatures block: show labels but remove signature lines. Insert today's date after 'Béjaia le :'
  const today = new Date();
  const dd = String(today.getDate()).padStart(2,'0');
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const yyyy = today.getFullYear();
  const todayStr = dd + '/' + mm + '/' + yyyy;

  html += '<div class="genie-signatures" style="position:absolute; left:18px; right:18px; bottom:90px; display:flex; justify-content:space-between;">';
    html += '<div style="text-align:left">';
    // place the date label with today's date
    html += '<div style="font-size:13px; margin-bottom:6px;">Béjaia le : ' + todayStr + '</div>';
    html += '</div>';
  html += '<div style="text-align:right">';
  html += '<div style="font-size:13px; margin-bottom:8px;">Signature</div>';
  html += '</div>';
    html += '</div>';
        html += '</div>';
        return html;
      }
 
      // Try to print in place
      try{ buildAndPrintFiche(payload); }catch(e){
        console.warn('Local fiche print failed, falling back to navigation/storage', e);
        try{ const key = 'PRINT_STUDENT_DATA_' + id; sessionStorage.setItem(key, JSON.stringify(payload)); window.location.href = (new URL('{% url "rapports" %}', window.location.origin)).toString(); }catch(ex2){ console.error('fallback also failed', ex2); alert('Impossible d\'imprimer la fiche: ' + (ex2 && ex2.message ? ex2.message : ex2)); }
      }
    });
  </script>

  <script>
    // Client-side filtering for inscriptions and live total of negative balances
    (function(){
      function parseNum(v){
        if (v === null || v === undefined) return 0;
        var s = String(v).trim();
        if (!s) return 0;
        // remove spaces and thousands separators, accept comma decimal
        s = s.replace(/\s/g,'').replace(/,/g,'.');
        var n = parseFloat(s);
        return isNaN(n) ? 0 : n;
      }
      function formatDA(n){
        try{
          var x = Number(n) || 0;
          return x.toFixed(2) + ' DA';
        }catch(e){ return '0.00 DA'; }
      }

      var searchEl = document.getElementById('insSearch');
      var formationEl = document.getElementById('insFormationFilter');
      var ecoleEl = document.getElementById('insEcoleFilter');
      var dateTypeEl = document.getElementById('insDateType');
      var groupeEl = document.getElementById('insGroupeFilter');
      var soldeEl = document.getElementById('insSoldeFilter');
      var tbody = document.getElementById('inscriptionsTbody');
      var countNumber = document.querySelector('#insCount .ins-count-number');
      var totalNumber = document.getElementById('insTotalNumber');

      function matchesDate(rowDateStr, dateType){
        if(!dateType) return true;
        if(!rowDateStr) return false;
        var r = new Date(rowDateStr + 'T00:00:00');
        var today = new Date();
        today.setHours(0,0,0,0);
        if(dateType === 'today'){
          return r.getTime() === today.getTime();
        }
        if(dateType === 'this_week'){
          // week starts Monday
          var dlo = new Date(today);
          var day = dlo.getDay(); if(day===0) day = 7; // Sunday->7
          dlo.setDate(dlo.getDate() - (day-1)); dlo.setHours(0,0,0,0);
          var dhi = new Date(dlo); dhi.setDate(dhi.getDate()+6); dhi.setHours(23,59,59,999);
          return r.getTime() >= dlo.getTime() && r.getTime() <= dhi.getTime();
        }
        if(dateType === 'this_month'){
          return r.getMonth() === today.getMonth() && r.getFullYear() === today.getFullYear();
        }
        return true;
      }

      function applyInsFilters(){
        if(!tbody) return;
        var rows = Array.from(tbody.querySelectorAll('tr'));
        var q = (searchEl && searchEl.value || '').trim().toLowerCase();
        var formVal = formationEl ? (formationEl.value || '') : '';
        var ecoVal = ecoleEl ? (ecoleEl.value || '') : '';
        var dateVal = dateTypeEl ? (dateTypeEl.value || '') : '';
        var grpVal = groupeEl ? (groupeEl.value || '') : '';
        var solVal = soldeEl ? (soldeEl.value || '') : '';

        var visibleCount = 0;
        var totalNegAbs = 0; // sum of absolute values for negative balances
        var totalPos = 0;    // sum of positive balances

        rows.forEach(function(r){
          // skip template/empty rows
          if(!r.dataset) return;
          var name = (r.dataset.etudiantName || '').toLowerCase();
          var phone = (r.dataset.etudiantPhone || r.dataset.etudiantPhone || '') || '';
          var form = (r.dataset.formation || '').toLowerCase();
          var eco = (r.dataset.ecole || '').toLowerCase();
          var grp = (r.dataset.groupe || '').toLowerCase();
          var fName = (r.dataset.formateurName || '').toLowerCase();
          var date = (r.dataset.date || '');
          var remaining = parseNum(r.dataset.remaining || r.getAttribute('data-remaining') || 0);

          var ok = true;
          if(q){
            var found = name.indexOf(q) >= 0 || (r.dataset.etudiantEmail||'').toLowerCase().indexOf(q) >= 0 || form.indexOf(q) >=0 || grp.indexOf(q) >=0 || fName.indexOf(q) >=0 || (r.dataset.remarques||'').toLowerCase().indexOf(q) >= 0;
            if(!found) ok = false;
          }
          if(formVal){ if(form !== formVal.toLowerCase()) ok = false; }
          if(ecoVal){ if(eco !== ecoVal.toLowerCase()) ok = false; }
          if(grpVal){ if(grp !== grpVal.toLowerCase()) ok = false; }
          if(!matchesDate(date, dateVal)) ok = false;
          if(solVal){
            if(solVal === 'negatif' && !(remaining < 0)) ok = false;
            if(solVal === 'regle' && !(Math.abs(remaining) < 1e-6)) ok = false;
            if(solVal === 'positif' && !(remaining > 0)) ok = false;
          }

          if(ok){
            r.style.display = '';
            visibleCount += 1;
            if(remaining < 0){ totalNegAbs += -remaining; }
            if(remaining > 0){ totalPos += remaining; }
          } else {
            r.style.display = 'none';
          }
        });

        // derive final total to pay using robust rule:
        // - if any negative balances are present (convention: negative = owes),
        //   total = sum(abs(negatives)) - sum(positives)  (positives are credits)
        // - otherwise (no negatives), assume positive balances mean owes:
        //   total = sum(positives)
        var totalToPay = 0;
        if (totalNegAbs > 0) {
          totalToPay = totalNegAbs - totalPos;
        } else {
          totalToPay = totalPos;
        }

        // clamp to zero if negative (shouldn't show negative amounts)
        if (totalToPay < 0) totalToPay = 0;

        // update header counters
        try{ if(countNumber) countNumber.textContent = String(visibleCount); }catch(e){}
        try{ if(totalNumber) totalNumber.textContent = (Math.round(totalToPay*100)/100).toFixed(2); }catch(e){}
      }

      // attach events
      try{ if(searchEl) searchEl.addEventListener('input', applyInsFilters); }catch(e){}
      try{ if(formationEl) formationEl.addEventListener('change', applyInsFilters); }catch(e){}
      try{ if(ecoleEl) ecoleEl.addEventListener('change', applyInsFilters); }catch(e){}
      try{ if(dateTypeEl) dateTypeEl.addEventListener('change', applyInsFilters); }catch(e){}
      try{ if(groupeEl) groupeEl.addEventListener('change', applyInsFilters); }catch(e){}
      try{ if(soldeEl) soldeEl.addEventListener('change', applyInsFilters); }catch(e){}

      // initial run
      window.addEventListener('load', function(){ setTimeout(applyInsFilters, 40); });
    })();
  </script>

    <script>
      // Small behavior bundle to match etudiants page for the copied addStudent modal:
      (function(){
        function readDatalist(id){ const dl = document.getElementById(id); if(!dl) return []; return Array.from(dl.querySelectorAll('option')).map(o=>o.value).filter(Boolean); }
        const nat = readDatalist('nationalite_list');
        const lieu = readDatalist('lieu_list');

        function makeList(key){ let el = document.getElementById('combo-full-'+key); if(el) return el; el = document.createElement('div'); el.id = 'combo-full-'+key; el.style.position='absolute'; el.style.zIndex=9999; el.style.background='#fff'; el.style.border='1px solid #e5e7eb'; el.style.borderRadius='6px'; el.style.boxShadow='0 10px 30px rgba(2,6,23,0.08)'; el.style.maxHeight='260px'; el.style.overflow='auto'; el.style.display='none'; document.body.appendChild(el); return el; }

        function renderListFor(input, items){
          const key = input.id || input.name || 'combo';
          const list = makeList(key);
          const q = (input.value || '').toLowerCase();
          const filtered = items.filter(v => !q || v.toLowerCase().indexOf(q) !== -1);
          list.innerHTML = filtered.map(v=>`<div class="combo-full-item" data-val="${v}" style="padding:8px 12px;cursor:pointer;border-bottom:1px solid #f3f4f6">${v}</div>`).join('') || '<div style="padding:8px 12px;color:#6b7280">Aucun résultat</div>';
          const r = input.getBoundingClientRect(); list.style.left = (r.left + window.scrollX) + 'px'; list.style.top = (r.bottom + window.scrollY + 6) + 'px'; list.style.minWidth = r.width + 'px'; list.style.display = 'block';
          list.querySelectorAll('.combo-full-item').forEach(it=>it.addEventListener('click', function(){ input.value = this.dataset.val || ''; list.style.display='none'; input.dispatchEvent(new Event('input')); input.focus(); }));
          function docHandler(e){ if(!list.contains(e.target) && e.target !== input){ list.style.display='none'; document.removeEventListener('click', docHandler); } }
          setTimeout(()=>document.addEventListener('click', docHandler), 10);
          return list;
        }

        const inputs = [ document.getElementById('nationalite'), document.getElementById('lieu_naissance') ].filter(Boolean);
        inputs.forEach(inp => {
          const items = inp.id && inp.id.indexOf('nationalite') !== -1 ? nat : lieu;
          inp.addEventListener('focus', ()=> renderListFor(inp, items));
          inp.addEventListener('click', ()=> renderListFor(inp, items));
          inp.addEventListener('input', function(){ const el = document.getElementById('combo-full-'+(this.id||this.name)); if (el && el.style.display !== 'none') renderListFor(this, items); });
          inp.addEventListener('keydown', function(e){ if (e.key === 'Escape'){ const el = document.getElementById('combo-full-'+(this.id||this.name)); if(el) el.style.display='none'; } });
        });

        // Name casing helpers
        function capitalizePrenom(s){ if(!s) return ''; return s.toLowerCase().split(/(\s|\-)/).map(part => { return part.replace(/^[\s\-]*([a-z\u00e0-\u017f])/i, function(m,c){ return c ? c.toUpperCase() : m; }); }).join(''); }
        function attachUppercase(el){ if(!el) return; el.addEventListener('blur', function(){ this.value = (this.value||'').toUpperCase(); }); }
        function attachCapitalize(el){ if(!el) return; el.addEventListener('blur', function(){ this.value = capitalizePrenom(this.value||''); }); }

        // Attach to inline add modal fields
        try{
          const form = document.getElementById('addStudentInlineForm');
          if (form){
            const nomAdd = form.querySelector('input[name="nom"]');
            const prenomAdd = form.querySelector('input[name="prenom"]');
            attachUppercase(nomAdd);
            attachCapitalize(prenomAdd);
          }
        }catch(e){}

        // Photo preview for inline modal with default SVG restore when cleared
        try{
          function insertDefaultAvatarIntoLabel_ins(label){
            if(!label) return;
            label.style.backgroundImage = '';
            label.style.backgroundSize = '';
            label.style.backgroundPosition = '';
            label.innerHTML = `
              <svg aria-hidden="true" focusable="false" width="72" height="72" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color:#4b5563">
                <circle cx="12" cy="8" r="3.6" fill="#E6EEF3" stroke="#CBD5E1"></circle>
                <path d="M4 20c0-3.3 3.6-6 8-6s8 2.7 8 6" fill="#F8FAFB" stroke="#CBD5E1"></path>
              </svg>
              <p class="text-sm text-gray-500 mt-2" style="margin:0">Photo</p>
              <p class="text-xs text-gray-400" style="margin:0">PNG, JPG</p>
            `;
            label.removeAttribute('aria-label');
          }
          const photoInput = document.querySelector('#addStudentModal #photoInput');
          if (photoInput){
            photoInput.addEventListener('change', function(){
              const file = this.files && this.files[0];
              const label = document.querySelector('#addStudentModal label[for="photoInput"]');
              if(!file){ insertDefaultAvatarIntoLabel_ins(label); return; }
              const reader = new FileReader();
              reader.onload = function(ev){
                const label = document.querySelector('#addStudentModal label[for="photoInput"]');
                if(label){
                  label.style.backgroundImage = `url(${ev.target.result})`;
                  label.style.backgroundSize = 'cover';
                  label.style.backgroundPosition = 'center';
                  label.querySelectorAll('*').forEach(n => n.remove());
                  label.setAttribute('aria-label','Photo uploadée');
                }
              };
              reader.readAsDataURL(file);
            });
          }
        }catch(e){}
      })();
    </script>

    <!-- Floating group manager icon (opens popup) -->
    <div>
      <button id="openGroupeManagerBtn" aria-label="Gérer les groupes" title="Gérer les groupes" class="fixed right-6 bottom-6 z-50 w-12 h-12 rounded-full bg-emerald-600 text-white shadow-lg flex items-center justify-center transition-transform will-change-transform">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="3" width="8" height="8" rx="1"/>
          <rect x="13" y="3" width="8" height="8" rx="1"/>
          <rect x="3" y="13" width="8" height="8" rx="1"/>
          <rect x="13" y="13" width="8" height="8" rx="1"/>
        </svg>
      </button>

      <style>
      #openGroupeManagerBtn{ box-shadow: 0 10px 30px rgba(16,185,129,0.12); }
      #openGroupeManagerBtn:focus{ outline: none; box-shadow: 0 0 0 6px rgba(16,185,129,0.12); }
      #openGroupeManagerBtn:hover{ transform: translateY(-4px) scale(1.06); }
      #openGroupeManagerBtn .icon{ stroke-width:1.6; }
      .groupe-manager-backdrop{ transition: opacity .22s ease; opacity:0; }
      .groupe-manager-backdrop.show{ opacity:1; }
      .groupe-manager-content{ transform: scale(.96) translate3d(0,0,0); opacity:0; transition: transform .32s cubic-bezier(.18,.9,.32,1), opacity .28s ease; will-change: transform, opacity; }
      .groupe-manager-content.open{ transform: scale(1) translate3d(0,0,0); opacity:1; }
      .groupe-row{ transition: transform .12s ease, box-shadow .12s ease; }
      .groupe-row:hover{ transform: translateY(-3px); box-shadow: 0 6px 18px rgba(15,23,42,0.06); }
      </style>

      <div id="groupeManagerModal" class="fixed inset-0 bg-black/40 hidden items-start justify-center pt-20 z-50 groupe-manager-backdrop">
        <div id="groupeManagerContent" class="groupe-manager-content bg-white w-full max-w-4xl rounded-2xl p-4 shadow-xl mx-4 max-h-[80vh] overflow-hidden border border-gray-100">
            <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold">Gestion des Groupes</h3>
            <div class="flex items-center gap-3">
              <select id="newGroupeFormation" class="px-2 py-1 border rounded bg-white">
                <option value="">Choisir formation</option>
                {% for f in formations %}
                <option value="{{ f.id }}">{{ f.nom }}</option>
                {% endfor %}
              </select>
              <button id="openAddGroupe" class="px-3 py-2 rounded bg-emerald-600 text-white">Ajouter</button>
              <button id="refreshGroupes" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200">Actualiser</button>
              <button id="closeGroupeManager" class="ml-2 px-3 py-2 rounded bg-gray-100">Fermer</button>
            </div>
          </div>
          <div class="overflow-auto border-t pt-3" style="max-height:calc(80vh - 120px)">
            <table id="groupesTable" class="w-full text-sm rounded-lg overflow-hidden">
              <thead class="bg-emerald-50 text-emerald-700 text-left sticky top-0">
                <tr>
                  <th class="px-3 py-2">Formation</th>
                  <th class="px-3 py-2">Groupe</th>
                  <th class="px-3 py-2">Inscrits</th>
                  <th class="px-3 py-2">Capacité</th>
                  <th class="px-3 py-2">Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
  
      <!-- Groupe modal (reuse style from salle modal) -->
      <div id="groupeModal" tabindex="-1" class="fixed inset-0 bg-black/50 hidden items-center justify-center p-4" style="z-index:99999;">
        <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-xl">
          <div class="flex items-center justify-between mb-4">
            <h2 id="groupeModalTitle" class="text-lg font-semibold">Nouveau groupe</h2>
            <button id="closeGroupeModal" class="p-2 rounded-lg hover:bg-gray-100">&times;</button>
          </div>
          <form id="groupeForm" class="space-y-3">
            <input type="hidden" name="id" />
            <div>
              <label class="text-sm block mb-1">Nom</label>
              <input name="nom" id="groupeFormNom" class="w-full border rounded-xl px-3 py-2" placeholder="G1" required />
            </div>
            <div>
              <label class="text-sm block mb-1">Capacité</label>
              <input name="capacite" id="groupeFormCap" type="number" class="w-full border rounded-xl px-3 py-2" value="16" />
            </div>
            <div class="flex justify-end gap-2 pt-2">
              <button type="button" id="cancelGroupe" class="px-4 py-2 rounded-xl bg-gray-200">Annuler</button>
              <button type="submit" id="saveGroupeBtn" class="px-4 py-2 rounded-xl bg-emerald-600 text-white">Enregistrer</button>
            </div>
          </form>
        </div>
      </div>

      <div id="toastAreaGroups" class="fixed right-6 bottom-6 space-y-2 z-50"></div>
    </div>

    <script>
    (function(){
      const openBtn = document.getElementById('openGroupeManagerBtn');
      const modal = document.getElementById('groupeManagerModal');
      const content = document.getElementById('groupeManagerContent');
      const closeBtn = document.getElementById('closeGroupeManager');
      const refreshBtn = document.getElementById('refreshGroupes');
      const tbody = document.querySelector('#groupesTable tbody');

    // formation_groups_json is provided by the view context
    let formationGroups = {};
    try{ formationGroups = JSON.parse('{{ formation_groups_json|default:"{}"|escapejs }}'); }catch(e){ console.error('formation_groups_json parse error', e); formationGroups = {}; }

      // Build a map of formation id -> name from template context
      const formationsMap = {};
      {% for f in formations %}
        formationsMap['{{ f.id }}'] = `{{ f.nom|escapejs }}`;
      {% endfor %}

      function buildRow(formationId, g){
        const tr = document.createElement('tr'); tr.className = 'groupe-row';
        const fname = formationsMap[String(formationId)] || (`Formation ${formationId}`);
        const gid = g.id || '';
        const code = g.nom || '';
        const count = (g.count !== undefined) ? g.count : '';
        const cap = (g.capacity !== undefined) ? g.capacity : '';
        const disabled = g.disabled ? ' (plein)' : '';
        tr.innerHTML = `
          <td class="px-3 py-2">${escapeHtml(fname)}</td>
          <td class="px-3 py-2 font-semibold">${escapeHtml(code)}</td>
          <td class="px-3 py-2">${escapeHtml(String(count))}</td>
          <td class="px-3 py-2">${escapeHtml(String(cap))}${disabled}</td>
          <td class="px-3 py-2">
            <button class="g-cp px-2 py-1 mr-2 rounded border" data-code="${escapeHtml(code)}" title="Copier">Copier</button>
            <button class="g-del delete-btn icon-btn px-2 py-1 rounded border text-red-600" data-id="${escapeHtml(gid)}" title="Supprimer">
              <svg class="icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12z" fill="#ef4444"/><path d="M19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="#ef4444"/></svg>
            </button>
          </td>
        `;
        return tr;
      }

      function escapeHtml(s){ return (s+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

      function populate(){
        tbody.innerHTML = '';
        Object.keys(formationGroups).forEach(fid => {
          const arr = formationGroups[fid] || [];
          arr.forEach(g => { const r = buildRow(fid, g); tbody.appendChild(r); });
        });
        attachButtons();
      }

      function showToast(msg, type){
        const area = document.getElementById('toastAreaGroups');
        if(!area) return alert(msg);
        const el = document.createElement('div');
        el.className = 'px-4 py-2 rounded shadow bg-gray-800 text-white';
        if(type==='error') el.classList.add('bg-red-600');
        el.textContent = msg;
        area.appendChild(el);
        setTimeout(()=>{ el.style.transition='opacity .3s'; el.style.opacity='0'; setTimeout(()=>el.remove(),350); }, 2500);
      }

      function attachButtons(){
        tbody.querySelectorAll('button.g-cp').forEach(b => {
          b.onclick = function(){ const code = this.dataset.code || ''; if(!code) return; navigator.clipboard?.writeText(code).then(()=>{ showToast('Copié: '+code); }).catch(()=>{ showToast('Copier: '+code); }); };
        });
        // delete buttons (use groupe id)
        tbody.querySelectorAll('button.g-del').forEach(b => {
          b.onclick = function(){
            const gid = this.dataset.id || '';
            if(!gid) return;
            if(!confirm('Supprimer ce groupe ?')) return;
            fetch('{% url "groupe_delete" %}', { method: 'POST', headers: { 'X-CSRFToken': getCookie('csrftoken') }, body: new URLSearchParams({ id: gid }) })
            .then(r=>r.json()).then(j=>{
              if(j.success) { showToast('Groupe supprimé'); populate(); } else { showToast('Erreur: ' + (j.error || ''),'error'); }
            }).catch(e=>{ showToast('Erreur réseau','error'); });
          };
        });
      }

      // helper to get cookie (CSRF)
      function getCookie(name){ const v=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)'); return v?v.pop():''; }

      // open add groupe modal
      const openAddBtn = document.getElementById('openAddGroupe');
      const groupeModal = document.getElementById('groupeModal');
      const groupeForm = document.getElementById('groupeForm');
      const closeGroupeModal = document.getElementById('closeGroupeModal');
      const cancelGroupe = document.getElementById('cancelGroupe');
      const newGroupeFormation = document.getElementById('newGroupeFormation');
      function computeNextGroupName(fid){
        try{
          const fname = formationsMap[String(fid)] || '';
          const first = (fname||'').trim().charAt(0).toUpperCase() || 'X';
          const prefix = 'G' + first;
          let max = 0;
          const arr = formationGroups[String(fid)] || [];
          arr.forEach(g => {
            const n = (g.nom||'').trim();
            if(!n) return;
            if(n.indexOf(prefix)===0){
              const tail = n.slice(prefix.length);
              const num = parseInt(tail, 10);
              if(!isNaN(num) && num>max) max = num;
            }
          });
          return prefix + String(max+1);
        }catch(e){ return 'G1'; }
      }

      if(openAddBtn){
        openAddBtn.addEventListener('click', ()=>{
          // ensure a formation is selected
          const fid = newGroupeFormation.value;
          if(!fid){ showToast('Choisir une formation d\'abord','error'); return; }
          // prefill default name based on formation first letter + incremental number
          try{ document.getElementById('groupeFormNom').value = computeNextGroupName(fid); }catch(e){ document.getElementById('groupeFormNom').value = 'G1'; }
          document.getElementById('groupeFormCap').value = '16';
          // ensure modal is attached to body so it escapes any transformed parent stacking context
          try{
            if(!document.body.contains(groupeModal)) document.body.appendChild(groupeModal);
          }catch(e){}
          groupeModal.style.zIndex = '99999';
          groupeModal.classList.remove('hidden'); groupeModal.classList.add('flex');
          // focus and lock background scroll to avoid underlying inputs remaining focused
          try{ groupeModal.focus(); document.documentElement.style.overflow = 'hidden'; document.body.style.overflow = 'hidden'; }catch(e){}
        });
      }
  if(closeGroupeModal) closeGroupeModal.addEventListener('click', ()=>{ groupeModal.classList.add('hidden'); groupeModal.classList.remove('flex'); try{ document.documentElement.style.overflow=''; document.body.style.overflow=''; }catch(e){} });
  if(cancelGroupe) cancelGroupe.addEventListener('click', ()=>{ groupeModal.classList.add('hidden'); groupeModal.classList.remove('flex'); try{ document.documentElement.style.overflow=''; document.body.style.overflow=''; }catch(e){} });

      // handle form submit
      if(groupeForm){
        groupeForm.addEventListener('submit', (ev)=>{
          ev.preventDefault();
          const fid = newGroupeFormation.value;
          const nom = document.getElementById('groupeFormNom').value.trim();
          const cap = document.getElementById('groupeFormCap').value || '16';
          if(!fid){ showToast('Choisir une formation','error'); return; }
          if(!nom){ showToast('Entrer le nom du groupe','error'); return; }
          fetch('{% url "groupe_add" %}', { method: 'POST', credentials: 'same-origin', headers: { 'X-CSRFToken': getCookie('csrftoken') }, body: new URLSearchParams({ formation: fid, nom: nom, capacite: cap }) })
            .then(r=>{
              if(!r.ok){ return r.text().then(t=>{ throw { status: r.status, text: t }; }); }
              return r.json();
            })
            .then(j=>{
              if(j.success){
                try{
                  // Show toast and close modal
                  showToast('Groupe ajouté');
                  groupeModal.classList.add('hidden'); groupeModal.classList.remove('flex');
                  // Insert new groupe into formationGroups so UI updates without full page reload
                  const newG = j.groupe || {};
                  const fid = String(newG.formation_id || fid);
                  const capInt = parseInt(cap, 10) || 16;
                  const entry = { id: newG.id, nom: newG.nom || (newG.name||''), disabled: false, count: 0, capacity: capInt };
                  if(!formationGroups[String(fid)]) formationGroups[String(fid)] = [];
                  // Prevent duplicates by id
                  const exists = formationGroups[String(fid)].some(x => String(x.id) === String(entry.id));
                  if(!exists) formationGroups[String(fid)].push(entry);
                  // Refresh groups table and any open select for this formation
                  try{ populate(); }catch(e){}
                  // update any groupe selects currently showing this formation
                  try{
                    const selMain = document.getElementById('addInsGroupeSelect');
                    const mainForm = document.getElementById('addInsForm');
                    if(mainForm && selMain){ const mf = mainForm.querySelector('select[name="formation"]'); if(mf && String(mf.value)===String(fid)) buildOptionsFor(fid, selMain); }
                    const editF = document.getElementById('editFormation'); const editSel = document.getElementById('editGroupeSelect');
                    if(editF && editSel && String(editF.value)===String(fid)) buildOptionsFor(fid, editSel);
                    const inlineF = document.querySelector('#addInsInlineModal select[name="formation"]'); const inlineSel = document.getElementById('inlineGroupeSelect');
                    if(inlineF && inlineSel && String(inlineF.value)===String(fid)) buildOptionsFor(fid, inlineSel);
                  }catch(e){}
                }catch(e){ console.warn('post-add UI update failed', e); }
              }
              else{ showToast('Erreur: ' + (j.error || ''),'error'); }
            }).catch(err=>{
              if(err && err.status){ showToast('Erreur serveur '+err.status+': '+(err.text||''),'error'); }
              else{ showToast('Erreur réseau: Vérifier la connexion ou la console du navigateur','error'); }
            });
        });
      }

      openBtn.addEventListener('click', ()=>{
        const contentEl = content;
        const modalEl = modal;
        modalEl.classList.remove('hidden'); modalEl.classList.add('flex','show');
        contentEl.classList.remove('open');
        const iconRect = openBtn.getBoundingClientRect();
        const contentRect = contentEl.getBoundingClientRect();
        const dx = (iconRect.left + iconRect.width/2) - (contentRect.left + contentRect.width/2);
        const dy = (iconRect.top + iconRect.height/2) - (contentRect.top + contentRect.height/2);
        contentEl.style.transform = `translate(${dx}px, ${dy}px) scale(0.12)`;
        contentEl.style.opacity = '0';
        requestAnimationFrame(()=>{
          requestAnimationFrame(()=>{
            contentEl.style.transition = 'transform .36s cubic-bezier(.18,.9,.32,1), opacity .28s ease';
            contentEl.style.transform = '';
            contentEl.style.opacity = '';
            contentEl.addEventListener('transitionend', function onOpen(){
              contentEl.classList.add('open');
              contentEl.removeEventListener('transitionend', onOpen);
            });
          });
        });
        populate();
      });

      closeBtn.addEventListener('click', ()=>{
        const contentEl = content; const modalEl = modal;
        const iconRect = openBtn.getBoundingClientRect();
        const contentRect = contentEl.getBoundingClientRect();
        const dx = (iconRect.left + iconRect.width/2) - (contentRect.left + contentRect.width/2);
        const dy = (iconRect.top + iconRect.height/2) - (contentRect.top + contentRect.height/2);
        contentEl.style.transition = 'transform .32s cubic-bezier(.18,.9,.32,1), opacity .24s ease';
        contentEl.style.transform = `translate(${dx}px, ${dy}px) scale(0.12)`;
        contentEl.style.opacity = '0';
        modalEl.classList.remove('show');
        const cleanup = ()=>{ modalEl.classList.add('hidden'); modalEl.classList.remove('flex'); contentEl.style.transition = ''; contentEl.style.transform=''; contentEl.style.opacity=''; contentEl.removeEventListener('transitionend', cleanup); };
        contentEl.addEventListener('transitionend', cleanup);
        setTimeout(cleanup, 420);
      });

      refreshBtn.addEventListener('click', ()=>{ location.reload(); });

      // initial populate if modal present and open manually via JS
      try{ if(modal.classList.contains('show')) populate(); }catch(e){}
    })();
    </script>

    {% endblock %}

