{% extends 'base.html' %}
{% load static %}
{% block title %}Règlements enseignants - GénieSchool{% endblock %}
{% block content %}
<style>
  /* reuse payments table style */
  .table-card{ background:var(--bg-card, #fff);border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(11,22,43,0.06);} 
  .tbl { width:100%; border-collapse:collapse; }
  .tbl thead th{ text-align:left; padding:14px; font-size:12px; color:#6b7280; text-transform:uppercase; font-weight:700; }
   .tbl tbody td{ padding:12px 18px; border-top:1px solid #f3f4f6; vertical-align:middle; }
   .tbl { table-layout: fixed; }
  .ref { font-family:monospace; color:var(--accent-1, #4f46e5); font-weight:700; }
  .name { font-weight:700; color:var(--text-primary, #0f172a); }
  .muted { color:var(--text-secondary, #6b7280); font-size:13px; }
  .amount { font-weight:700; color:var(--text-primary, #0f172a); }
  .badge-partial{ background:var(--badge-partial-bg, #fff7ed); color:var(--badge-partial-text, #b45309); padding:6px 10px; border-radius:999px; font-weight:700; }
  /* indigo themed animated search (matches payment ID color #4f46e5) */
  .search-wrapper { position: relative; }
  .search-wrapper::before{ content:''; position:absolute; inset: -4px; border-radius:14px; background: linear-gradient(90deg, rgba(79,70,229,0.06), rgba(99,102,241,0.04)); opacity:0; transition: opacity .18s ease, transform .18s ease; pointer-events:none; }
  .search-input { padding-left: 44px; padding-right: 44px; border-radius: 10px; border: 1px solid rgba(79,70,229,0.12); transition: box-shadow .18s ease, transform .12s ease, border-color .12s ease, background .18s ease; background: linear-gradient(180deg,#ffffff,#f8fafc); position:relative; z-index:1; }
  .search-input:focus{ outline: none; box-shadow: 0 12px 40px rgba(79,70,229,0.12); transform: translateY(-3px); border-color: rgba(79,70,229,0.3); }
  .search-wrapper.focused::before{ opacity:1; transform:translateY(-2px); }
  .search-icon{ position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#6366f1; font-size:18px; pointer-events:none; z-index:2; }
  .search-wrapper.focused .search-icon{ color:#4f46e5; transform:translateY(-50%) scale(1.02); }
  .ins-clear{ position:absolute; right:8px; top:50%; transform:translateY(-50%); background:transparent; border:none; font-size:18px; color:#6b7280; cursor:pointer; display:none; z-index:2; padding:6px; border-radius:999px; transition: transform .12s ease, opacity .12s ease; }
  .ins-clear.show{ display:block; opacity:1; color:#4f46e5; }
  .ins-clear:hover{ background: rgba(79,70,229,0.06); transform: translateY(-1px); }
  .ins-clear:active{ transform:scale(.92); }
  .ripple{ position:absolute; width:12px; height:12px; border-radius:50%; background:rgba(79,70,229,0.12); transform:scale(0); opacity:0.9; pointer-events:none; }
  .search-input::placeholder{ color:#9ca3af; transition: opacity .2s ease, transform .25s ease; }
  .search-wrapper.focused .search-input::placeholder{ opacity:0.7; transform:translateY(-1px); }
  /* print button styling (indigo themed) */
  .print-btn{ display:inline-flex; align-items:center; gap:6px; border:1px solid rgba(79,70,229,0.14); color:#4f46e5; background:transparent; padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:700; font-size:13px; }
  .print-btn:hover{ background: rgba(79,70,229,0.06); transform:translateY(-1px); }
  .print-btn .material-icons{ font-size:18px; }
  /* Modern modal styles (colorful + animated) */
  .modal-backdrop{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:linear-gradient(180deg, rgba(15,23,42,0.5), rgba(79,70,229,0.12)); z-index:60; }
  .modal-backdrop.open{ display:flex; }
  .modal-card{ width:90%; max-width:720px; border-radius:14px; padding:0; overflow:hidden; transform: translateY(18px) scale(.98); opacity:0; transition: transform .32s cubic-bezier(.16,.84,.44,1), opacity .28s ease, box-shadow .28s ease; box-shadow:0 18px 50px rgba(79,70,229,0.12); background: var(--modal-bg, linear-gradient(180deg, #ffffff, #fbf7ff)); border:1px solid rgba(99,102,241,0.12); }
  .modal-card.show{ transform: translateY(0) scale(1); opacity:1; }
  .modal-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:18px 20px; background:linear-gradient(90deg,#eef2ff,#f8fafc); border-bottom:1px solid rgba(99,102,241,0.06); }
  .modal-title{ display:flex; align-items:center; gap:12px; font-weight:700; color:#4f46e5; }
  .modal-body{ padding:18px 20px; }
  .modal-actions{ padding:14px 20px; border-top:1px solid rgba(15,23,42,0.04); display:flex; justify-content:flex-end; gap:8px; }
  .btn-ghost{ background:transparent; border:1px solid rgba(15,23,42,0.06); padding:8px 12px; border-radius:8px; }
  .btn-accent{ background:linear-gradient(90deg,#7c3aed,#4f46e5); color:white; padding:8px 12px; border-radius:8px; border:none; }
  .close-modal{ background:transparent; border:none; font-size:18px; cursor:pointer; color:#6b7280; }
</style>
<main>
  <header class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold">Règlements des enseignants</h1>
    <div>
      <button id="openAddBtn" class="btn-primary py-2 px-4 rounded-lg flex items-center font-semibold"><span class="material-icons mr-2">add</span>Ajouter un règlement</button>
    </div>
  </header>

  <div class="flex items-center justify-between mb-4">
    <div class="search-wrapper w-1/3">
      <span class="material-icons search-icon">search</span>
      <input id="paySearch" type="text" placeholder="Rechercher un paiement (nom, référence, montant...)" class="search-input w-full shadow-sm py-2" />
      <button id="payClearBtn" class="ins-clear" title="Effacer">&times;</button>
    </div>
    <div></div>
  </div>

  <!-- debug counter removed per request -->

  <!-- Edit Reglement Modal (modern animated) -->
  <div id="editReglementModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="editReglementTitle">
      <div class="modal-header">
        <div class="modal-title"><span class="material-icons" style="color:#7c3aed">edit</span><span id="editReglementTitle">Modifier le règlement</span></div>
        <button id="closeEditModal" class="close-modal" aria-label="Fermer">✕</button>
      </div>
      <div class="modal-body">
        <form id="editReglementForm">
          <input type="hidden" name="id" id="editReglementId" />
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm text-gray-600">Montant</label>
              <input type="number" step="0.01" name="montant" id="editMontant" class="w-full border rounded px-2 py-1" />
            </div>
            <div>
              <label class="block text-sm text-gray-600">Mode</label>
              <select name="mode" id="editMode" class="w-full border rounded px-2 py-1">
                <option value="cash">Espèces</option>
                <option value="cheque">Chèque</option>
                <option value="virement">Virement</option>
              </select>
            </div>
          </div>

          <!-- enseignant name (read-only display) -->
          <div class="mt-3">
            <label class="block text-sm text-gray-600">Enseignant</label>
            <div id="editEnseignantName" class="name mt-1">—</div>
          </div>

          <!-- mode-specific fields for edit (hidden by default, toggled by JS) -->
          <div class="grid grid-cols-2 gap-4 mt-3">
            <div id="edit_numero_cheque_row" class="hidden">
              <label class="block text-sm text-gray-600">N° de chèque</label>
              <input name="numero_cheque" id="edit_numero_cheque" class="w-full border rounded px-2 py-1" />
            </div>
            <div id="edit_date_cheque_row" class="hidden">
              <label class="block text-sm text-gray-600">Date du chèque</label>
              <input type="date" name="date_cheque" id="edit_date_cheque" class="w-full border rounded px-2 py-1" />
            </div>
            <div id="edit_compte_bancaire_row" class="hidden col-span-2">
              <label class="block text-sm text-gray-600">Compte bancaire (RIB/IBAN)</label>
              <input name="compte_bancaire" id="edit_compte_bancaire" class="w-full border rounded px-2 py-1" />
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" id="cancelEdit" class="btn-ghost">Annuler</button>
            <button type="submit" class="btn-accent">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="table-card overflow-x-auto bg-white rounded-xl shadow">
    <table class="min-w-full text-sm text-left text-gray-700">
      <colgroup>
        <col style="width:48%">
        <col style="width:20%">
        <col style="width:20%">
        <col style="width:12%">
      </colgroup>
      <thead class="bg-gray-100 text-gray-600 uppercase text-xs font-semibold">
        <tr>
          <th class="px-6 py-3">NOM / PRÉNOM</th>
          <th class="px-6 py-3 text-right">Montant</th>
          <th class="px-6 py-3">Solde</th>
          <th class="px-6 py-3">Actions</th>
        </tr>
      </thead>
      <tbody id="reglementsTbody">
        {% for r in reglements %}
  <tr class="border-b reglement-row" data-id="{{ r.id }}" data-enseignant-name="{{ r.enseignant }}" data-mode="{{ r.mode|default:'' }}" data-numero-cheque="{{ r.numero_cheque|default:'' }}" data-date-cheque="{{ r.date_cheque|default:'' }}" data-compte-bancaire="{{ r.compte_bancaire|default:'' }}" data-enseignant-sexe="{% if r.enseignant %}{{ r.enseignant.sexe|default:'' }}{% else %}{% endif %}" data-enseignant-bio="{% if r.enseignant %}{{ r.enseignant.bio|default:'' }}{% else %}{% endif %}">
          <td class="px-6 py-4 font-semibold">{{ r.enseignant }}</td>
          <td class="px-6 py-4 text-right font-semibold amount">{{ r.montant|floatformat:2 }} DZD</td>
          <td class="px-6 py-4 text-gray-500">-</td>
          <td class="px-6 py-4 text-center">
            <button class="btn-edit" data-id="{{ r.id }}" title="Modifier" aria-label="Modifier" style="background:transparent;border:none;cursor:pointer;padding:6px;border-radius:6px;display:inline-flex;align-items:center;justify-content:center;">
              <!-- modern inline SVG pencil icon (uses currentColor) -->
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="18" height="18" style="color:#4f46e5;">
                <path d="M3 21v-3a2 2 0 0 1 .59-1.41L17.5 2.68a2 2 0 0 1 2.83 0l0 0a2 2 0 0 1 0 2.83L6.41 20.41A2 2 0 0 1 5 21H3z"></path>
                <path d="M14 7l3 3"></path>
              </svg>
            </button>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="4" class="px-6 py-6 text-center text-gray-500">Aucun règlement enregistré.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</main>

<!-- Add Modal -->
  <div id="addModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="addReglementTitle">
      <div class="modal-header">
        <div class="modal-title"><span class="material-icons" style="color:#7c3aed">add</span><span id="addReglementTitle">Ajouter un règlement</span></div>
        <button id="cancelAdd" class="close-modal" aria-label="Fermer">✕</button>
      </div>
      <div class="modal-body">
        <form id="addForm">
          {% csrf_token %}
          <div class="grid grid-cols-2 gap-3">
            <select name="enseignant_id" class="border px-3 py-2 rounded col-span-2">
              <option value="">-- Choisir enseignant --</option>
              {% for e in enseignants %}
              <option value="{{ e.id }}" data-sexe="{{ e.sexe|default:'' }}" data-bio="{{ e.bio|default:'' }}">{{ e.prenom }} {{ e.nom }}</option>
              {% endfor %}
            </select>
            <input name="montant" placeholder="Montant" class="border px-3 py-2 rounded" />
            <select name="mode" id="addMode" class="border px-3 py-2 rounded">
              <option value="cash">Espèces</option>
              <option value="cheque">Chèque</option>
              <option value="virement">Virement</option>
            </select>
            <!-- conditional fields: cheque / virement -->
            <input name="numero_cheque" id="add_numero_cheque" placeholder="N° de chèque" class="border px-3 py-2 rounded hidden" />
            <input type="date" name="date_cheque" id="add_date_cheque" class="border px-3 py-2 rounded hidden" />
            <input name="compte_bancaire" id="add_compte_bancaire" placeholder="Compte bancaire (RIB/IBAN)" class="border px-3 py-2 rounded hidden" />
      <!-- per-formation balances removed -->
          </div>
          <div class="modal-actions">
            <button type="button" id="cancelAddBtn" class="btn-ghost">Annuler</button>
            <button type="submit" class="btn-accent">Enregistrer</button>
          </div>
        </form>
      </div>
    </div>
  </div>

<script>
  // Edit modal handlers (use animated modal classes)
  const editModal = document.getElementById('editReglementModal');
  const editForm = document.getElementById('editReglementForm');
  const closeEditModalBtn = document.getElementById('closeEditModal');
  const cancelEditBtn = document.getElementById('cancelEdit');

  function openEditModal() { editModal.classList.add('open'); setTimeout(()=> document.querySelector('#editReglementModal .modal-card').classList.add('show'), 20); editModal.setAttribute('aria-hidden','false'); }
  function closeEditModal() { document.querySelector('#editReglementModal .modal-card').classList.remove('show'); setTimeout(()=>{ editModal.classList.remove('open'); editModal.setAttribute('aria-hidden','true'); }, 240); }

    // Attach to dynamically created buttons
    document.querySelectorAll('.btn-edit').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const id = btn.getAttribute('data-id');
        // find the row
        const row = document.querySelector(`.reglement-row[data-id='${id}']`);
        if (!row) return;
  const amount = row.querySelector('.amount') ? row.querySelector('.amount').textContent.replace('DZD','').trim() : '';
  document.getElementById('editReglementId').value = id;
  document.getElementById('editMontant').value = amount.replace(/[^0-9.,-]/g, '').replace(',','.');
    // prefill enseignant name if present
    try{ const enseignantName = row.dataset.enseignantName || row.getAttribute('data-enseignant-name') || ''; const nameEl = document.getElementById('editEnseignantName'); if (nameEl) nameEl.textContent = enseignantName || '—'; }catch(e){}
    // prefill mode-specific fields
    try{
      const mode = row.dataset.mode || '';
      const numCheque = row.dataset.numeroCheque || row.dataset.numero_cheque || '';
      const dateCheque = row.dataset.dateCheque || row.dataset.date_cheque || '';
      const compte = row.dataset.compteBancaire || row.dataset.compte_bancaire || '';
      const editModeEl = document.getElementById('editMode');
      const editNumCheque = document.getElementById('edit_numero_cheque');
      const editDateCheque = document.getElementById('edit_date_cheque');
      const editCompte = document.getElementById('edit_compte_bancaire');
      if (editModeEl) { editModeEl.value = mode || 'cash'; }
      if (editNumCheque) editNumCheque.value = numCheque || '';
      if (editDateCheque) editDateCheque.value = dateCheque || '';
      if (editCompte) editCompte.value = compte || '';
      // show/hide rows according to mode
      toggleEditModeFields(editModeEl ? editModeEl.value : '');
      // ensure change listener updates visibility when user changes mode
      if (editModeEl) editModeEl.addEventListener('change', function(){ toggleEditModeFields(this.value); });
    }catch(e){}
    openEditModal();
      });
    });

    closeEditModalBtn.addEventListener('click', () => closeEditModal());
    cancelEditBtn.addEventListener('click', () => closeEditModal());

    editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(editForm);
      const id = formData.get('id');
      try {
        const resp = await fetch('{% url "reglements_enseignants_edit" %}', {
          method: 'POST',
          credentials: 'same-origin',
          headers: { 'X-CSRFToken': getCookie('csrftoken'), 'X-Requested-With': 'XMLHttpRequest' },
          body: formData
        });
        const data = await resp.json();
        if (data.success) {
          // update only montant in row (other fields removed)
          const row = document.querySelector(`.reglement-row[data-id='${id}']`);
          if (row) {
            row.querySelector('.amount').textContent = (parseFloat(data.reglement.montant).toFixed(2) || '0.00') + ' DZD';
          }
          closeEditModal();
        } else {
          alert(data.error || 'Erreur lors de la mise à jour');
        }
      } catch (err) {
        console.error(err);
        alert('Erreur réseau');
      }
    });

  // helper to toggle visibility of edit modal mode-specific fields
  function toggleEditModeFields(mode){
    const numRow = document.getElementById('edit_numero_cheque_row');
    const dateRow = document.getElementById('edit_date_cheque_row');
    const compteRow = document.getElementById('edit_compte_bancaire_row');
    if (!numRow || !dateRow || !compteRow) return;
    if (mode === 'cheque'){
      numRow.classList.remove('hidden'); dateRow.classList.remove('hidden'); compteRow.classList.add('hidden');
    } else if (mode === 'virement'){
      numRow.classList.add('hidden'); dateRow.classList.add('hidden'); compteRow.classList.remove('hidden');
    } else {
      numRow.classList.add('hidden'); dateRow.classList.add('hidden'); compteRow.classList.add('hidden');
    }
  }

    // helper to get csrf token cookie
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  function getCookie(name) { let cookieValue = null; if (document.cookie && document.cookie !== '') { const cookies = document.cookie.split(';'); for (let i = 0; i < cookies.length; i++) { const cookie = cookies[i].trim(); if (cookie.substring(0, name.length + 1) === (name + '=')) { cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break; } } } return cookieValue; }
  const csrftoken = getCookie('csrftoken');
  const addModal = document.getElementById('addModal');
  document.getElementById('openAddBtn').addEventListener('click', ()=> { addModal.classList.add('open'); setTimeout(()=> document.querySelector('#addModal .modal-card').classList.add('show'),20); addModal.setAttribute('aria-hidden','false'); });
  // close buttons
  document.getElementById('cancelAdd').addEventListener('click', ()=> closeAddModal());
  document.getElementById('cancelAddBtn').addEventListener('click', ()=> closeAddModal());
  function closeAddModal(){ document.querySelector('#addModal .modal-card').classList.remove('show'); setTimeout(()=>{ addModal.classList.remove('open'); addModal.setAttribute('aria-hidden','true'); },240); }

  document.getElementById('addForm').addEventListener('submit', function(e){
    e.preventDefault();
    const data = new FormData(e.target);
    fetch('{% url "reglements_enseignants_add" %}', {
      method: 'POST', credentials: 'same-origin', headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }, body: data
    }).then(r=>r.json()).then(json=>{
      if(json.success){ location.reload(); } else { alert('Erreur: '+(json.error||'')); }
    }).catch(()=>alert('Erreur réseau'));
  });
  // add modal helpers: show/hide conditional fields based on payment mode and show per-formation balances
    (function(){
    const addModalEl = document.getElementById('addModal');
    const addFormEl = document.getElementById('addForm');
    const addMode = document.getElementById('addMode');
    const numCheque = document.getElementById('add_numero_cheque');
    const dateCheque = document.getElementById('add_date_cheque');
    const compteB = document.getElementById('add_compte_bancaire');

    function setModeFields(mode){
      // default: cash
      if (!numCheque || !dateCheque || !compteB) return;
      if (mode === 'cheque'){
        numCheque.classList.remove('hidden'); dateCheque.classList.remove('hidden'); compteB.classList.add('hidden');
      } else if (mode === 'virement'){
        numCheque.classList.add('hidden'); dateCheque.classList.add('hidden'); compteB.classList.remove('hidden');
      } else {
        numCheque.classList.add('hidden'); dateCheque.classList.add('hidden'); compteB.classList.add('hidden');
      }
    }

    if (addMode) {
      // default to cash
      setModeFields(addMode.value || 'cash');
      addMode.addEventListener('change', function(){ setModeFields(this.value); });
    }

    // balances per formation feature removed — no network call required
    const enseignantSelect = addFormEl.querySelector('[name="enseignant_id"]');
    if (enseignantSelect){ enseignantSelect.addEventListener('change', function(){ /* balances removed */ }); }
  })();
  // Payments-style search micro-interactions adapted for reglements table
  (function(){
    const input = document.getElementById('paySearch');
    const clearBtn = document.getElementById('payClearBtn');
    const wrapper = document.querySelector('.search-wrapper');
  function updateClear(){ if(input && input.value && clearBtn) clearBtn.classList.add('show'); else if(clearBtn) clearBtn.classList.remove('show'); }
  function filterReglements(){ if(!input) return; const q = input.value.trim().toLowerCase(); document.querySelectorAll('#reglementsTbody tr').forEach(tr=>{ const nom = ((tr.querySelector('td:nth-child(1)') ? tr.querySelector('td:nth-child(1)').textContent : '')).toLowerCase(); const montant = (tr.querySelector('.amount') ? tr.querySelector('.amount').textContent : '').toLowerCase(); const textOk = q === '' || nom.includes(q) || montant.includes(q); tr.style.display = textOk ? '' : 'none'; }); }
  if(input){ input.addEventListener('input', function(){ updateClear(); filterReglements(); }); input.addEventListener('focus', ()=> wrapper && wrapper.classList.add('focused')); input.addEventListener('blur', ()=> wrapper && wrapper.classList.remove('focused')); }
  if(clearBtn){ clearBtn.addEventListener('click', function(e){ e.preventDefault(); const r=document.createElement('span'); r.className='ripple'; clearBtn.appendChild(r); r.style.left='50%'; r.style.top='50%'; r.style.transform='translate(-50%,-50%) scale(0)'; requestAnimationFrame(()=>{ r.style.transform='translate(-50%,-50%) scale(10)'; r.style.opacity='0'; r.style.transition='transform .45s ease, opacity .45s ease'; }); setTimeout(()=>{ try{ clearBtn.removeChild(r); }catch(e){} },500); input.value=''; input.focus(); updateClear(); filterReglements(); }); }
  updateClear();
  // ensure rows are shown/filtered correctly on initial load
  try{ filterReglements(); }catch(e){ console.error('filterReglements init error', e); }
  })();

  // delete action removed from UI; no delete handlers
</script>

{% endblock %}
