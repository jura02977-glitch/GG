{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="modal-overlay" style="position:fixed; inset:0; z-index:120; padding:20px; background: rgba(2,6,23,0.08);">
  <div class="modal card charges-modal" style="border-radius:14px;box-shadow:0 28px 80px rgba(2,6,23,0.14);transform-origin:center;animation:modalPop .28s cubic-bezier(.2,.9,.25,1) both;width:900px;max-width:calc(100% - 40px);">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:18px 20px;border-bottom:1px solid #f1f5f9;">
      <h2 style="margin:0;font-size:18px;font-weight:700;">{% if creating %}Nouvelle charge{% else %}Modifier la charge{% endif %}</h2>
      <button class="modal-close" aria-label="Fermer">✕</button>
    </div>
  <form method="post" enctype="multipart/form-data" style="padding:18px;">
      {% csrf_token %}
      <div class="grid" style="grid-template-columns:1fr;gap:14px;align-items:start;">
        {{ form.non_field_errors }}
        <div>
          <label class="block text-sm font-medium">Type</label>
          <div class="type-row" style="display:flex;flex-direction:column;gap:8px;align-items:stretch;">
            <div>
              {{ form.type_main }}
            </div>
            <div>
              {{ form.sous_type }}
            </div>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium">Montant</label>
          {{ form.montant }}
        </div>
        <div style="display:flex;gap:8px;flex-direction:column;">
          <label class="block text-sm font-medium">Contact</label>
          <div style="display:flex;gap:8px;flex-direction:row;">
            <div style="flex:1;">
              {{ form.contact_name }}
            </div>
            <div style="flex:0 0 160px;">
              {{ form.contact_phone }}
            </div>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium">Référence (optionnel)</label>
          {{ form.reference }}
        </div>
        <div>
          <label class="block text-sm font-medium">Description</label>
          {{ form.remarque }}
        </div>
        <!-- Attachment / AI auto-fill removed as requested -->
      </div>
      <div class="actions" style="border-top:1px solid #f1f5f9;margin-top:12px;display:flex;justify-content:flex-end;gap:10px;padding-top:12px;align-items:center;">
        <a href="{% url 'charges' %}" class="modal-close btn-secondary px-3 py-1 rounded" style="margin-right:6px;">Annuler</a>
        <button class="btn-primary px-3 py-1 rounded" type="submit">Enregistrer</button>
      </div>
    </form>
  </div>
</div>
  <script>
    (function(){
      // close buttons
      var closeBtns = document.querySelectorAll('.modal-close');
      closeBtns.forEach(function(b){ b.addEventListener('click', function(){
        var overlay = document.querySelector('.modal-overlay'); if(overlay) overlay.style.display='none';
      }); });
      document.addEventListener('keydown', function(e){ if(e.key === 'Escape'){ var overlay = document.querySelector('.modal-overlay'); if(overlay) overlay.style.display='none'; } });
    // overlay click => close
    var overlay = document.querySelector('.modal-overlay');
    if(overlay){
      overlay.addEventListener('click', function(e){ if(e.target === overlay) overlay.style.display='none'; });
      // append to body to avoid clipping/stacking context issues
      if(overlay.parentNode !== document.body) document.body.appendChild(overlay);
    }
      // ensure selects/inputs inside modal use same classes and don't overflow
      var inputs = document.querySelectorAll('.modal .form-control');
      inputs.forEach(function(i){ i.style.boxSizing='border-box'; i.style.padding='10px 12px'; i.style.borderRadius='6px'; i.style.border='1px solid #e9eef3'; i.style.maxWidth='100%'; i.style.width='100%'; });

      // --- Dynamic sous_type filtering based on selected type_main ---
      var typeMain = document.querySelector('select[name="type_main"]');
      var sousSelect = document.querySelector('select[name="sous_type"]');

      // mapping of allowed sous_type values per main type (matches backend TYPE_SUBTYPE_MAP)
      var mapping = {
        'travaux': [
          {v: 'maconnerie', t: 'Maçonnerie'},
          {v: 'plomberie', t: 'Plomberie'},
          {v: 'carrelage', t: 'Carrelage et faïence'},
          {v: 'peinture', t: 'Peinture'},
          {v: 'courant_fort', t: 'Courant fort'},
          {v: 'courant_faible', t: 'Courant faible'},
          {v: 'menuiserie', t: 'Menuiserie générale'},
          {v: 'finitions', t: 'Finitions'},
          {v: 'soudeur', t: 'Soudeur'},
          {v: 'quincaillerie', t: 'Quincaillerie'},
        ],
        'amenagement': [
          {v: 'mobilier', t: 'Mobilier'},
          {v: 'materiel_equipement', t: 'Matériel et équipement'},
        ],
        'vehicule': [
          {v: 'carburant', t: 'Carburant'},
          {v: 'assurance', t: 'Assurance'},
          {v: 'entretien_mecanique', t: 'Entretien et mécanique'},
        ],
        'fiscales': [
          {v: 'impot', t: 'Impôt'},
          {v: 'cnas', t: 'CNAS'},
          {v: 'casnos', t: 'CASNOS'},
          {v: 'quittance_fiscale', t: 'Quittance fiscale'},
        ],
        'fonctionnement': [
          {v: 'fourniture_bureautique', t: 'Fourniture bureautique'},
          {v: 'impression_photocopie', t: 'Impression et photocopie'},
          {v: 'publicite', t: 'Publicité'},
          {v: 'loyer', t: 'LOYER'},
          {v: 'entretien_nettoyage', t: 'Entretien et nettoyage'},
        ],
        'autres': [
          {v: 'alimentation', t: 'Alimentations'},
          {v: 'cafe_restaurant', t: 'Café & Restaurant'},
          {v: 'voyage', t: 'Voyage'},
          {v: 'transport', t: 'Transport'},
          {v: 'divers', t: 'Divers'},
        ],
        'abonnement': [
          {v: 'facture_electricite', t: "facture d'éléctricité"},
          {v: 'facture_gaz', t: 'facture Gaz'},
          {v: 'facture_internet', t: 'facture internet'},
          {v: 'facture_telephone', t: 'facture téléphone'},
          {v: 'facture_TV', t: 'facture TV'},
        ]
      };

      function rebuildSousOptions(selectedMain){
        if(!sousSelect) return;
        // preserve current value when possible
        var current = sousSelect.value;
        // clear all options
        sousSelect.innerHTML = '';
        // add default placeholder
        var opt = document.createElement('option'); opt.value = ''; opt.text = '--- Choisir un sous-type ---';
        sousSelect.appendChild(opt);
        if(!selectedMain) return;
        var list = mapping[selectedMain] || [];
        list.forEach(function(item){
          var o = document.createElement('option'); o.value = item.v; o.text = item.t; sousSelect.appendChild(o);
        });
        // if previous value still exists in new list, restore it
        try{
          sousSelect.value = current;
        }catch(e){}
      }

      if(typeMain && sousSelect){
        // initial build according to current state
        rebuildSousOptions(typeMain.value);
        // change handler
        typeMain.addEventListener('change', function(){ rebuildSousOptions(typeMain.value); });
      }

    })();

  // AI auto-fill removed from this form
  </script>
  <style>
    @keyframes modalPop { from { opacity:0; transform: translateY(12px) scale(.98); } to { opacity:1; transform: translateY(0) scale(1); } }
    /* responsive: on small screens stack columns and decorate inputs */
    @media (max-width:760px){
      .grid{ grid-template-columns: 1fr !important; gap:14px !important; }
      .modal{ width: calc(100% - 24px) !important; padding:16px !important; }
      /* color + soft animated background for mobile popups (green app palette) */
      .modal{ background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,255,250,0.95)); border: 1px solid rgba(22,163,74,0.08); box-shadow: 0 24px 80px rgba(22,163,74,0.08); overflow: hidden; }
      .modal:before{ content:''; position:absolute; inset:0; pointer-events:none; background:radial-gradient(600px 200px at 10% 10%, rgba(22,163,74,0.06), transparent 12%), radial-gradient(500px 180px at 90% 90%, rgba(5,150,105,0.04), transparent 14%); transform: translateZ(0); }
      .modal h2{ position:relative; z-index:2; }
      .modal .form-control{ transition: box-shadow .22s ease, transform .18s ease; }
      .modal .form-control:focus{ box-shadow: 0 10px 30px rgba(22,163,74,0.12); transform: translateY(-2px); }
      /* playful submit button gradient using app greens */
      .modal .btn-primary{ background: linear-gradient(90deg,var(--app-green),var(--app-green-2)); color:#fff; box-shadow:0 12px 30px rgba(5,150,105,0.12); transform-origin:center; transition: transform .18s ease; }
      .modal .btn-primary:hover{ transform:translateY(-4px) scale(1.02); box-shadow:0 22px 60px rgba(5,150,105,0.16); }
      /* Stack the type selects vertically */
      .modal .type-row{ flex-direction:column !important; align-items:stretch !important; }
      .modal .type-row > div{ flex:unset !important; width:100% !important; }
      /* Make labels clearer and inputs full-width */
      .modal label { display:block; margin-bottom:8px; font-weight:700; color:var(--text-secondary); }
      .modal input, .modal select, .modal textarea { width:100% !important; box-sizing:border-box; padding:12px 14px !important; border-radius:10px !important; border:1px solid #e6edf3 !important; background:linear-gradient(180deg,#ffffff,#fbfbff); box-shadow:0 8px 20px rgba(2,6,23,0.04); font-size:14px; }
      .modal textarea { min-height:110px; }
      /* Actions stacked and buttons full width */
      .modal .actions { flex-direction:column !important; align-items:stretch !important; gap:10px !important; }
      .modal .actions .modal-close { width:100%; display:block; text-align:center; }
      .modal .actions .btn-primary { width:100%; }
      /* Slightly larger title and decorative gradient */
      .modal h2 { font-size:18px; font-weight:800; background: linear-gradient(90deg,var(--app-green-2),var(--app-green)); -webkit-background-clip:text; background-clip:text; color:transparent; }
    }
  </style>
{% endblock %}